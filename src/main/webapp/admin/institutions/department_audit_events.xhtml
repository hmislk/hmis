<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:body>
        <ui:composition template="/admin/institutions/admin_institutions_index.xhtml">
            <ui:define name="admin">
                <h:form id="form">
                    <p:growl id="msg"/>
                    <p:panel styleClass="mb-3">
                        <f:facet name="header">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <h:outputText value="Department Audit Events" />
                                <div>
                                    <p:commandButton
                                        value="Back to Department List"
                                        icon="fas fa-arrow-left"
                                        action="/admin/institutions/departments?faces-redirect=true"
                                        styleClass="ui-button-info ui-button-outlined mx-1"
                                        ajax="false"
                                        immediate="true"
                                        title="Return to Department management"/>

                                    <p:commandButton
                                        value="Refresh Events"
                                        icon="fas fa-sync"
                                        action="#{departmentController.fillDepartmentAuditEvents}"
                                        update=":form:auditTable :form:msg"
                                        styleClass="ui-button-info mx-1"
                                        title="Reload audit events for this Department"/>
                                </div>
                            </div>
                        </f:facet>

                        <p:panelGrid columns="2" layout="tabular" styleClass="mb-3">
                            <p:outputLabel for="deptName" value="Name: "/>
                            <h:outputText id="deptName" value="#{departmentController.current.name}"/>
                            <p:outputLabel for="deptCode" value="Code: "/>
                            <h:outputText id="deptCode" value="#{departmentController.current.code}"/>
                            <p:outputLabel for="deptStatus" value="Status: "/>
                            <h:panelGroup id="deptStatus">
                                <h:outputText value="Active" rendered="#{not departmentController.current.inactive}"
                                              style="background-color: #28a745; color: white; padding: 3px 8px; border-radius: 3px;"/>
                                <h:outputText value="Inactive" rendered="#{departmentController.current.inactive}"
                                              style="background-color: #dc3545; color: white; padding: 3px 8px; border-radius: 3px;"/>
                            </h:panelGroup>
                            <p:outputLabel for="deptType" value="Department Type: "/>
                            <h:outputText id="deptType" value="#{departmentController.current.departmentType}"/>
                            <p:outputLabel for="deptInst" value="Institution: "/>
                            <h:outputText id="deptInst" value="#{departmentController.current.institution.name}"/>
                            <p:outputLabel for="deptSite" value="Site: "/>
                            <h:outputText id="deptSite" value="#{departmentController.current.site.name}"/>
                            <p:outputLabel for="totalEvents" value="Total Audit Events: "/>
                            <h:outputText id="totalEvents" value="#{departmentController.departmentAuditEvents.size()}"
                                          style="background-color: #17a2b8; color: white; padding: 3px 8px; border-radius: 3px;"/>
                        </p:panelGrid>

                        <p:dataTable
                            id="auditTable"
                            value="#{departmentController.departmentAuditEvents}"
                            var="audit"
                            paginator="true"
                            rows="20"
                            paginatorPosition="both"
                            paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                            currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} events"
                            rowsPerPageTemplate="10,20,50,100"
                            emptyMessage="No audit events found for this Department."
                            styleClass="table table-striped">

                            <p:column headerText="ID" style="width: 4em;" styleClass="text-end">
                                <h:outputText value="#{audit.id}" />
                            </p:column>

                            <p:column headerText="Date / Time" style="width: 12em;">
                                <h:outputText value="#{audit.eventDataTime}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}"/>
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Action" style="width: 10em;" styleClass="text-center">
                                <h:outputText value="#{audit.eventTrigger}"
                                              style="background-color: #{audit.eventTrigger eq 'Create Department' ? '#28a745' :
                                                    (audit.eventTrigger eq 'Update Department' ? '#ffc107' :
                                                    (audit.eventTrigger eq 'Delete Department' ? '#dc3545' :
                                                    (audit.eventTrigger eq 'Activate Department' ? '#17a2b8' :
                                                    (audit.eventTrigger eq 'Deactivate Department' ? '#6c757d' : '#007bff'))))};
                                                    color: #{audit.eventTrigger eq 'Update Department' ? 'black' : 'white'};
                                                    padding: 3px 8px; border-radius: 3px; font-size: 0.85em;"/>
                            </p:column>

                            <p:column headerText="User" style="width: 12em;">
                                <h:outputText value="#{webUserController.findWebUserNameWithTitleById(audit.webUserId)}" />
                            </p:column>

                            <p:column headerText="Changes" style="width: auto;">
                                <div class="audit-changes">
                                    <h:outputText value="#{audit.difference}" escape="true" />
                                </div>
                            </p:column>

                            <p:column headerText="Status" style="width: 6em;" styleClass="text-center">
                                <h:outputText value="#{audit.eventStatus}"
                                              style="background-color: #{audit.eventStatus eq 'Completed' ? '#28a745' :
                                                    (audit.eventStatus eq 'Failed' ? '#dc3545' : '#ffc107')};
                                                    color: #{audit.eventStatus eq 'Failed' or audit.eventStatus eq 'Completed' ? 'white' : 'black'};
                                                    padding: 3px 8px; border-radius: 3px; font-size: 0.85em;"/>
                            </p:column>

                            <p:column headerText="IP Address" style="width: 10em;">
                                <h:outputText value="#{audit.ipAddress}" styleClass="text-muted" style="font-size: 0.85em;"/>
                            </p:column>

                        </p:dataTable>
                    </p:panel>

                    <!-- Load audit events when page loads -->
                    <f:event type="preRenderView" listener="#{departmentController.fillDepartmentAuditEvents}" />

                </h:form>

                <!-- Custom CSS for better audit display -->
                <style>
                    .audit-changes {
                        max-width: 400px;
                        word-wrap: break-word;
                        white-space: pre-line;
                        font-family: 'Courier New', monospace;
                        font-size: 0.85em;
                        line-height: 1.3;
                    }

                    .table th {
                        background-color: #f8f9fa;
                        font-weight: 600;
                        border-top: none;
                    }

                    .table td {
                        vertical-align: middle;
                        padding: 0.75rem 0.5rem;
                    }
                </style>

            </ui:define>
        </ui:composition>
    </h:body>
</html>
