<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:body>
        <ui:composition template="/reports/index.xhtml">
            <ui:define name="subcontent">
                <h:form >

                    <p:panelGrid columns="5" layout="tabular" class="w-100" >
                        <f:facet name="header" >
                            <h:outputLabel value="Collection Centre Reports Print" ></h:outputLabel>
                        </f:facet>
                        <p:outputLabel value="From Date" />
                        <p:datePicker
                            showTime="true"
                            value="#{reportController.fromDate}" 
                            pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="To Date" />
                        <p:datePicker 
                            showTime="true"
                            class="w-100"
                            value="#{reportController.toDate}" 
                            pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />


                        <p:outputLabel value="Institution" />
                        <p:selectOneMenu filter="true" id="cmdInstitution" 
                                         class="w-100"
                                         value="#{reportController.institution}">
                            <f:selectItem itemLabel="All" />
                            <f:selectItems value="#{institutionController.companies}"
                                           var="i"
                                           itemLabel="#{i.name}"
                                           itemValue="#{i}" />
                        </p:selectOneMenu>
                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="Collection Center Name" />
                        <p:selectOneMenu 
                            style=" max-width: 100%; overflow-x: auto; "
                            class="w-100"
                            value="#{reportController.collectingCentre}"
                            filter="true">
                            <f:selectItem itemLabel="Select Collecting Centre"/>
                            <f:selectItems var="r" itemLabel="#{r.name}" 
                                           value="#{collectingCentreController.items}" 
                                           itemValue="#{r}" />
                        </p:selectOneMenu>

                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf3c5;" styleClass="fa mr-2" /> <!-- FontAwesome map marker icon -->
                            <h:outputLabel value="Site" for="siteMenu" class="mx-3"/>
                        </h:panelGroup>
                        <p:selectOneMenu
                            id="siteMenu"
                            styleClass="w-100 form-control"  
                            value="#{searchController.site}" 
                            filter="true">
                            <f:selectItem itemLabel="All Sites" />
                            <f:selectItems value="#{institutionController.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site}" />
                        </p:selectOneMenu>
                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="Collecting Centre Route" />
                        <p:selectOneMenu 
                            style=" max-width: 100%; overflow-x: auto; "
                            class="w-100"
                            value="#{reportController.route}"
                            filter="true"
                            filterMatchMode="contains">
                            <f:selectItem itemLabel="All" />
                            <f:selectItems value="#{routeController.items}"
                                           var="r"
                                           itemLabel="#{r.name}"
                                           itemValue="#{r}" />
                        </p:selectOneMenu>


                        <p:outputLabel value="Patient MRN" />
                        <p:inputText value="#{reportController.phn}" />
                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="Invoice Number" />
                        <p:inputText  style=" max-width: 100%; overflow-x: auto; "
                                      class="w-100"
                                      value="#{reportController.invoiceNumber}" />

                        <p:outputLabel value="Investigation" />
                        <p:autoComplete 
                            widgetVar="aPt" 
                            id="acPt" 
                            forceSelection="true" 
                            converter="ixcon"
                            value="#{reportController.investigation}" 
                            completeMethod="#{investigationController.completeInvestigationsWIthoutReportFormats}" 
                            var="apt" 
                            itemLabel="#{apt.name}" 
                            inputStyleClass="w-100" 
                            itemValue="#{apt}" 
                            class="w-100" 
                            size="10" 
                            minQueryLength="3">
                            <p:column headerText="Name">
                                #{apt.name}
                            </p:column>
                            <p:column headerText="Code">
                                #{apt.code}
                            </p:column>
                        </p:autoComplete> 

                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="Laboratory" />
                        <p:selectOneMenu 
                            style=" max-width: 100%; overflow-x: auto; "
                            class="w-100"
                            value="#{reportController.toDepartment}">
                            <f:selectItem itemLabel="Select Laboratory" />
                            <f:selectItems var="r" itemLabel="#{r.name}" 
                                           value="#{departmentController.labs}" 
                                           itemValue="#{r}" />
                        </p:selectOneMenu>


                        <p:outputLabel value="Referring Doctor" />
                        <p:autoComplete forceSelection="true" 
                                        id="cmbDoc" 
                                        value="#{reportController.doctor}" 
                                        completeMethod="#{doctorController.completeDoctor}" var="ix" 
                                        minQueryLength="4"
                                        placeholder="Type at least 4 letters to search"
                                        itemLabel="#{ix.person.name}" 
                                        itemValue="#{ix}" 
                                        inputStyleClass="form-control"
                                        class="w-100" 
                                        size="10">
                            <p:column headerText="Name" >
                                <h:outputText value="#{ix.person.nameWithTitle}" ></h:outputText>
                            </p:column>
                            <p:column headerText="Code" >
                                <h:outputText value="#{ix.code}" ></h:outputText>
                            </p:column>
                        </p:autoComplete>
                        <p:spacer width="50"></p:spacer>
                        <p:outputLabel value="Status" />
                        <p:selectOneMenu
                            value="#{reportController.status}"
                            style=" max-width: 100%; overflow-x: auto; "
                            class="w-100">
                            <f:selectItem itemLabel="Select Status" />
                            <f:selectItems value="#{enumController.billItemStatuses}" var="sts" itemLabel="#{sts.label}" itemValue="#{sts}" ></f:selectItems>
                        </p:selectOneMenu>
                        <p:selectOneMenu filter="true" filterMatchMode="contains" class="w-100" style="max-width:100%;"
                                         value="#{reportController.patientInvestigationStatus}">
                            <f:selectItem itemLabel="Any" />
                            <f:selectItems value="#{enumController.patientInvestigationStatuses}" var="pis" itemValue="#{pis}" itemLabel="#{pis.label}"/>
                        </p:selectOneMenu>

                        <p:commandButton ajax="false"
                                         value="Process"
                                         action="#{reportController.listCcReportPrint()}" />

                    </p:panelGrid>





                    <p:dataTable  
                        class="w-100"
                        value="#{reportController.patientInvestigations}" 
                        var="patientInvestigation" 
                        paginator="true"
                        rowKey="#{patientInvestigation.id}"
                        rowIndexVar="n"
                        paginatorPosition="bottom"
                        rows="10"
                        paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                        rowsPerPageTemplate="10,25,50"
                        style="table-layout: fixed; width: 100%;">

                        <!-- Selection Box Column -->
                        <p:column  style="width: 1em; vertical-align: top;">
                            #{n+1}
                        </p:column>

                        <!-- Bill Number Column with Icon and Colour -->
                        <p:column headerText="Bill Number" style="width: 5em; vertical-align: top;">
                          #{patientInvestigation.billItem.bill.deptId}
                        </p:column>

                        <p:column headerText="Patient" style="width: 10em; vertical-align: top;">
                           #{patientInvestigation.billItem.bill.patient.person.nameWithTitle}
                        </p:column>

                        <p:column headerText="Investigations" style="width: 7em; vertical-align: top;">
                            #{patientInvestigation.investigation.name}
                        </p:column>

                        <p:column headerText="Status" style="width: 7em; vertical-align: top;">
                            <h:outputLabel value="#{patientInvestigation.status}"/>
                        </p:column>

                        <!-- Ordered Institution and Department Column with Icons -->
                        <p:column headerText="Ordered Institute" style="width: 8em; vertical-align: top;">
                            <h:panelGroup rendered="#{patientInvestigation.billItem.bill.collectingCentre == null}">
                                <i class="fas fa-hospital text-info"></i> <!-- Institution Icon -->
                                <h:outputLabel value="#{patientInvestigation.billItem.bill.institution.name}" />
                                <br/>
                                <i class="fas fa-building text-primary"></i> <!-- Department Icon -->
                                <h:outputLabel value="#{patientInvestigation.billItem.bill.department.name}" />
                            </h:panelGroup>
                            <h:panelGroup rendered="#{patientInvestigation.billItem.bill.collectingCentre != null}">
                                <i class="fas fa-box text-secondary"></i> <!-- Collecting Centre Icon -->
                                <h:outputLabel value="#{patientInvestigation.billItem.bill.collectingCentre.name}" />
                            </h:panelGroup>
                        </p:column>

                        <!-- Lab Institution and Department Column with Icons -->
                        <p:column headerText="Lab" style="width: 5em; vertical-align: top;">
                            <i class="fas fa-flask text-danger"></i> <!-- Lab Institution Icon -->
                            <h:outputLabel value="#{patientInvestigation.billItem.bill.toInstitution.name}" />
                            <br/>
                            <i class="fas fa-vials text-success"></i> <!-- Lab Department Icon -->
                            <h:outputLabel value="#{patientInvestigation.billItem.bill.toDepartment.name}" />
                        </p:column>

                        <!-- Samples Column -->
                        <p:column headerText="Samples" style="width: 5em; vertical-align: top;">
                            <ui:repeat value="#{patientInvestigationController.getPatientSampleComponentsByInvestigation(patientInvestigation)}" var="psc">
                                <div class="ui-g d-grid" style="margin-bottom: 10px;">
                                    <div class="ui-g-6">
                                        <i class="fa fa-vial"></i>
                                        <h:outputText value="#{psc.patientSample.id}" class="text-primary" />
                                    </div>
                                </div>
                            </ui:repeat>
                        </p:column>

                    </p:dataTable>




                </h:form>

            </ui:define>
        </ui:composition>

    </h:body>
</html>
