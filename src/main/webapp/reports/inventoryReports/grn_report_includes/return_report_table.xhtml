<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:body>
        <ui:composition>
            <h:panelGroup class="m-4" rendered="#{pharmacyController.reportType eq 'returnReport'}">
                <h5>GRN Return</h5>
                <p:dataTable id="tbl2" value="#{pharmacyController.bills}"
                             var="r"
                             rowIndexVar="n"
                             paginator="true"
                             rows="10"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             currentPageReportTemplate="Showing {startRecord} to {endRecord} of {totalRecords}"
                             rowsPerPageTemplate="5,10,15,25,50,100,500,1000">

                    <p:column headerText="Purchase Return No" width="6em">
                        <p:commandLink
                            style="border-bottom: #003c36;"
                            ajax="false"
                            value="#{r.deptId}"
                            action="/pharmacy/pharmacy_reprint_grn_return">
                            <f:setPropertyActionListener target="#{pharmacyBillSearch.bill}" value="#{r}"/>
                        </p:commandLink>
                        <f:facet name="footer">
                            <h:outputText value="Total"/>
                        </f:facet>
                    </p:column>
                    <p:column headerText="GRN No" width="6em">
                        <p:commandLink
                            ajax="false"
                            value="#{r.referenceBill.deptId}"
                            action="/pharmacy/pharmacy_grn">
                            <f:setPropertyActionListener value="#{r.referenceBill}"
                                                         target="#{grnController.grnBill}"/>
                            <f:setPropertyActionListener value="true" target="#{grnController.printPreview}"/>
                        </p:commandLink>
                    </p:column>
                    <p:column headerText="GRN Invoice No" width="6em"
                              style="text-align: right; padding-right: 20px;">
                        <h:outputText value="#{r.referenceBill.invoiceNumber}"/>
                    </p:column>
                    <p:column headerText="GRN Date" width="6em">
                        <h:outputText value="#{r.referenceBill.createdAt}">
                            <f:convertDateTime
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Reference Institution" width="6em">
                        <h:outputText value="#{r.referenceBill.referenceInstitution.name}"/>
                    </p:column>
                    <p:column headerText="Created At" width="6em">
                        <h:outputText value="#{r.createdAt}">
                            <f:convertDateTime
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Approved At" width="6em">
                        <h:outputText value="#{r.referenceBill.createdAt}">
                            <f:convertDateTime
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Supplier" width="6em">
                        <h:outputText value="#{r.toInstitution.name}"/>
                    </p:column>
                    <p:column headerText="Purchase Value" width="6em" style="text-align: right;">
                        <h:outputText
                            value="#{r.billFinanceDetails.totalPurchaseValue}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>

                        <f:facet name="footer">
                            <h:outputText value="#{pharmacyController.totalPurchase}">
                                <f:convertNumber pattern="#,##0.00"/>
                            </h:outputText>
                        </f:facet>
                    </p:column>
                    <p:column headerText="Cost Value" width="6em" style="text-align: right;">
                        <h:outputText
                            value="#{r.billFinanceDetails.totalCostValue}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>

                        <f:facet name="footer">
                            <h:outputText value="#{pharmacyController.totalCostValue}">
                                <f:convertNumber pattern="#,##0.00"/>
                            </h:outputText>
                        </f:facet>
                    </p:column>
                    <p:column headerText="Sale Value" width="6em" style="text-align: right;">
                        <h:outputText
                            value="#{r.billFinanceDetails.totalRetailSaleValue}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>
                        <f:facet name="footer">
                            <h:outputText value="#{pharmacyController.totalSaleValue}">
                                <f:convertNumber pattern="#,##0.00"/>
                            </h:outputText>
                        </f:facet>
                    </p:column>

                    <p:column headerText="Purchase Details" width="50em" style="text-align: center;">
                        <p:rowExpansion>
                            <p:dataTable id="billItemsTable" value="#{r.billItems}" var="bi" rowKey="#{bi.id}"
                                         style="margin:0">
                                <p:column headerText="Item Name" style="text-align: left;">
                                    <h:outputText value="#{bi.item.name}"/>
                                </p:column>
                                <p:column headerText="Qty" class="text-end" >
                                    <h:outputText value="#{bi.pharmaceuticalBillItem.qty}"/>
                                </p:column>
                                <p:column headerText="Free Qty"  class="text-end" >
                                    <h:outputText value="#{bi.pharmaceuticalBillItem.freeQty}"/>
                                </p:column>
                                <p:column headerText="Purchase Rate"  class="text-end" >
                                    <h:outputLabel value="#{bi.pharmaceuticalBillItem.purchaseRate}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Cost Rate"  class="text-end" >
                                    <h:outputLabel value="#{bi.billItemFinanceDetails.lineCostRate}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Discount Rate"  class="text-end" >
                                    <h:outputLabel value="#{bi.billItemFinanceDetails.lineDiscountRate ne null ?
                                                            bi.billItemFinanceDetails.lineDiscountRate : bi.referanceBillItem.billItemFinanceDetails.lineDiscountRate}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Item MRP"  class="text-end" >
                                    <h:outputLabel value="#{bi.pharmaceuticalBillItem.retailRate}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Batch Code" style="text-align: left;">
                                    <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.batchNo}"/>
                                </p:column>
                                <p:column headerText="UOM" style="text-align: left;">
                                    <h:outputText value="#{bi.item.measurementUnit.name}"/>
                                </p:column>
                            </p:dataTable>
                        </p:rowExpansion>
                    </p:column>
                </p:dataTable>
            </h:panelGroup>
        </ui:composition>
    </h:body>
</html>
