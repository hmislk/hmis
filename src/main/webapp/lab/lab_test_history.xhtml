<html xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:na="http://xmlns.jcp.org/jsf/composite/template"
      xmlns:s="http://www.w3.org/1999/xhtml"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
        <title>Medical Test Tracking Interface</title>
        <h:outputStylesheet name="css/lab-test-history.css" />
    </h:head>

    <h:body>
        <ui:composition template="/resources/template/template_without_menu.xhtml">
            <ui:define name="content">
                <h:form>
                    <h:panelGroup rendered="#{!webUserController.hasPrivilege('AccessLabTestHistory')}" >
                        <na:not_authorize />
                    </h:panelGroup>

                    <h:panelGroup rendered="#{webUserController.hasPrivilege('AccessLabTestHistory')}" >
                        <h:outputStylesheet name="css/lab-test-history.css" />

                        <div class="container">
                            <div class="main-wrapper">
                                <!-- Header -->
                                <div class="header-card">
                                    <div class="header-content">
                                        <div class="header-left">
                                            <div class="icon-container">
                                                <i class="fa fa-history" aria-hidden="true" style="font-size: 18px;"></i>
                                            </div>
                                            <h1 class="header-title">Investigation Tracking History</h1>
                                        </div>
                                        <p:commandButton 
                                            class="ui-button-danger"
                                            action="#{laboratoryManagementController.navigateToBackFormPatientReportEditingView()}"
                                            icon="fa fa-times"
                                            title="Close">
                                        </p:commandButton>
                                    </div>

                                    <!-- Patient Information -->
                                    <div class="patient-info">
                                        <div class="patient-grid">
                                            <div class="patient-details">
                                                <h2 class="patient-name">
                                                    <i class="fa-regular fa-user" style="font-size: 32px;" ></i>
                                                    #{patientInvestigationController.current.billItem.bill.patient.person.nameWithTitle}
                                                </h2>
                                                <div class="patient-meta">
                                                    <p class="meta-item">
                                                        <i class="fa-regular fa-calendar-check" style="font-size: 28px;"></i>
                                                        #{patientInvestigationController.current.billItem.bill.patient.person.sex.shortLabel} - #{patientInvestigationController.current.billItem.bill.patient.person.ageYearsComponent} Years #{patientInvestigationController.current.billItem.bill.patient.person.ageMonthsComponent} Months
                                                    </p>
                                                    <p class="meta-item">
                                                        <i class="fa-regular fa-address-card"  style="font-size: 24px;"></i>
                                                        Patient ID : #{patientInvestigationController.current.billItem.bill.patient.phn}
                                                    </p>
                                                    <h:panelGroup rendered="#{patientInvestigationController.current.billItem.bill.patientEncounter ne null and patientInvestigationController.current.billItem.bill.patientEncounter.currentPatientRoom ne null}">
                                                        <p class="meta-item">
                                                            <i class="fa-solid fa-bed" style="font-size: 24px;"></i>
                                                            #{patientInvestigationController.current.billItem.bill.patientEncounter.currentPatientRoom.roomFacilityCharge.name} / #{patientInvestigationController.current.billItem.bill.patientEncounter.bhtNo}
                                                        </p>
                                                    </h:panelGroup>
                                                </div>
                                            </div>
                                            <div class="sample-info">
                                                <div class="sample-card">
                                                    <h3 class="sample-title">Sample Information</h3>
                                                    <div class="sample-details">
                                                        <div class="sample-row">
                                                            <span class="sample-label">Sample ID:</span>
                                                            <span class="sample-value">#{patientInvestigationController.getPatientSample()}</span>
                                                        </div>
                                                        <div class="sample-row">
                                                            <span class="sample-label">Investigation:</span>
                                                            <span class="sample-investigation">#{patientInvestigationController.current.billItem.item.name}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tracking Table -->
                                <div class="tracking-section">
                                    <div class="tracking-content">

                                        <div class="table-container">
                                            <table class="tracking-table">
                                                <thead>
                                                    <tr class="table-header">
                                                        <th class="th-cell">Process Stage</th>
                                                        <th class="th-cell">Personnel</th>
                                                        <th class="th-cell">Transporter</th>
                                                        <th class="th-cell">Location</th>
                                                        <th class="th-cell">Comment</th>
                                                        <th class="th-cell">Date</th>
                                                        <th class="th-cell">Time</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                        <ui:repeat value="#{labTestHistoryController.getLabTestHistoryByInvestigation(patientInvestigationController.current)}" var="history">
                                                            <tr class="table-row row-white">
                                                                <td class="td-cell">
                                                                    <span class="stage-name">#{history.historyType.label}</span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="person-name">#{history.user.webUserPerson.nameWithTitle}</span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="person-name">#{history.transporter != null and history.transporter.person != null ? history.transporter.person.nameWithTitle : 'N/A'}</span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="location-name">#{history.institutionName} - #{history.departmentName}</span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="comment">#{history.comment}</span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="date-text">
                                                                        <h:outputText value="#{history.historyAt}">
                                                                            <f:convertDateTime pattern="dd/MM/yyyy" />
                                                                        </h:outputText>
                                                                    </span>
                                                                </td>
                                                                <td class="td-cell">
                                                                    <span class="time-text">
                                                                        <h:outputText value="#{history.historyAt}">
                                                                            <f:convertDateTime pattern="HH:mm:ss" />
                                                                        </h:outputText>
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        

                                                    </ui:repeat>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h:panelGroup>
                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>