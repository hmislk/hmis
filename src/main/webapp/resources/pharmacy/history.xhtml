<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://xmlns.jcp.org/jsf/composite"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <!-- INTERFACE -->
    <cc:interface>
    </cc:interface>

    <!-- IMPLEMENTATION -->
    <cc:implementation>
        <p:panel id="tab">
            <f:facet name="header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h:outputLabel styleClass="fas fa-file-invoice " />
                        <h:outputLabel value="History of : " style="margin-left: 30px"/>
                        <h:outputLabel class="mx-1" value="#{pharmacyController.pharmacyItem.name}"/>
                    </div>
                    <div>
                        <h:outputLabel value="From Date"/>
                        <p:calendar class="mx-2" id="frmDate" value="#{pharmacyController.fromDate}" 
                                    navigator="true"  pattern="#{sessionController.applicationPreference.longDateTimeFormat}"  >

                        </p:calendar>

                        <h:outputLabel value="To Date"/>
                        <p:calendar class="mx-2" id="toDate" value="#{pharmacyController.toDate}" navigator="true" pattern="#{sessionController.applicationPreference.longDateTimeFormat}"  >

                        </p:calendar>
                        <p:commandButton 
                            update="panelHistoryData" 
                            process="@this frmDate toDate" 
                            action="#{pharmacyController.fillDetails()}"
                            class="ui-button-info"
                            icon="far fa-eye" 
                            value="View Detail"/>
                    </div>
                </div>
            </f:facet>

            <h:panelGroup id="panelHistoryData" >
                <h:panelGroup 
                    rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Blocks', true)}">
                    <div class="row">
                        <h:panelGroup 
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockStocks"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Stocks Block', true)}" >
                            <p:panel class="w-100" style="font-size: 15px;" >
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Stock*
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered" id="stock">
                                        <thead class="table-dark">
                                            <tr>
                                                <th class="w-25">Institution / Department</th>
                                                <th class="w-25">Site</th>
                                                <th class="w-25 text-end">Stock Quantity</th>
                                                <th class="w-25 text-end">Institution Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <ui:repeat value="#{pharmacyController.institutionStockDtos}" var="stockDto">
                                                <!-- Institution Header Row (shown only for first department of each institution) -->
                                                <ui:fragment rendered="#{pharmacyController.isFirstDepartmentOfInstitution(stockDto)}">
                                                    <tr class="table-secondary">
                                                        <td class="fw-bold">
                                                            <h:outputText value="#{stockDto.institutionName}"/>
                                                        </td>
                                                        <td></td>
                                                        <td></td>
                                                        <td class="text-end fw-bold">
                                                            <h:outputText value="#{pharmacyController.getInstitutionTotal(stockDto.institutionId)}">
                                                                <f:convertNumber integerOnly="true" />
                                                            </h:outputText>
                                                        </td>
                                                    </tr>
                                                </ui:fragment>

                                                <!-- Department Row -->
                                                <tr>
                                                    <td class="ps-4">
                                                        <h:outputText value="#{stockDto.departmentName}"/>
                                                    </td>
                                                    <td>
                                                        <h:outputText value="#{stockDto.siteName}"/>
                                                    </td>
                                                    <td class="text-end">
                                                        <h:outputText value="#{stockDto.stockQuantity}">
                                                            <f:convertNumber integerOnly="true" />
                                                        </h:outputText>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </ui:repeat>
                                        </tbody>
                                        <tfoot class="table-dark">
                                            <tr>
                                                <th colspan="3" class="fw-bold">
                                                    <h:outputText value="Grand Total Stock"/>
                                                </th>
                                                <th class="text-end fw-bold">
                                                    <h:outputText id="grandTotalBlock" value="#{pharmacyController.grantStock}">
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputText>
                                                </th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div> 
                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockSales"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Sale Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Pharmacy Sale
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionSales}" var="ins" id="phSale">
                                    <p:columnGroup type="header">
                                        <p:row>
                                            <p:column class="w-50">
                                                <f:facet name="header">
                                                    Department Name
                                                </f:facet>
                                            </p:column>
                                            <p:column class="w-25" style="text-align: right;">
                                                <f:facet name="header">
                                                    Qty
                                                </f:facet>
                                            </p:column>
                                            <p:column class="w-25" style="text-align: right;">
                                                <f:facet name="header">
                                                    Value
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>
                                    <p:subTable  value="#{ins.departmentSales}" var="dep">
                                        <f:facet name="header">
                                            #{ins.institution.name}
                                        </f:facet>
                                        <p:column>
                                            #{dep.department.name}
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleValue}">  
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:columnGroup type="footer">
                                            <p:row>
                                                <p:column footerText="Total "></p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionQty}">
                                                            <f:convertNumber integerOnly="true" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionValue}">
                                                            <f:convertNumber  pattern="#,##0.00" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                            </p:row>
                                        </p:columnGroup>
                                    </p:subTable>  
                                    <p:columnGroup type="footer">
                                        <p:row>
                                            <p:column>
                                                <f:facet name="footer">
                                                    Total Institution
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantSaleQty}">   
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantSaleValue}">
                                                        <f:convertNumber  pattern="#,##0.00" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>

                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockInpatientIssue"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display BHT Issue Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    BHT Issue
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionBhtIssue}" var="ins" id="bht">
                                    <p:columnGroup type="header">
                                        <p:row>
                                            <p:column class="w-50">
                                                <f:facet name="header">
                                                    Department Name
                                                </f:facet>
                                            </p:column>
                                            <p:column class="w-25" style="text-align: right;">
                                                <f:facet name="header">
                                                    Qty
                                                </f:facet>
                                            </p:column>
                                            <p:column class="w-25" style="text-align: right;">
                                                <f:facet name="header">
                                                    Value
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>
                                    <p:subTable  value="#{ins.departmentSales}" var="dep">
                                        <f:facet name="header">
                                            #{ins.institution.name}
                                        </f:facet>
                                        <p:column>
                                            #{dep.department.name}
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleValue}">  
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:columnGroup type="footer">
                                            <p:row>
                                                <p:column footerText="Total "></p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionQty}">
                                                            <f:convertNumber integerOnly="true" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionValue}">
                                                            <f:convertNumber  pattern="#,##0.00" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                            </p:row>
                                        </p:columnGroup>
                                    </p:subTable>  
                                    <p:columnGroup type="footer">
                                        <p:row>
                                            <p:column>
                                                <f:facet name="footer">
                                                    Total Institution
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantBhtIssueQty}">   
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantBhtValue}">
                                                        <f:convertNumber  pattern="#,##0.00" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>

                                </p:dataTable>

                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockWholesale"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Whole Sale Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Pharmacy Whole Sale
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionWholeSales}" var="ins" id="phWhSale">
                                    <p:columnGroup type="header">
                                        <p:row>
                                            <p:column >
                                                <f:facet name="header">
                                                    Department Name
                                                </f:facet>
                                            </p:column>
                                            <p:column >
                                                <f:facet name="header">
                                                    Qty
                                                </f:facet>
                                            </p:column>
                                            <p:column >
                                                <f:facet name="header">
                                                    Value
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>
                                    <p:subTable  value="#{ins.departmentSales}" var="dep">
                                        <f:facet name="header">
                                            #{ins.institution.name}
                                        </f:facet>
                                        <p:column>
                                            #{dep.department.name}
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleValue}">  
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:columnGroup type="footer">
                                            <p:row>
                                                <p:column footerText="Total "></p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionQty}">
                                                            <f:convertNumber integerOnly="true" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{ins.institutionValue}">
                                                            <f:convertNumber  pattern="#,##0.00" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                            </p:row>
                                        </p:columnGroup>
                                    </p:subTable>  
                                    <p:columnGroup type="footer">
                                        <p:row>
                                            <p:column>
                                                <f:facet name="footer">
                                                    Total Institution
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantWholeSaleQty}">   
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{pharmacyController.grantWholeSaleValue}">
                                                        <f:convertNumber  pattern="#,##0.00" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>

                                </p:dataTable>

                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockIssue"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Transfer Issue Block', true)}" >
                            <p:panel >
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Transfer Issue
                                </div>
                                <p:dataTable styleClass="noBorder" id="trIssueBlock" value="#{pharmacyController.institutionTransferIssue}" var="ins">
                                    <p:columnGroup type="header">
                                        <p:row>
                                            <p:column >
                                                <f:facet name="header">
                                                    To Depart. Name
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="header">
                                                    Sent Qty
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="header">
                                                    Sent Value
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>
                                    <p:subTable  value="#{ins.departmentSales}" var="dep">
                                        <f:facet name="header">
                                            #{ins.institution.name}
                                        </f:facet>
                                        <p:column>
                                            #{dep.department.name}
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleQtyAbs}">    
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:column style="text-align: right;">
                                            <h:outputLabel value="#{dep.saleValueAbs}">    
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel> 
                                        </p:column>
                                        <p:columnGroup type="footer">
                                            <p:row>
                                                <p:column footerText="Total "></p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{0-ins.institutionQty}">
                                                            <f:convertNumber integerOnly="true" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                                <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                                    <f:facet name="footer">
                                                        <h:outputLabel value="#{0-ins.institutionValue}">
                                                            <f:convertNumber  pattern="#,##0.00" />
                                                        </h:outputLabel>
                                                    </f:facet>
                                                </p:column>
                                            </p:row>
                                        </p:columnGroup>
                                    </p:subTable>  
                                    <p:columnGroup type="footer">
                                        <p:row>
                                            <p:column>
                                                <f:facet name="footer">
                                                    Total Institution
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{0-pharmacyController.grantTransferIssueQty}">
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                            <p:column style="text-align: right;">
                                                <f:facet name="footer">
                                                    <h:outputLabel  value="#{0-pharmacyController.grantTransferIssueValue}">
                                                        <f:convertNumber  pattern="#,##0.00" />
                                                    </h:outputLabel>
                                                </f:facet>
                                            </p:column>
                                        </p:row>
                                    </p:columnGroup>

                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockGrn"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display GRN Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    GRN Details
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.grnDtos}" var="g">
                                    <p:column headerText="GRN No">#{g.grnNo}</p:column>
                                    <p:column headerText="Dept">#{g.departmentName}</p:column>
                                    <p:column headerText="Date">
                                        <h:outputLabel value="#{g.createdAt}">
                                            <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Qty" class="text-end">#{g.quantity}</p:column>
                                    <p:column headerText="Value" class="text-end">
                                        <h:outputText value="#{g.netTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockGrnReturn"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display GRN Return Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    GRN Return Details
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.grnReturnDtos}" var="g">
                                    <p:column headerText="GRN Return No">#{g.grnReturnNo}</p:column>
                                    <p:column headerText="Dept">#{g.departmentName}</p:column>
                                    <p:column headerText="Date">
                                        <h:outputLabel value="#{g.createdAt}">
                                            <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Qty" class="text-end">#{g.quantityReturned}</p:column>
                                    <p:column headerText="Value" class="text-end">
                                        <h:outputText value="#{g.returnValue}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockPendingGrn"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Pending GRN Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Pending GRN Details
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.pendingGrns}" var="pendingGrn">
                                    <p:column headerText="GRN No">#{pendingGrn.bill.deptId}</p:column>
                                    <p:column headerText="GRN Date">
                                        <h:outputLabel value="#{pendingGrn.bill.createdAt}">
                                            <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Supplier">#{pendingGrn.bill.fromInstitution.name}</p:column>
                                    <p:column headerText="Qty Received" class="text-end">
                                        <h:outputText value="#{pendingGrn.pharmaceuticalBillItem.qty}">
                                            <f:convertNumber integerOnly="true" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Status">
                                        <h:outputText value="#{pendingGrn.bill.billTypeAtomic == 'PHARMACY_GRN_PRE' ? 'Saved' : 'Awaiting Approval'}" />
                                    </p:column>
                                </p:dataTable>

                            </p:panel>
                        </h:panelGroup>
                        <h:panelGroup
                            layout="block"
                            class="col-3"
                            id="itemDetailsBlockPurchaseOrders"
                            rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Purchase Orders Block', true)}" >
                            <p:panel>
                                <div style="background-color: #337357; padding: 10px; font-weight: bold; color: white; text-align: center;">
                                    Purchase Order Details
                                </div>
                                <p:dataTable styleClass="noBorder" value="#{pharmacyController.pos}" var="po">
                                    <p:column headerText="Order No">#{po.bill.deptId}</p:column>
                                    <p:column headerText="Order at">
                                        <h:outputLabel value="#{po.bill.createdAt}">
                                            <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Supplier">#{po.bill.toInstitution.name}</p:column>
                                    <p:column headerText="Qty Ordered" class="text-end">
                                        <h:outputText value="#{po.pharmaceuticalBillItem.qty}">
                                            <f:convertNumber integerOnly="true" />
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>

                            </p:panel>
                        </h:panelGroup>
                    </div>
                </h:panelGroup>
                <p:tabView  
                    rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Tabview', true)}"
                    class="w-100"  
                    activeIndex="0" 
                    style="border: 1px solid lightgray; padding: 10px;">

                    <p:tab
                        title="Stock"
                        id="itemDetailsTabStocks"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Stocks Tab', true)}">

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="w-25">Institution / Department</th>
                                        <th class="w-25">Site</th>
                                        <th class="w-25 text-end">Stock Quantity</th>
                                        <th class="w-25 text-end">Institution Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ui:repeat value="#{pharmacyController.institutionStockDtos}" var="stockDto">
                                        <!-- Institution Header Row (shown only for first department of each institution) -->
                                        <ui:fragment rendered="#{pharmacyController.isFirstDepartmentOfInstitution(stockDto)}">
                                            <tr class="table-secondary">
                                                <td class="fw-bold">
                                                    <h:outputText value="#{stockDto.institutionName}"/>
                                                </td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-end fw-bold">
                                                    <h:outputText value="#{pharmacyController.getInstitutionTotal(stockDto.institutionId)}">
                                                        <f:convertNumber integerOnly="true" />
                                                    </h:outputText>
                                                </td>
                                            </tr>
                                        </ui:fragment>

                                        <!-- Department Row -->
                                        <tr>
                                            <td class="ps-4">
                                                <h:outputText value="#{stockDto.departmentName}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{stockDto.siteName}"/>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{stockDto.stockQuantity}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td></td>
                                        </tr>
                                    </ui:repeat>
                                </tbody>
                                <tfoot class="table-dark">
                                    <tr>
                                        <th colspan="3" class="fw-bold">
                                            <h:outputText value="Grand Total Stock"/>
                                        </th>
                                        <th class="text-end fw-bold">
                                            <h:outputText id="grandTotalTab" value="#{pharmacyController.grantStock}">
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputText>
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                    </p:tab>

                    <p:tab 
                        title="Sale" 
                        id="itemDetailsTabSales"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Sale Tab', true)}">
                        <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionSales}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQty}">   
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValue}">  
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantSaleQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantSaleValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabSaleItems"
                        title="Sale Bill Item" 
                        class="w-100"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Sale Bill Item Tab', true)}">

                        <p:commandButton ajax="false" icon="fas fa-file-excel"
                                         class="ui-button-success" value="Excel" action="#{pharmacyController.createTable()}" >
                            <p:dataExporter type="xlsx" target="tbl" fileName="Category_report"  />

                        </p:commandButton>
                        <br/>
                        <p:dataTable id="tbl" styleClass="noBorder" value="#{pharmacyController.grns}" var="bi"
                                     paginator="true" 
                                     rows="10" 
                                     paginatorPosition="bottom"
                                     paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="5,10,15">
                            <p:column >
                                <f:facet name="header">
                                    Ins ID
                                </f:facet>
                                <p:outputLabel value="#{bi.bill.insId}" />
                            </p:column>
                            <p:column >
                                <f:facet name="header">
                                    dept ID
                                </f:facet>
                                <p:outputLabel value="#{bi.bill.deptId}" />
                            </p:column>
                            <p:column >
                                <f:facet name="header">
                                    Department
                                </f:facet>
                                <p:outputLabel value="#{bi.bill.department.name}" />
                            </p:column>
                            <p:column >
                                <f:facet name="header">
                                    Qty
                                </f:facet>
                                <p:outputLabel value="#{bi.pharmaceuticalBillItem.qty}" />
                            </p:column>

                        </p:dataTable>
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabWholesale"
                        title="Whole Sale" rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Whole Sale Tab', true)}">
                        <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionWholeSales}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQty}">   
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValue}">  
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantWholeSaleQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantWholeSaleValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabInpatient"
                        title="BHT Issue"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display BHT Issue Tab', true)}">
                        <p:dataTable styleClass="noBorder" value="#{pharmacyController.institutionBhtIssue}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQty}">   
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValue}">  
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantBhtIssueQty}">   
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{pharmacyController.grantBhtValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabTransferIssue"
                        title="Transfer Issue" 
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Transfer Issue Tab', true)}">
                        <p:dataTable styleClass="noBorder" id="trIssueTab" value="#{pharmacyController.institutionTransferIssue}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            To Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Sent Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Sent Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQtyAbs}">    
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValueAbs}">    
                                        <f:convertNumber  pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantTransferIssueQty}">
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantTransferIssueValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabTransferReceive"
                        title="Transfer Receive"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Transfer Receive Tab', true)}">
                        <p:dataTable styleClass="noBorder" id="trRceive" 
                                     value="#{pharmacyController.institutionTransferReceive}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            From Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Received Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Received Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQtyAbs}"> 
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValueAbs}"> 
                                        <f:convertNumber  pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{0-ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{0-ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantTransferReceiveQty}">
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantTransferReceiveValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabConsuption"
                        title="Department Issue" 
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Department Issue Tab', true)}">
                        <p:dataTable styleClass="noBorder" id="depIssue"
                                     value="#{pharmacyController.institutionIssue}" var="ins">
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column >
                                        <f:facet name="header">
                                            To Department Name
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Sent Qty
                                        </f:facet>
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header">
                                            Sent Value
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>
                            <p:subTable  value="#{ins.departmentSales}" var="dep">
                                <f:facet name="header">
                                    #{ins.institution.name}
                                </f:facet>
                                <p:column>
                                    #{dep.department.name}
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleQtyAbs}">    
                                        <f:convertNumber integerOnly="true" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:column style="text-align: right;">
                                    <h:outputLabel value="#{dep.saleValueAbs}">    
                                        <f:convertNumber  pattern="#,##0.00" />
                                    </h:outputLabel> 
                                </p:column>
                                <p:columnGroup type="footer">
                                    <p:row>
                                        <p:column footerText="Total "></p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionQty}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                        <p:column style="text-align: right;" footerText="#{ins.institutionValue}">
                                            <f:facet name="footer">
                                                <h:outputLabel value="#{0-ins.institutionValue}">
                                                    <f:convertNumber  pattern="#,##0.00" />
                                                </h:outputLabel>
                                            </f:facet>
                                        </p:column>
                                    </p:row>
                                </p:columnGroup>
                            </p:subTable>  
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column>
                                        <f:facet name="footer">
                                            Total Institution
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantIssueQty}">
                                                <f:convertNumber integerOnly="true" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                    <p:column style="text-align: right;">
                                        <f:facet name="footer">
                                            <h:outputLabel  value="#{0-pharmacyController.grantIssueValue}">
                                                <f:convertNumber  pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </f:facet>
                                    </p:column>
                                </p:row>
                            </p:columnGroup>

                        </p:dataTable>                
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabGrn"
                        title="GRN" 
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display GRN Tab', true)}">

                        <p:dataTable styleClass="noBorder" id="grn" value="#{pharmacyController.grnDtos}"
                                     var="dd2" scrollable="true"  paginator="true"
                                     rows="10"
                                     paginatorPosition="bottom"
                                     paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="5,10,15" >
                            <p:column headerText="GRN No">
                                #{dd2.grnNo}
                            </p:column>
                            <p:column headerText="Department">
                                #{dd2.departmentName}
                            </p:column>
                            <p:column headerText="Date">
                                <h:outputLabel value="#{dd2.createdAt}" >
                                    <f:convertDateTime  timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" ></f:convertDateTime>
                                </h:outputLabel>
                            </p:column>
                            <p:column headerText="PO No">
                                <h:outputText value="#{dd2.poNo}" />
                            </p:column>
                            <p:column headerText="Supplier">
                                <h:outputText value="#{dd2.supplierName}" />
                            </p:column>
                            <p:column headerText="Item">
                                <h:outputText value="#{dd2.itemName}" />
                            </p:column>
                            <p:column headerText="Qty">
                                <h:outputText value="#{dd2.quantity}" />
                            </p:column>
                            <p:column headerText="Fr. Qty">
                                <h:outputText value="#{dd2.freeQuantity}" />
                            </p:column>
                            <p:column headerText="Purchase Rate">
                                <h:outputText value="#{dd2.purchaseRate}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Cost Rate per unit">
                                <h:outputText value="#{dd2.totalCostRate}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Sale Rate">
                                <h:outputText value="#{dd2.retailSaleRate}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Value">
                                <h:outputText value="#{dd2.netTotal}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                        </p:dataTable>
                    </p:tab>

                    <p:tab 
                        id="itemDetailsTabPendingGrn"
                        title="Pending GRN" 
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Pending GRN Tab', true)}">
                        <p:dataTable 
                            id="pendinggrn" 
                            value="#{pharmacyController.pendingGrns}"
                            var="pendingGrnRow" scrollable="true"  paginator="true"
                            rows="10"
                            paginatorPosition="bottom"
                            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                            rowsPerPageTemplate="5,10,15" >

                            <p:column headerText="GRN Number">
                                #{pendingGrnRow.bill.deptId}
                            </p:column>
                            <p:column headerText="Department">
                                #{pendingGrnRow.bill.department.name}
                            </p:column>
                            <p:column headerText="GRN Date">
                                <h:outputLabel value="#{pendingGrnRow.bill.createdAt}" >
                                    <f:convertDateTime  timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                </h:outputLabel>
                            </p:column>
                            <p:column headerText="Supplier">
                                #{pendingGrnRow.bill.fromInstitution.name}
                            </p:column>
                            <p:column headerText="Item">
                                #{pendingGrnRow.item.name}
                            </p:column>
                            <p:column headerText="Qty Received" class="text-end">
                                <h:outputText value="#{pendingGrnRow.pharmaceuticalBillItem.qty}">
                                    <f:convertNumber integerOnly="true" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Free Qty Received" class="text-end">
                                <h:outputText value="#{pendingGrnRow.pharmaceuticalBillItem.freeQty}">
                                    <f:convertNumber integerOnly="true" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Status">
                                #{pendingGrnRow.bill.billTypeAtomic == 'PHARMACY_GRN_PRE' ? 'Saved' : 'Awaiting Approval'}
                            </p:column> 
                        </p:dataTable>

                    </p:tab>

                    <p:tab
                        title="GRN Return"
                        id="itemDetailsTabGrnReturn"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display GRN Return Tab', true)}">

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="grnr">
                                <thead class="table-dark">
                                    <tr>
                                        <th rowspan="2">GRN Return No</th>
                                        <th rowspan="2">Department</th>
                                        <th rowspan="2">Return Date</th>
                                        <th rowspan="2">Supplier</th>
                                        <th rowspan="2">Item</th>
                                        <th colspan="2" class="text-center">Quantities</th>
                                        <th colspan="3" class="text-center">Rates &amp; Value</th>
                                    </tr>
                                    <tr>
                                        <th class="text-end">Qty Returned</th>
                                        <th class="text-end">Free Qty Returned</th>
                                        <th class="text-end">Purchase Rate</th>
                                        <th class="text-end">Sale Rate</th>
                                        <th class="text-end">Return Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ui:repeat value="#{pharmacyController.grnReturnDtos}" var="dd2">
                                        <tr>
                                            <td>
                                                <h:outputText value="#{dd2.grnReturnNo}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{dd2.departmentName}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{dd2.createdAt}">
                                                    <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                </h:outputText>
                                            </td>
                                            <td>
                                                <h:outputText value="#{dd2.supplierName}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{dd2.itemName}"/>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{dd2.quantityReturned}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{dd2.freeQuantityReturned}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{dd2.purchaseRate}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{dd2.saleRate}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{dd2.returnValue}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                        </tr>
                                    </ui:repeat>
                                </tbody>
                            </table>
                        </div>
                    </p:tab>

                    <p:tab title="Purchase Orders" rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Purchase Orders Tab', true)}">

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="tblPurchaseOrders">
                                <thead class="table-dark">
                                    <tr>
                                        <th rowspan="2">Order Number</th>
                                        <th rowspan="2">Order Date</th>
                                        <th rowspan="2">Supplier</th>
                                        <th rowspan="2">Item</th>
                                        <th colspan="3" class="text-center">Qty</th>
                                        <th colspan="3" class="text-center">Free Qty</th>
                                    </tr>
                                    <tr>
                                        <th class="text-end">Ordered</th>
                                        <th class="text-end">Received</th>
                                        <th class="text-end">Remaining</th>
                                        <th class="text-end">Ordered</th>
                                        <th class="text-end">Received</th>
                                        <th class="text-end">Remaining</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ui:repeat value="#{pharmacyController.poDtos}" var="poDto">
                                        <tr>
                                            <td>
                                                <h:outputText value="#{poDto.billDeptId}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{poDto.billCreatedAt}">
                                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                </h:outputText>
                                            </td>
                                            <td>
                                                <h:outputText value="#{poDto.supplierName}"/>
                                            </td>
                                            <td>
                                                <h:outputText value="#{poDto.itemName}"/>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.qty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.completedQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.remainingQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.freeQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.completedFreeQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{poDto.remainingFreeQty}">
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </td>
                                        </tr>
                                    </ui:repeat>
                                </tbody>
                            </table>
                        </div>
                    </p:tab>

                    <p:tab title="Pending POs" rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Pending PO Tab', true)}">
                        <p:dataTable 
                            styleClass="noBorder" 
                            id="tablePendingPos" 
                            value="#{pharmacyController.pendingPoDtos}" 
                            var="pendingPo"
                            rows="10"
                            paginator="true"
                            paginatorPosition="bottom"
                            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                            rowsPerPageTemplate="5,10,15" >
                            <p:column headerText="PO No">
                                <p:outputLabel value="#{pendingPo.billDeptId}"></p:outputLabel>
                            </p:column>
                            <p:column headerText="PO Date">
                                <p:outputLabel value="#{pendingPo.billCreatedAt}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}"/>
                                </p:outputLabel>
                            </p:column>
                            <p:column headerText="Requested By">
                                <p:outputLabel value="#{pendingPo.creatorName}"/>                                                                
                            </p:column>

                            <p:column headerText="Supplier">
                                <p:outputLabel value="#{pendingPo.supplierName}"></p:outputLabel>
                            </p:column>
                            <p:column headerText="PO Qty" class="text-end">
                                <h:outputText value="#{pendingPo.qty}">
                                    <f:convertNumber integerOnly="true" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Free Qty" class="text-end">
                                <h:outputText value="#{pendingPo.freeQty}">
                                    <f:convertNumber integerOnly="true" />
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                    </p:tab>

                    <p:tab
                        title="Direct Purchase"
                        id="tabDirectPurchase"
                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Direct Purchase Tab', true)}">

                        <p:dataTable 
                            styleClass="noBorder" 
                            id="tblDirectPurchase" 
                            value="#{pharmacyController.directPurchaseDtos}" var="dd3"
                            rows="10" 
                            paginator="true"
                            paginatorPosition="bottom"
                            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                            rowsPerPageTemplate="5,10,15">
                            <p:column headerText="Bill No">
                                #{dd3.billDeptId}
                            </p:column>
                            <p:column headerText="Supplier">
                                #{dd3.billFromInstitutionName}
                            </p:column>
                            <p:column headerText="Billed By">
                                #{dd3.billCreaterName}
                            </p:column>    
                            <p:column headerText="Billed At">
                                <p:outputLabel value="#{dd3.billCreatedAt}" >
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}"></f:convertDateTime>
                                </p:outputLabel>
                            </p:column> 
                            <p:column headerText="Purchase Rate" class="text-end"> 
                                #{dd3.purchaseRate} 
                            </p:column>     
                            <p:column headerText="Sale Rate" class="text-end"> 
                                #{dd3.retailRate} 
                            </p:column>     
                            <p:column headerText="Purchase Qty" class="text-end"> 
                                #{dd3.qty} 
                            </p:column>     
                            <p:column headerText="Free Qty" class="text-end"> 
                                #{dd3.freeQty} 
                            </p:column>     
                            <p:column headerText="Purchase Value" class="text-end"> 
                                #{-dd3.billNetTotal} 
                            </p:column>  
                        </p:dataTable>
                    </p:tab>

                    <p:tab title="Pack Sizes" rendered="#{configOptionApplicationController.getBooleanValueByKey('Pharmacy Item Details Section - Display Pack Sizes Tab', true)}">
                        <p:dataTable value="#{pharmacyController.ampps}" var="p" >
                            <p:column>
                                <h:outputLabel value="#{p.name}" ></h:outputLabel>
                            </p:column>
                            <p:column class="text-end"> 
                                <h:outputLabel value="#{p.dblValue}" ></h:outputLabel> 
                            </p:column> 

                        </p:dataTable>
                    </p:tab>
                </p:tabView>
            </h:panelGroup>
        </p:panel>

    </cc:implementation>
</html>
