<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://xmlns.jcp.org/jsf/composite"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui">

    <!-- INTERFACE -->
    <cc:interface>
    </cc:interface>

    <!-- IMPLEMENTATION -->
    <cc:implementation>
        <p:dataTable 
            class="w-100 mt-3"
            value="#{laboratoryDoctorDashboardController.items}" 
            var="patientInvestigation" 
            paginator="true"
            rowKey="#{patientInvestigation.id}"
            paginatorPosition="bottom"
            rows="15"
            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
            rowsPerPageTemplate="15,50,100"
            style="table-layout: fixed; width: 100%;">

            <!-- Bill Number Column with Icon and Colour -->
            <p:column headerText="Bill Number" style="width: 13em; vertical-align: top;">
                <p:commandLink 
                    ajax="false" 
                    class="text-primary"
                    value="#{patientInvestigation.billItem.bill.deptId}" 
                    action="#{billSearch.navigateToViewOpdBill()}">
                    <f:setPropertyActionListener value="#{patientInvestigation.billItem.bill}" target="#{billSearch.bill}"/>
                </p:commandLink>
                <br/>
                <h:outputLabel value="#{patientInvestigation.billItem.bill.createdAt}">
                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}"></f:convertDateTime>
                </h:outputLabel>
                <br/>
                <h:panelGroup rendered="#{patientInvestigation.billItem.bill.patientEncounter ne null}">
                    <h:outputLabel style="color: #0d6efd;" value="#{patientInvestigation.billItem.bill.patientEncounter.bhtNo}"/>
                </h:panelGroup>

            </p:column>

            <!-- Patient Details Column with Icons -->
            <p:column headerText="Patient" style="vertical-align: top;">
                <i class="fas fa-user text-primary" style="width: 27px;"></i> <!-- Name Icon -->
                <h:outputLabel value="#{patientInvestigation.billItem.bill.patient.person.nameWithTitle}" />
                <br/>
                <i class="fas fa-birthday-cake text-info" style="width: 27px;"></i> <!-- Age Icon -->
                <h:outputLabel value="#{patientInvestigation.billItem.bill.patient.person.ageAsString}" />
                <h:outputLabel value="/" class="text-center" style="width: 30px;"/>
                <i class="fas fa-venus-mars text-danger" style="width: 27px;"></i> <!-- Sex Icon -->
                <h:outputLabel value="#{patientInvestigation.billItem.bill.patient.person.sex.label}" />
                <br/>
                <h:panelGroup rendered="#{!patientInvestigation.billItem.bill.patient.person.mobile.blank}">
                    <i class="fas fa-mobile-alt text-warning" style="width: 27px;"></i> <!-- Mobile Icon -->
                    <h:outputLabel value="#{patientInvestigation.billItem.bill.patient.person.mobile}" />
                </h:panelGroup>
            </p:column>

            <!-- Investigation Name Column -->
            <p:column headerText="Investigation" style="width: 400px; vertical-align: top;">
                <i class="fas fa-vial text-danger" style="width: 27px;"></i> <!-- Investigation Icon -->
                <h:outputLabel rendered="#{not webUserController.hasPrivilege('Developers')}" value="#{patientInvestigation.investigation.name}"/>
                <p:commandLink 
                    value="#{patientInvestigation.investigation.name}" 
                    rendered="#{webUserController.hasPrivilege('Developers')}" 
                    action="#{investigationController.navigateToManageInvestigation()}">
                    <f:setPropertyActionListener value="#{patientInvestigation.investigation}" target="#{investigationController.current}"/>
                </p:commandLink>
            </p:column>

            <!-- Ordered Institution and Department Column with Icons -->
            <p:column headerText="Ordered Institute" style="vertical-align: top;">
                <h:panelGroup rendered="#{patientInvestigation.billItem.bill.collectingCentre == null}">
                    <i class="fas fa-hospital text-info" style="width: 27px;"></i> <!-- Institution Icon -->
                    <h:outputLabel value="#{patientInvestigation.billItem.bill.institution.name}" />
                    <br/>
                    <i class="fas fa-building text-primary" style="width: 27px;"></i> <!-- Department Icon -->
                    <h:outputLabel value="#{patientInvestigation.billItem.bill.department.name}" />
                </h:panelGroup>
                <h:panelGroup rendered="#{patientInvestigation.billItem.bill.collectingCentre != null}">
                    <i class="fas fa-box text-secondary" style="width: 27px;"></i> <!-- Collecting Centre Icon -->
                    <h:outputLabel value="#{patientInvestigation.billItem.bill.collectingCentre.name}" />
                </h:panelGroup>
            </p:column>

            <!-- Samples Column -->
            <p:column headerText="Sample IDs" style="width:10em; vertical-align: top;">
                <ui:repeat value="#{laboratoryDoctorDashboardController.getPatientSampleComponentsByInvestigation(patientInvestigation)}" var="sample">
                    <div class="ui-g d-grid" style="margin-bottom: 10px;">
                        <div class="ui-g-6 d-flex">
                            <i class="fa fa-vial"></i>
                            <h:outputText value="#{sample}" class="mx-2 text-primary" />
                        </div>
                    </div>
                </ui:repeat>
            </p:column>

            <!-- Status Column -->
            <p:column headerText="Status" style="width: 12em; vertical-align: top;">
                <h:outputLabel value="#{patientInvestigation.status.label}"/>
                <br/>
                <br/>
                <p:badge 
                    value="Item Refunded" 
                    severity="info"
                    style="width: 200px;"
                    rendered="#{patientInvestigation.billItem.refunded}"
                    styleClass="ui-badge-warning" >
                </p:badge>

                <p:badge 
                    value="Bill Cancel" 
                    severity="info"
                    rendered="#{patientInvestigation.billItem.bill.cancelled}"
                    style="width: 200px;"
                    styleClass="ui-badge-danger" >
                </p:badge>
            </p:column>

            <!-- Actions Column -->
            <p:column headerText="Actions" style="width: 300px; vertical-align: top;">

                <h:panelGroup rendered="#{patientInvestigation.billItem.bill.cancelled ne true and patientInvestigation.billItem.refunded ne true}">
                    <div class="d-flex gap-2">

                        <p:commandButton 
                            icon="fa fa-file-text"
                            value="New Report" 
                            id="btnNewReport"
                            disabled="#{!patientInvestigation.sampleAccepted}" 
                            rendered="#{webUserController.hasPrivilege('LabDataentry')}"
                            action="#{patientReportController.navigateToCreatedPatientReport(patientInvestigation)}"
                            class="ui-button-danger"
                            onclick="if (!confirm('Are you sure you want to create a new patient report?'))
                                        return false;"
                            ajax="false">
                        </p:commandButton>

                        <p:commandButton 
                            icon="fa fa-file-text"
                            value="To Reports" 
                            class="ui-button-success"
                            ajax="false"
                            action="#{laboratoryDoctorDashboardController.navigateToPatientReportsFromSelectedInvestigation(patientInvestigation)}" >
                        </p:commandButton>
                    </div>

                </h:panelGroup>

                <h:panelGroup rendered="#{patientInvestigation.billItem.bill.cancelled}" class="d-flex justify-content-center mt-2">
                    <p:badge 
                        value="Bill Cancel" 
                        severity="info"
                        size="large"
                        style="width: 200px;"
                        styleClass="ui-badge-danger" >
                    </p:badge>
                </h:panelGroup>

                <h:panelGroup rendered="#{patientInvestigation.billItem.refunded}">
                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Creating a new laboratory patient report for a refunded BillItem.',true)}">
                        <div class="d-flex gap-2">

                            <p:commandButton 
                                icon="fa fa-file-text"
                                value="New Report" 
                                id="btnNewReportForRefund"
                                rendered="#{webUserController.hasPrivilege('LabDataentry')}"
                                disabled="#{!patientInvestigation.sampleAccepted}" 
                                action="#{patientReportController.navigateToCreatedPatientReport(patientInvestigation)}"
                                class="ui-button-danger"
                                onclick="if (!confirm('Are you sure you want to create a new patient report?'))
                                            return false;"
                                ajax="false">
                            </p:commandButton>

                            <p:commandButton 
                                icon="fa fa-file-text"
                                value="To Reports"
                                class="ui-button-success"
                                ajax="false" 
                                action="#{laboratoryDoctorDashboardController.navigateToPatientReportsFromSelectedInvestigation(patientInvestigation)}">
                            </p:commandButton>
                        </div>

                    </h:panelGroup>

                    <h:panelGroup rendered="#{!configOptionApplicationController.getBooleanValueByKey('Creating a new laboratory patient report for a refunded BillItem.',true)}">
                        <div class="d-flex justify-content-center mt-2">
                            <p:badge 
                                value="Item Refunded" 
                                severity="info"
                                size="large"
                                style="width: 200px;"
                                styleClass="ui-badge-warning" >
                            </p:badge>
                        </div>
                    </h:panelGroup>
                </h:panelGroup>
            </p:column>
        </p:dataTable>
    </cc:implementation>
</html>
