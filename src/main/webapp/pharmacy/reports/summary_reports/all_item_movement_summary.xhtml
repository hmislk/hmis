<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:body>
        <ui:composition template="/pharmacy/pharmacy_analytics.xhtml">
            <ui:define name="subcontent">
                
                <h:panelGroup rendered="#{webUserController.hasPrivilege('PharmacyReports') or webUserController.hasPrivilege('PharmacyAdministration')}">
                    <p:panel header="All Item Movement Summary" >

                    <h:form >
                        <h:panelGrid columns="8" styleClass="w-100 form-grid" columnClasses="label-icon-column, input-column">
                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa ml-5" />
                                <h:outputLabel value="From" for="fromDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="fromDate"
                                value="#{pharmacySummaryReportController.fromDate}"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />

                            <p:spacer width="50" ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa mr-2" />
                                <h:outputLabel value="To" for="toDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="toDate"
                                value="#{pharmacySummaryReportController.toDate}"
                                navigator="false"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />

                            <p:spacer width="50" ></p:spacer>
                            <p:spacer width="50" ></p:spacer>
                            <p:spacer width="50" ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf19c;" styleClass="fa mr-2" />
                                <h:outputLabel value="Institution" for="cmbIns" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmbIns"
                                styleClass="w-100 form-control"
                                value="#{pharmacySummaryReportController.institution}"
                                filter="true">
                                <f:selectItem itemLabel="All Institutions" />
                                <f:selectItems value="#{institutionController.companies}" var="ins" itemLabel="#{ins.name}" itemValue="#{ins}" />
                                <p:ajax process="cmbIns" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf3c5;" styleClass="fa mr-2" />
                                <h:outputLabel value="Site" for="siteMenu" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="siteMenu"
                                styleClass="w-100 form-control"
                                value="#{pharmacySummaryReportController.site}"
                                filter="true">
                                <f:selectItem itemLabel="All Sites" />
                                <f:selectItems value="#{institutionController.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site}" />
                                <p:ajax process="siteMenu" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf0e8;" styleClass="fa mr-2" />
                                <h:outputLabel value="Department" for="cmbDept" class="mx-3"/>
                            </h:panelGroup>
                            <h:panelGroup id="cmbDept">
                                <p:selectOneMenu
                                    rendered="#{pharmacySummaryReportController.institution eq null and pharmacySummaryReportController.site eq null}"
                                    styleClass="w-100 form-control"
                                    value="#{pharmacySummaryReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSite()}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>

                                <p:selectOneMenu
                                    rendered="#{pharmacySummaryReportController.institution eq null and pharmacySummaryReportController.site ne null}"
                                    styleClass="w-100 form-control"
                                    value="#{pharmacySummaryReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacySummaryReportController.site)}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>

                                <p:selectOneMenu
                                    rendered="#{pharmacySummaryReportController.institution ne null and pharmacySummaryReportController.site eq null}"
                                    styleClass="w-100 form-control"
                                    value="#{pharmacySummaryReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSiteForInstitution(pharmacySummaryReportController.institution)}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>

                                <p:selectOneMenu
                                    rendered="#{pharmacySummaryReportController.institution ne null and pharmacySummaryReportController.site ne null}"
                                    styleClass="w-100 form-control"
                                    value="#{pharmacySummaryReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacySummaryReportController.institution, pharmacySummaryReportController.site)}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>
                            </h:panelGroup>
                        </h:panelGrid>

                        <p:commandButton
                            value="Generate Report"
                            ajax="false"
                            action="#{pharmacySummaryReportController.generateAllItemMovementReport()}"
                            styleClass="ui-button-success m-1"
                            icon="pi pi-cog" />

                        <p:commandButton
                            value="View Available Reports"
                            ajax="false"
                            action="#{pharmacySummaryReportController.viewAlreadyAvailableAllItemMovementSummaryReports()}"
                            styleClass="ui-button-info m-1"
                            icon="pi pi-search" />

                        <p:dataTable
                            id="tblReports"
                            value="#{pharmacySummaryReportController.historicalRecords}"
                            var="rec"
                            rowIndexVar="i"
                            paginator="true"
                            paginatorAlwaysVisible="false"
                            paginatorPosition="top"
                            rows="10"
                            rowsPerPageTemplate="5,10,15,50"
                            styleClass="my-3">
                            <p:column headerText="No" exportable="false">
                                <h:outputText value="#{i+1}" />
                            </p:column>
                            <p:column headerText="From">
                                <h:outputText value="#{rec.fromDateTime}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="To">
                                <h:outputText value="#{rec.toDateTime}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Created At">
                                <h:outputText value="#{rec.createdAt}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Created By">
                                <h:outputText value="#{rec.createdBy == null ? 'N/A' : rec.createdBy.webUserPerson.name}" />
                            </p:column>
                            <p:column headerText="Completed">
                                <h:outputText value="#{rec.completed ? 'Yes' : 'No'}" />
                            </p:column>
                            <p:column headerText="Download" exportable="false">
                                <p:commandButton
                                    rendered="#{rec.completed}"
                                    ajax="false"
                                    styleClass="ui-button-warning"
                                    icon="pi pi-download"
                                    value="Download">
                                    <p:fileDownload value="#{pharmacySummaryReportController.downloadHistoricalRecordFile(rec)}" />
                                </p:commandButton>
                            </p:column>
                            <p:column headerText="Delete" exportable="false">
                                <p:commandButton
                                    icon="pi pi-trash"
                                    styleClass="ui-button-danger"
                                    value="Delete"
                                    action="#{pharmacySummaryReportController.retireHistoricalRecord(rec)}"
                                    update="tblReports"
                                    onclick="if (!confirm('Are you sure you want to delete this record?')) return false;" />
                            </p:column>
                        </p:dataTable>

                    </h:form>

                </p:panel>
                </h:panelGroup>
                
                <h:panelGroup rendered="#{not (webUserController.hasPrivilege('PharmacyReports') or webUserController.hasPrivilege('PharmacyAdministration'))}">
                    <p:panel header="Access Denied">
                        <p:messages autoUpdate="true" closable="true" />
                        <div class="alert alert-warning" role="alert">
                            <h4 class="alert-heading">Access Denied</h4>
                            <p>You do not have sufficient privileges to access this report. Please contact your system administrator to request access.</p>
                            <hr />
                            <p class="mb-0">Required privileges: <strong>Pharmacy Reports</strong> or <strong>Pharmacy Administration</strong></p>
                        </div>
                    </p:panel>
                </h:panelGroup>

            </ui:define>
        </ui:composition>
    </h:body>
</html>
