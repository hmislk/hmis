<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <h:body>
        <ui:composition template="/pharmacy/pharmacy_analytics.xhtml">
            <ui:define name="subcontent">
                <h:form>

                    <!-- Filter Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h:outputText value="&#xf0b0;" styleClass="fa me-2" /> <!-- Filter icon -->
                            <h:outputText value="Report Filters" styleClass="fw-bold"/>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Date Filter -->
                                <div class="col-md-4 col-lg-3">
                                    <h:outputLabel for="fromDate" value="Date" styleClass="form-label fw-bold"/>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <h:outputText value="&#xf073;" styleClass="fa text-primary"/>
                                        </span>
                                        <p:calendar
                                            id="fromDate"
                                            value="#{pharmacyDailyStockReportOptimizedController.fromDate}"
                                            pattern="#{sessionController.applicationPreference.longDateFormat}"
                                            styleClass="form-control"
                                            showOn="button"/>
                                    </div>
                                </div>

                                <!-- Institution Filter -->
                                <div class="col-md-4 col-lg-3">
                                    <h:outputLabel for="cmbIns" value="Institution" styleClass="form-label fw-bold"/>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <h:outputText value="&#xf19c;" styleClass="fa text-primary"/>
                                        </span>
                                        <p:selectOneMenu
                                            id="cmbIns"
                                            styleClass="form-select"
                                            value="#{pharmacyDailyStockReportOptimizedController.institution}"
                                            filter="true"
                                            filterMatchMode="contains">
                                            <f:selectItem itemLabel="All Institutions" itemValue="#{null}"/>
                                            <f:selectItems value="#{institutionController.companies}" var="ins" itemLabel="#{ins.name}" itemValue="#{ins}"/>
                                            <p:ajax process="cmbIns" update="cmbSite cmbDept"/>
                                        </p:selectOneMenu>
                                    </div>
                                </div>

                                <!-- Site Filter -->
                                <div class="col-md-4 col-lg-3">
                                    <h:outputLabel for="cmbSite" value="Site" styleClass="form-label fw-bold"/>
                                    <h:panelGroup id="cmbSite">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <h:outputText value="&#xf3c5;" styleClass="fa text-primary"/>
                                            </span>
                                            <p:selectOneMenu
                                                id="siteMenu"
                                                styleClass="form-select"
                                                value="#{pharmacyDailyStockReportOptimizedController.site}"
                                                filter="true"
                                                filterMatchMode="contains">
                                                <f:selectItem itemLabel="All Sites" itemValue="#{null}"/>
                                                <f:selectItems value="#{institutionController.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site}"/>
                                                <p:ajax process="siteMenu" update="cmbDept"/>
                                            </p:selectOneMenu>
                                        </div>
                                    </h:panelGroup>
                                </div>

                                <!-- Department Filter -->
                                <div class="col-md-6 col-lg-3">
                                    <h:outputLabel for="department" value="Department" styleClass="form-label fw-bold"/>
                                    <h:panelGroup id="cmbDept">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <h:outputText value="&#xf0e8;" styleClass="fa text-primary"/>
                                            </span>
                                            <!-- Component 1: Without Institution and Site -->
                                            <p:selectOneMenu
                                                id="department1"
                                                rendered="#{pharmacyDailyStockReportOptimizedController.institution eq null and pharmacyDailyStockReportOptimizedController.site eq null}"
                                                styleClass="form-select"
                                                value="#{pharmacyDailyStockReportOptimizedController.department}"
                                                filterMatchMode="contains"
                                                filter="true">
                                                <f:selectItem itemLabel="All Departments" itemValue="#{null}"/>
                                                <f:selectItems
                                                    value="#{departmentController.getDepartmentsOfInstitutionAndSite()}"
                                                    var="d"
                                                    itemLabel="#{d.name}"
                                                    itemValue="#{d}"/>
                                            </p:selectOneMenu>

                                            <!-- Component 2: With Site Only -->
                                            <p:selectOneMenu
                                                id="department2"
                                                rendered="#{pharmacyDailyStockReportOptimizedController.institution eq null and pharmacyDailyStockReportOptimizedController.site ne null}"
                                                styleClass="form-select"
                                                value="#{pharmacyDailyStockReportOptimizedController.department}"
                                                filterMatchMode="contains"
                                                filter="true">
                                                <f:selectItem itemLabel="All Departments" itemValue="#{null}"/>
                                                <f:selectItems
                                                    value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacyDailyStockReportOptimizedController.site)}"
                                                    var="d"
                                                    itemLabel="#{d.name}"
                                                    itemValue="#{d}"/>
                                            </p:selectOneMenu>

                                            <!-- Component 3: With Institution Only -->
                                            <p:selectOneMenu
                                                id="department3"
                                                rendered="#{pharmacyDailyStockReportOptimizedController.institution ne null and pharmacyDailyStockReportOptimizedController.site eq null}"
                                                styleClass="form-select"
                                                value="#{pharmacyDailyStockReportOptimizedController.department}"
                                                filterMatchMode="contains"
                                                filter="true">
                                                <f:selectItem itemLabel="All Departments" itemValue="#{null}"/>
                                                <f:selectItems
                                                    value="#{departmentController.getDepartmentsOfInstitutionAndSiteForInstitution(pharmacyDailyStockReportOptimizedController.institution)}"
                                                    var="d"
                                                    itemLabel="#{d.name}"
                                                    itemValue="#{d}"/>
                                            </p:selectOneMenu>

                                            <!-- Component 4: With Both Institution and Site -->
                                            <p:selectOneMenu
                                                id="department4"
                                                rendered="#{pharmacyDailyStockReportOptimizedController.institution ne null and pharmacyDailyStockReportOptimizedController.site ne null}"
                                                styleClass="form-select"
                                                value="#{pharmacyDailyStockReportOptimizedController.department}"
                                                filterMatchMode="contains"
                                                filter="true">
                                                <f:selectItem itemLabel="All Departments" itemValue="#{null}"/>
                                                <f:selectItems
                                                    value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacyDailyStockReportOptimizedController.institution, pharmacyDailyStockReportOptimizedController.site)}"
                                                    var="d"
                                                    itemLabel="#{d.name}"
                                                    itemValue="#{d}"/>
                                            </p:selectOneMenu>
                                        </div>
                                    </h:panelGroup>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h:outputText value="&#xf0ae;" styleClass="fa me-2" /> <!-- Actions icon -->
                            <h:outputText value="Actions" styleClass="fw-bold"/>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-auto">
                                    <p:commandButton
                                        value="Generate Report"
                                        ajax="false"
                                        action="#{pharmacyDailyStockReportOptimizedController.processDailyStockBalanceReportOptimized}"
                                        styleClass="btn btn-primary"
                                        icon="fa fa-refresh">
                                        <f:ajax render="reportSection exportButtons"/>
                                    </p:commandButton>
                                </div>

                                <!-- Export Buttons (shown only when report is available) -->
                                <h:panelGroup id="exportButtons" layout="block" styleClass="col-auto">
                                    <h:panelGroup layout="block"
                                                  rendered="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport != null and pharmacyDailyStockReportOptimizedController.fromDate != null and pharmacyDailyStockReportOptimizedController.department != null}">
                                        <div class="btn-group" role="group" aria-label="Export options">
                                            <p:commandButton
                                                value="Download Excel"
                                                ajax="false"
                                                action="#{pharmacyDailyStockReportOptimizedController.downloadExcel}"
                                                styleClass="btn btn-success"
                                                icon="fa fa-file-excel-o"
                                                title="Download report as Excel file"/>

                                            <p:commandButton
                                                value="Print"
                                                ajax="false"
                                                action="#{pharmacyDailyStockReportOptimizedController.navigateToPrintPage}"
                                                styleClass="btn btn-info"
                                                icon="fa fa-print"
                                                title="Open print-friendly version"/>
                                        </div>
                                    </h:panelGroup>
                                </h:panelGroup>

                                <div class="col-auto ms-auto">
                                    <p:commandButton
                                        value="Clear"
                                        immediate="true"
                                        ajax="true"
                                        actionListener="#{pharmacyDailyStockReportOptimizedController.clearFilters}"
                                        update="@form"
                                        styleClass="btn btn-outline-secondary"
                                        icon="fa fa-eraser"
                                        title="Clear all filters and reset form"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Results Section -->
                    <h:panelGroup id="reportSection">
                        <div class="card"
                             rendered="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport != null and pharmacyDailyStockReportOptimizedController.fromDate != null and pharmacyDailyStockReportOptimizedController.department != null}">
                            <div class="card-header bg-info text-white">
                                <h:outputText value="&#xf1c0;" styleClass="fa me-2" /> <!-- Database icon -->
                                <h:outputText value="Daily Stock Value Report Results" styleClass="fw-bold"/>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped table-hover mb-0">
                        <tr>
                            <th colspan="2" class="bg-primary text-white text-center">
                                <h:outputText value="Daily Stock Value Report"></h:outputText>
                            </th>
                        </tr>
                        <tr>
                            <th class="bg-secondary text-white text-center">
                                <h:outputText value="Date : "></h:outputText>
                                <h:outputText value="#{pharmacyDailyStockReportOptimizedController.fromDate}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}"></f:convertDateTime>
                                </h:outputText>
                            </th>
                            <th class="bg-secondary text-white text-center">
                                <h:outputText value="Department : "></h:outputText>
                                <h:outputText value="#{pharmacyDailyStockReportOptimizedController.department.name}"></h:outputText>
                            </th>
                        </tr>

                        <tr class="table-primary">
                            <td>
                                <h:outputLabel value="Opening Stock"></h:outputLabel>
                            </td>
                            <td class="text-end">
                                <h:outputLabel value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.openingStockValue}" class="me-4">
                                    <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                </h:outputLabel>
                            </td>
                        </tr>

                        <ui:repeat value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacySalesByAdmissionTypeAndDiscountSchemeBundle.rows}" var="sale">
                            <tr class="table-success">
                                <td>
                                    <h:outputLabel value="#{sale.rowType}"></h:outputLabel>
                                </td>
                                <td class="text-end">
                                    <h:outputLabel value="#{sale.netTotal}" class="me-4">
                                        <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                    </h:outputLabel>
                                </td>
                            </tr>
                        </ui:repeat>
                        <tr class="bg-success text-white">
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6"></div>
                                    <div class="col-6">
                                        <h:outputLabel value="Total Sales"></h:outputLabel>
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6 text-end">
                                        <h:outputLabel value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacySalesByAdmissionTypeAndDiscountSchemeBundle.summaryRow.netTotal}" class="me-4">
                                            <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                        </h:outputLabel>
                                    </div>
                                    <div class="col-6"></div>
                                </div>
                            </td>
                        </tr>

                        <ui:repeat
                            id="purchaseBundles"
                            value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyPurchaseByBillTypeBundle.rows}" var="purchase">
                            <tr class="table-warning">
                                <td>
                                    <h:outputLabel value="#{purchase.rowType}"></h:outputLabel>
                                </td>
                                <td class="text-end">
                                    <h:outputLabel value="#{purchase.valueOfStocksAtRetailSaleRate}" class="me-4">
                                        <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                    </h:outputLabel>
                                </td>
                            </tr>
                        </ui:repeat>
                        <tr class="bg-warning text-dark">
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6"></div>
                                    <div class="col-6">
                                        <h:outputLabel value="Total Purchases"></h:outputLabel>
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6 text-end">
                                        <h:outputLabel
                                            id="lblPurchaseBillsTotalAtRetailRate"
                                            value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyPurchaseByBillTypeBundle.summaryRow.valueOfStocksAtRetailSaleRate}" class="me-4">
                                            <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                        </h:outputLabel>
                                    </div>
                                    <div class="col-6"></div>
                                </div>
                            </td>
                        </tr>

                        <ui:repeat value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyTransferByBillTypeBundle.rows}" var="transfer">
                            <tr class="table-info">
                                <td>
                                    <h:outputLabel value="#{transfer.rowType}"></h:outputLabel>
                                </td>
                                <td class="text-end">
                                    <h:outputLabel value="#{transfer.valueOfStocksAtRetailSaleRate}" class="me-4">
                                        <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                    </h:outputLabel>
                                </td>
                            </tr>
                        </ui:repeat>
                        <tr class="bg-info text-dark">
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6"></div>
                                    <div class="col-6">
                                        <h:outputLabel value="Total Transfers"></h:outputLabel>
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6 text-end">
                                        <h:outputLabel value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyTransferByBillTypeBundle.summaryRow.valueOfStocksAtRetailSaleRate}" class="me-4">
                                            <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                        </h:outputLabel>
                                    </div>
                                    <div class="col-6"></div>
                                </div>
                            </td>
                        </tr>

                        <ui:repeat value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyAdjustmentsByBillTypeBundle.rows}" var="adjustment">
                            <tr class="table-danger">
                                <td>
                                    <h:outputLabel value="#{adjustment.rowType}"></h:outputLabel>
                                </td>
                                <td class="text-end">
                                    <h:outputLabel value="#{adjustment.grossTotal}" class="me-4">
                                        <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                    </h:outputLabel>
                                </td>
                            </tr>
                        </ui:repeat>
                        <tr class="bg-danger text-white">
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6"></div>
                                    <div class="col-6">
                                        <h:outputLabel value="Total Adjustments"></h:outputLabel>
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold">
                                <div class="row">
                                    <div class="col-6 text-end">
                                        <h:outputLabel value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.pharmacyAdjustmentsByBillTypeBundle.summaryRow.valueOfStocksAtRetailSaleRate}" class="me-4">
                                            <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                        </h:outputLabel>
                                    </div>
                                    <div class="col-6"></div>
                                </div>
                            </td>
                        </tr>

                        <tr class="table-primary">
                            <td>
                                <h:outputLabel value="Closing Stock"></h:outputLabel>
                            </td>
                            <td class="text-end">
                                <h:outputLabel value="#{pharmacyDailyStockReportOptimizedController.dailyStockBalanceReport.closingStockValue}" class="me-4">
                                    <f:convertNumber pattern="#,##0.00"></f:convertNumber>
                                </h:outputLabel>
                            </td>
                        </tr>
                                </table>
                            </div>
                        </div>
                    </h:panelGroup>




                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
