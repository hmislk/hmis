<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/resources/template/template.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ph="http://xmlns.jcp.org/jsf/composite/pharmacy"
                xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
                xmlns:po="http://xmlns.jcp.org/jsf/composite/pharmacy">
    <ui:define name="content">
        <h:form id="form">
            <h:panelGroup rendered="#{!webUserController.hasPrivilege('CreatePurchaseOrder')}" >
                You are NOT authorized
            </h:panelGroup>
            <h:panelGroup id="gpOrder" rendered="#{webUserController.hasPrivilege('CreatePurchaseOrder')}" >
                <p:defaultCommand target="btnSave" ></p:defaultCommand>
                <p:messages id="pageMessages" ></p:messages>
                <h:panelGroup id="notPrintPreview"  rendered="#{not createPoController.printPreview}" class="w-100 p-0 m-0">

                    <h:panelGroup rendered="#{not createPoController.currentBill.checked}">
                        <div class="row">
                            <div class="col-9">

                                <p:dataTable
                                    styleClass="noBorder"
                                    rowIndexVar="i"
                                    style="padding: 0;"
                                    var="dto"
                                    scrollable="true"
                                    scrollHeight="350px"
                                    rowKey="#{dto.serialNo}"
                                    value="#{createPoController.itemDtos}"
                                    selection="#{createPoController.selectedItemDtos}"
                                    selectionMode="multiple"
                                    id="itemList" >

                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between">
                                            <h:outputLabel  value="Purchase Order Items"/>
                                            <p:commandButton ajax="false" class="ui-button-danger" value="Remove Selected"
                                                             action="#{createPoController.removeSelected()}"/>
                                        </div>
                                    </f:facet>

                                    <p:column selectionBox="true" width="2em"  style="padding: 0;" />

                                    <p:column headerText="No" width="2em" style="padding: 0;" >
                                        <h:outputLabel value="#{dto.serialNo+1}" >
                                            <f:convertNumber pattern="00" ></f:convertNumber>
                                        </h:outputLabel>
                                    </p:column>

                                    <p:column headerText="Item"  style=" padding: 0;">
                                        <h:outputLabel value="#{dto.itemName}  - #{dto.itemCode}" ></h:outputLabel>
                                    </p:column>

                                    <p:column
                                        headerText="Qty"
                                        width="6em"
                                        class="text-end px-1"
                                        style="padding: 0px;">
                                        <p:inputText
                                            autocomplete="off"
                                            id="qty"
                                            value="#{dto.quantity}"
                                            style="padding: 0;"
                                            label="Qty"
                                            class="text-end w-100"
                                            onfocus="this.select()">
                                            <f:convertNumber pattern="0.#" ></f:convertNumber>
                                            <p:ajax
                                                event="blur"
                                                update="total :#{p:resolveFirstComponentWithId('tot',view).clientId} @this :#{p:resolveFirstComponentWithId('pageMessages',view).clientId}"
                                                process="@this price"
                                                listener="#{createPoController.onEditDto(dto)}" ></p:ajax>
                                        </p:inputText>
                                    </p:column>

                                    <p:column
                                        width="5em"
                                        headerText="Free Qty"
                                        class="text-end px-1"
                                        style="padding: 0px;">
                                        <p:inputText
                                            autocomplete="off"
                                            id="freeQty"
                                            onfocus="this.select()"
                                            class="text-end w-100"
                                            value="#{dto.freeQuantity}"
                                            style="padding: 0;"
                                            label="Qty">
                                            <f:convertNumber pattern="0.#" ></f:convertNumber>
                                            <f:ajax
                                                event="blur"
                                                render="total :#{p:resolveFirstComponentWithId('tot',view).clientId}  @this :#{p:resolveFirstComponentWithId('pageMessages',view).clientId}"
                                                execute="@this price"
                                                listener="#{createPoController.onEditDto(dto)}" >
                                            </f:ajax>
                                        </p:inputText>
                                    </p:column>

                                    <p:column
                                        headerText="P Price"
                                        class="text-end px-1"
                                        style="padding: 0px;"
                                        width="6em">
                                        <h:panelGroup id="price">
                                            <p:inputText
                                                id="txtRetailRate"
                                                onfocus="this.select()"
                                                autocomplete="off"
                                                style="padding: 0;"
                                                value="#{dto.purchaseRate}"
                                                class="w-100 text-end">
                                                <f:convertNumber pattern="#,##0.00"/>
                                                <f:ajax event="blur" render="total :#{p:resolveFirstComponentWithId('tot',view).clientId}"  execute="@this qty" listener="#{createPoController.onEditDto(dto)}" ></f:ajax>
                                            </p:inputText>
                                        </h:panelGroup>
                                    </p:column>

                                    <p:column
                                        headerText="Total"
                                        class="text-end px-1"
                                        style="padding: 0;"
                                        width="6em">
                                        <h:panelGroup id="total">
                                            <h:outputText
                                                id="lblTotal"
                                                value="#{dto.lineTotal}" >
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </h:panelGroup>
                                    </p:column>

                                    <p:column
                                        headerText="Stock in Units"
                                        width="6em"
                                        style="padding: 0;"
                                        class="text-end px-1">
                                        <h:outputText value="#{dto.stockInUnits}">
                                            <f:convertNumber pattern="#,##0.00"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column
                                        headerText="Usage" width="6em"
                                        style="padding: 0;"
                                        class="text-end px-1">
                                        <p:outputLabel value="#{dto.usageCount}" style="width:4em; text-align: right;">
                                            <f:convertNumber pattern="#,##0.00"/>
                                        </p:outputLabel>
                                    </p:column>

                                    <p:column  style="width:5em; text-align: right; padding: 0;">
                                        <p:commandButton
                                            class="ui-button-danger"
                                            icon="fas fa-trash"
                                            process="itemList"
                                            update="itemList :#{p:resolveFirstComponentWithId('tot',view).clientId}"
                                            tabindex="-1"
                                            style="padding: 0;"
                                            action="#{createPoController.removeItemDto(dto)}"/>
                                    </p:column>

                                </p:dataTable>

                                <div >
                                    <ph:history/>
                                </div>


                            </div>
                            <div class="col-3">
                                <p:panel header="Purchase Order" id="po">
                                    <p:outputLabel value="Supplier"
                                                   class="form-label"
                                                   for="acSupplier"></p:outputLabel>
                                    <p:autoComplete
                                        id="acSupplier"
                                        converter="deal"
                                        value="#{createPoController.currentBill.toInstitution}"
                                        forceSelection="true"
                                        required="true"
                                        class="w-100"
                                        inputStyleClass="w-100"
                                        requiredMessage="Supplier is Required"
                                        completeMethod="#{dealerController.completeActiveDealor}"
                                        var="vt" itemLabel="#{vt.name}" itemValue="#{vt}" >
                                        <f:ajax
                                            event="itemSelect"
                                            execute="@this"
                                            render=":#{p:resolveFirstComponentWithId('exDItem',view).clientId}"
                                            listener="#{createPoController.loadDealerItems()}"
                                            />
                                    </p:autoComplete>

                                    <p:outputLabel value="Payment Method"
                                                   class="form-label"
                                                   for="cmbPs"></p:outputLabel>
                                    <p:selectOneMenu class="w-100"  id="cmbPs" value="#{createPoController.currentBill.paymentMethod}">
                                        <f:selectItem itemLabel="Select Payment method"/>
                                        <f:selectItems value="#{enumController.paymentMethodsForGrn}" var="pm" itemLabel="#{pm.label}" itemValue="#{pm}">
                                        </f:selectItems>
                                        <p:ajax process="@this" update="po" event="change"/>
                                        <p:ajax process="@this" update="duration" event="itemSelect" />
                                    </p:selectOneMenu>


                                    <h:panelGroup rendered="#{createPoController.currentBill.paymentMethod eq 'Credit'}" id="duration" >
                                        <div class="d-flex" >
                                            <div class="ui-inputgroup mx-1 my-1">
                                                <p:inputText
                                                    onfocus="this.select();"
                                                    value="#{createPoController.currentBill.creditDuration}"
                                                    style="width: 10em;">
                                                </p:inputText>
                                                <div class="ui-inputgroup-addon">Days</div>
                                            </div>
                                        </div>
                                    </h:panelGroup>

                                    <p:spacer
                                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Consignment in Pharmacy Purchasing', true)}"
                                        class="my-4"></p:spacer>
                                    <h:panelGroup
                                        class="my-4"
                                        rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Consignment in Pharmacy Purchasing', true)}">
                                        <p:selectBooleanCheckbox value="#{createPoController.currentBill.consignment}" itemLabel="Consignment"/>
                                    </h:panelGroup>

                                    <p:outputLabel
                                        value="Comments"
                                        class="form-label w-100">
                                    </p:outputLabel>
                                    <p:inputTextarea
                                        value="#{createPoController.currentBill.comments}"
                                        class="form-control w-100" ></p:inputTextarea>
                                    <p:outputLabel
                                        value="Total Value"
                                        class="form-label w-100"></p:outputLabel>
                                    <p:outputLabel
                                        class="m-1 w-100"
                                        id="tot"
                                        style="font-weight: bold;"
                                        value="#{createPoController.currentBill.netTotal}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </p:outputLabel>
                                    <p:commandButton
                                        id="btnSave"
                                        ajax="false"
                                        value="Save"
                                        action="#{createPoController.saveRequest}"
                                        icon="pi pi-save"
                                        class="ui-button-success m-1"
                                        disabled="#{createPoController.currentBill.checked}"/>
                                    <p:commandButton
                                        id="btnFinalize"
                                        ajax="false"
                                        value="Finalize"
                                        action="#{createPoController.finalizeRequest()}"
                                        icon="pi pi-check"
                                        class="ui-button-warning m-1"
                                        onclick="return confirm('Are you sure you want to finalize this purchase order? This action cannot be undone.');"
                                        disabled="#{createPoController.currentBill.checked}"/>
                                    <p:commandButton
                                        ajax="false"
                                        value="New Order"
                                        action="#{createPoController.resetBillValues}"
                                        icon="pi pi-plus"
                                        class="ui-button-danger m-1"/>

                                    <h:panelGroup>

                                    </h:panelGroup>
                                </p:panel>
                                <p:panel header="Add Items" >
                                    <p:outputLabel
                                        class="form-label w-100"
                                        value="Add supplier Items" ></p:outputLabel>
                                    <p:commandButton
                                        class="m-1 ui-button-success"
                                        ajax="false"
                                        value="Add All"
                                        action="#{createPoController.addAllSupplierItems}"/>
                                    <p:commandButton
                                        class="m-1 ui-button-success "
                                        ajax="false"
                                        value="Add Items Below ROL"
                                        action="#{createPoController.addAllSupplierItemsBelowRol()}"/>

                                    <hr/>
                                    <p:outputLabel
                                        for="exDItem"
                                        class="form-label w-100"
                                        value="Select and Add a supplier Item" ></p:outputLabel>
                                    <p:selectOneMenu
                                        id="exDItem"
                                        value="#{createPoController.selectedDealerItem}"
                                        class="w-75"
                                        filterMatchMode="contains"
                                        filter="true"
                                        height="500"
                                        var="vt" >
                                        <p:column headerText="Item"  style="width: 350px; padding: 6px;">
                                            <h:outputLabel value="#{vt.itemName}"></h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Code"  style="padding: 6px;">
                                            <h:outputLabel value="#{vt.itemCode}"></h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Department Stock"  style="padding: 6px; text-align: right;">
                                            <p:outputLabel value="#{vt.stockInUnits}">
                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                            </p:outputLabel>
                                        </p:column>
                                        <f:selectItems value="#{createPoController.dealerItemDtos}" var="di" itemLabel="#{di.itemName}" itemValue="#{di}" ></f:selectItems>
                                    </p:selectOneMenu>
                                    <p:commandButton
                                        class="m-1 ui-button-success"
                                        value="Add"
                                        action="#{createPoController.addDealerItem}"
                                        process="exDItem @this"
                                        update="exDItem :#{p:resolveFirstComponentWithId('itemList',view).clientId} tot" />
                                    <hr/>
                                    <p:outputLabel
                                        for="exItem"
                                        class="form-label w-100"
                                        value="Select Any Item and Add" ></p:outputLabel>
                                    <p:autoComplete
                                        id="exItem"
                                        value="#{createPoController.currentBillItem.item}"
                                        forceSelection="true"
                                        class="w-75"
                                        maxResults="50"
                                        scrollHeight="600"
                                        minQueryLength="#{configOptionApplicationController.getShortTextValueByKey('Minimum Number of Characters to Search for Item','4')}"
                                        inputStyleClass="w-100"
                                        completeMethod="#{itemController.completeAmpAndAmppItemForLoggedDepartment}" var="vt" itemLabel="#{vt.name}" itemValue="#{vt}" >
                                        <p:column headerText="ID" rendered="#{webUserController.hasPrivilege('Developers')}" >
                                            <h:outputLabel value="#{vt.id}"></h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Item" style="width: 350px; padding: 6px;">
                                            <h:outputLabel value="#{vt.name}"></h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Code" style="padding: 6px;">
                                            <h:outputLabel value="#{vt.code}"></h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Department Stock" style="padding: 6px; text-align: right;">
                                            <p:outputLabel value="#{stockController.departmentItemStock(sessionController.department , vt)}">
                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                            </p:outputLabel>
                                        </p:column>
                                    </p:autoComplete>
                                    <p:commandButton
                                        class="mx-1 ui-button-success"
                                        value="Add"
                                        action="#{createPoController.addItem}"
                                        process="exItem @this"
                                        update="exItem :#{p:resolveFirstComponentWithId('itemList',view).clientId} tot pageMessages" />

                                </p:panel>
                            </div>
                        </div>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{createPoController.currentBill.checked}" class="w-100 p-3">
                        <div class="alert alert-warning" role="alert">
                            <h:outputText value="This purchase order request has been finalized and cannot be modified." />
                        </div>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{createPoController.currentBill.checked}" class="w-100 p-3">
                        <div class="d-flex justify-content-center gap-2">
                            <p:commandButton
                                ajax="false"
                                value="View Print Preview"
                                action="#{createPoController.setPrintPreview(true)}"
                                icon="pi pi-eye"
                                class="ui-button-info"/>
                            <p:commandButton
                                ajax="false"
                                value="New Order"
                                action="#{createPoController.resetBillValues}"
                                icon="pi pi-plus"
                                class="ui-button-success"/>
                        </div>
                    </h:panelGroup>

                </h:panelGroup>


                <p:panel
                    rendered="#{createPoController.printPreview}"
                    styleClass="print-preview"
                    class="w-100">
                    <f:facet name="header">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h:outputLabel value="Purchase Order Request" class="mt-2"/>
                            </div>
                            <div class="d-flex gap-2">
                                <p:commandButton
                                    rendered="#{webUserController.hasPrivilege('ChangeReceiptPrintingPaperTypes')}"
                                    value="Settings"
                                    icon="fas fa-cog"
                                    class="ui-button-secondary"
                                    type="button"
                                    onclick="PF('purchaseOrderConfigDialog').show();" >
                                </p:commandButton>
                                <p:commandButton
                                    ajax="false"
                                    value="Print"
                                    icon="fas fa-print"
                                    class="ui-button-info">
                                    <p:printer target=":form:printPaper" />
                                </p:commandButton>
                                <p:commandButton
                                    ajax="false"
                                    value="New Order"
                                    action="#{createPoController.resetBillValues}"
                                    icon="fas fa-plus"
                                    styleClass="ui-button-success"/>
                            </div>
                        </div>
                    </f:facet>

                    <div class="d-flex justify-content-center">


                        <h:panelGroup style="width: 212mm; height: 275mm;" id="printPaper" layout="block">

                            <po:purchase_order_request_custom_1
                                rendered="#{configOptionController.getBooleanValueByKey('Pharmacy Purchase Order Request Print - A4 Paper Custom 1', true)}"
                                bill="#{createPoController.currentBill}"
                                billItems="#{createPoController.billItems}">
                            </po:purchase_order_request_custom_1>

                            <po:purchase_order_request_custom_2
                                rendered="#{configOptionController.getBooleanValueByKey('Pharmacy Purchase Order Request Print - A4 Paper Custom 2', false)}"
                                bill="#{createPoController.currentBill}"
                                billItems="#{createPoController.billItems}">
                            </po:purchase_order_request_custom_2>

                        </h:panelGroup>

                    </div>
                </p:panel>

            </h:panelGroup>

        </h:form>


        <p:dialog widgetVar="stockDetailsDialog" modal="true" header="Stock Details" width="50%" height="auto">
            <h:form id="stockDetailsForm">

                <p:dataTable id="stockList" value="#{stockController.selectedItemStocks}" var="s" scrollable="true" scrollHeight="250px;">

                    <f:facet name="header">
                        <h:outputText id="stockItemName" value="Item: #{stockController.selectedItem.name}" />
                    </f:facet>

                    <p:column headerText="Expiry Date">
                        <h:outputText value="#{s.itemBatch.dateOfExpire}">
                            <f:convertDateTime pattern="dd MMMM yyyy" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Department">
                        <h:outputText value="#{s.department.name}" />
                    </p:column>

                    <p:column headerText="Stock">
                        <h:outputText value="#{s.stock}">
                            <f:convertNumber pattern="#.#" />
                        </h:outputText>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="Total Stock Quantity: " />
                        <h:outputText id="stockQty" value="#{stockController.totalStockQty}">
                            <f:convertNumber pattern="#.#" />
                        </h:outputText>
                    </f:facet>

                </p:dataTable>
            </h:form>
        </p:dialog>



        <p:dialog widgetVar="expStockDetailsDialog" modal="true" header="Expiring Stock Details" width="50%" height="auto">
            <h:form id="expStockDetailsForm">

                <p:dataTable id="expStockList" value="#{stockController.selectedItemExpiaringStocks}" var="s">

                    <f:facet name="header">
                        <h:outputText id="expItemName" value="#{stockController.selectedItem.name}" />
                    </f:facet>

                    <p:column headerText="Expiry Date">
                        <h:outputText value="#{s.itemBatch.dateOfExpire}">
                            <f:convertDateTime pattern="dd MMMM yyyy" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Department">
                        <h:outputText value="#{s.department.name}">
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Stock">
                        <h:outputText value="#{s.stock}" >
                            <f:convertNumber pattern="#.#" ></f:convertNumber>
                        </h:outputText>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="Total Expiaring Quentity by " />
                        <h:outputText value="#{stockController.shortExpiaryDate}" >
                            <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}" ></f:convertDateTime>
                        </h:outputText>
                        <h:outputText value=" : " />
                        <h:outputText id="expQty" value="#{stockController.expiaringStockQty}" >
                            <f:convertNumber pattern="#.#" ></f:convertNumber>
                        </h:outputText>
                    </f:facet>

                </p:dataTable>

            </h:form>
        </p:dialog>

        <!-- Purchase Order Configuration Dialog -->
        <p:dialog id="purchaseOrderConfigDialog"
                  header="Purchase Order Request Printer Configuration"
                  widgetVar="purchaseOrderConfigDialog"
                  modal="true"
                  width="800"
                  height="500"
                  resizable="true"
                  maximizable="true"
                  closeOnEscape="true">

            <p:ajax event="open" listener="#{purchaseOrderConfigController.loadCurrentConfig}" update="purchaseOrderConfigForm" />

            <h:form id="purchaseOrderConfigForm">

                <div class="row">
                    <div class="col-md-12">
                        <div class="card config-section">
                            <div class="card-header">
                                <h6><i class="fas fa-file-alt"></i> Purchase Order Paper Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="custom1Paper"
                                        value="#{purchaseOrderConfigController.custom1Paper}" />
                                    <p:outputLabel for="custom1Paper" value="A4 Paper Custom Format 1" class="ms-2" />
                                    <small class="form-text text-muted d-block">A4 purchase order format - Custom 1</small>
                                </div>

                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="custom2Paper"
                                        value="#{purchaseOrderConfigController.custom2Paper}" />
                                    <p:outputLabel for="custom2Paper" value="A4 Paper Custom Format 2" class="ms-2" />
                                    <small class="form-text text-muted d-block">A4 purchase order format - Custom 2</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <p:messages id="purchaseOrderConfigMessages" showDetail="true" closable="true" />
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-2">
                                        <p:commandButton
                                            value="Apply &amp; Close"
                                            icon="fas fa-save"
                                            class="ui-button-success"
                                            ajax="false"
                                            action="#{purchaseOrderConfigController.saveConfig}" />
                                        <p:commandButton
                                            value="Cancel"
                                            icon="fas fa-times"
                                            class="ui-button-secondary"
                                            onclick="PF('purchaseOrderConfigDialog').hide(); return false;"
                                            type="button" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
