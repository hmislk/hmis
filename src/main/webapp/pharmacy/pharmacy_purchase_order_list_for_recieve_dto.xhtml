<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition template="/resources/template/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="title"></ui:define>

    <ui:define name="content">
        <h:panelGroup rendered="#{!webUserController.hasPrivilege('GoodsRecipt')}">
            <div class="alert alert-warning text-center py-3">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                <h:outputText value="Access Restricted - You do not have the necessary permissions to access this page." styleClass="fw-medium"/>
            </div>
        </h:panelGroup>
        <h:panelGroup id="gpPOListForReceive" rendered="#{webUserController.hasPrivilege('GoodsRecipt')}">
            <h:form>
                <p:panel styleClass="shadow-sm border-0">
                    <f:facet name="header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-truck-loading text-primary me-2"></i>
                                <h:outputText value="Approved POs to Create GRN (Optimized)" styleClass="text-primary fw-bold"/>
                            </div>
                            <div class="badge bg-success fs-6 px-3 py-2">
                                <i class="fas fa-rocket me-1"></i>
                                Fast Loading - DTO Optimized
                            </div>
                        </div>
                    </f:facet>

                    <div class="row g-3">
                        <div class="col-lg-3 col-md-4">
                            <p:panel styleClass="h-100 shadow-sm border-0">
                                <f:facet name="header">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-filter text-info me-2"></i>
                                        <span class="fw-bold">Search Filters</span>
                                    </div>
                                </f:facet>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-calendar-alt me-1"></i>From Date
                                    </label>
                                    <p:calendar
                                        id="fromDate"
                                        class="w-100"
                                        inputStyleClass="form-control"
                                        value="#{searchController.fromDate}"
                                        navigator="false"
                                        pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                        placeholder="Select start date">
                                    </p:calendar>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-calendar-alt me-1"></i>To Date
                                    </label>
                                    <p:calendar
                                        id="toDate"
                                        class="w-100"
                                        inputStyleClass="form-control"
                                        value="#{searchController.toDate}"
                                        navigator="false"
                                        pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                        placeholder="Select end date">
                                    </p:calendar>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-hashtag me-1"></i>PO Number
                                    </label>
                                    <p:inputText
                                        autocomplete="off"
                                        class="form-control"
                                        value="#{searchController.searchKeyword.billNo}"
                                        placeholder="Enter PO number" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-building me-1"></i>Distributor
                                    </label>
                                    <p:inputText
                                        autocomplete="off"
                                        class="form-control"
                                        value="#{searchController.searchKeyword.toInstitution}"
                                        placeholder="Enter distributor name" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-coins me-1"></i>PO Value
                                    </label>
                                    <p:inputText
                                        autocomplete="off"
                                        class="form-control"
                                        value="#{searchController.searchKeyword.netTotal}"
                                        placeholder="Enter PO value" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-pills me-1"></i>Item Name
                                    </label>
                                    <p:inputText
                                        autocomplete="off"
                                        class="form-control"
                                        value="#{searchController.searchKeyword.itemName}"
                                        placeholder="Enter item name" />
                                </div>
                                <p:commandButton
                                    class="ui-button-success w-100"
                                    icon="fas fa-search"
                                    id="btnSearch"
                                    ajax="false"
                                    value="Search Purchase Orders"
                                    action="#{searchController.createPoTablePharmacyDto}"
                                    style="min-height: 45px;"/>
                            </p:panel>
                        </div>
                        <div class="col-lg-9 col-md-8">
                            <p:panel styleClass="shadow-sm border-0">
                                <f:facet name="header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-list text-success me-2"></i>
                                            <span class="fw-bold">Approved Purchase Orders Ready for GRN</span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Click actions to create GRN or receive goods
                                        </small>
                                    </div>
                                </f:facet>
                                <p:dataTable
                                    id="tbl"
                                    value="#{searchController.pharmacyPurchaseOrderDtos}"
                                    var="p"
                                    rows="15"
                                    paginator="true"
                                    paginatorPosition="bottom"
                                    paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                    rowsPerPageTemplate="5,10,15,25"
                                    styleClass="table-striped va-top"
                                    emptyMessage="No purchase orders found matching your search criteria"
                                    sortMode="multiple"
                                    resizableColumns="true"
                                    reflow="true"
                                    stripedRows="true"
                                    size="small">
                                    <p:column headerText="Request Details" sortBy="#{p.createdAt}" styleClass="text-nowrap" width="200">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-medium">
                                                    <h:outputLabel value="#{p.createdAt}">
                                                        <f:convertDateTime timeZone="Asia/Colombo" pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                                                    </h:outputLabel>
                                                </span>
                                            </div>
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-medium">#{p.creatorName}</span>
                                            </div>
                                            <h:panelGroup rendered="#{p.cancelled}">
                                                <div class="alert alert-danger py-1 px-2 mb-0 small border-0">
                                                    <strong>Cancelled</strong>
                                                </div>
                                            </h:panelGroup>
                                            <p:commandButton
                                                ajax="false"
                                                value="View PO"
                                                title="View and Print Purchase Order"
                                                class="ui-button-info"
                                                icon="fas fa-eye"
                                                action="#{billSearch.navigateToViewBillByAtomicBillTypeByBillId(p.billId)}"
                                                style="min-width: 120px;" />
                                        </div>
                                    </p:column>

                                    <p:column headerText="Supplier Details" sortBy="#{p.supplierName}" width="200">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-medium">#{p.supplierName}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge #{p.consignment ? 'bg-info' : 'bg-light text-dark'}">#{p.consignment ? 'Consignment' : 'Purchase'}</span>
                                            </div>
                                        </div>
                                    </p:column>

                                    <p:column headerText="Department &amp; PO Number" sortBy="#{p.departmentName}" width="180">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-medium">#{p.departmentName}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span>#{p.deptId}</span>
                                            </div>
                                        </div>
                                    </p:column>
                                    <p:column headerText="Order Value" sortBy="#{p.netTotal}" styleClass="text-end" width="140">
                                        <h:outputLabel value="#{p.netTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputLabel>
                                    </p:column>

                                    <p:column headerText="Actions" styleClass="text-center" exportable="false" width="160">
                                        <div class="d-flex flex-column align-items-center gap-2">
                                            <p:commandButton
                                                ajax="false"
                                                value="Receive"
                                                title="Goods Receive when Costing is not managed."
                                                class="ui-button-warning w-100"
                                                icon="fas fa-truck-loading"
                                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Manage Costing', true)}"
                                                action="#{grnController.navigateToResive()}"
                                                disabled="#{p.cancelled or p.billClosed or p.fullyIssued}">
                                                <f:param name="billId" value="#{p.billId}"/>
                                            </p:commandButton>

                                            <p:commandButton
                                                id="btnCreteGrnWithCosting"
                                                ajax="false"
                                                value="Create GRN"
                                                class="ui-button-success w-100"
                                                icon="fas fa-plus-circle"
                                                title="Create a GRN for Selected Approved PO with costing"
                                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Manage Costing', true)}"
                                                action="#{grnCostingController.navigateToResiveCostingWithSaveApprove()}"
                                                disabled="#{p.cancelled or p.billClosed or p.fullyIssued}">
                                                <f:param name="billId" value="#{p.billId}"/>
                                            </p:commandButton>

                                            <p:commandButton
                                                ajax="false"
                                                class="ui-button-info  w-100"
                                                icon="fas fa-store"
                                                value="Wholesale GRN"
                                                title="Create Wholesale GRN"
                                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Manage Pharmacy Wholesales', true)}"
                                                action="#{grnController.navigateToReceiveWholesale()}"
                                                disabled="#{p.cancelled or p.billClosed or p.fullyIssued}"
                                                style="min-width: 120px;">
                                                <f:param name="billId" value="#{p.billId}"/>
                                            </p:commandButton>

                                            <p:commandButton
                                                id="btnPoClose"
                                                ajax="false"
                                                class="ui-button-warning w-100"
                                                icon="fas fa-lock"
                                                value="PO Close"
                                                title="Close Purchase Order"
                                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Allow Pharmacy Purchase Order Closing', true) and !p.billClosed}"
                                                action="#{grnController.closeSelectedPurchaseOrder()}"
                                                disabled="#{p.cancelled}"
                                                style="min-width: 120px;">
                                                <f:param name="billId" value="#{p.billId}"/>
                                            </p:commandButton>

                                            <p:commandButton
                                                ajax="false"
                                                id="btnPoOpen"
                                                class="ui-button-success ui-button-outlined w-100"
                                                icon="fas fa-unlock"
                                                value="PO Re-Open"
                                                title="Re-open Purchase Order"
                                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Allow Pharmacy Purchase Order Closing', true) and p.billClosed}"
                                                action="#{grnController.openSelectedPurchaseOrder()}"
                                                disabled="#{p.cancelled}"
                                                style="min-width: 120px;">
                                                <f:param name="billId" value="#{p.billId}"/>
                                            </p:commandButton>
                                        </div>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </div>
                    </div>
                </p:panel>

            </h:form>
        </h:panelGroup>
    </ui:define>
</ui:composition>
