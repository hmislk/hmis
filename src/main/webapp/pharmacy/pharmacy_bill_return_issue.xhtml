<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:ph="http://xmlns.jcp.org/jsf/composite/pharmacy">

    <h:head>
        <title>Pharmacy Bill Return - Issue</title>
    </h:head>
    <h:body>
        <ui:composition template="/resources/template/template.xhtml">

            <ui:define name="content">
                <h:form>


                    <h:panelGroup rendered="#{!issueReturnController.printPreview}">
                        <!-- Page Header -->
                        <p:panel styleClass="mb-3">
                            <f:facet name="header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-undo text-warning me-2"></i>
                                        <h:outputText value="Pharmacy Issue Return" styleClass="fw-bold"/>

                                        <!-- Config Button (Admin Only) -->
                                        <h:panelGroup rendered="#{webUserController.hasPrivilege('Admin')}">
                                            <p:commandButton
                                                value="Config"
                                                icon="fa fa-cog"
                                                title="Page Configuration Management"
                                                action="#{pageAdminController.navigateToPageAdmin('pharmacy/pharmacy_bill_return_issue')}"
                                                ajax="false"
                                                styleClass="ui-button-secondary mx-1">
                                            </p:commandButton>
                                        </h:panelGroup>


                                    </div>

                                    <!-- Center - Navigation Buttons -->
                                    <div class="d-flex align-items-center gap-2">
                                        <p:commandButton
                                            value="List Issues To Create Return"
                                            action="/pharmacy/pharmacy_search_issue_bill_for_return?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-plus-circle"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('CreateDisposalReturn')}"
                                            title="Create a new Disposal Return Request">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="List Returns to Finalize"
                                            action="/pharmacy/pharmacy_disposal_return_finalize?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-tasks"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('FinalizeDisposalReturn')}"
                                            title="Finalize Disposal Return Requests">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="List Returns To Approve"
                                            action="/pharmacy/pharmacy_disposal_return_approve?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-check-circle"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('ApproveDisposalReturn')}"
                                            title="Approve Disposal Return Requests">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="Completed Returns"
                                            action="/pharmacy/pharmacy_disposal_return_completed?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-check-double"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('ViewDisposalReturn')}"
                                            title="View Completed Disposal Returns">
                                        </p:commandButton>
                                    </div>

                                    <!-- Right - Action Buttons -->
                                    <div class="d-flex align-items-center gap-2">
                                        <p:commandButton
                                            icon="fas fa-save"
                                            styleClass="ui-button-secondary"
                                            value="Save"
                                            title="Save return bill as draft"
                                            action="#{issueReturnController.saveDisposalIssueReturnBill()}"
                                            rendered="#{issueReturnController.returnBill.checkedBy eq null and not issueReturnController.originalBill.fullReturned}"
                                            ajax="false">
                                        </p:commandButton>
                                        <p:commandButton
                                            icon="fas fa-check-circle"
                                            styleClass="ui-button-success"
                                            value="Finalize"
                                            onclick="return confirm('Are you sure you want to finalize this disposal issue? This action cannot be undone.');"
                                            title="Finalize return bill"
                                            action="#{issueReturnController.finalizeDisposalIssueReturnBill()}"
                                            rendered="#{issueReturnController.returnBill.checkedBy eq null and not issueReturnController.originalBill.fullReturned}"
                                            ajax="false">
                                        </p:commandButton>
                                        <p:commandButton
                                            icon="fas fa-money-bill"
                                            styleClass="ui-button-warning"
                                            value="Approve Return"
                                            onclick="return confirm('Are you sure you want to approve this disposal issue? This action cannot be undone.');"
                                            title="Approve and process the return"
                                            action="#{issueReturnController.settleDisposalIssueReturnBill}"
                                            rendered="#{issueReturnController.returnBill.checkedBy ne null and (issueReturnController.returnBill.completed eq false or issueReturnController.returnBill.completed eq null) and webUserController.hasPrivilege('ApproveDisposalReturn') and not issueReturnController.originalBill.fullReturned}"
                                            ajax="false">
                                        </p:commandButton>
                                    </div>
                                </div>
                            </f:facet>
                        </p:panel>

                        <!-- Messages Panel -->
                        <p:messages id="messages" showDetail="true" closable="true" globalOnly="false" />

                        <!-- Warning for Fully Returned Bills -->
                        <p:panel rendered="#{issueReturnController.originalBill.fullReturned}" styleClass="mb-3">
                            <div class="alert alert-danger d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <div>
                                    <h:outputText value="This disposal issue bill has been fully returned on " styleClass="fw-bold"/>
                                    <h:outputText value="#{issueReturnController.originalBill.fullReturnedAt}">
                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateTimeFormat}"/>
                                    </h:outputText>
                                    <h:outputText value=" by #{issueReturnController.originalBill.fullReturnedBy.webUserPerson.nameWithTitle}. No further returns are allowed." styleClass="fw-bold"/>
                                </div>
                            </div>
                        </p:panel>

                        <!-- Main Content Row: Returning Items and Return Summary -->
                        <div class="row mb-3">
                            <!-- Returning Items - 8 Columns -->
                            <div class="col-lg-8">
                                <p:panel header="Returning Items" styleClass="shadow-sm h-100">
                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-list text-primary me-2"></i>
                                                <h:outputText value="Returning Items" styleClass="fw-bold"/>
                                            </div>
                                            <div>
                                                <p:commandButton
                                                    icon="fas fa-trash"
                                                    value="Delete Selected"
                                                    styleClass="ui-button-danger"
                                                    title="Delete selected items from return"
                                                    action="#{issueReturnController.deleteSelectedItems()}"
                                                    disabled="#{issueReturnController.originalBill.fullReturned}"
                                                    ajax="false">
                                                    <p:confirm header="Confirmation"
                                                               message="Are you sure you want to delete the selected items?"
                                                               icon="pi pi-exclamation-triangle"/>
                                                </p:commandButton>
                                            </div>
                                        </div>
                                    </f:facet>

                                    <p:dataTable
                                        var="rbi"
                                        value="#{issueReturnController.returnBillItems}"
                                        styleClass="table-striped"
                                        scrollable="true"
                                        rows="15"
                                        id="itemList"
                                        selectionMode="multiple"
                                        selection="#{issueReturnController.selectedBillItems}"
                                        rowKey="#{rbi.id}"
                                        paginator="true"
                                        paginatorPosition="bottom"
                                        rowsPerPageTemplate="10,15,25,50">

                                        <p:column selectionBox="true" width="3em" styleClass="text-center" />

                                        <p:column headerText="Item Name" sortBy="#{rbi.item.name}">
                                            <h:outputText value="#{rbi.item.name}"/>
                                        </p:column>

                                        <p:column headerText="Batch No" sortBy="#{rbi.pharmaceuticalBillItem.itemBatch.batchNo}">
                                            <h:outputText value="#{rbi.pharmaceuticalBillItem.itemBatch.batchNo}"/>   
                                        </p:column>

                                        <p:column headerText="Expiry Date" sortBy="#{rbi.pharmaceuticalBillItem.itemBatch.dateOfExpire}">
                                            <h:outputText value="#{rbi.pharmaceuticalBillItem.itemBatch.dateOfExpire}">
                                                <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Current Stock" styleClass="text-center" width="6em">
                                            <h:outputText value="#{rbi.pharmaceuticalBillItem.stock.stock}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Issued Qty" styleClass="text-end">
                                            <h:outputText value="#{rbi.referanceBillItem.qty}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Previously Returned Qty" styleClass="text-end">
                                            <h:outputText value="#{rbi.referanceBillItem.billItemFinanceDetails.returnQuantity}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Unit Rate" styleClass="text-end">
                                            <h:outputText value="#{rbi.netRate}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Return Qty" styleClass="text-center" width="8em">
                                            <p:inputText
                                                id="txtReturnQty"
                                                value="#{rbi.qty}"
                                                styleClass="text-end w-100"
                                                autocomplete="off"
                                                onfocus="this.select()"
                                                disabled="#{issueReturnController.originalBill.fullReturned}"
                                                title="Enter quantity to return (max: #{rbi.remainingQty})">
                                                <p:ajax
                                                    id="ajexReturnQty"
                                                    event="blur"
                                                    update="txtReturnQty lblReturnValue :#{p:resolveFirstComponentWithId('total',view).clientId} :#{p:resolveFirstComponentWithId('messages',view).clientId}"
                                                    listener="#{issueReturnController.calculateBillItemTotals(rbi)}"/>
                                            </p:inputText>
                                        </p:column>

                                        <p:column headerText="Return Value" styleClass="text-end">
                                            <h:outputText id="lblReturnValue" value="#{rbi.netValue}" styleClass="fw-bold">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Action" styleClass="text-center" width="6em" exportable="false">
                                            <p:commandButton
                                                icon="fas fa-trash"
                                                styleClass="ui-button-danger"
                                                title="Delete this item"
                                                action="#{issueReturnController.deleteItem(rbi)}"
                                                disabled="#{issueReturnController.originalBill.fullReturned}"
                                                update="itemList :#{p:resolveFirstComponentWithId('total',view).clientId}"
                                                process="@this">
                                                <p:confirm header="Confirmation"
                                                           message="Are you sure you want to delete this item?"
                                                           icon="pi pi-exclamation-triangle"/>
                                            </p:commandButton>
                                        </p:column>

                                    </p:dataTable>
                                </p:panel>
                            </div>

                            <!-- Return Summary - 4 Columns -->
                            <div class="col-lg-4">
                                <p:panel header="Return Summary" styleClass="shadow-sm h-100">
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <h:outputText value="Return Comment:" styleClass="fw-bold d-block mb-2"/>
                                            <p:inputTextarea
                                                id="comments"
                                                class="w-100"
                                                value="#{issueReturnController.returnBill.comments}"
                                                rows="3">
                                            </p:inputTextarea>
                                        </div>
                                        <div class="mt-auto">
                                            <h:outputText value="Receivable Amount:" styleClass="fw-bold d-block mb-2"/>
                                            <h:outputText
                                                id="total"
                                                value="#{issueReturnController.returnBill.netTotal}"
                                                styleClass="text-success fw-bold fs-4">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </div>
                                    </div>
                                </p:panel>
                            </div>
                        </div>

                        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
                            <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" />
                        </p:confirmDialog>

                    </h:panelGroup>

                    <!-- Print Preview Section -->
                    <h:panelGroup rendered="#{issueReturnController.printPreview}">
                        <p:panel styleClass="shadow-sm mb-3">
                            <f:facet name="header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h:outputText value="Disposal Issue Return - Print Preview" styleClass="fw-bold"/>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <p:commandButton
                                            value="List Issues To Create Return"
                                            action="/pharmacy/pharmacy_search_issue_bill_for_return?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-plus-circle"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('CreateDisposalReturn')}"
                                            title="Create a new Disposal Return Request">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="List Returns to Finalize"
                                            action="/pharmacy/pharmacy_disposal_return_finalize?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-tasks"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('FinalizeDisposalReturn')}"
                                            title="Finalize Disposal Return Requests">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="List Returns To Approve"
                                            action="/pharmacy/pharmacy_disposal_return_approve?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-check-circle"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('ApproveDisposalReturn')}"
                                            title="Approve Disposal Return Requests">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="Completed Returns"
                                            action="/pharmacy/pharmacy_disposal_return_completed?faces-redirect=true"
                                            ajax="false"
                                            icon="fas fa-check-double"
                                            styleClass="ui-button-info ui-button-outlined"
                                            rendered="#{webUserController.hasPrivilege('ViewDisposalReturn')}"
                                            title="View Completed Disposal Returns">
                                        </p:commandButton>
                                        <p:commandButton
                                            styleClass="ui-button-info"
                                            icon="fas fa-print"
                                            value="Print"
                                            title="Print the return bill"
                                            ajax="false">
                                            <p:printer target="gpBillPreview1"/>
                                        </p:commandButton>
                                        <p:commandButton
                                            rendered="#{webUserController.hasPrivilege('ChangeReceiptPrintingPaperTypes')}"
                                            value="Settings"
                                            icon="fas fa-cog"
                                            styleClass="ui-button-secondary"
                                            type="button"
                                            onclick="PF('billReturnIssueConfigDialog').show();" />
                                    </div>
                                </div>
                            </f:facet>

                            <h:panelGroup id="gpBillPreview1">
                                <ph:disposal_issue_return
                                    rendered="#{configOptionController.getBooleanValueByKey('Pharmacy Bill Return Issue Receipt is A4 Paper',true)}"
                                    bill="#{issueReturnController.returnBill}"/>
                                <ph:disposal_issue_return_custom_1
                                    rendered="#{configOptionController.getBooleanValueByKey('Pharmacy Bill Return Issue Receipt is Custom 1',false)}"
                                    bill="#{issueReturnController.returnBill}"/>
                                <ph:disposal_issue_return_custom_2
                                    rendered="#{configOptionController.getBooleanValueByKey('Pharmacy Bill Return Issue Receipt is Custom 2',false)}"
                                    bill="#{issueReturnController.returnBill}"/>
                            </h:panelGroup>
                        </p:panel>
                    </h:panelGroup>

                    <!-- Bill Return Issue Configuration Dialog -->
                    <p:dialog id="billReturnIssueConfigDialog"
                              header="Bill Return Issue Printer Configuration"
                              widgetVar="billReturnIssueConfigDialog"
                              modal="true"
                              width="600"
                              height="400"
                              resizable="true"
                              maximizable="true"
                              closeOnEscape="true">

                        <p:ajax event="open" listener="#{pharmacyConfigController.loadCurrentConfig}" update="billReturnIssueConfigForm" />

                        <h:form id="billReturnIssueConfigForm">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card config-section">
                                        <div class="card-header">
                                            <h6><i class="fas fa-file-alt"></i> Bill Return Issue Paper Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <p:selectBooleanCheckbox
                                                    id="billReturnIssueA4"
                                                    value="#{pharmacyConfigController.billReturnIssueA4Paper}" />
                                                <p:outputLabel for="billReturnIssueA4" value="A4 Paper Format" class="ms-2" />
                                                <small class="form-text text-muted d-block">Standard A4 paper format for bill return issue receipts</small>
                                            </div>
                                            <div class="mb-3">
                                                <p:selectBooleanCheckbox
                                                    id="billReturnIssueCustom1"
                                                    value="#{pharmacyConfigController.billReturnIssueCustom1}" />
                                                <p:outputLabel for="billReturnIssueCustom1" value="Custom Format 1" class="ms-2" />
                                                <small class="form-text text-muted d-block">Custom format 1 for bill return issue receipts</small>
                                            </div>
                                            <div class="mb-3">
                                                <p:selectBooleanCheckbox
                                                    id="billReturnIssueCustom2"
                                                    value="#{pharmacyConfigController.billReturnIssueCustom2}" />
                                                <p:outputLabel for="billReturnIssueCustom2" value="Custom Format 2" class="ms-2" />
                                                <small class="form-text text-muted d-block">Custom format 2 for bill return issue receipts</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <p:messages id="billReturnIssueConfigMessages" showDetail="true" closable="true" />
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex gap-2">
                                                    <p:commandButton
                                                        value="Apply &amp; Close"
                                                        icon="fas fa-save"
                                                        class="ui-button-success"
                                                        ajax="false"
                                                        action="#{pharmacyConfigController.saveBillReturnIssueConfig}" />
                                                    <p:commandButton
                                                        value="Cancel"
                                                        icon="fas fa-times"
                                                        styleClass="ui-button-secondary"
                                                        onclick="PF('billReturnIssueConfigDialog').hide(); return false;"
                                                        type="button" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </h:form>
                    </p:dialog>

                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
