<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:body>
        <ui:composition template="/resources/template/template.xhtml">
            <ui:define name="content">
        <h:panelGroup rendered="#{!webUserController.hasPrivilege('PurchaseOrdersApprovel')}">
            You are NOT authorized
        </h:panelGroup>
        <h:panelGroup id="gpOrderApprove" rendered="#{webUserController.hasPrivilege('PurchaseOrdersApprovel')}">
            <h:form>
                <p:panel styleClass="border-0">
                    <f:facet name="header">
                        <i class="fas fa-rocket text-success me-2"></i>
                        <h:outputLabel
                            class="mb-0 text-success"
                            value="Approve Purchase Orders (DTO - Fast)" ></h:outputLabel>
                    </f:facet>
                    <div class="row">
                        <div class="col-lg-3 col-md-4">
                            <p:panel header="Search Filters" styleClass="h-100">
                                <div class="mb-3">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    <p:outputLabel value="From Date" class="form-label fw-bold text-secondary" for="fromDate"></p:outputLabel>
                                    <p:calendar 
                                        class="w-100" 
                                        inputStyleClass="form-control" 
                                        id="fromDate" 
                                        value="#{searchController.fromDate}" 
                                        navigator="false" 
                                        pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                        placeholder="Select start date">      
                                    </p:calendar>
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    <p:outputLabel value="To Date" class="form-label fw-bold text-secondary" for="toDate"></p:outputLabel>
                                    <p:calendar 
                                        class="w-100" 
                                        inputStyleClass="form-control" 
                                        id="toDate" 
                                        value="#{searchController.toDate}" 
                                        navigator="false" 
                                        pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                        placeholder="Select end date">                                                                              
                                    </p:calendar>
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-building me-1"></i>
                                    <p:outputLabel value="Supplier" class="form-label fw-bold text-secondary" for="supplierInput"></p:outputLabel>
                                    <p:inputText 
                                        class="form-control" 
                                        autocomplete="off" 
                                        id="supplierInput"
                                        value="#{searchController.searchKeyword.toInstitution}" 
                                        placeholder="Enter supplier name" />
                                </div>
                                <!-- Search Buttons positioned for better visibility -->
                                <div class="mb-4">
                                    <p:commandButton 
                                        class="ui-button-info w-100 mb-2" 
                                        icon="fas fa-search" 
                                        value="Search All Requests (DTO)" 
                                        action="#{searchController.createPoRequestedAndApprovedPharmacyDto()}" 
                                        ajax="false"
                                        style="min-height: 40px;"
                                        title="High-performance DTO-based search">
                                    </p:commandButton>
                                    <p:commandButton 
                                        class="ui-button-success w-100 mb-2" 
                                        icon="fas fa-check" 
                                        value="Search Approved Requests (DTO)" 
                                        action="#{searchController.createApprovedPharmacyDto()}" 
                                        ajax="false"
                                        style="min-height: 40px;"
                                        title="High-performance DTO-based approved search">
                                    </p:commandButton>
                                    <p:commandButton 
                                        class="ui-button-warning w-100" 
                                        icon="fas fa-clock" 
                                        value="Search To Approve Requests (DTO)" 
                                        action="#{searchController.fillOnlyFinalizedPharmacyPoDto()}" 
                                        ajax="false"
                                        style="min-height: 40px;"
                                        title="High-performance DTO-based finalized search">
                                    </p:commandButton>
                                </div>

                                <!-- Collapsible Advanced Filters -->
                                <p:panel header="Advanced Filters" toggleable="true" collapsed="true" styleClass="mb-3">
                                    <div class="mb-3">
                                        <i class="fas fa-user me-1"></i>
                                        <p:outputLabel value="Requested User" class="form-label fw-bold text-secondary" for="requestedUser"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="requestedUser"
                                            value="#{searchController.searchKeyword.creator}" 
                                            placeholder="Enter user name" />
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-hospital me-1"></i>
                                        <p:outputLabel value="Department" class="form-label fw-bold text-secondary" for="department"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="department"
                                            value="#{searchController.searchKeyword.department}" 
                                            placeholder="Enter department" />
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-hashtag me-1"></i>
                                        <p:outputLabel value="PO Number" class="form-label fw-bold text-secondary" for="poNumber"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="poNumber"
                                            value="#{searchController.searchKeyword.refBillNo}" 
                                            placeholder="Enter PO number" />
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-coins me-1"></i>
                                        <p:outputLabel value="Requested Value" class="form-label fw-bold text-secondary" for="requestedValue"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="requestedValue"
                                            value="#{searchController.searchKeyword.total}" 
                                            placeholder="Enter amount" />
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-coins me-1"></i>
                                        <p:outputLabel value="Approved Value" class="form-label fw-bold text-secondary" for="approvedValue"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="approvedValue"
                                            value="#{searchController.searchKeyword.netTotal}" 
                                            placeholder="Enter approved amount" />
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-list-ol me-1"></i>
                                        <p:outputLabel value="Max Results" class="form-label fw-bold text-secondary" for="maxResults"></p:outputLabel>
                                        <p:inputText 
                                            class="form-control" 
                                            autocomplete="off" 
                                            id="maxResults"
                                            value="#{searchController.maxResult}" 
                                            placeholder="Max number of results" />
                                    </div>
                                </p:panel>
                            </p:panel>
                        </div>
                        <div class="col-lg-9 col-md-8">

                            <p:dataTable 
                                id="tbl" 
                                value="#{searchController.pharmacyPurchaseOrderDtos}" 
                                var="dto"
                                rows="15"
                                paginator="true"
                                paginatorPosition="bottom"
                                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                rowsPerPageTemplate="5,10,15,25"
                                styleClass="table-striped"
                                emptyMessage="No purchase orders found matching your criteria"
                                sortMode="multiple"
                                resizableColumns="true"
                                reflow="true">
                                <p:column headerText="Request Details">
                                    <div class="d-flex flex-column gap-1">
                                        <div>
                                            <h:outputText value="#{dto.creatorName}" class="fw-bold"/>
                                        </div>
                                        <div>
                                            <small class="text-muted">
                                                <h:outputText value="#{dto.createdAt}">
                                                    <f:convertDateTime timeZone="Asia/Colombo" pattern="dd/MM/yyyy HH:mm" />
                                                </h:outputText>
                                            </small>
                                        </div>
                                        <h:panelGroup rendered="#{dto.cancelled}">
                                            <div class="text-danger">
                                                <small>Cancelled</small>
                                            </div>
                                        </h:panelGroup>
                                    </div>
                                </p:column>

                                <p:column headerText="Supplier">
                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                        <h:outputText value="#{dto.supplierName}" />
                                        <h:panelGroup rendered="#{dto.consignment and configOptionApplicationController.getBooleanValueByKey('Enable Consignment in Pharmacy Purchasing', true)}">
                                            <p:badge value="Consignment" severity="info"/>
                                        </h:panelGroup>
                                    </div>
                                </p:column>

                                <p:column headerText="Requested Department">
                                    <h:outputText value="#{dto.departmentName}" />
                                </p:column>

                                <p:column headerText="Requested Value" sortBy="#{dto.netTotal}" styleClass="text-end">
                                    <div class="d-flex flex-column align-items-end gap-1">
                                        <h:outputText value="#{dto.netTotal}" class="fw-bold">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                        <small class="text-muted">#{dto.paymentMethod}</small>
                                    </div>
                                </p:column>

                                <p:column headerText="Approval Details">
                                    <div class="d-flex flex-column gap-1">
                                        <h:panelGroup rendered="#{dto.approverName ne null}">
                                            <div>
                                                <h:outputText value="#{dto.approverName}" class="fw-bold"/>
                                            </div>
                                            <div>
                                                <small class="text-muted">
                                                    <h:outputText value="#{dto.referenceBillCreatedAt}">
                                                        <f:convertDateTime timeZone="Asia/Colombo" pattern="dd/MM/yyyy HH:mm" />
                                                    </h:outputText>
                                                </small>
                                            </div>
                                        </h:panelGroup>
                                        <h:panelGroup rendered="#{dto.approverName eq null}">
                                            <small class="text-muted">Not approved yet</small>
                                        </h:panelGroup>
                                    </div>
                                </p:column> 

                                <p:column headerText="PO Number" >
                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                        <h:outputText value="#{dto.referenceBillDeptId}" rendered="#{dto.referenceBillCancelled eq false and dto.referenceBillId ne null}"/>
                                        <h:outputText value="-" rendered="#{dto.referenceBillId eq null}"/>
                                        
                                        <!-- Status badges integrated in PO Number column -->
                                        <h:panelGroup rendered="#{dto.pending}">
                                            <p:badge value="Pending" severity="warning"/>
                                        </h:panelGroup>
                                        <h:panelGroup rendered="#{dto.approved}">
                                            <p:badge value="Approved" severity="success"/>
                                        </h:panelGroup>
                                        <h:panelGroup rendered="#{dto.draft}">
                                            <p:badge value="Draft" severity="secondary"/>
                                        </h:panelGroup>
                                    </div>
                                </p:column>
                                <p:column headerText="Approved Value" sortBy="#{dto.referenceBillNetTotal}" styleClass="text-end">
                                    <div class="d-flex flex-column align-items-end gap-1">
                                        <h:panelGroup rendered="#{dto.referenceBillId ne null and dto.referenceBillNetTotal ne null}">
                                            <h:outputText value="#{dto.referenceBillNetTotal}" class="fw-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                            <small class="text-muted">#{dto.referenceBillPaymentMethod}</small>
                                        </h:panelGroup>
                                    </div>
                                </p:column>

                                <p:column 
                                    id="colActions"
                                    headerText="Actions"
                                    styleClass="text-center" 
                                    exportable="false"
                                    width="8em">
                                    <div class="d-flex justify-content-center align-items-center gap-1">
                                        <p:commandButton
                                            id="btnApprove"
                                            ajax="false"
                                            icon="pi pi-check"
                                            class="ui-button-success ui-button-sm"
                                            title="Approve Purchase Order"
                                            action="#{purchaseOrderController.navigateToPurchaseOrderApproval}"
                                            disabled="#{dto.checkedById eq null or dto.approved or dto.cancelled eq true or !webUserController.hasPrivilege('PurchaseOrdersApprovel')}">
                                            <f:setPropertyActionListener target="#{purchaseOrderController.requestedBillId}" value="#{dto.billId}"/>
                                        </p:commandButton>
                                        <p:commandButton 
                                            id="btnViewApproved"
                                            ajax="false"
                                            icon="pi pi-eye"
                                            class="ui-button-info ui-button-sm"
                                            title="View Approved Purchase Order"
                                            action="#{pharmacyBillSearch.navigateToReprintPharmacyPurchaseOrderFromDto}" 
                                            disabled="#{not dto.approved}">
                                            <f:setPropertyActionListener target="#{pharmacyBillSearch.billId}" value="#{dto.referenceBillId}"/>
                                        </p:commandButton>
                                        <p:commandButton 
                                            id="btnViewRequest"
                                            ajax="false"
                                            icon="pi pi-file"
                                            class="ui-button-secondary ui-button-sm"
                                            title="View Purchase Request"
                                            action="pharmacy_reprint_order_request?faces-redirect=true">
                                            <f:setPropertyActionListener target="#{pharmacyBillSearch.billId}" value="#{dto.billId}"/>
                                        </p:commandButton>
                                    </div>
                                </p:column>
                            </p:dataTable>

                        </div>
                    </div>
                </p:panel>            
            </h:form>
        </h:panelGroup>
            </ui:define>
        </ui:composition>
    </h:body>
</html>