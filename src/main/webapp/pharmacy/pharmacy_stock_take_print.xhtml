<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head />
    <h:body>
        <ui:composition template="/pharmacy/adjustments/pharmacy_adjustment_index.xhtml">
            <ui:define name="subcontent">
                <div class="container-fluid">
                    <div class="card">
                        <div class="card-header">
                            <h:outputText value="Pharmacy Stock Count Bill" style="font-size: 1.5rem; font-weight: bold; color: #495057;"/>
                        </div>
                        <div class="card-body">
                            <h:form>
                                <div class="row mb-4">
                                    <div class="col-lg-8">
                                        <div class="btn-toolbar" role="toolbar">
                                            <div class="btn-group mr-3" role="group" aria-label="Print Actions">
                                                <p:commandButton 
                                                    value="Print Report" 
                                                    icon="fa fa-print" 
                                                    ajax="false" 
                                                    styleClass="ui-button-info mx-1">
                                                    <p:printer target="reportView" />
                                                </p:commandButton>
                                                <p:commandButton 
                                                    value="Export PDF" 
                                                    icon="fa fa-file-pdf" 
                                                    ajax="false" 
                                                    styleClass="ui-button-secondary mx-1">
                                                    <p:dataExporter type="pdf" target=":#{p:resolveFirstComponentWithId('tbl',view).clientId}" fileName="pharmacy_stock_count_#{pharmacyStockTakeController.snapshotBill.deptId}" />
                                                </p:commandButton>
                                            </div>
                                            <div class="btn-group mr-3" role="group" aria-label="Download Sheets">
                                                <p:commandButton value="Download Guided Sheet" ajax="false" 
                                                               styleClass="ui-button-success mx-1" icon="fa fa-download" 
                                                               onclick="PrimeFaces.monitorDownload(start, stop);">
                                                    <p:fileDownload value="#{pharmacyStockTakeController.downloadGuidedSheet}" />
                                                </p:commandButton>
                                                <p:commandButton value="Download Blind Sheet" ajax="false" 
                                                               styleClass="ui-button-warning mx-1" icon="fa fa-download" 
                                                               onclick="PrimeFaces.monitorDownload(start, stop);">
                                                    <p:fileDownload value="#{pharmacyStockTakeController.downloadBlindSheet}" />
                                                </p:commandButton>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 text-right">
                                        <p:commandButton value="Back to Stock Take" ajax="false" 
                                                       styleClass="ui-button-secondary" icon="fa fa-arrow-left" 
                                                       action="pharmacy_stock_take?faces-redirect=true"/>
                                    </div>
                                </div>

                                <!-- Category-specific download section -->
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h:outputText value="Download by Category" style="font-size: 1.2rem; font-weight: bold; color: #495057;"/>
                                    </div>
                                    <div class="card-body">
                                        <div class="row align-items-end">
                                            <div class="col-lg-4">
                                                <h:outputLabel for="categoryFilter" value="Select Category:" styleClass="form-label font-weight-bold"/>
                                                <p:autoComplete id="categoryFilter"
                                                              value="#{pharmacyStockTakeController.selectedCategory}"
                                                              completeMethod="#{pharmacyStockTakeController.completeCategory}"
                                                              var="cat"
                                                              itemLabel="#{cat.name}"
                                                              itemValue="#{cat}"
                                                              converter="#{categoryController.converter}"
                                                              emptyMessage="No categories found"
                                                              dropdown="true"
                                                              cache="false"
                                                              queryDelay="300"
                                                              minQueryLength="1"
                                                              styleClass="form-control"
                                                              placeholder="Type to search categories...">
                                                    <p:ajax event="itemSelect" update="categoryDownloadButtons"/>
                                                </p:autoComplete>
                                            </div>
                                            <div class="col-lg-8">
                                                <h:panelGroup id="categoryDownloadButtons">
                                                    <div class="btn-group" role="group" aria-label="Category Download Actions">
                                                        <p:commandButton value="Download Category Guided Sheet"
                                                                       ajax="false"
                                                                       styleClass="ui-button-success mx-1"
                                                                       icon="fa fa-download"
                                                                       disabled="#{pharmacyStockTakeController.selectedCategory == null}"
                                                                       onclick="PrimeFaces.monitorDownload(start, stop);">
                                                            <p:fileDownload value="#{pharmacyStockTakeController.downloadCategoryGuidedSheet}" />
                                                        </p:commandButton>
                                                        <p:commandButton value="Download Category Blind Sheet"
                                                                       ajax="false"
                                                                       styleClass="ui-button-warning mx-1"
                                                                       icon="fa fa-download"
                                                                       disabled="#{pharmacyStockTakeController.selectedCategory == null}"
                                                                       onclick="PrimeFaces.monitorDownload(start, stop);">
                                                            <p:fileDownload value="#{pharmacyStockTakeController.downloadCategoryBlindSheet}" />
                                                        </p:commandButton>
                                                    </div>
                                                </h:panelGroup>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h:panelGroup id="reportView">
                                    <div class="row mb-4">
                                        <div class="col-lg-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h:outputText value="Bill Information" 
                                                                 style="font-weight: bold; color: #495057; font-size: 1.1rem;"/>
                                                    <p:panelGrid columns="2" styleClass="ui-panelgrid-blank mt-2" 
                                                                 columnClasses="text-right pr-3 font-weight-bold,text-left">
                                                        <h:outputText value="Institution:" style="font-weight:bold; color: #6c757d;"/>
                                                        <h:outputText value="#{pharmacyStockTakeController.snapshotBill.institution.name}" 
                                                                     style="color: #495057;"/>
                                                        <h:outputText value="Department:" style="font-weight:bold; color: #6c757d;"/>
                                                        <h:outputText value="#{pharmacyStockTakeController.snapshotBill.department.name}" 
                                                                     style="color: #495057;"/>
                                                        <h:outputText value="Bill No:" style="font-weight:bold; color: #6c757d;"/>
                                                        <h:outputText value="#{pharmacyStockTakeController.snapshotBill.deptId}" 
                                                                     style="color: #495057; font-family: monospace;"/>
                                                    </p:panelGrid>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="card bg-success text-white">
                                                <div class="card-body text-center">
                                                    <h:outputText value="Total Stock Value" 
                                                                 style="font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 10px;"/>
                                                    <h:outputText value="#{pharmacyStockTakeController.snapshotBill.netTotal}" 
                                                                 style="font-weight: bold; font-size: 2rem;">
                                                        <f:convertNumber pattern="#,##0.00"/>
                                                    </h:outputText>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <p:separator style="margin: 2rem 0;"/>

                                    <p:dataTable id="tbl" 
                                                widgetVar="tbl" 
                                                value="#{pharmacyStockTakeController.snapshotBill.billItems}" 
                                                var="bi" 
                                                rows="25" 
                                                paginator="true"
                                                paginatorPosition="both"
                                                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                rowsPerPageTemplate="10,25,50,100"
                                                styleClass="ui-datatable-striped ui-datatable-gridlines"
                                                emptyMessage="No stock items found for this bill."
                                                sortMode="multiple">
                                        
                                        <p:column headerText="Bill Item ID" sortBy="#{bi.id}"
                                                 filterBy="#{bi.id}" filterMatchMode="exact"
                                                 style="width: 110px; text-align: right;">
                                            <h:outputText value="#{bi.id}" 
                                                         style="color: #6c757d; font-family: monospace;"/>
                                        </p:column>
                                        
                                        <p:column headerText="Category" sortBy="#{bi.item.category.name}" 
                                                 filterBy="#{bi.item.category.name}" filterMatchMode="contains"
                                                 style="width: 120px;">
                                            <h:outputText value="#{bi.item.category.name}" 
                                                         style="color: #495057;"/>
                                        </p:column>
                                        
                                        <p:column headerText="Item Description" sortBy="#{bi.descreption}" 
                                                 filterBy="#{bi.descreption}" filterMatchMode="contains"
                                                 style="min-width: 200px;">
                                            <h:outputText value="#{bi.descreption}" 
                                                         style="color: #495057; font-weight: 500;"/>
                                        </p:column>
                                        
                                        <p:column headerText="Batch No." sortBy="#{bi.pharmaceuticalBillItem.stock.itemBatch.batchNo}" 
                                                 filterBy="#{bi.pharmaceuticalBillItem.stock.itemBatch.batchNo}" filterMatchMode="contains"
                                                 style="width: 100px; text-align: center;">
                                            <h:outputText value="#{bi.pharmaceuticalBillItem.stock.itemBatch.batchNo}" 
                                                         style="color: #6c757d; font-family: monospace;"/>
                                        </p:column>
                                        
                                        <p:column headerText="Expiry Date" sortBy="#{bi.pharmaceuticalBillItem.stock.itemBatch.dateOfExpire}" 
                                                 filterBy="#{bi.pharmaceuticalBillItem.stock.itemBatch.dateOfExpire}" filterMatchMode="contains"
                                                 style="width: 110px; text-align: center;">
                                            <h:outputText value="#{bi.pharmaceuticalBillItem.stock.itemBatch.dateOfExpire}" 
                                                         style="color: #6c757d;">
                                                <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}"/>
                                            </h:outputText>
                                        </p:column>
                                        
                                        <p:column headerText="Quantity" sortBy="#{bi.qty}" 
                                                 filterBy="#{bi.qty}" filterMatchMode="exact"
                                                 style="width: 80px; text-align: right;">
                                            <h:outputText value="#{bi.qty}" 
                                                         style="color: #495057; font-weight: 500;">
                                                <f:convertNumber integerOnly="true"/>
                                            </h:outputText>
                                        </p:column>
                                        
                                        <p:column headerText="Purchase Rate" sortBy="#{bi.pharmaceuticalBillItem.itemBatch.purcahseRate}" 
                                                 filterBy="#{bi.pharmaceuticalBillItem.itemBatch.purcahseRate}" filterMatchMode="exact"
                                                 style="width: 110px; text-align: right;">
                                            <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.purcahseRate}" 
                                                         style="color: #6c757d;">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>
                                        
                                        <p:column headerText="Retail Rate" sortBy="#{bi.pharmaceuticalBillItem.itemBatch.retailsaleRate}" 
                                                 filterBy="#{bi.pharmaceuticalBillItem.itemBatch.retailsaleRate}" filterMatchMode="exact"
                                                 style="width: 110px; text-align: right;">
                                            <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.retailsaleRate}" 
                                                         style="color: #6c757d;">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>
                                        
                                        <p:column headerText="Cost Rate" sortBy="#{bi.pharmaceuticalBillItem.itemBatch.costRate}" 
                                                 filterBy="#{bi.pharmaceuticalBillItem.itemBatch.costRate}" filterMatchMode="exact"
                                                 style="width: 110px; text-align: right;">
                                            <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.costRate}" 
                                                         style="color: #6c757d;">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Line Value" sortBy="#{bi.netValue}" 
                                                 filterBy="#{bi.netValue}" filterMatchMode="exact"
                                                 style="width: 120px; text-align: right;">
                                            <h:outputText value="#{bi.netValue}" 
                                                         style="color: #28a745; font-weight: bold;">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>
                                    </p:dataTable>

                                    <div class="row mt-4 no-print">
                                        <div class="col-lg-8">
                                            <p:messages id="messages" showDetail="true" closable="true" />
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-right">
                                                    <h:outputText value="Report Summary" 
                                                                 style="font-weight: bold; color: #6c757d; font-size: 1.1rem; display: block; margin-bottom: 10px;"/>
                                                    <h:outputText value="Total Items: " 
                                                                 style="font-weight: bold; color: #6c757d;"/>
                                                    <h:outputText value="#{pharmacyStockTakeController.snapshotBill.billItems.size()}" 
                                                                 style="color: #495057; font-weight: bold;"/>
                                                    <br/>
                                                    <h:outputText value="Net Total: " 
                                                                 style="font-weight: bold; color: #6c757d;"/>
                                                    <h:outputText value="#{pharmacyStockTakeController.snapshotBill.netTotal}" 
                                                                 style="font-weight: bold; color: #28a745; font-size: 1.3rem;">
                                                        <f:convertNumber pattern="#,##0.00"/>
                                                    </h:outputText>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </h:panelGroup>

                                <style type="text/css">
                                    @media print {
                                        .no-print, .no-print * {
                                            display: none !important;
                                        }
                                        .card {
                                            border: 1px solid #dee2e6 !important;
                                            box-shadow: none !important;
                                        }
                                        .btn-toolbar, .btn-group {
                                            display: none !important;
                                        }
                                        .ui-paginator {
                                            display: none !important;
                                        }
                                        .ui-datatable .ui-datatable-header {
                                            background: #f8f9fa !important;
                                            print-color-adjust: exact;
                                        }
                                        body {
                                            font-size: 12px !important;
                                        }
                                        .card-header {
                                            background: #e9ecef !important;
                                            print-color-adjust: exact;
                                        }
                                        .bg-success {
                                            background-color: #28a745 !important;
                                            print-color-adjust: exact;
                                        }
                                    }
                                </style>

                            </h:form>
                        </div>
                    </div>
                </div>
            </ui:define>
        </ui:composition>
    </h:body>

</html>
