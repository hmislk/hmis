<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:body>
        <ui:composition template="/pharmacy/admin/index.xhtml">
            <ui:define name="subcontent">
                <h:form id="form">
                    <p:growl id="msg" life="3000"/>

                    <p:panel header="AMP Management" styleClass="mb-3">
                        <!-- Modern Search Section -->
                        <div class="search-section mb-3">
                            <h6 class="mb-2">Search & Select AMP</h6>
                            <p:autoComplete
                                id="acAmp"
                                class="w-100"
                                inputStyleClass="w-100"
                                value="#{ampController.selectedAmpDto}"
                                completeMethod="#{ampController.completeAmpDto}"
                                var="dto"
                                itemLabel="#{dto.name}"
                                itemValue="#{dto}"
                                converter="ampDtoConverter"
                                maxResults="20"
                                minQueryLength="2"
                                forceSelection="true"
                                disabled="#{ampController.editable}"
                                placeholder="Search by name, code, or barcode (minimum 2 characters)...">
                                <p:ajax event="itemSelect"
                                        process="@this"
                                        update="detailPanel statusFilterPanel actionButtons" />
                                <p:column headerText="Name" style="width: auto;">
                                    <h:outputText value="#{dto.name}" styleClass="fw-bold"/>
                                    <br/>
                                    <small class="text-muted">#{dto.vmpDisplay}</small>
                                </p:column>
                                <p:column headerText="Code/Barcode" style="width: 120px;">
                                    <h:outputText value="#{dto.codeDisplay}"/>
                                    <br/>
                                    <small class="text-muted">#{dto.barcodeDisplay}</small>
                                </p:column>
                                <p:column headerText="Status" style="width: 70px; text-align: center;">
                                    <p:badge value="#{dto.statusDisplay}"
                                             severity="#{dto.retired ? 'danger' : 'success'}"
                                             style="font-size: 0.75em;"/>
                                </p:column>
                            </p:autoComplete>
                        </div>

                        <!-- Status Filter Section -->
                        <div id="statusFilterPanel" class="status-filter-section mb-3">
                            <div class="d-flex gap-2 align-items-center">
                                <label class="form-label mb-0">Show:</label>
                                <p:commandButton value="Active"
                                                action="#{ampController.setStatusFilter('ACTIVE')}"
                                                update="detailPanel"
                                                styleClass="#{ampController.statusFilter == 'ACTIVE' ? 'ui-button-success' : 'ui-button-outlined ui-button-success'}"
                                                process="@this"/>
                                <p:commandButton value="Inactive"
                                                action="#{ampController.setStatusFilter('INACTIVE')}"
                                                update="detailPanel"
                                                styleClass="#{ampController.statusFilter == 'INACTIVE' ? 'ui-button-danger' : 'ui-button-outlined ui-button-danger'}"
                                                process="@this"/>
                                <p:commandButton value="All"
                                                action="#{ampController.setStatusFilter('ALL')}"
                                                update="detailPanel"
                                                styleClass="#{ampController.statusFilter == 'ALL' ? 'ui-button-info' : 'ui-button-outlined ui-button-info'}"
                                                process="@this"/>
                            </div>
                        </div>

                        <!-- Main Content Layout -->
                        <div class="row">
                            <div class="col-md-8">
                                <p:panel id="detailPanel" styleClass="h-100">
                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>
                                                #{empty ampController.current ? 'AMP Details' :
                                                  (empty ampController.current.id ? 'Add New AMP' : 'Edit AMP Details')}
                                            </span>
                                            <div>
                                                <h:panelGroup rendered="#{ampController.current ne null and ampController.current.id ne null}"
                                                              styleClass="badge #{ampController.current.retired ? 'badge-danger' : 'badge-success'} me-2">
                                                    #{ampController.current.retired ? 'Inactive' : 'Active'}
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{ampController.editable}"
                                                              styleClass="badge badge-warning">
                                                    #{ampController.current.id ne null ? 'Editing' : 'Adding New'}
                                                </h:panelGroup>
                                            </div>
                                        </div>
                                    </f:facet>

                                    <!-- Clean, simplified form fields -->
                                    <div class="form-section" rendered="#{ampController.current ne null}">

                                        <!-- Essential Information Section -->
                                        <h6 class="section-header">Essential Information</h6>
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <p:outputLabel for="ampName" value="AMP Name *"/>
                                                <p:inputText id="ampName"
                                                           value="#{ampController.current.name}"
                                                           class="form-control"
                                                           disabled="#{not ampController.editable}"
                                                           required="true"
                                                           requiredMessage="AMP name is required"/>
                                            </div>
                                            <div class="col-md-3">
                                                <p:outputLabel for="ampCode" value="Code *">
                                                    <i class="fas fa-info-circle ms-1 text-muted"
                                                       title="Auto-generated if blank"></i>
                                                </p:outputLabel>
                                                <div class="input-group">
                                                    <p:inputText id="ampCode"
                                                               value="#{ampController.current.code}"
                                                               class="form-control"
                                                               disabled="#{not ampController.editable}"/>
                                                    <p:commandButton icon="fas fa-magic"
                                                                   title="Generate Code"
                                                                   action="#{ampController.generateCode()}"
                                                                   update="ampCode"
                                                                   rendered="#{ampController.editable}"
                                                                   styleClass="btn btn-outline-secondary"
                                                                   process="@this"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <p:outputLabel for="ampBarcode" value="Barcode"/>
                                                <p:inputText id="ampBarcode"
                                                           value="#{ampController.current.barcode}"
                                                           class="form-control"
                                                           disabled="#{not ampController.editable}"/>
                                            </div>
                                        </div>

                                        <!-- VMP Relationship Section -->
                                        <h6 class="section-header">Product Information</h6>
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <p:outputLabel for="vmpSelect" value="Virtual Product (VMP) *"/>
                                                <p:autoComplete id="vmpSelect"
                                                              value="#{ampController.current.vmp}"
                                                              completeMethod="#{ampController.completeVmpByName}"
                                                              var="vmp"
                                                              itemLabel="#{vmp.name}"
                                                              itemValue="#{vmp}"
                                                              converter="vmp"
                                                              disabled="#{not ampController.editable}"
                                                              class="form-control"
                                                              required="true"
                                                              requiredMessage="VMP selection is required">
                                                    <p:ajax event="itemSelect" update="dosageInfo strengthInfo"/>
                                                </p:autoComplete>
                                            </div>
                                            <div class="col-md-6" id="dosageInfo">
                                                <p:outputLabel value="Dosage Form"/>
                                                <p:inputText value="#{ampController.current.vmp.dosageForm.name}"
                                                           readonly="true"
                                                           class="form-control-plaintext"
                                                           rendered="#{ampController.current.vmp ne null}"/>
                                                <p:inputText value="Not specified"
                                                           readonly="true"
                                                           class="form-control-plaintext text-muted"
                                                           rendered="#{ampController.current.vmp eq null}"/>
                                            </div>
                                        </div>

                                        <!-- Business Rules Section -->
                                        <h6 class="section-header">Business Rules</h6>
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <p:selectBooleanCheckbox id="discountAllowed"
                                                                           value="#{ampController.current.discountAllowed}"
                                                                           disabled="#{not ampController.editable}"
                                                                           styleClass="form-check-input"/>
                                                    <p:outputLabel for="discountAllowed" value="Allow Discounts" styleClass="form-check-label"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <p:selectBooleanCheckbox id="refundsAllowed"
                                                                           value="#{ampController.current.refundsAllowed}"
                                                                           disabled="#{not ampController.editable}"
                                                                           styleClass="form-check-input"/>
                                                    <p:outputLabel for="refundsAllowed" value="Allow Refunds" styleClass="form-check-label"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <p:selectBooleanCheckbox id="consumptionAllowed"
                                                                           value="#{ampController.current.consumptionAllowed}"
                                                                           disabled="#{not ampController.editable}"
                                                                           styleClass="form-check-input"/>
                                                    <p:outputLabel for="consumptionAllowed" value="Consumable" styleClass="form-check-label"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <p:selectBooleanCheckbox id="allowFractions"
                                                                           value="#{ampController.current.allowFractions}"
                                                                           disabled="#{not ampController.editable}"
                                                                           styleClass="form-check-input"/>
                                                    <p:outputLabel for="allowFractions" value="Allow Fractions" styleClass="form-check-label"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </p:panel>
                            </div>

                            <!-- Right Side Panel -->
                            <div class="col-md-4">
                                <div class="action-panels">
                                    <!-- Action Buttons Panel -->
                                    <p:panel header="Actions" styleClass="mb-3">
                                        <div id="actionButtons" class="d-grid gap-2">
                                            <p:commandButton id="btnAdd" value="Add New AMP"
                                                           action="#{ampController.prepareAdd()}"
                                                           update="detailPanel actionButtons statusFilterPanel"
                                                           icon="fas fa-plus"
                                                           styleClass="ui-button-success"/>
                                            <p:commandButton id="btnEdit" value="Edit AMP"
                                                           action="#{ampController.prepareEdit()}"
                                                           update="detailPanel actionButtons"
                                                           disabled="#{ampController.current.id eq null or ampController.editable}"
                                                           icon="fas fa-edit"
                                                           styleClass="ui-button-warning"/>
                                            <p:commandButton id="btnSave" value="Save"
                                                           action="#{ampController.save()}"
                                                           update="detailPanel actionButtons statusFilterPanel"
                                                           rendered="#{ampController.editable}"
                                                           icon="fas fa-save"
                                                           styleClass="ui-button-success"/>
                                            <p:commandButton id="btnCancel" value="Cancel"
                                                           action="#{ampController.cancel()}"
                                                           update="detailPanel actionButtons"
                                                           rendered="#{ampController.editable}"
                                                           icon="fas fa-times"
                                                           styleClass="ui-button-secondary"
                                                           immediate="true"/>
                                            <p:commandButton id="btnDelete" value="Delete AMP"
                                                           action="#{ampController.delete()}"
                                                           update="detailPanel actionButtons statusFilterPanel"
                                                           disabled="#{ampController.current.id eq null or ampController.editable}"
                                                           icon="fas fa-trash"
                                                           styleClass="ui-button-danger"
                                                           onclick="return confirm('Are you sure you want to delete this AMP?')"/>
                                        </div>
                                    </p:panel>

                                    <!-- Status Management Panel -->
                                    <p:panel header="Status Management"
                                           rendered="#{ampController.current ne null and ampController.current.id ne null}"
                                           styleClass="mb-3">
                                        <div class="d-grid gap-2">
                                            <p:commandButton id="btnToggleStatus"
                                                           value="#{ampController.toggleStatusButtonText}"
                                                           action="#{ampController.toggleAmpStatus()}"
                                                           update="detailPanel actionButtons statusFilterPanel"
                                                           styleClass="#{ampController.toggleStatusButtonClass}"
                                                           icon="#{ampController.current.retired ? 'fas fa-play' : 'fas fa-pause'}"
                                                           onclick="return confirm('Are you sure you want to change the status of this AMP?')"/>
                                            <p:commandButton id="btnAuditEvents"
                                                           value="View Audit History"
                                                           action="#{ampController.navigateToAmpAuditEvents()}"
                                                           icon="fas fa-history"
                                                           ajax="false"
                                                           styleClass="ui-button-info"/>
                                        </div>
                                    </p:panel>

                                    <!-- Bulk Operations Panel -->
                                    <p:panel header="Bulk Operations" styleClass="mb-3">
                                        <div class="d-grid gap-2">
                                            <p:commandButton value="Generate All Codes"
                                                           action="#{ampController.performBulkCodeGeneration()}"
                                                           update="detailPanel"
                                                           icon="fas fa-magic"
                                                           styleClass="ui-button-info"
                                                           onclick="return confirm('Generate codes for all AMPs without codes?')"/>
                                            <p:commandButton value="Upload AMPs"
                                                           onclick="PF('uploadDialog').show()"
                                                           icon="fas fa-upload"
                                                           styleClass="ui-button-secondary"/>
                                        </div>
                                    </p:panel>
                                </div>
                            </div>
                        </div>
                    </p:panel>

                    <!-- Upload Dialog -->
                    <p:dialog header="Upload AMPs" widgetVar="uploadDialog" modal="true" width="400">
                        <p:fileUpload id="fileUpload"
                                      value="#{ampController.file}"
                                      mode="simple"
                                      allowTypes="/(\.|\/)(xlsx|xls)$/"
                                      update="msg"
                                      label="Choose Excel File"/>
                        <div class="mt-2">
                            <p:commandButton value="Upload"
                                           action="#{ampController.uploadAmps()}"
                                           update="msg detailPanel"
                                           onclick="PF('uploadDialog').hide()"/>
                            <p:commandButton value="Cancel"
                                           onclick="PF('uploadDialog').hide()"
                                           type="button"
                                           styleClass="ui-button-secondary"/>
                        </div>
                    </p:dialog>
                </h:form>

                <!-- Custom CSS for modern layout -->
                <style>
                    .search-section {
                        background: #f8f9fa;
                        padding: 1rem;
                        border-radius: 0.375rem;
                        border: 1px solid #dee2e6;
                    }

                    .status-filter-section {
                        background: #ffffff;
                        padding: 0.75rem;
                        border-radius: 0.375rem;
                        border: 1px solid #dee2e6;
                    }

                    .section-header {
                        color: #495057;
                        font-weight: 600;
                        margin-bottom: 0.5rem;
                        padding-bottom: 0.25rem;
                        border-bottom: 2px solid #dee2e6;
                    }

                    .form-section {
                        padding: 1rem 0;
                    }

                    .action-panels .ui-panel {
                        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
                    }

                    .action-panels .ui-panel .ui-panel-content {
                        padding: 1rem;
                    }

                    .badge-success {
                        background-color: #28a745;
                        color: white;
                    }

                    .badge-danger {
                        background-color: #dc3545;
                        color: white;
                    }

                    .badge-warning {
                        background-color: #ffc107;
                        color: #212529;
                    }
                </style>
            </ui:define>
        </ui:composition>
    </h:body>
</html>