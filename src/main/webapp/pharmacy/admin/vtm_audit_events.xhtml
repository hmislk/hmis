<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:body>
        <ui:composition template="/pharmacy/admin/index.xhtml">
            <ui:define name="subcontent">
                <h:form id="form">
                    <p:growl id="msg"/>

                    <!-- Page Header -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h3>
                                <i class="fas fa-history"></i>
                                VTM Audit Events
                                <small class="text-muted">
                                    - #{vtmController.current.name}
                                    <span class="badge badge-secondary">#{vtmController.current.code}</span>
                                </small>
                            </h3>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <p:commandButton
                                value="Back to VTM Management"
                                icon="fas fa-arrow-left"
                                action="/pharmacy/admin/vtm_dto?faces-redirect=true"
                                class="ui-button-secondary mr-2"
                                immediate="true" />

                            <p:commandButton
                                value="Refresh"
                                icon="fas fa-sync"
                                action="#{vtmController.fillVtmAuditEvents}"
                                update=":form:auditTable :form:msg"
                                class="ui-button-info" />

                            <p:commandButton
                                value="Debug All VTM Events"
                                icon="fas fa-bug"
                                action="#{vtmController.debugAllVtmAuditEvents}"
                                class="ui-button-warning ml-2"
                                style="margin-left: 10px;" />
                        </div>
                    </div>

                    <!-- VTM Information Summary -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <p:panel header="VTM Information" styleClass="mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Name:</strong> #{vtmController.current.name}<br/>
                                        <strong>Code:</strong> #{vtmController.current.code}<br/>
                                        <strong>Status:</strong>
                                        <span class="badge #{vtmController.current.retired ? 'badge-danger' : 'badge-success'}">
                                            #{vtmController.current.retired ? 'Retired' : 'Active'}
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Department:</strong> #{vtmController.current.departmentType}<br/>
                                        <strong>Total Audit Events:</strong>
                                        <span class="badge badge-info">#{vtmController.vtmAuditEvents.size()}</span>
                                    </div>
                                </div>
                            </p:panel>
                        </div>
                    </div>

                    <!-- Audit Events Table -->
                    <div class="row">
                        <div class="col-12">
                            <p:panel header="Audit Events History">
                                <p:dataTable
                                    id="auditTable"
                                    value="#{vtmController.vtmAuditEvents}"
                                    var="audit"
                                    paginator="true"
                                    rows="20"
                                    paginatorPosition="both"
                                    paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                    currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} events"
                                    rowsPerPageTemplate="10,20,50,100"
                                    emptyMessage="No audit events found for this VTM."
                                    styleClass="table table-striped">

                                    <p:column headerText="#" style="width: 50px;">
                                        <h:outputText value="#{audit.id}" />
                                    </p:column>

                                    <p:column headerText="Date / Time" style="width: 150px;">
                                        <h:outputText value="#{audit.eventDataTime}">
                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Action" style="width: 120px;">
                                        <span class="badge #{audit.eventTrigger eq 'Create VTM' ? 'badge-success' :
                                                            (audit.eventTrigger eq 'Update VTM' ? 'badge-warning' : 'badge-danger')}">
                                            #{audit.eventTrigger}
                                        </span>
                                    </p:column>

                                    <p:column headerText="User" style="width: 150px;">
                                        <h:outputText value="#{webUserController.findWebUserNameWithTitleById(audit.webUserId)}" />
                                    </p:column>

                                    <p:column headerText="Changes" style="width: auto;">
                                        <div class="audit-changes">
                                            <h:outputText escape="false" value="#{audit.difference}" />
                                        </div>
                                    </p:column>

                                    <p:column headerText="Status" style="width: 80px;">
                                        <span class="badge #{audit.eventStatus eq 'Completed' ? 'badge-success' :
                                                            (audit.eventStatus eq 'Failed' ? 'badge-danger' : 'badge-warning')}">
                                            #{audit.eventStatus}
                                        </span>
                                    </p:column>

                                    <p:column headerText="IP" style="width: 120px;">
                                        <small class="text-muted">#{audit.ipAddress}</small>
                                    </p:column>

                                </p:dataTable>
                            </p:panel>
                        </div>
                    </div>

                    <!-- Load audit events when page loads -->
                    <f:event type="preRenderView" listener="#{vtmController.fillVtmAuditEvents}" />

                </h:form>

                <!-- Custom CSS for better audit display -->
                <style>
                    .audit-changes {
                        max-width: 400px;
                        word-wrap: break-word;
                        white-space: pre-line;
                        font-family: 'Courier New', monospace;
                        font-size: 0.85em;
                        line-height: 1.3;
                    }

                    .badge {
                        font-size: 0.75em;
                        padding: 0.25em 0.5em;
                    }

                    .table th {
                        background-color: #f8f9fa;
                        font-weight: 600;
                        border-top: none;
                    }

                    .table td {
                        vertical-align: middle;
                        padding: 0.75rem 0.5rem;
                    }

                    .text-muted {
                        color: #6c757d !important;
                    }
                </style>

            </ui:define>
        </ui:composition>
    </h:body>
</html>