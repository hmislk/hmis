<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:body>
    <ui:composition template="/pharmacy/pharmacy_analytics.xhtml">
        <ui:define name="subcontent">

            <p:panel header="Pharmacy Return Without Trasing Report" styleClass="m-2">
                <h:form id="reportForm">

                    <!-- 8-column filter grid matching procurement report -->
                    <h:panelGrid columns="8" styleClass="w-100 form-grid mb-3" columnClasses="label-column, input-column, spacer-column">

                        <!-- From Date -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf073;" styleClass="fa mr-2" />
                            <h:outputLabel value="From" for="fromDate" class="mx-2"/>
                        </h:panelGroup>
                        <p:calendar
                            id="fromDate"
                            styleClass="w-100"
                            inputStyleClass="w-100 form-control"
                            value="#{pharmacyReturnWithoutTrasingReportController.fromDate}"
                            pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                            navigator="true" />

                        <p:spacer width="20" />

                        <!-- To Date -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf073;" styleClass="fa mr-2" />
                            <h:outputLabel value="To" for="toDate" class="mx-2"/>
                        </h:panelGroup>
                        <p:calendar
                            id="toDate"
                            styleClass="w-100"
                            inputStyleClass="w-100 form-control"
                            value="#{pharmacyReturnWithoutTrasingReportController.toDate}"
                            pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                            navigator="true" />

                        <p:spacer width="20" />
                        <p:spacer width="20" />

                        <!-- Institution Filter -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf19c;" styleClass="fa mr-2" />
                            <h:outputLabel value="Institution" for="cmbIns" class="mx-2"/>
                        </h:panelGroup>
                        <p:selectOneMenu id="cmbIns" styleClass="w-100 form-control"
                                         value="#{pharmacyReturnWithoutTrasingReportController.institution}" filter="true">
                            <f:selectItem itemLabel="All Institutions" />
                            <f:selectItems value="#{institutionController.companies}" var="ins"
                                          itemLabel="#{ins.name}" itemValue="#{ins}" />
                            <p:ajax process="cmbIns" update="cmbDept" />
                        </p:selectOneMenu>

                        <p:spacer width="20" />

                        <!-- Site Filter -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf3c5;" styleClass="fa mr-2" />
                            <h:outputLabel value="Site" for="siteMenu" class="mx-2"/>
                        </h:panelGroup>
                        <p:selectOneMenu id="siteMenu" styleClass="w-100 form-control"
                                         value="#{pharmacyReturnWithoutTrasingReportController.site}" filter="true">
                            <f:selectItem itemLabel="All Sites" />
                            <f:selectItems value="#{institutionController.sites}" var="site"
                                          itemLabel="#{site.name}" itemValue="#{site}" />
                            <p:ajax process="siteMenu" update="cmbDept" />
                        </p:selectOneMenu>

                        <p:spacer width="20" />

                        <!-- Department Filter with Cascade Logic -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf0e8;" styleClass="fa mr-2" />
                            <h:outputLabel value="Department" for="cmbDept" class="mx-2"/>
                        </h:panelGroup>
                        <h:panelGroup id="cmbDept">
                            <!-- Department dropdown based on institution/site selection -->
                            <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.institution == null and pharmacyReturnWithoutTrasingReportController.site == null}">
                                <p:selectOneMenu styleClass="w-100 form-control" value="#{pharmacyReturnWithoutTrasingReportController.department}" filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems value="#{departmentController.departmentsOfInstitutionAndSite}" var="dep"
                                                  itemLabel="#{dep.name}" itemValue="#{dep}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.institution == null and pharmacyReturnWithoutTrasingReportController.site != null}">
                                <p:selectOneMenu styleClass="w-100 form-control" value="#{pharmacyReturnWithoutTrasingReportController.department}" filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacyReturnWithoutTrasingReportController.site)}" var="dep"
                                                  itemLabel="#{dep.name}" itemValue="#{dep}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.institution != null and pharmacyReturnWithoutTrasingReportController.site == null}">
                                <p:selectOneMenu styleClass="w-100 form-control" value="#{pharmacyReturnWithoutTrasingReportController.department}" filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems value="#{departmentController.getDepartmentsOfInstitutionAndSiteForInstitution(pharmacyReturnWithoutTrasingReportController.institution)}" var="dep"
                                                  itemLabel="#{dep.name}" itemValue="#{dep}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.institution != null and pharmacyReturnWithoutTrasingReportController.site != null}">
                                <p:selectOneMenu styleClass="w-100 form-control" value="#{pharmacyReturnWithoutTrasingReportController.department}" filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems value="#{departmentController.getDepartmentsOfInstitutionAndSite(pharmacyReturnWithoutTrasingReportController.institution, pharmacyReturnWithoutTrasingReportController.site)}" var="dep"
                                                  itemLabel="#{dep.name}" itemValue="#{dep}" />
                                </p:selectOneMenu>
                            </h:panelGroup>
                        </h:panelGroup>

                        <!-- Report View Type -->
                        <h:panelGroup layout="block" styleClass="form-group">
                            <h:outputText value="&#xf080;" styleClass="fa mr-2" />
                            <h:outputLabel value="Report View" for="reportViewType" class="mx-2"/>
                        </h:panelGroup>
                        <p:selectOneMenu id="reportViewType" styleClass="w-100 form-control"
                                         value="#{pharmacyReturnWithoutTrasingReportController.reportViewType}">
                            <f:selectItem itemLabel="-- Select Report View --" itemValue="#{null}" />
                            <f:selectItem itemLabel="By Bill" itemValue="BY_BILL" />
                            <f:selectItem itemLabel="By Bill Items" itemValue="BY_BILL_ITEM" />
                        </p:selectOneMenu>

                    </h:panelGrid>

                    <!-- Action Buttons -->
                    <div class="mb-3">
                        <p:commandButton value="Process Report" ajax="false"
                                       action="#{pharmacyReturnWithoutTrasingReportController.processReport()}"
                                       styleClass="ui-button-success m-1" icon="pi pi-cog" />

                        <p:commandButton value="Clear Filters" ajax="false"
                                       action="#{pharmacyReturnWithoutTrasingReportController.resetFilters()}"
                                       styleClass="ui-button-secondary m-1" icon="pi pi-refresh" />
                    </div>

                    <!-- BY_BILL Report View -->
                    <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.reportViewType eq 'BY_BILL' and pharmacyReturnWithoutTrasingReportController.billReportData != null}">

                        <!-- Download/Print buttons for Bill Report -->
                        <div class="mb-2">
                            <p:commandButton value="Download Excel" ajax="false" styleClass="ui-button-info m-1" icon="pi pi-download">
                                <p:dataExporter type="xlsx" target="billTable"
                                              fileName="pharmacy_return_without_trasing_by_bill_#{pharmacyReturnWithoutTrasingReportController.fromDate}_to_#{pharmacyReturnWithoutTrasingReportController.toDate}" />
                            </p:commandButton>

                            <p:commandButton value="Print" ajax="false" styleClass="ui-button-warning m-1" icon="pi pi-print">
                                <p:printer target="billTable" />
                            </p:commandButton>
                        </div>

                        <!-- Bill-level DataTable -->
                        <p:dataTable id="billTable"
                                     styleClass="ui-datatable-borderless ui-datatable-sm compact-datatable"
                                     style="font-size: #{pharmacyReturnWithoutTrasingReportController.fontSizeForScreen}"
                                     value="#{pharmacyReturnWithoutTrasingReportController.billReportData}" var="row"
                                     paginator="true"
                                     rows="#{pharmacyReturnWithoutTrasingReportController.rowsPerPageForScreen}"
                                     paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="25,50,100,200">

                            <p:column headerText="Bill No" width="12em">
                                <h:outputText value="#{row.deptId}" />
                                <f:facet name="footer">
                                    <h:outputText value="Total (#{pharmacyReturnWithoutTrasingReportController.totalRecordCount} bills)"
                                                  style="font-weight: bold" />
                                </f:facet>
                            </p:column>

                            <p:column headerText="Date" width="10em">
                                <h:outputText value="#{row.createdAt}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateTimeFormat}" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Supplier">
                                <h:outputText value="#{row.supplierName}" />
                            </p:column>

                            <p:column headerText="Department">
                                <h:outputText value="#{row.departmentName}" />
                            </p:column>

                            <p:column headerText="Payment Method" width="8em">
                                <h:outputText value="#{row.paymentMethod}" />
                            </p:column>

                            <p:column headerText="Gross Total" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.grossTotal}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.grossTotal}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Discount" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.discount}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.discount}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Net Total" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.netTotal}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.netTotal}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Cost Value" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.totalCostValue}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.totalCostValue}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Purchase Value" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.totalPurchaseValue}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.totalPurchaseValue}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Retail Value" width="10em" styleClass="text-end">
                                <h:outputText value="#{row.totalRetailValue}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                                <f:facet name="footer">
                                    <h:outputText value="#{pharmacyReturnWithoutTrasingReportController.summaryRow.totalRetailValue}"
                                                  style="font-weight: bold">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputText>
                                </f:facet>
                            </p:column>

                            <p:column headerText="Comments">
                                <h:outputText value="#{row.comments}" />
                            </p:column>

                        </p:dataTable>
                    </h:panelGroup>

                    <!-- BY_BILL_ITEM Report View -->
                    <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.reportViewType eq 'BY_BILL_ITEM' and pharmacyReturnWithoutTrasingReportController.billItemReportData != null}">

                        <!-- Download/Print buttons for Bill Item Report -->
                        <div class="mb-2">
                            <p:commandButton value="Download Excel" ajax="false" styleClass="ui-button-info m-1" icon="pi pi-download">
                                <p:dataExporter type="xlsx" target="billItemTable"
                                              fileName="pharmacy_return_without_trasing_by_bill_items_#{pharmacyReturnWithoutTrasingReportController.fromDate}_to_#{pharmacyReturnWithoutTrasingReportController.toDate}" />
                            </p:commandButton>

                            <p:commandButton value="Print" ajax="false" styleClass="ui-button-warning m-1" icon="pi pi-print">
                                <p:printer target="billItemTable" />
                            </p:commandButton>
                        </div>

                        <!-- Bill item-level DataTable -->
                        <p:dataTable id="billItemTable"
                                     styleClass="ui-datatable-borderless ui-datatable-sm compact-datatable"
                                     style="font-size: #{pharmacyReturnWithoutTrasingReportController.fontSizeForScreen}"
                                     value="#{pharmacyReturnWithoutTrasingReportController.billItemReportData}" var="itemRow"
                                     paginator="true"
                                     rows="#{pharmacyReturnWithoutTrasingReportController.rowsPerPageForScreen}"
                                     paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="25,50,100,200">

                            <p:column headerText="Bill No" width="12em">
                                <h:outputText value="#{itemRow.billDeptId}" />
                            </p:column>

                            <p:column headerText="Date" width="10em">
                                <h:outputText value="#{itemRow.billCreatedAt}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateTimeFormat}" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Item Name">
                                <h:outputText value="#{itemRow.itemName}" />
                            </p:column>

                            <p:column headerText="Item Code" width="8em">
                                <h:outputText value="#{itemRow.itemCode}" />
                            </p:column>

                            <p:column headerText="Batch No" width="8em">
                                <h:outputText value="#{itemRow.batchNo}" />
                            </p:column>

                            <p:column headerText="Expiry Date" width="8em">
                                <h:outputText value="#{itemRow.expiryDate}">
                                    <f:convertDateTime pattern="dd/MM/yyyy" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Quantity" width="8em" styleClass="text-end">
                                <h:outputText value="#{itemRow.quantity}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Purchase Rate" width="8em" styleClass="text-end">
                                <h:outputText value="#{itemRow.purchaseRate}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Purchase Value" width="10em" styleClass="text-end">
                                <h:outputText value="#{itemRow.purchaseValue}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Retail Rate" width="8em" styleClass="text-end">
                                <h:outputText value="#{itemRow.retailRate}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Retail Value" width="10em" styleClass="text-end">
                                <h:outputText value="#{itemRow.retailValue}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Line Total" width="10em" styleClass="text-end">
                                <h:outputText value="#{itemRow.lineTotal}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Supplier">
                                <h:outputText value="#{itemRow.supplierName}" />
                            </p:column>

                        </p:dataTable>
                    </h:panelGroup>

                    <!-- No Results Message -->
                    <h:panelGroup rendered="#{pharmacyReturnWithoutTrasingReportController.reportViewType != null and pharmacyReturnWithoutTrasingReportController.billReportData == null and pharmacyReturnWithoutTrasingReportController.billItemReportData == null}">
                        <div class="alert alert-info mt-3">
                            <h:outputText value="No data available. Please click 'Process Report' to generate the report." />
                        </div>
                    </h:panelGroup>

                </h:form>
            </p:panel>
        </ui:define>
    </ui:composition>
</h:body>
</html>