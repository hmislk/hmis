<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/pharmacy/pharmacy_analytics.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp"
                >


    <ui:define name="subcontent">

        <h:panelGroup rendered="true" >
            <h:form>
                <p:panel header="Purchase/GRN Search Report">
                    <h:panelGrid columns="6" class="w-100">
                        <h:outputLabel value="From Date"/>
                        <p:calendar styleClass="dateTimePicker" id="frmDate" value="#{pharmacyPurchaseController.fromDate}" navigator="true"  pattern="#{sessionController.applicationPreference.longDateTimeFormat}"  >
                        </p:calendar>

                        <h:outputLabel value="To Date"/>
                        <p:calendar styleClass="dateTimePicker" id="toDate" value="#{pharmacyPurchaseController.toDate}" navigator="true" pattern="#{sessionController.applicationPreference.longDateTimeFormat}"  >
                        </p:calendar>

                        <h:outputLabel  value="Institution"  />
                        <p:autoComplete  value="#{pharmacyPurchaseController.institution}"  
                                         completeMethod="#{institutionController.completeInstitution}" var="ins"
                                         itemValue="#{ins}" itemLabel="#{ins.name}" 
                                         forceSelection="true" rendered="true">
                        </p:autoComplete>

                        <h:outputLabel  value="Department"  />
                        <p:autoComplete  value="#{pharmacyPurchaseController.department}"  
                                         completeMethod="#{departmentController.completeDept}" var="dept"
                                         itemValue="#{dept}" itemLabel="#{dept.name}" 
                                         forceSelection="true" rendered="true">
                        </p:autoComplete>

                        <h:outputLabel  value="Supplier"  />
                        <p:autoComplete  value="#{pharmacyPurchaseController.supplier}"  
                                         completeMethod="#{institutionController.completeSuppliers}" var="supplier"
                                         itemValue="#{supplier}" itemLabel="#{supplier.name}" 
                                         forceSelection="true" rendered="true">
                        </p:autoComplete>

                        <h:outputLabel  value="Payment Method"  />
                        <p:selectOneMenu   id="pay" value="#{pharmacyPurchaseController.paymentMethodFilter}">     
                            <f:selectItem itemLabel="Select Payment Method" />
                            <f:selectItems value="#{enumController.paymentMethodsForPo}"  />
                        </p:selectOneMenu>

                        <h:outputLabel  value="Item"  />
                        <p:autoComplete  value="#{pharmacyPurchaseController.selectedItem}"  
                                         completeMethod="#{pharmacyPurchaseController.completeItems}" var="item"
                                         itemValue="#{item}" itemLabel="#{item.name}" 
                                         forceSelection="true" rendered="true">
                        </p:autoComplete>

                        <h:outputLabel  value="Report Type"  />
                        <p:selectOneMenu value="#{pharmacyPurchaseController.reportType}">
                            <f:selectItem itemLabel="Bill Items" itemValue="BILL_ITEM" />
                            <f:selectItem itemLabel="Bills" itemValue="BILL" />
                        </p:selectOneMenu>

                        <h:outputLabel  value="Item Type Filter"  />
                        <p:selectOneMenu value="#{pharmacyPurchaseController.itemTypeFilter}">
                            <f:selectItem itemLabel="All Item Types" itemValue="ALL" />
                            <f:selectItem itemLabel="AMP" itemValue="AMP" />
                            <f:selectItem itemLabel="VMP" itemValue="VMP" />
                            <f:selectItem itemLabel="AMPP" itemValue="AMPP" />
                            <f:selectItem itemLabel="VMPP" itemValue="VMPP" />
                            <f:selectItem itemLabel="ATM" itemValue="ATM" />
                            <f:selectItem itemLabel="VTM" itemValue="VTM" />
                        </p:selectOneMenu>

                    </h:panelGrid>

                    <h:panelGrid columns="3" class="my-2">
                        <p:commandButton id="btnRefresh" ajax="false" value="Search" 
                                         icon="fa-solid fa-search"
                                         class="ui-button-warning"
                                         actionListener="#{pharmacyPurchaseController.searchBills()}"
                                         style="float: right;" /> 

                        <p:commandButton actionListener="#{pharmacyPurchaseController.searchBills()}" 
                                         ajax="false" value="Excel" 
                                         icon="fa-solid fa-file-excel"
                                         class="ui-button-success mx-2" 
                                         style="float: right;" >
                            <p:dataExporter type="xlsx" target="searchResults" fileName="pharmacy_purchase_search_results"  />
                        </p:commandButton>

                        <p:commandButton ajax="false" value="Print" 
                                         icon="fa-solid fa-print"
                                         class="ui-button-info"
                                         style="float: right;" >
                            <p:printer target="reportPrint"/>
                        </p:commandButton>
                    </h:panelGrid>

                    <p:panel id="reportPrint">
                        <h:panelGrid columns="2" styleClass="printBlock" style="min-width: 100%;">

                            <h:outputLabel value="Purchase/GRN Search Results"/>
                            <h:outputLabel/>
                            <h:outputLabel value="Institution "/>
                            <h:outputLabel value="#{pharmacyPurchaseController.institution.name}"/>
                            <h:outputLabel value="Department "/>
                            <h:outputLabel value="#{pharmacyPurchaseController.department.name}"/>
                            <h:outputLabel value="From" />
                            <h:outputLabel  value="#{pharmacyPurchaseController.fromDate}" >
                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                            </h:outputLabel>                          
                            <h:outputLabel value="To"/>
                            <h:outputLabel  value="#{pharmacyPurchaseController.toDate}" >
                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                            </h:outputLabel>
                        </h:panelGrid>


                        <p:dataTable id="searchResults" value="#{pharmacyPurchaseController.rows}" var="row" 
                                     rendered="#{pharmacyPurchaseController.rows.size() > 0}" 
                                     filteredValue="#{pharmacyPurchaseController.filteredRows}"
                                     globalFilter="#{pharmacyPurchaseController.globalFilter}"
                                     paginator="true" rows="20" 
                                     paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="5,10,15,20,50">

                            <f:facet name="header">  
                                <h:outputLabel value="Search Results - #{pharmacyPurchaseController.reportType == 'BILL_ITEM' ? 'By Bill Items' : 'By Bills'}"/>
                            </f:facet>

                            <p:column headerText="Bill Number" sortBy="#{row.bill.deptId}" filterBy="#{row.bill.deptId}">
                                <h:outputLabel value="#{row.bill.deptId}"/>
                            </p:column>

                            <p:column headerText="Bill Date" sortBy="#{row.bill.createdAt}" filterBy="#{row.bill.createdAt}">
                                <h:outputLabel value="#{row.bill.createdAt}">
                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Institution" rendered="#{pharmacyPurchaseController.institution eq null}" 
                                      sortBy="#{row.bill.institution.name}" filterBy="#{row.bill.institution.name}">
                                <h:outputLabel value="#{row.bill.institution.name}"/>
                            </p:column>

                            <p:column headerText="Department" rendered="#{pharmacyPurchaseController.department eq null}" 
                                      sortBy="#{row.bill.department.name}" filterBy="#{row.bill.department.name}">
                                <h:outputLabel value="#{row.bill.department.name}"/>
                            </p:column>

                            <p:column headerText="Supplier" rendered="#{pharmacyPurchaseController.supplier eq null}" 
                                      sortBy="#{row.bill.fromInstitution.name}" filterBy="#{row.bill.fromInstitution.name}">
                                <h:outputLabel value="#{row.bill.fromInstitution.name}"/>
                            </p:column>

                            <p:column headerText="Bill Type" sortBy="#{row.bill.billType}" filterBy="#{row.bill.billType}">
                                <h:outputLabel value="#{row.bill.billType}"/>
                            </p:column>

                            <p:column headerText="Item" rendered="#{pharmacyPurchaseController.reportType == 'BILL_ITEM'}" 
                                      sortBy="#{row.item.name}" filterBy="#{row.item.name}">
                                <h:outputLabel value="#{row.item.name}"/>
                            </p:column>

                            <p:column headerText="Quantity" style="text-align: right" 
                                      sortBy="#{row.qty}" rendered="#{pharmacyPurchaseController.reportType == 'BILL_ITEM'}">
                                <h:outputLabel value="#{row.qty}">
                                    <f:convertNumber pattern="#,##0"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Free Quantity" style="text-align: right" 
                                      sortBy="#{row.freeQty}" rendered="#{pharmacyPurchaseController.reportType == 'BILL_ITEM'}">
                                <h:outputLabel value="#{row.freeQty}">
                                    <f:convertNumber pattern="#,##0"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Total Quantity" style="text-align: right" 
                                      rendered="#{pharmacyPurchaseController.reportType == 'BILL_ITEM'}">
                                <h:outputLabel value="#{row.qty + row.freeQty}">
                                    <f:convertNumber pattern="#,##0"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Bill Total" style="text-align: right" 
                                      rendered="#{pharmacyPurchaseController.reportType == 'BILL'}" 
                                      sortBy="#{row.bill.total}">
                                <h:outputLabel value="#{row.bill.total}">
                                    <f:convertNumber pattern="#,##0.00"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Net Total" style="text-align: right" 
                                      rendered="#{pharmacyPurchaseController.reportType == 'BILL'}" 
                                      sortBy="#{row.bill.netTotal}">
                                <h:outputLabel value="#{row.bill.netTotal}">
                                    <f:convertNumber pattern="#,##0.00"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Discount" style="text-align: right" 
                                      rendered="#{pharmacyPurchaseController.reportType == 'BILL'}" 
                                      sortBy="#{row.bill.discount}">
                                <h:outputLabel value="#{row.bill.discount}">
                                    <f:convertNumber pattern="#,##0.00"/>
                                </h:outputLabel>
                            </p:column>

                            <p:column headerText="Actions" style="text-align: center;">
                                <p:commandButton value="View" 
                                                 action="#{pharmacyPurchaseController.viewBill(row.bill)}"
                                                 class="ui-button-info"
                                                 icon="fa-solid fa-eye"/>
                            </p:column>

                        </p:dataTable>

                    </p:panel>



                    <p:spacer height="30"/>

                </p:panel>
            </h:form>
        </h:panelGroup>
    </ui:define>

</ui:composition>
