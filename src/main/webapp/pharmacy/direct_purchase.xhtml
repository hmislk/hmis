<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    template="/resources/template/template.xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
    xmlns:pharmacy="http://xmlns.jcp.org/jsf/composite/pharmacy"
    xmlns:ph="http://xmlns.jcp.org/jsf/composite/ezcomp/pharmacy">

    <ui:define name="content">
        <h:form id="bill">
            <p:growl id="msg"/>
            <h:panelGroup rendered="#{!pharmacyDirectPurchaseController.printPreview}">
                <p:panel  >
                    <f:facet name="header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <h:outputText styleClass="fas fa-shopping-bag"/>
                                <h:outputText class="mx-4" value="Pharmacy Direct Purchase" />
                            </div>
                            <div>

                                <p:commandButton
                                    id="btnSettle"
                                    value="Settle"
                                    onclick="if (!confirm('Are you sure?'))
                                                return false"
                                    action="#{pharmacyDirectPurchaseController.settleDirectPurchaseBillFinally}"
                                    styleClass="ui-button-success"
                                    ajax="false"
                                    icon="pi pi-check-circle"
                                    style="margin-right: 8px;">
                                </p:commandButton>
                                <p:commandButton
                                    value="New Direct Purchase Bill"
                                    ajax="false"
                                    styleClass="ui-button-warning"
                                    icon="pi pi-plus"
                                    action="#{pharmacyDirectPurchaseController.navigateToStartNewDirectPurchaseBill()}"
                                    style="margin-right: 8px;">
                                </p:commandButton>
                            </div>
                        </div>
                    </f:facet>

                    <div class="row" >
                        <div class="col-12" >
                            <h:panelGroup
                                rendered="#{pharmacyDirectPurchaseController.warningMessage ne null}" >
                                <h:inputTextarea
                                    class="text-warning w-100"
                                    readonly="true"
                                    value="#{pharmacyDirectPurchaseController.warningMessage}" >
                                </h:inputTextarea>
                            </h:panelGroup>
                        </div>
                    </div>

                    <div class="row" >
                        <div class="col-12" >
                            <p:messages id="pageMessages" ></p:messages>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <p:panel
                                id="itemselectgrid"
                                class="m-1 w-100"
                                header="Add New Item" >
                                <f:facet name="header" >
                                    <h:outputText styleClass="fa-solid fa-circle-plus" />
                                    <h:outputText  class="mx-4" value="Add New Item" />
                                </f:facet>
                                <p:focus id="focusItem" for="acItem" ></p:focus>
                                <div class="row w-100">
                                    <div class="col-4">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            value="Select Item"/><br/>
                                        <p:autoComplete
                                            class="w-100 m-1"
                                            inputStyleClass="w-100"
                                            id="acItem"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.item}"
                                            forceSelection="true"
                                            completeMethod="#{itemController.completeAmpAndAmppItemForLoggedDepartment}"
                                            var="vt"
                                            maxResults="20"
                                            itemLabel="#{vt.name}"
                                            itemValue="#{vt}" >
                                            <p:column headerText="Item" style="padding: 6px;">
                                                <h:outputLabel value="#{vt.name}"></h:outputLabel>
                                            </p:column>
                                            <p:column headerText="Code" style="padding: 6px;">
                                                <h:outputLabel value="#{vt.code}"></h:outputLabel>
                                            </p:column>
                                            <p:ajax
                                                event="itemSelect"
                                                process="acItem"
                                                listener="#{pharmacyDirectPurchaseController.onItemSelect}"
                                                update="txtQty txtFreeQty txtPrate txtLineDiscountRate txtLineDiscountValue 
                                                txtRetailRate txtRetailValue txtUnitsPerPack txtPackOrUnit txtCostValue
                                                txtPurchaseValueMinusLineDiscountValue txtPurchaseValue" />

                                        </p:autoComplete>
                                    </div>
                                    <div class="col-1">
                                        <h:outputLabel 
                                            value="Quantity"
                                            class="w-100 m-1"/><br/>
                                        <p:inputText
                                            id="txtQty"
                                            class="w-100 m-1 text-end"
                                            autocomplete="off"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.quantity}">
                                            <p:ajax
                                                event="blur"
                                                process="@this"
                                                listener="#{pharmacyDirectPurchaseController.onQuantityChange}"
                                                update="txtLineDiscountValue txtPurchaseValueMinusLineDiscountValue
                                                txtRetailValue txtCostValue
                                                txtPurchaseValue txtUnitsPerPack txtPackOrUnit @this
                                                :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId}
                                                :#{p:resolveFirstComponentWithId('pageMessages', view).clientId}" />
                                        </p:inputText>
                                    </div>
                                    <div class="col-1">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            value="Free Quantity"/>
                                        <p:inputText
                                            autocomplete="off"
                                            id="txtFreeQty"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.freeQuantity}">
                                            <!--<f:convertNumber integerOnly="#{!pharmacyDirectPurchaseController.currentBillItem.item.allowFractions}" />-->
                                            <p:ajax
                                                event="blur"
                                                process="@this"
                                                update="txtLineDiscountValue txtPurchaseValueMinusLineDiscountValue txtRetailValue txtCostValue @this
                                                :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId}
                                                :#{p:resolveFirstComponentWithId('pageMessages', view).clientId}"
                                                listener="#{pharmacyDirectPurchaseController.onFreeQuantityChange}" />
                                        </p:inputText>
                                    </div>

                                    <div class="col-1">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            value="Purchase Rate" /><br/>
                                        <p:inputText
                                            id="txtPrate"
                                            autocomplete="off"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineGrossRate}">
                                            <p:ajax 
                                                event="blur"
                                                process="@this"
                                                listener="#{pharmacyDirectPurchaseController.onLineGrossRateChange}"
                                                update="txtPurchaseValue txtLineDiscountValue txtPurchaseValueMinusLineDiscountValue
                                                txtRetailValue txtCostValue
                                                txtPackOrUnit txtUnitsPerPack
                                                :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId}" />

                                        </p:inputText>
                                        <p:keyFilter for="txtFreeQty" mask="#{pharmacyDirectPurchaseController.currentBillItem.item.allowFractions ? 'num' : 'int'}" />
                                        <p:keyFilter for="txtQty" mask="#{pharmacyDirectPurchaseController.currentBillItem.item.allowFractions ? 'num' : 'int'}" />

                                    </div>
                                    <div class="col-1">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Discount Rate" /><br/>
                                        <p:inputText
                                            id="txtLineDiscountRate"
                                            autocomplete="off"
                                            onfocus="this.select()"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineDiscountRate}">
                                            <p:ajax 
                                                event="blur"
                                                process="@this"
                                                listener="#{pharmacyDirectPurchaseController.onLineDiscountRateChange}"
                                                update="txtLineDiscountValue txtPurchaseValueMinusLineDiscountValue
                                                txtRetailValue txtCostValue
                                                txtPurchaseValue txtUnitsPerPack txtPackOrUnit
                                                :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId}" />
                                        </p:inputText>
                                    </div>


                                    <div class="col-1">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Retail Rate" />
                                        <p:inputText
                                            autocomplete="off"
                                            id="txtRetailRate"
                                            onfocus="this.select()"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.retailSaleRate}">
                                            <f:convertNumber pattern="#,##0.00" />
                                            <p:ajax 
                                                event="blur"
                                                process="@this"
                                                listener="#{pharmacyDirectPurchaseController.onRetailSaleRateChange}"
                                                update="txtRetailValue txtPackOrUnit txtUnitsPerPack
                                                :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId}" />
                                        </p:inputText>
                                    </div>

                                    <div class="col-1">
                                        <p:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Date of Expiry"/>
                                        <p:calendar
                                            navigator="true"
                                            class="w-100 m-1 text-end"
                                            inputStyleClass="w-100 my-1"
                                            id="calDoe"
                                            pattern="dd MM yy"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.pharmaceuticalBillItem.doe}">
                                            <f:ajax event="dateSelect" execute="@this tmp" render="tmp" listener="#{pharmacyDirectPurchaseController.setBatch()}"/>
                                        </p:calendar>
                                    </div>
                                    <div class="col-1">
                                        <h:outputLabel
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Batch No"/>
                                        <p:inputText
                                            autocomplete="off"
                                            class="w-100 m-1"
                                            id="tmp"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.pharmaceuticalBillItem.stringValue}"  />
                                    </div>

                                    <div class="col-1">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            value="&nbsp;"></h:outputLabel>
                                        <p:commandButton
                                            id="btnAdd"
                                            value="Add"
                                            class="ui-button-success w-100"
                                            icon="fas fa-plus"
                                            action="#{pharmacyDirectPurchaseController.addItem}"
                                            process="@this" 
                                            update="itemList itemselectgrid tot focusItem :#{p:resolveFirstComponentWithId('lblGrossTotal',view).clientId} :#{p:resolveFirstComponentWithId('saleValue',view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId} msg"/>
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Pack or Unit" />
                                        <p:inputText
                                            id="txtPackOrUnit"
                                            disabled="true"
                                            autocomplete="off"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.item.class.simpleName eq 'Ampp' ? 'Pack' : 'Unit'}" />

                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Units per pack" />
                                        <h:panelGroup  id="txtUnitsPerPack" >
                                            <p:inputText
                                                rendered="#{pharmacyDirectPurchaseController.currentBillItem.item.class.simpleName eq 'Ampp'}"
                                                disabled="true"
                                                autocomplete="off"
                                                class="w-100 m-1 text-end"
                                                value="#{pharmacyDirectPurchaseController.currentBillItem.item.dblValue}">
                                            </p:inputText>
                                            <p:inputText
                                                rendered="#{pharmacyDirectPurchaseController.currentBillItem.item.class.simpleName eq 'Amp'}"
                                                disabled="true"
                                                autocomplete="off"
                                                class="w-100 m-1 text-end"
                                                value="1">
                                            </p:inputText>
                                        </h:panelGroup>
                                    </div>

                                    <div class="col-2">
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Purchase Value" /><br/>
                                        <p:inputText
                                            id="txtPurchaseValue"
                                            disabled="true"
                                            autocomplete="off"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineGrossTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </p:inputText>
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Discount" /><br/>
                                        <p:inputText
                                            id="txtLineDiscountValue"
                                            autocomplete="off"
                                            disabled="true"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineDiscount}">
                                        </p:inputText>
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Net Value" /><br/>
                                        <p:inputText
                                            id="txtPurchaseValueMinusLineDiscountValue"
                                            autocomplete="off"
                                            disabled="true"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineNetTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </p:inputText>
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Retail Value"></h:outputLabel>
                                        <p:inputText
                                            autocomplete="off"
                                            id="txtRetailValue"
                                            disabled="true"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.retailSaleRatePerUnit * pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.totalQuantityByUnits}" >
                                            <f:convertNumber pattern="#,##0.00" />
                                        </p:inputText>
                                    </div>

                                    <div class="col-1 text-end">
                                        <h:outputLabel 
                                            class="w-100 m-1"
                                            style="white-space: nowrap;"
                                            value="Cost Value"></h:outputLabel>
                                        <p:inputText
                                            autocomplete="off"
                                            id="txtCostValue"
                                            disabled="true"
                                            class="w-100 m-1 text-end"
                                            value="#{pharmacyDirectPurchaseController.currentBillItem.billItemFinanceDetails.lineCost}" >
                                            <f:convertNumber pattern="#,##0.00" />
                                        </p:inputText>
                                    </div>




                                </div>
                            </p:panel>

                            <p:dataTable
                                class="m-1 w-100"
                                rowIndexVar="i"
                                var="ph"
                                value="#{pharmacyDirectPurchaseController.billItems}"
                                id="itemList">

                                <f:facet name="header">
                                    <h:outputText styleClass="fas fa-shopping-cart" />
                                    <h:outputText class="mx-4" value="Added Items" />
                                </f:facet>

                                <p:column headerText="No" width="2em">
                                    <h:outputLabel value="#{i + 1}" />
                                </p:column>

                                <p:column
                                    id="colItem"
                                    headerText="Item" width="10em">
                                    <h:outputText value="#{ph.item.name}" />
                                    <p:commandButton id="btnViewSelectedItemDetails"
                                                     icon="pi pi-search"
                                                     title="View Item Details"
                                                     action="#{pharmacyDirectPurchaseController.displayItemDetails(ph)}"
                                                     update=":bill:tot :bill:purchaseHistory"
                                                     process="@this"
                                                     styleClass="ui-button-icon-only mx-3"/>
                                    <p:commandLink
                                        id="btnViewFinanceDetails"
                                        styleClass="mx-2"
                                        title="View Finance Details"
                                        oncomplete="PF('dialog#{i}').show()"
                                        process="@this"
                                        update="@none">
                                        <i class="fas fa-info-circle" />
                                    </p:commandLink>
                                    <p:dialog 
                                        id="dialog"
                                        position="top"
                                        widgetVar="dialog#{i}"
                                        header="Details"
                                        modal="true"
                                        closable="true"
                                        resizable="false"
                                        class="w-75"
                                        dynamic="true">
                                        <ph:bill_item_finance_details pbi="#{ph}"/>
                                    </p:dialog>
                                </p:column>

                                <p:column headerText="Qty"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.quantity}" class="w-100"/>
                                </p:column>

                                <p:column headerText="Free"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.freeQuantity}" />
                                </p:column>

                                <p:column headerText="P. Rate"  styleClass="text-end">
                                    <h:outputLabel
                                        id="txtPurchaseRateOfBillItem"
                                        value="#{ph.billItemFinanceDetails.grossRate}">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>

                                <p:column headerText="Dis. Rate"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.lineDiscountRate}" >
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>

                                <p:column headerText="RR"  styleClass="text-end">
                                    <h:outputLabel 
                                        value="#{ph.billItemFinanceDetails.retailSaleRate}">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="DOE" styleClass="text-end">
                                    <h:outputLabel value="#{ph.pharmaceuticalBillItem.doe}">
                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Batch" styleClass="text-end">
                                    <h:outputLabel value="#{ph.pharmaceuticalBillItem.stringValue}" />
                                </p:column>
                                <p:column headerText="Gross"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.lineGrossTotal}">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Discount"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.lineDiscount}">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Net"  styleClass="text-end">
                                    <h:outputLabel value="#{ph.billItemFinanceDetails.lineNetTotal}">
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </p:column>

                                <p:column headerText="Profit %"  styleClass="text-end">
                                    <h:outputText
                                        id="profMargin"
                                        value="#{ph.billItemFinanceDetails.profitMargin}"
                                        styleClass="#{pharmacyDirectPurchaseController.isProfitMarginExcessive(ph) ? 'ui-messages-fatal' : ''}">
                                        <f:convertNumber pattern="0.0" />
                                    </h:outputText>
                                </p:column>

                                <p:column>
                                    <p:commandButton class="mr-4 ui-button-danger" icon="fas fa-trash" ajax="false" action="#{pharmacyDirectPurchaseController.removeItem(ph)}" />
                                </p:column>
                            </p:dataTable>



                            <p:separator ></p:separator>

                            <p:panel header="Bill Expenses" class="my-3" >
                                <f:facet name="header">
                                    <h:outputText styleClass="fas fa-money-bill-wave" />
                                    <h:outputText class="mx-4" value="Bill Expenses" />
                                </f:facet>
                                <h:panelGroup id="billExpenseGrid">
                                    <div class="row w-100">
                                        <div class="col-4">
                                            <h:outputLabel 
                                                class="w-100 m-1"
                                                value="Select Expense"/><br/>
                                            <p:autoComplete
                                                id="acExpense"
                                                class="w-100 m-1"
                                                inputStyleClass="w-100"
                                                value="#{pharmacyDirectPurchaseController.currentExpense.item}"
                                                forceSelection="true"
                                                completeMethod="#{itemController.completeExpenseItem}"
                                                var="ex"
                                                itemLabel="#{ex.name}"
                                                itemValue="#{ex}">
                                                <p:ajax
                                                    event="itemSelect"
                                                    process="acExpense"
                                                    listener="#{pharmacyDirectPurchaseController.onExpenseItemSelect}"
                                                    update="billExpenseGrid" />
                                            </p:autoComplete>
                                        </div>
                                        <div class="col-2">
                                            <h:outputLabel 
                                                class="w-100 m-1"
                                                value="Value"/><br/>
                                            <p:inputText
                                                autocomplete="off"
                                                id="txtExpense"
                                                class="w-100 m-1 text-end"
                                                onfocus="this.select()"
                                                styleClass="numericTxt"
                                                value="#{pharmacyDirectPurchaseController.currentExpense.rate}" />
                                        </div>
                                        <div class="col-3">
                                            <h:outputLabel 
                                                class="w-100 m-1"
                                                value="Description"/><br/>
                                            <p:inputText 
                                                class="w-100 m-1"
                                                maxlength="250" 
                                                value="#{pharmacyDirectPurchaseController.currentExpense.descreption}" />
                                        </div>
                                        <div class="col-2">
                                            <h:outputLabel 
                                                class="w-100 m-1"
                                                value="Considered for Costing"/><br/>
                                            <div class="w-100 m-1 d-flex align-items-center justify-content-center" style="height: 38px;">
                                                <p:selectBooleanCheckbox value="#{pharmacyDirectPurchaseController.currentExpense.consideredForCosting}" />
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <h:outputLabel 
                                                class="w-100 m-1"
                                                value="&nbsp;"/><br/>
                                            <p:commandButton
                                                id="btnAddExpense"
                                                value="Add"
                                                icon="fas fa-plus"
                                                class="ui-button-warning w-100"
                                                action="#{pharmacyDirectPurchaseController.addExpense()}"
                                                ajax = "false"
                                                process="billExpenseGrid btnAddExpense @this"
                                                update=" billExpenseGrid @all"/>
                                        </div>
                                    </div>
                                </h:panelGroup>
                                <p:dataTable 
                                    id="tblExpenses"
                                    value="#{pharmacyDirectPurchaseController.billExpenses}" 
                                    var="be" 
                                    class="mt-2"
                                    emptyMessage="No Bill Expenses" >
                                    <p:column headerText="Expense" >
                                        <h:outputLabel value="#{be.item.name}" ></h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Value" >
                                        <h:outputLabel value="#{be.netValue}" >
                                            <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Description" >
                                        <h:outputLabel value="#{be.descreption}" ></h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Considered for Costing" >
                                        <p:selectBooleanCheckbox value="#{be.consideredForCosting}" >
                                            <p:ajax event="change"
                                                    listener="#{pharmacyDirectPurchaseController.updateExpenseCosting(be)}"
                                                    update="@parent" />
                                        </p:selectBooleanCheckbox>
                                    </p:column>
                                    <p:column headerText="Delete" >
                                        <p:commandButton
                                            id="btnRemoveExpense"
                                            title="Delete expense"
                                            styleClass="ui-button-danger"
                                            icon="pi pi-trash"
                                            action="#{pharmacyDirectPurchaseController.removeExpense(be)}"
                                            process="@this"
                                            update="tblExpenses :#{p:resolveFirstComponentWithId('billExpenseGrid',view).clientId} :#{p:resolveFirstComponentWithId('tot',view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails',view).clientId}" />

                                    </p:column>
                                </p:dataTable>
                            </p:panel>

                            <p:commandButton
                                id="nullButton"
                                value="No Action"
                                action="#"
                                style="display: none;" ></p:commandButton>

                            <p:defaultCommand  target="btnAdd" />

                        </div>
                        <div class="col-4">
                            <p:panel header="Purchasing Details" class="m-1">
                                <f:facet name="header">
                                    <h:outputText styleClass="fas fa-shopping-basket"/>
                                    <h:outputText class="mx-4" value="Purchasing Details"/>
                                </f:facet>
                                <h:panelGrid class="w-100">
                                    <p:outputLabel value="Select Supplier"/>
                                    <p:autoComplete
                                        class=" w-100 my-2"
                                        inputStyleClass="w-100"
                                        converter="deal"
                                        value="#{pharmacyDirectPurchaseController.bill.fromInstitution}"
                                        forceSelection="true"
                                        completeMethod="#{dealerController.completeActiveDealor}"
                                        var="vt"
                                        maxResults="10"
                                        itemLabel="#{vt.name}"
                                        itemValue="#{vt}" />
                                    <h:outputLabel value="Purchasing Institution"/>
                                    <p:autoComplete
                                        class=" w-100 my-2"
                                        inputStyleClass="w-100"
                                        value="#{pharmacyDirectPurchaseController.bill.referenceInstitution}"
                                        completeMethod="#{institutionController.completeCompany}"
                                        forceSelection="true"
                                        var="vt"
                                        itemLabel="#{vt.name}"
                                        itemValue="#{vt}" />

                                    <p:outputLabel value="Invoice No"/>
                                    <p:inputText class="w-100" autocomplete="off" value="#{pharmacyDirectPurchaseController.bill.invoiceNumber}" >
                                        <p:ajax process="@this" event="keyup"></p:ajax>
                                    </p:inputText>
                                    <p:outputLabel value="Invoice Date"/>
                                    <p:calendar class="w-100" 
                                                inputStyleClass="w-100" 
                                                value="#{pharmacyDirectPurchaseController.bill.invoiceDate}"  
                                                navigator="true"
                                                pattern="#{sessionController.applicationPreference.shortDateFormat}" >
                                        <p:ajax process="@this" ></p:ajax>
                                    </p:calendar>

                                    <h:outputLabel value="Payment Method" class="mb-2"/>
                                    <p:selectOneMenu style="width: 300px;" id="cmbPs" value="#{pharmacyDirectPurchaseController.bill.paymentMethod}">
                                        <f:selectItem itemLabel="Select Payment Method" />
                                        <f:selectItems value="#{enumController.paymentMethodsForGrn}" />
                                        <p:ajax event="change" process="cmbPs" ></p:ajax>
                                    </p:selectOneMenu>

                                    <p:spacer class="my-1"  rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Consignment in Pharmacy Purchasing', true)}"></p:spacer>
                                    <h:panelGroup class="my-1" rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Consignment in Pharmacy Purchasing', true)}">
                                        <p:selectBooleanCheckbox value="#{pharmacyDirectPurchaseController.bill.consignment}" itemLabel="Consignment"/>
                                    </h:panelGroup>

                                </h:panelGrid>
                            </p:panel>
                            <p:panel id="panelBillDetails" header="Bill details" class="m-1" >
                                <f:facet name="header" >
                                    <h:outputText styleClass="fas fa-receipt"/>
                                    <h:outputText  class="mx-4" value="Bill Details" />
                                </f:facet>
                                <p:tabView id="tot">
                                    <!-- Legacy Summary -->
                                    <p:tab title="Bill Summary">
                                        <p:panelGrid columns="2" >
                                            <p:outputLabel 
                                                value="Gross Total" />
                                            <p:outputLabel 
                                                id="lblGrossTotal" 
                                                value="#{pharmacyDirectPurchaseController.bill.total}" 
                                                class="w-100 text-end ui-inputfield bg-secondary text-white"
                                                />

                                            <p:outputLabel value="Tax" />
                                            <p:inputText 
                                                autocomplete="off" 
                                                id="tx" 
                                                class="w-100 text-end"
                                                value="#{pharmacyDirectPurchaseController.bill.tax}">
                                                <p:ajax 
                                                    process="tx" 
                                                    update=":#{p:resolveFirstComponentWithId('lblNetTotal', view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId} :#{p:resolveFirstComponentWithId('billExpensesTotal', view).clientId} :#{p:resolveFirstComponentWithId('expensesConsidered', view).clientId} :#{p:resolveFirstComponentWithId('expensesNotConsidered', view).clientId} :#{p:resolveFirstComponentWithId('saleValue', view).clientId} :#{p:resolveFirstComponentWithId('itemList', view).clientId}" 
                                                    event="keyup"
                                                    listener="#{pharmacyDirectPurchaseController.billDiscountChangedByUser()}" />
                                                <p:ajax 
                                                    process="tx" 
                                                    update=":#{p:resolveFirstComponentWithId('lblNetTotal', view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId} :#{p:resolveFirstComponentWithId('billExpensesTotal', view).clientId} :#{p:resolveFirstComponentWithId('expensesConsidered', view).clientId} :#{p:resolveFirstComponentWithId('expensesNotConsidered', view).clientId} :#{p:resolveFirstComponentWithId('saleValue', view).clientId} :#{p:resolveFirstComponentWithId('itemList', view).clientId}" 
                                                    event="blur"
                                                    listener="#{pharmacyDirectPurchaseController.billDiscountChangedByUser()}" />
                                                <f:convertNumber pattern="#,##0.00" />
                                            </p:inputText>

                                            <p:outputLabel value="Bill Discount" />
                                            <p:inputText 
                                                class="w-100 text-end"
                                                id="dis" 
                                                autocomplete="off" 
                                                value="#{pharmacyDirectPurchaseController.bill.discount}">
                                                <p:ajax 
                                                    process="dis" 
                                                    update=":#{p:resolveFirstComponentWithId('lblNetTotal', view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId} :#{p:resolveFirstComponentWithId('billExpensesTotal', view).clientId} :#{p:resolveFirstComponentWithId('expensesConsidered', view).clientId} :#{p:resolveFirstComponentWithId('expensesNotConsidered', view).clientId} :#{p:resolveFirstComponentWithId('saleValue', view).clientId} :#{p:resolveFirstComponentWithId('itemList', view).clientId}" 
                                                    event="keyup"
                                                    listener="#{pharmacyDirectPurchaseController.billDiscountChangedByUser()}" />
                                                <p:ajax 
                                                    process="dis" 
                                                    update=":#{p:resolveFirstComponentWithId('lblNetTotal', view).clientId} :#{p:resolveFirstComponentWithId('billFinanceDetails', view).clientId} :#{p:resolveFirstComponentWithId('billExpensesTotal', view).clientId} :#{p:resolveFirstComponentWithId('expensesConsidered', view).clientId} :#{p:resolveFirstComponentWithId('expensesNotConsidered', view).clientId} :#{p:resolveFirstComponentWithId('saleValue', view).clientId} :#{p:resolveFirstComponentWithId('itemList', view).clientId}" 
                                                    event="blur"
                                                    listener="#{pharmacyDirectPurchaseController.billDiscountChangedByUser()}" />
                                                <f:convertNumber pattern="#,##0.00" />
                                            </p:inputText>

                                            <p:outputLabel value="Bill Expenses (Considered for Costing)" />
                                            <h:outputLabel 
                                                id="expensesConsidered"
                                                class="w-100 text-end ui-inputfield bg-info text-white"
                                                value="#{pharmacyDirectPurchaseController.bill.expensesTotalConsideredForCosting}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel>

                                            <p:outputLabel value="Net Total" />

                                            <h:outputLabel 
                                                id="lblNetTotal"
                                                class="w-100 text-end ui-inputfield bg-success text-white"
                                                value="#{pharmacyDirectPurchaseController.bill.netTotal}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel>

                                            <p:outputLabel value="Bill Expenses (Not Considered for Costing)" />
                                            <h:outputLabel 
                                                id="expensesNotConsidered"
                                                class="w-100 text-end ui-inputfield bg-warning text-dark"
                                                value="#{pharmacyDirectPurchaseController.bill.expensesTotalNotConsideredForCosting}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel>

                                            <p:outputLabel value="Sale Value" />
                                            <h:outputLabel 
                                                id="saleValue"
                                                class="w-100 text-end ui-inputfield bg-primary text-white"
                                                value="#{pharmacyDirectPurchaseController.bill.saleValue}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputLabel>
                                        </p:panelGrid>
                                    </p:tab>

                                    <!-- Detailed Finance Tab -->
                                    <p:tab title="Financial Summary">
                                        <h:panelGroup id="billFinanceDetails" >
                                            <ph:bill_finance_details bill="#{pharmacyDirectPurchaseController.bill}" ></ph:bill_finance_details>
                                        </h:panelGroup>

                                    </p:tab>

                                </p:tabView>


                            </p:panel>
                        </div>
                    </div>
                    <div class="row" >
                        <div class="col-12" >
                            <h:panelGroup id="purchaseHistory">
                                <pharmacy:history/>
                            </h:panelGroup>
                        </div>
                    </div>
                </p:panel>
            </h:panelGroup>
            <h:panelGroup rendered="#{pharmacyDirectPurchaseController.printPreview}">
                <p:panel >
                    <f:facet name="header" >
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h:outputText styleClass="fa-solid fa-circle-plus" />
                                <h:outputLabel value="Direct Purchase Order" class="mx-4"></h:outputLabel>
                            </div>
                            <div>
                                <p:commandButton
                                    value="Print"
                                    ajax="false"
                                    action="#"
                                    class="ui-button-info mx-2"
                                    icon="fas fa-print">
                                    <p:printer target="gpBillPreview" ></p:printer>
                                </p:commandButton>
                                <p:commandButton
                                    rendered="#{webUserController.hasPrivilege('ChangeReceiptPrintingPaperTypes')}"
                                    value="Settings"
                                    icon="fas fa-cog"
                                    class="ui-button-secondary mx-1"
                                    type="button"
                                    onclick="PF('directPurchaseConfigDialog').show();" />
                                <p:commandButton
                                    ajax="false"
                                    class="ui-button-success"
                                    icon="fa fa-plus"
                                    action="#{pharmacyDirectPurchaseController.prepareForNewDIrectPurchaseBill()}"
                                    value="New Bill"/>

                            </div>
                        </div>
                    </f:facet>

                    <h:panelGroup id="gpBillPreview" >
                        <pharmacy:direct_purhcase
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - A4', true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:direct_purhcase>
                        <pharmacy:purhcase
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - A4 (Custom 1)', true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:purhcase>
                        <pharmacy:direct_purhcase_with_costing
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - A4 Details',true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:direct_purhcase_with_costing>
                        <pharmacy:direct_purhcase_with_costing_custom_letter
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - Custom Letter Format',true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:direct_purhcase_with_costing_custom_letter>
                        <pharmacy:direct_purhcase_with_costing_custom_1
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - Custom 1',true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:direct_purhcase_with_costing_custom_1>
                        <pharmacy:direct_purhcase_with_costing_custom_2
                            rendered="#{configOptionController.getBooleanValueByKey('Direct Purchase Bill Print - Custom 2',true)}"
                            bill="#{pharmacyDirectPurchaseController.bill}"
                            ShowProfit="#{configOptionApplicationController.getBooleanValueByKey('Show Profit % in Direct Purchase Bill', true)}"
                            ShowRetailValue="#{configOptionApplicationController.getBooleanValueByKey('Show Retail Value in Direct Purchase Bill', true)}">
                        </pharmacy:direct_purhcase_with_costing_custom_2>
                    </h:panelGroup>
                </p:panel>
            </h:panelGroup>



        </h:form>

        <!-- Direct Purchase Configuration Dialog -->
        <p:dialog id="directPurchaseConfigDialog"
                  header="Direct Purchase Printer Configuration"
                  widgetVar="directPurchaseConfigDialog"
                  modal="true"
                  width="600"
                  height="400"
                  resizable="true"
                  maximizable="true"
                  closeOnEscape="true">

            <p:ajax event="open" listener="#{pharmacyConfigController.loadCurrentConfig}" update="directPurchaseConfigForm" />

            <h:form id="directPurchaseConfigForm">

                <div class="row">
                    <div class="col-12">
                        <div class="card config-section">
                            <div class="card-header">
                                <h6><i class="fas fa-file-alt"></i> Direct Purchase Paper Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseA4Paper"
                                        value="#{pharmacyConfigController.directPurchaseA4Paper}" />
                                    <p:outputLabel for="directPurchaseA4Paper" value="A4 Paper Format" class="ms-2" />
                                    <small class="form-text text-muted d-block">Standard A4 paper format for direct purchase bills</small>
                                </div>
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseA4PaperCustom1"
                                        value="#{pharmacyConfigController.directPurchaseA4PaperCustom1}" />
                                    <p:outputLabel for="directPurchaseA4PaperCustom1" value="Direct Purchase Bill Print - A4 (Custom 1)" class="ms-2" />
                                    <small class="form-text text-muted d-block">Standard A4 paper (Custom 1) format for direct purchase bills</small>
                                </div>
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseA4Details"
                                        value="#{pharmacyConfigController.directPurchaseA4Details}" />
                                    <p:outputLabel for="directPurchaseA4Details" value="A4 Paper Format with Details" class="ms-2" />
                                    <small class="form-text text-muted d-block">A4 format with detailed information display</small>
                                </div>
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseCustomLetter"
                                        value="#{pharmacyConfigController.directPurchaseCustomLetter}" />
                                    <p:outputLabel for="directPurchaseCustomLetter" value="Custom Letter Format" class="ms-2" />
                                    <small class="form-text text-muted d-block">Custom letter size paper format with costing details</small>
                                </div>
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseCustom1"
                                        value="#{pharmacyConfigController.directPurchaseCustom1}" />
                                    <p:outputLabel for="directPurchaseCustom1" value="Custom Format 1" class="ms-2" />
                                    <small class="form-text text-muted d-block">Custom paper format 1 with costing details</small>
                                </div>
                                <div class="mb-3">
                                    <p:selectBooleanCheckbox
                                        id="directPurchaseCustom2"
                                        value="#{pharmacyConfigController.directPurchaseCustom2}" />
                                    <p:outputLabel for="directPurchaseCustom2" value="Custom Format 2" class="ms-2" />
                                    <small class="form-text text-muted d-block">Custom paper format 2 with costing details</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <p:messages id="directPurchaseConfigMessages" showDetail="true" closable="true" />
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-2">
                                        <p:commandButton
                                            value="Apply &amp; Close"
                                            icon="fas fa-save"
                                            class="ui-button-success"
                                            ajax="false"
                                            action="#{pharmacyConfigController.saveDirectPurchaseConfig}" />
                                        <p:commandButton
                                            value="Cancel"
                                            icon="fas fa-times"
                                            class="ui-button-secondary"
                                            onclick="PF('directPurchaseConfigDialog').hide(); return false;"
                                            type="button" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
