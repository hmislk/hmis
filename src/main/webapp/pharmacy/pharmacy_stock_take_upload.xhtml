<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head>
        <style>
            .border-dashed {
                border-style: dashed !important;
            }
            
            .upload-area:hover {
                background-color: #e9ecef !important;
                transition: background-color 0.3s ease;
            }
            
            .download-option {
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                padding: 1rem;
                background-color: #fff;
            }
            
            .info-item {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .font-weight-medium {
                font-weight: 500;
            }
            
            .opacity-75 {
                opacity: 0.75;
            }
            
            @media (max-width: 768px) {
                .download-option {
                    margin-bottom: 1rem;
                }
                
                .info-item {
                    flex-direction: column;
                    align-items: flex-start;
                }
                
                .info-item span {
                    margin-left: 0 !important;
                    margin-top: 0.25rem;
                }
            }
        </style>
    </h:head>
    <h:body>
        <ui:composition template="/pharmacy/adjustments/pharmacy_adjustment_index.xhtml">
            <ui:define name="subcontent">
                <div class="container-fluid">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-upload fa-lg mr-3"></i>
                                <div>
                                    <h:outputText value="Upload Stock Adjustments" styleClass="h4 mb-0"/>
                                    <small class="d-block opacity-75">Import physical stock count data from Excel sheets</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h:panelGroup rendered="#{empty pharmacyStockTakeController.snapshotBill}">
                                <div class="alert alert-warning d-flex align-items-center">
                                    <i class="fa fa-exclamation-triangle fa-lg mr-3"></i>
                                    <div>
                                        <strong>No Snapshot Bill Selected</strong>
                                        <p class="mb-0">Please go back to the stock take list and choose a snapshot bill to proceed with the upload.</p>
                                    </div>
                                </div>
                            </h:panelGroup>

                            <h:panelGroup rendered="#{not empty pharmacyStockTakeController.snapshotBill}">
                                <div class="card bg-light mb-4">
                                    <div class="card-body">
                                        <h:outputText value="Snapshot Bill Information" styleClass="h5 mb-3 text-primary"/>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="info-item mb-2">
                                                    <i class="fa fa-building text-muted mr-2"></i>
                                                    <strong>Institution:</strong>
                                                    <span class="ml-2">#{pharmacyStockTakeController.snapshotBill.institution.name}</span>
                                                </div>
                                                <div class="info-item mb-2">
                                                    <i class="fa fa-sitemap text-muted mr-2"></i>
                                                    <strong>Department:</strong>
                                                    <span class="ml-2">#{pharmacyStockTakeController.snapshotBill.department.name}</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="info-item mb-2">
                                                    <i class="fa fa-file-alt text-muted mr-2"></i>
                                                    <strong>Bill No:</strong>
                                                    <span class="ml-2 badge badge-secondary" style="font-family: monospace;">#{pharmacyStockTakeController.snapshotBill.deptId}</span>
                                                </div>
                                                <div class="info-item mb-2">
                                                    <i class="fa fa-calendar text-muted mr-2"></i>
                                                    <strong>Created:</strong>
                                                    <span class="ml-2">
                                                        <h:outputText value="#{pharmacyStockTakeController.snapshotBill.createdAt}">
                                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}"/>
                                                        </h:outputText>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h:form id="frmDownloads">
                                    <div class="card mb-4">
                                        <div class="card-header bg-info text-white">
                                            <i class="fa fa-download mr-2"></i>
                                            <strong>Download Stock Count Sheets</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3 mb-md-0">
                                                    <div class="download-option h-100">
                                                        <div class="mb-2">
                                                            <i class="fa fa-eye text-success mr-2"></i>
                                                            <strong>Guided Sheet</strong>
                                                        </div>
                                                        <p class="text-muted mb-3">Includes current system quantities for reference during counting</p>
                                                        <p:commandButton value="Download Guided Sheet" ajax="false" 
                                                                       styleClass="ui-button-success ui-button-lg" 
                                                                       icon="fa fa-download" 
                                                                       onclick="PrimeFaces.monitorDownload(start, stop);">
                                                            <p:fileDownload value="#{pharmacyStockTakeController.downloadGuidedSheet}" />
                                                        </p:commandButton>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="download-option h-100">
                                                        <div class="mb-2">
                                                            <i class="fa fa-eye-slash text-warning mr-2"></i>
                                                            <strong>Blind Sheet</strong>
                                                        </div>
                                                        <p class="text-muted mb-3">No system quantities shown - for unbiased physical counting</p>
                                                        <p:commandButton value="Download Blind Sheet" ajax="false" 
                                                                       styleClass="ui-button-warning ui-button-lg" 
                                                                       icon="fa fa-download" 
                                                                       onclick="PrimeFaces.monitorDownload(start, stop);">
                                                            <p:fileDownload value="#{pharmacyStockTakeController.downloadBlindSheet}" />
                                                        </p:commandButton>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </h:form>

                                <h:form id="frmUpload" enctype="multipart/form-data">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <i class="fa fa-upload mr-2"></i>
                                            <strong>Upload Completed Physical Count Sheet</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="upload-instructions mb-4">
                                                <div class="alert alert-info">
                                                    <i class="fa fa-info-circle mr-2"></i>
                                                    <strong>Instructions:</strong>
                                                    <ul class="mb-0 mt-2">
                                                        <li>Upload the Excel file with completed physical counts</li>
                                                        <li>Ensure all quantities are filled in the "Physical Count" column</li>
                                                        <li>File must be in Excel format (.xlsx or .xls)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <div class="upload-area p-4 border-dashed border-2 border-secondary rounded text-center mb-3" 
                                                 style="background-color: #f8f9fa;">
                                                <i class="fa fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                <div class="mb-3">
                                                    <p:fileUpload value="#{pharmacyStockTakeController.file}" 
                                                                mode="simple" 
                                                                label="Choose Excel File"
                                                                styleClass="ui-button-lg ui-button-outlined"/>
                                                </div>
                                                <p class="text-muted mb-0">Select your completed stock count Excel file</p>
                                            </div>
                                            
                                            <div class="text-center">
                                                <p:commandButton value="Process Upload &amp; Generate Preview" 
                                                               icon="fa fa-upload" 
                                                               styleClass="ui-button-success ui-button-lg"
                                                               actionListener="#{pharmacyStockTakeController.parseUploadedSheet()}" 
                                                               update=":frmPreview"/>
                                            </div>
                                        </div>
                                    </div>
                                </h:form>

                                <h:form id="frmPreview">
                                    <h:panelGroup rendered="#{not empty pharmacyStockTakeController.physicalCountBill and not empty pharmacyStockTakeController.physicalCountBill.billItems}">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <i class="fa fa-table mr-2"></i>
                                                <strong>Physical Count Results Preview</strong>
                                                <small class="ml-2 opacity-75">Review the parsed data before saving</small>
                                            </div>
                                            <div class="card-body p-0">
                                                <p:dataTable value="#{pharmacyStockTakeController.physicalCountBill.billItems}" var="bi"
                                                             rows="25" paginator="true"
                                                             paginatorPosition="both"
                                                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                             rowsPerPageTemplate="10,25,50,100"
                                                             styleClass="ui-datatable-striped ui-datatable-gridlines"
                                                             responsiveLayout="scroll">
                                                    <p:column headerText="Item Code" style="min-width: 100px;" styleClass="font-weight-bold">
                                                        <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.item.code}" 
                                                                    styleClass="badge badge-light"/>
                                                    </p:column>
                                                    <p:column headerText="Item Name" style="min-width: 200px;">
                                                        <h:outputText value="#{bi.item.name}" styleClass="font-weight-medium"/>
                                                    </p:column>
                                                    <p:column headerText="Batch No" style="width: 120px; text-align:center;">
                                                        <h:outputText value="#{bi.pharmaceuticalBillItem.itemBatch.batchNo}" 
                                                                    styleClass="badge badge-info"/>
                                                    </p:column>
                                                    <p:column headerText="System Qty" style="width: 100px; text-align:right;">
                                                        <h:outputText value="#{bi.referanceBillItem.qty}" 
                                                                    styleClass="font-weight-bold text-primary">
                                                            <f:convertNumber integerOnly="true"/>
                                                        </h:outputText>
                                                    </p:column>
                                                    <p:column headerText="Physical Qty" style="width: 100px; text-align:right;">
                                                        <h:outputText value="#{bi.qty}" 
                                                                    styleClass="font-weight-bold text-success">
                                                            <f:convertNumber integerOnly="true"/>
                                                        </h:outputText>
                                                    </p:column>
                                                    <p:column headerText="Variance" style="width: 100px; text-align:right;">
                                                        <h:outputText value="#{bi.adjustedValue}" 
                                                                    styleClass="font-weight-bold #{bi.adjustedValue gt 0 ? 'text-success' : (bi.adjustedValue lt 0 ? 'text-danger' : 'text-muted')}">
                                                            <f:convertNumber integerOnly="true"/>
                                                        </h:outputText>
                                                    </p:column>
                                                </p:dataTable>
                                            </div>
                                            <div class="card-footer bg-light">
                                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                                    <div class="text-muted mb-2 mb-md-0">
                                                        <i class="fa fa-info-circle mr-2" aria-hidden="true"></i>
                                                        Review all variances before saving or approving
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <p:commandButton value="Save Physical Count" 
                                                                       icon="fa fa-save" 
                                                                       styleClass="ui-button-success ui-button-lg mr-2"
                                                                       title="Persist the current physical count entries"
                                                                       ajax="false" 
                                                                       action="#{pharmacyStockTakeController.savePhysicalCount}"/>

                                                        <p:commandButton value="Approve &amp; Post Adjustments (Background)"
                                                                       icon="fa fa-check"
                                                                       styleClass="ui-button-warning ui-button-lg mr-2"
                                                                       title="Approve this physical count and create stock adjustment entries"
                                                                       ajax="false"
                                                                       rendered="#{webUserController.hasPrivilege('PharmacyStockTakeApprove') and not empty pharmacyStockTakeController.physicalCountBill and not empty pharmacyStockTakeController.physicalCountBill.billItems}"
                                                                       onclick="return confirm('Approve this physical count and post stock adjustments?');"
                                                                       action="#{pharmacyStockTakeController.startApprovePhysicalCountAsync}"/>

                                                        <p:commandButton value="Reject"
                                                                       icon="fa fa-times"
                                                                       styleClass="ui-button-secondary ui-button-lg"
                                                                       title="Reject this physical count without posting adjustments"
                                                                       ajax="false"
                                                                       rendered="#{webUserController.hasPrivilege('PharmacyStockTakeApprove') and not empty pharmacyStockTakeController.physicalCountBill}"
                                                                       onclick="return confirm('Reject this physical count?');"
                                                                       action="#{pharmacyStockTakeController.rejectPhysicalCount}"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <h:panelGroup id="approvalProgressPanel">
                                                <h:panelGroup rendered="#{pharmacyStockTakeController.approvalRunning}">
                                                    <div class="alert alert-info mt-3" role="alert">
                                                        <div class="d-flex align-items-center">
                                                            <i class="fa fa-spinner fa-spin mr-2" aria-hidden="true"></i>
                                                            <span>Approval in progress: #{pharmacyStockTakeController.approvalStatusText}</span>
                                                        </div>
                                                        <div class="mt-2">
                                                            <p:progressBar value="#{pharmacyStockTakeController.approvalProgressPercent}" displayOnly="true"/>
                                                        </div>
                                                    </div>
                                                    <p:poll interval="2" update="approvalProgressPanel"/>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{not pharmacyStockTakeController.approvalRunning and pharmacyStockTakeController.approvalStatusText eq 'Completed'}">
                                                    <div class="alert alert-success mt-3" role="alert">
                                                        <i class="fa fa-check mr-2" aria-hidden="true"></i>
                                                        Approval completed successfully.
                                                    </div>
                                                </h:panelGroup>
                                            </h:panelGroup>
                                        </div>
                                    </h:panelGroup>
                                </h:form>
                            </h:panelGroup>
                        </div>
                    </div>
                </div>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
