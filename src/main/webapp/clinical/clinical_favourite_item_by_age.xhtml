<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:autocomplete="http://xmlns.jcp.org/jsf/composite/autocomplete">

    <h:body>

        <ui:composition template="/emr/admin/index.xhtml">

            <ui:define name="subcontent">

                <h:form >
                    <p:panel  >
                        <f:facet name="header" >
                            <h:outputText value="Manage Favourite Medicines By Age" >
                            </h:outputText>
                        </f:facet>

                        <h:panelGrid columns="4" >
                            <p:outputLabel value="Select Medicine" ></p:outputLabel>

                            <p:autoComplete id="acItem"
                                            value="#{favouriteController.item}"
                                            forceSelection="true" class="mx-4 w-100" inputStyleClass="w-100"
                                            completeMethod="#{itemController.completeMedicineByTypePriority}"
                                            var="vt" itemLabel="#{vt.name}" itemValue="#{vt}" >
                                <p:column headerText="Item" >
                                    <h:outputLabel value="#{vt.name}"></h:outputLabel>
                                </p:column>
                                <p:ajax event="itemSelect" process="@this" update="tab"
                                        listener="#{favouriteController.onItemSelected}" />
                            </p:autoComplete>
                            
                            <p:commandButton value="Add New"
                                             class="ui-button-success mx-4" icon="fas fa-plus"
                                             onclick="PF('dlg2').show();"
                                             action="#{favouriteController.prepareAddingFavouriteItem()}" >
                            </p:commandButton>
                        </h:panelGrid>
                        <p:dialog
                            id="dlgFavioriteMedicines"
                            header="Add Favourite Medicine" widgetVar="dlg2" modal="true" width="600px" responsive="true">
                            <h:panelGrid id="tab" columns="2" styleClass="w-100 p-3" columnClasses="p-2,p-2">

                                <!-- Medicine Information Section -->
                                <p:outputLabel value="Selected Medicine:" styleClass="font-weight-bold" />
                                <h:outputText value="#{favouriteController.item.name}" styleClass="text-primary font-weight-bold" />

                                <!-- AMP/VMP Information Section -->
                                <h:panelGroup rendered="#{favouriteController.selectedItemAmpOrVmp}">
                                    <p:outputLabel value="Medicine Type:" styleClass="font-weight-bold" />
                                    <h:panelGroup styleClass="bg-info text-white p-2 rounded w-100">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <h:outputText value="#{favouriteController.item.medicineType}" styleClass="font-weight-bold" />
                                        <h:outputText value=" - Properties are read-only (taken from medicine definition)" styleClass="small" />
                                    </h:panelGroup>
                                </h:panelGroup>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Age Range Section -->
                                <p:outputLabel value="From Age (Days):" for="fromDays" styleClass="font-weight-bold" />
                                <h:panelGroup>
                                    <p:inputText id="fromDays" value="#{favouriteController.current.fromDays}"
                                                 styleClass="w-100 mb-1" placeholder="Enter age in days">
                                        <p:ajax event="keyup" update="fromAgeDisplay" />
                                        <p:ajax event="blur" update="fromAgeDisplay" />
                                    </p:inputText>
                                    <h:panelGroup id="fromAgeDisplay" layout="block" styleClass="text-muted small mt-1">
                                        <i class="fas fa-info-circle"></i>
                                        <h:outputText value=" Approximately: " />
                                        <h:outputText value="#{favouriteController.current.fromDays / 365}"
                                                      rendered="#{favouriteController.current.fromDays >= 365}">
                                            <f:convertNumber pattern="0.0" />
                                        </h:outputText>
                                        <h:outputText value=" years"
                                                      rendered="#{favouriteController.current.fromDays >= 365}" />
                                        <h:outputText value="#{favouriteController.current.fromDays / 30}"
                                                      rendered="#{favouriteController.current.fromDays >= 30 and favouriteController.current.fromDays &lt; 365}">
                                            <f:convertNumber pattern="0.0" />
                                        </h:outputText>
                                        <h:outputText value=" months"
                                                      rendered="#{favouriteController.current.fromDays >= 30 and favouriteController.current.fromDays &lt; 365}" />
                                        <h:outputText value="#{favouriteController.current.fromDays} days"
                                                      rendered="#{favouriteController.current.fromDays &lt; 30 and favouriteController.current.fromDays > 0}" />
                                    </h:panelGroup>
                                </h:panelGroup>

                                <p:outputLabel value="To Age (Days):" for="toDays" styleClass="font-weight-bold" />
                                <h:panelGroup>
                                    <p:inputText id="toDays" value="#{favouriteController.current.toDays}"
                                                 styleClass="w-100 mb-1" placeholder="Enter age in days">
                                        <p:ajax event="keyup" update="toAgeDisplay" />
                                        <p:ajax event="blur" update="toAgeDisplay" />
                                    </p:inputText>
                                    <h:panelGroup id="toAgeDisplay" layout="block" styleClass="text-muted small mt-1">
                                        <i class="fas fa-info-circle"></i>
                                        <h:outputText value=" Approximately: " />
                                        <h:outputText value="#{favouriteController.current.toDays / 365}"
                                                      rendered="#{favouriteController.current.toDays >= 365}">
                                            <f:convertNumber pattern="0.0" />
                                        </h:outputText>
                                        <h:outputText value=" years"
                                                      rendered="#{favouriteController.current.toDays >= 365}" />
                                        <h:outputText value="#{favouriteController.current.toDays / 30}"
                                                      rendered="#{favouriteController.current.toDays >= 30 and favouriteController.current.toDays &lt; 365}">
                                            <f:convertNumber pattern="0.0" />
                                        </h:outputText>
                                        <h:outputText value=" months"
                                                      rendered="#{favouriteController.current.toDays >= 30 and favouriteController.current.toDays &lt; 365}" />
                                        <h:outputText value="#{favouriteController.current.toDays} days"
                                                      rendered="#{favouriteController.current.toDays &lt; 30 and favouriteController.current.toDays > 0}" />
                                    </h:panelGroup>
                                </h:panelGroup>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Category Section -->
                                <p:outputLabel value="Medicine Category:" for="category" styleClass="font-weight-bold" />
                                <h:panelGroup>
                                    <!-- Read-only display for AMP/VMP -->
                                    <h:outputText value="#{favouriteController.current.category.name}"
                                                  styleClass="w-100 form-control-plaintext text-muted"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.category != null}" />
                                    <h:outputText value="Not specified from selected medicine"
                                                  styleClass="w-100 form-control-plaintext text-muted font-italic"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.category == null}" />

                                    <!-- Editable dropdown for other types -->
                                    <p:selectOneMenu id="category" value="#{favouriteController.current.category}"
                                                     styleClass="w-100" autoWidth="false"
                                                     rendered="#{not favouriteController.selectedItemAmpOrVmp}">
                                        <f:selectItem itemLabel="Select Category" />
                                        <f:selectItems value="#{pharmaceuticalItemCategoryController.items}"
                                                       var="myItem" itemValue="#{myItem}" itemLabel="#{myItem.name}" />
                                    </p:selectOneMenu>
                                </h:panelGroup>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Dosage Section -->
                                <p:outputLabel value="Dose:" for="dose" styleClass="font-weight-bold" />
                                <p:inputText id="dose" value="#{favouriteController.current.dose}"
                                             styleClass="w-100" placeholder="Enter dose amount" />

                                <p:outputLabel value="Dose Unit:" for="doseUnit" styleClass="font-weight-bold" />
                                <h:panelGroup>
                                    <!-- Read-only display for AMP/VMP -->
                                    <h:outputText value="#{favouriteController.current.doseUnit.name}"
                                                  styleClass="w-100 form-control-plaintext text-muted"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.doseUnit != null}" />
                                    <h:outputText value="Not specified from selected medicine"
                                                  styleClass="w-100 form-control-plaintext text-muted font-italic"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.doseUnit == null}" />

                                    <!-- Editable dropdown for other types -->
                                    <p:selectOneMenu id="doseUnit" value="#{favouriteController.current.doseUnit}"
                                                     styleClass="w-100" autoWidth="false"
                                                     rendered="#{not favouriteController.selectedItemAmpOrVmp}">
                                        <f:selectItem itemLabel="Select Dose Unit" />
                                        <f:selectItems value="#{measurementUnitController.items}"
                                                       var="myItem" itemValue="#{myItem}" itemLabel="#{myItem.name}" />
                                    </p:selectOneMenu>
                                </h:panelGroup>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Frequency Section -->
                                <p:outputLabel value="Frequency:" for="frequency" styleClass="font-weight-bold" />
                                <p:selectOneMenu id="frequency" value="#{favouriteController.current.frequencyUnit}"
                                                 styleClass="w-100" autoWidth="false">
                                    <f:selectItem itemLabel="Select Frequency" />
                                    <f:selectItems value="#{measurementUnitController.frequencyUnits}"
                                                   var="myItem" itemValue="#{myItem}" itemLabel="#{myItem.name}" />
                                </p:selectOneMenu>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Duration Section -->
                                <p:outputLabel value="Duration:" for="duration" styleClass="font-weight-bold" />
                                <p:inputText id="duration" value="#{favouriteController.current.duration}"
                                             styleClass="w-100" placeholder="Enter duration" />

                                <p:outputLabel value="Duration Unit:" for="durationUnit" styleClass="font-weight-bold" />
                                <p:selectOneMenu id="durationUnit" value="#{favouriteController.current.durationUnit}"
                                                 styleClass="w-100" autoWidth="false">
                                    <f:selectItem itemLabel="Select Duration Unit" />
                                    <f:selectItems value="#{measurementUnitController.durationUnits}"
                                                   var="myItem" itemValue="#{myItem}" itemLabel="#{myItem.name}" />
                                </p:selectOneMenu>

                                <!-- Section Separator -->
                                <h:outputText value="" styleClass="d-block mt-3" />
                                <h:outputText value="" styleClass="d-block mt-3" />

                                <!-- Issue Quantity Section -->
                                <p:outputLabel value="Issue Quantity:" for="issueQty" styleClass="font-weight-bold" />
                                <p:inputText id="issueQty" value="#{favouriteController.current.issue}"
                                             styleClass="w-100" placeholder="Enter quantity to issue" />

                                <p:outputLabel value="Issue Unit:" for="issueUnit" styleClass="font-weight-bold" />
                                <h:panelGroup>
                                    <!-- Read-only display for AMP/VMP -->
                                    <h:outputText value="#{favouriteController.current.issueUnit.name}"
                                                  styleClass="w-100 form-control-plaintext text-muted"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.issueUnit != null}" />
                                    <h:outputText value="Not specified from selected medicine"
                                                  styleClass="w-100 form-control-plaintext text-muted font-italic"
                                                  rendered="#{favouriteController.selectedItemAmpOrVmp and favouriteController.current.issueUnit == null}" />

                                    <!-- Editable dropdown for other types -->
                                    <p:selectOneMenu id="issueUnit" value="#{favouriteController.current.issueUnit}"
                                                     styleClass="w-100" autoWidth="false"
                                                     rendered="#{not favouriteController.selectedItemAmpOrVmp}">
                                        <f:selectItem itemLabel="Select Issue Unit" />
                                        <f:selectItems value="#{measurementUnitController.issueUnits}"
                                                       var="myItem" itemValue="#{myItem}" itemLabel="#{myItem.name}" />
                                    </p:selectOneMenu>
                                </h:panelGroup>

                            </h:panelGrid>
                            <f:facet name="footer">
                                <p:commandButton styleClass="ui-button-success" ajax="false"
                                                 icon="fas fa-save" value="Save Favourite Medicine"
                                                 action="#{favouriteController.saveFavMedicine}" />
                                <p:commandButton styleClass="ui-button-secondary ml-2"
                                                 icon="fas fa-times" value="Cancel"
                                                 onclick="PF('dlg2').hide(); return false;" />
                            </f:facet>
                        </p:dialog>



                        <p:dataTable value="#{favouriteController.items}" var="fi" styleClass="w-100" paginator="true" rows="10">
                            <p:column  >
                                <f:facet name="header" >
                                    <i class="fas fa-baby mr-1"></i>
                                    <h:outputText value="From Age" ></h:outputText>
                                </f:facet>
                                <h:panelGroup>
                                    <h:outputText value="#{fi.fromDays}" styleClass="font-weight-bold">
                                        <f:convertNumber pattern="0.#" />
                                    </h:outputText>
                                    <h:outputText value=" days" styleClass="text-muted" />
                                    <h:outputText value=" (" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 30}" />
                                    <h:outputText value="#{fi.fromDays / 365}" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 365}">
                                        <f:convertNumber pattern="0.0" />
                                    </h:outputText>
                                    <h:outputText value=" yrs" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 365}" />
                                    <h:outputText value="#{fi.fromDays / 30}" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 30 and fi.fromDays &lt; 365}">
                                        <f:convertNumber pattern="0.0" />
                                    </h:outputText>
                                    <h:outputText value=" mos" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 30 and fi.fromDays &lt; 365}" />
                                    <h:outputText value=")" styleClass="text-muted small"
                                                  rendered="#{fi.fromDays >= 30}" />
                                </h:panelGroup>
                            </p:column>
                            <p:column  >
                                <f:facet name="header" >
                                    <i class="fas fa-child mr-1"></i>
                                    <h:outputText value="To Age" ></h:outputText>
                                </f:facet>
                                <h:panelGroup>
                                    <h:outputText value="#{fi.toDays}" styleClass="font-weight-bold">
                                        <f:convertNumber pattern="0.#" />
                                    </h:outputText>
                                    <h:outputText value=" days" styleClass="text-muted" />
                                    <h:outputText value=" (" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 30}" />
                                    <h:outputText value="#{fi.toDays / 365}" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 365}">
                                        <f:convertNumber pattern="0.0" />
                                    </h:outputText>
                                    <h:outputText value=" yrs" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 365}" />
                                    <h:outputText value="#{fi.toDays / 30}" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 30 and fi.toDays &lt; 365}">
                                        <f:convertNumber pattern="0.0" />
                                    </h:outputText>
                                    <h:outputText value=" mos" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 30 and fi.toDays &lt; 365}" />
                                    <h:outputText value=")" styleClass="text-muted small"
                                                  rendered="#{fi.toDays >= 30}" />
                                </h:panelGroup>
                            </p:column>
                            <p:column  >
                                <f:facet name="header" >
                                    <i class="fas fa-pills mr-1"></i>
                                    <h:outputText value="Medicine" ></h:outputText>
                                </f:facet>
                                <h:outputText value="#{fi.item.name}" styleClass="font-weight-bold text-primary" ></h:outputText>
                            </p:column>
                            <p:column >
                                <f:facet name="header" >
                                    <i class="fas fa-tag mr-1"></i>
                                    <h:outputText value="Category" ></h:outputText>
                                </f:facet>
                                <h:outputText value="#{fi.category}" ></h:outputText>
                            </p:column>
                            <p:column >
                                <f:facet name="header" >
                                    <i class="fas fa-prescription-bottle mr-1"></i>
                                    <h:outputText value="Dosage" ></h:outputText>
                                </f:facet>
                                <h:panelGroup>
                                    <h:outputText value="#{fi.dose}" >
                                        <f:convertNumber pattern="0.#" />
                                    </h:outputText>
                                    <h:outputText value=" " />
                                    <h:outputText value="#{fi.doseUnit.name}" styleClass="text-muted" />
                                </h:panelGroup>
                            </p:column>
                            <p:column >
                                <f:facet name="header" >
                                    <i class="fas fa-clock mr-1"></i>
                                    <h:outputText value="Frequency" ></h:outputText>
                                </f:facet>
                                <h:outputText value="#{fi.frequencyUnit.name}" ></h:outputText>
                            </p:column>
                            <p:column >
                                <f:facet name="header" >
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    <h:outputText value="Duration" ></h:outputText>
                                </f:facet>
                                <h:panelGroup>
                                    <h:outputText value="#{fi.duration}" >
                                        <f:convertNumber pattern="0.#" />
                                    </h:outputText>
                                    <h:outputText value=" " />
                                    <h:outputText value="#{fi.durationUnit.name}" styleClass="text-muted" />
                                </h:panelGroup>
                            </p:column>
                            <p:column >
                                <f:facet name="header" >
                                    <i class="fas fa-box mr-1"></i>
                                    <h:outputText value="Issue Quantity" ></h:outputText>
                                </f:facet>
                                <h:panelGroup>
                                    <h:outputText value="#{fi.issue}" >
                                        <f:convertNumber pattern="0.#" />
                                    </h:outputText>
                                    <h:outputText value=" " />
                                    <h:outputText value="#{fi.issueUnit.name}" styleClass="text-muted" />
                                </h:panelGroup>
                            </p:column>

                        </p:dataTable>

                    </p:panel>
                </h:form>
            </ui:define>

        </ui:composition>

    </h:body>
</html>
