<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
        <h:outputStylesheet>
            .printTable {
                border-collapse: collapse;
                font-size: 11px !important;
                width: 100%;
            }
            .printTable th, .printTable td {
                border: 1px solid black;
                padding: 4px 6px;
            }
            .printTable th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            .text-end {
                text-align: right;
            }
            .text-center {
                text-align: center;
            }
            .font-weight-bold {
                font-weight: bold;
            }
            .payment-method-header {
                background-color: #6c757d !important;
                color: white !important;
                font-weight: bold;
            }
            .category-header {
                background-color: #e9ecef !important;
                font-weight: 500;
                padding-left: 20px !important;
            }
            .category-subtotal {
                background-color: #bee5eb !important;
                font-weight: bold;
            }
            .payment-method-total {
                background-color: #fff3cd !important;
                font-weight: bold;
            }
            .grand-total {
                background-color: #d4edda !important;
                font-weight: bold;
                font-size: 12px !important;
            }
            .data-row td:first-child {
                padding-left: 30px !important;
            }
            .report-header {
                text-align: center;
                margin-bottom: 15px;
            }
            .report-header h2 {
                margin: 5px 0;
            }
            .report-header p {
                margin: 3px 0;
                color: #666;
            }
            .screenOnly {
                display: none;
            }
            @media screen {
                .screenOnly {
                    display: inline-block;
                }
            }
            @media print {
                .screenOnly {
                    display: none !important;
                }
                body {
                    margin: 0;
                    padding: 10px;
                }
            }
        </h:outputStylesheet>
    </h:head>

    <h:body>
        <ui:composition template="/resources/template/template_contents_only.xhtml">
            <ui:define name="content">
                <h:form>
                    <p:commandButton
                        value="Print"
                        onclick="window.print();"
                        class="screenOnly ui-button-warning m-1"
                        icon="pi pi-print"/>

                    <p:button
                        value="Back to Report"
                        outcome="hospital_doctor_fee_report"
                        class="screenOnly ui-button-secondary m-1"
                        icon="pi pi-arrow-left"/>

                    <div class="report-header">
                        <h2>
                            <h:outputText value="#{sessionController.institution.name}" />
                        </h2>
                        <h3>Hospital Fee &amp; Doctor Fee Report</h3>
                        <p>
                            From: <h:outputText value="#{opdReportController.fromDate}">
                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                            </h:outputText>
                            &nbsp;&nbsp;|&nbsp;&nbsp;
                            To: <h:outputText value="#{opdReportController.toDate}">
                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateTimeFormat}" />
                            </h:outputText>
                        </p>
                        <p>
                            <h:outputText value="User: #{opdReportController.webUser.webUserPerson.name}" rendered="#{opdReportController.webUser != null}" />
                            <h:outputText value=" | " rendered="#{opdReportController.webUser != null and opdReportController.institution != null}" />
                            <h:outputText value="Institution: #{opdReportController.institution.name}" rendered="#{opdReportController.institution != null}" />
                            <h:outputText value=" | " rendered="#{opdReportController.institution != null and opdReportController.department != null}" />
                            <h:outputText value="Department: #{opdReportController.department.name}" rendered="#{opdReportController.department != null}" />
                        </p>
                    </div>

                    <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos != null and not empty opdReportController.hospitalDoctorFeeReportDtos}">

                        <table class="printTable">
                            <thead>
                                <tr>
                                    <th style="width: 180px;">Patient Name</th>
                                    <th style="width: 150px;">Doctor Name</th>
                                    <th style="width: 80px;">Bill Type</th>
                                    <th style="width: 100px;" class="text-end">Hospital Fee</th>
                                    <th style="width: 100px;" class="text-end">Doctor Fee</th>
                                    <th style="width: 100px;" class="text-end">Net Total</th>
                                    <th style="width: 90px;">Bill Date</th>
                                    <th style="width: 100px;">Payment Method</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ui:repeat value="#{opdReportController.hospitalDoctorFeeBundle.nestedPaymentMethodGroups.entrySet()}"
                                           var="paymentEntry">

                                    <tr class="payment-method-header">
                                        <td colspan="8">
                                            #{paymentEntry.key.label} Payment Method
                                        </td>
                                    </tr>

                                    <ui:repeat value="#{paymentEntry.value.entrySet()}" var="categoryEntry">

                                        <tr class="category-header">
                                            <td colspan="8">
                                                #{categoryEntry.key == 'BILL' ? 'Normal Bills' :
                                                  categoryEntry.key == 'CANCELLATION' ? 'Cancellations' : 'Returns'}
                                                (#{categoryEntry.value.size()} records)
                                            </td>
                                        </tr>

                                        <ui:repeat value="#{categoryEntry.value}" var="dto">
                                            <tr class="data-row">
                                                <td>#{dto.patientName}</td>
                                                <td>#{dto.doctorName}</td>
                                                <td>#{dto.transactionTypeLabel}</td>
                                                <td class="text-end">
                                                    <h:outputText value="#{dto.hospitalFee}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td class="text-end">
                                                    <h:outputText value="#{dto.doctorFee}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td class="text-end">
                                                    <h:outputText value="#{dto.netTotal}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td>
                                                    <h:outputText value="#{dto.billDate}">
                                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                    </h:outputText>
                                                </td>
                                                <td>#{dto.paymentMethod.label}</td>
                                            </tr>
                                        </ui:repeat>

                                        <tr class="category-subtotal">
                                            <td colspan="3" class="text-end">
                                                #{categoryEntry.key == 'BILL' ? 'Normal Bills' :
                                                  categoryEntry.key == 'CANCELLATION' ? 'Cancellations' : 'Returns'} Subtotal:
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'HOSPITAL')}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'DOCTOR')}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                            <td class="text-end">
                                                <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'NET')}">
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </td>
                                            <td colspan="2"></td>
                                        </tr>

                                    </ui:repeat>

                                    <tr class="payment-method-total">
                                        <td colspan="3" class="text-end">
                                            #{paymentEntry.key.label} Total:
                                        </td>
                                        <td class="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getHospitalFeeSubtotalForPaymentMethod(paymentEntry.key)}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </td>
                                        <td class="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getDoctorFeeSubtotalForPaymentMethod(paymentEntry.key)}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </td>
                                        <td class="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getSubtotalForPaymentMethod(paymentEntry.key)}">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </td>
                                        <td colspan="2"></td>
                                    </tr>

                                </ui:repeat>
                            </tbody>
                            <tfoot>
                                <tr class="grand-total">
                                    <td colspan="3" class="text-end">
                                        GRAND TOTAL:
                                    </td>
                                    <td class="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandHospitalFeeTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </td>
                                    <td class="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandDoctorFeeTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </td>
                                    <td class="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos == null or empty opdReportController.hospitalDoctorFeeReportDtos}">
                        <p>No data found for the selected criteria. Please go back and process the report first.</p>
                    </h:panelGroup>

                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
