<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:body>
        <ui:composition template="/opd/analytics/index.xhtml">
            <ui:define name="subcontent">
                <!-- Enhanced CSS for nested grouping -->
                <style>
                    .table-responsive {
                        font-size: 0.9em;
                        overflow-x: auto;
                    }

                    .data-row:hover {
                        background-color: #f8f9fa !important;
                        cursor: pointer;
                    }

                    .category-subtotal {
                        border-top: 2px solid #dee2e6 !important;
                        background-color: #e9ecef !important;
                    }

                    .payment-method-total {
                        border-top: 3px solid #ffc107 !important;
                        border-bottom: 3px solid #ffc107 !important;
                        background-color: #fff3cd !important;
                    }

                    .grand-total {
                        border-top: 4px solid #28a745 !important;
                        background-color: #d4edda !important;
                    }

                    .badge-success {
                        background-color: #28a745;
                        color: white;
                    }

                    .badge-warning {
                        background-color: #ffc107;
                        color: #212529;
                    }

                    .badge-danger {
                        background-color: #dc3545;
                        color: white;
                    }

                    .table-secondary td {
                        background-color: #6c757d !important;
                        color: white !important;
                        font-weight: bold;
                    }

                    .table-light td {
                        background-color: #f8f9fa !important;
                        font-weight: 500;
                    }

                    .table-info td {
                        background-color: #bee5eb !important;
                        border-color: #86cfda !important;
                    }

                    .table-warning td {
                        background-color: #ffeaa7 !important;
                        border-color: #fdcb6e !important;
                    }

                    .table-success td {
                        background-color: #a8e6cf !important;
                        border-color: #88d8a3 !important;
                    }

                    .pi {
                        font-family: "PrimeIcons" !important;
                        font-style: normal;
                        font-weight: normal;
                        line-height: 1;
                    }

                    .pi-credit-card:before {
                        content: "\e900";
                    }

                    .pi-angle-right:before {
                        content: "\e930";
                    }

                    .mr-2 {
                        margin-right: 0.5rem;
                    }

                    .pl-4 {
                        padding-left: 1.5rem;
                    }

                    .text-end {
                        text-align: right;
                    }

                    .text-right {
                        text-align: right;
                    }

                    .font-weight-bold {
                        font-weight: bold !important;
                    }

                    .font-weight-medium {
                        font-weight: 500 !important;
                    }

                    .h5 {
                        font-size: 1.25rem;
                        font-weight: 500;
                    }

                    .badge {
                        display: inline-block;
                        padding: 0.25rem 0.5rem;
                        font-size: 0.75rem;
                        font-weight: 700;
                        line-height: 1;
                        text-align: center;
                        white-space: nowrap;
                        vertical-align: baseline;
                        border-radius: 0.25rem;
                    }

                    /* Responsive adjustments */
                    @media (max-width: 768px) {
                        .table-responsive {
                            font-size: 0.8em;
                        }
                        .table th,
                        .table td {
                            padding: 0.25rem;
                        }
                    }
                </style>
                <p:panel header="Hospital Fee &amp; Doctor Fee Report">
                    <h:form>
                        <h:panelGrid columns="8" styleClass="w-100 form-grid" columnClasses="label-icon-column, input-column">
                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa ml-5" />
                                <h:outputLabel value="From" for="fromDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="fromDate"
                                value="#{opdReportController.fromDate}"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                />

                            <p:spacer width="50" ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa mr-2" />
                                <h:outputLabel value="To" for="toDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="toDate"
                                value="#{opdReportController.toDate}"
                                navigator="false"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                />

                            <p:spacer width="50" ></p:spacer>
                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf0f0;" styleClass="fa mr-2" />
                                <h:outputLabel value="User" for="user" class="mx-3" />
                            </h:panelGroup>
                            <p:autoComplete
                                forceSelection="true"
                                value="#{opdReportController.webUser}"
                                placeholder="Select User"
                                completeMethod="#{webUserController.completeUser}"
                                id="user"
                                var="u"
                                itemLabel="#{u.webUserPerson.name}"
                                itemValue="#{u}"
                                class="w-100"
                                inputStyleClass="w-100"
                                >
                            </p:autoComplete>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf19c;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Institution" for="cmbIns" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmbIns"
                                styleClass="w-100 form-control"
                                value="#{opdReportController.institution}"
                                filter="true">
                                <f:selectItem itemLabel="All Institutions" />
                                <f:selectItems value="#{institutionController.companies}" var="ins" itemLabel="#{ins.name}" itemValue="#{ins}" />
                                <p:ajax process="cmbIns" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf3c5;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Site" for="siteMenu" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="siteMenu"
                                styleClass="w-100 form-control"
                                value="#{opdReportController.site}"
                                filter="true">
                                <f:selectItem itemLabel="All Sites" />
                                <f:selectItems value="#{institutionController.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site}" />
                                <p:ajax process="siteMenu" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf0e8;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Department" for="cmbDept" class="mx-3"/>
                            </h:panelGroup>
                            <h:panelGroup id="cmbDept">
                                <!-- Simple department selector -->
                                <p:selectOneMenu
                                    styleClass="w-100 form-control"
                                    value="#{opdReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSite()}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf80d;" styleClass="fa mr-2" />
                                <h:outputLabel value="Admission Type" for="cmbAdmissionType" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmbAdmissionType"
                                class="w-100"
                                autoWidth="false"
                                value="#{opdReportController.admissionType}" >
                                <f:selectItem itemLabel="All Admission Type"/>
                                <f:selectItems value="#{inwardReportController.admissionty}" var="myItem"
                                               itemValue="#{myItem}" itemLabel="#{myItem.name}"></f:selectItems>
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf80d;" styleClass="fa mr-2" />
                                <h:outputLabel value="Discount Scheme" for="cmdDiscount" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmdDiscount"
                                class="w-100"
                                autoWidth="false"
                                value="#{opdReportController.paymentScheme}" >
                                <f:selectItem itemLabel="Select"/>
                                <f:selectItems value="#{paymentSchemeController.items}" var="ps" itemLabel="#{ps.name}"/>
                            </p:selectOneMenu>

                        </h:panelGrid>

                        <p:commandButton
                            value="Process"
                            ajax="false"
                            action="#{opdReportController.generateHospitalDoctorFeeReport()}"
                            styleClass="ui-button-success m-1"
                            icon="pi pi-cog">
                        </p:commandButton>

                        <p:commandButton
                            value="Download Excel"
                            ajax="false"
                            action="#{opdReportController.downloadHospitalDoctorFeeExcel()}"
                            styleClass="ui-button-info m-1"
                            icon="pi pi-download"
                            rendered="#{opdReportController.hospitalDoctorFeeReportDtos != null and not empty opdReportController.hospitalDoctorFeeReportDtos}">
                        </p:commandButton>

                        <p:button
                            value="Print"
                            outcome="hospital_doctor_fee_report_print"
                            styleClass="ui-button-warning m-1"
                            icon="pi pi-print"
                            rendered="#{opdReportController.hospitalDoctorFeeReportDtos != null and not empty opdReportController.hospitalDoctorFeeReportDtos}">
                        </p:button>

                        <!-- Display grouped data by payment method -->
                        <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos != null and not empty opdReportController.hospitalDoctorFeeReportDtos}">

                            <p:panel header="Summary by Payment Method" styleClass="mt-3">
                                <p:dataTable
                                    id="summaryTbl"
                                    styleClass="ui-datatable-borderless ui-datatable-sm compact-datatable"
                                    value="#{opdReportController.hospitalDoctorFeeBundle.paymentMethodGroups.entrySet()}" var="entry"
                                    emptyMessage="No data available">

                                    <p:column headerText="Payment Method" width="20em">
                                        <h:outputText value="#{entry.key.label}" />
                                    </p:column>

                                    <p:column headerText="Hospital Fee Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getHospitalFeeSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Doctor Fee Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getDoctorFeeSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Net Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:summaryRow>
                                        <p:column colspan="1">
                                            <h:outputText value="Grand Total" styleClass="font-weight-bold" />
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandHospitalFeeTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandDoctorFeeTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                    </p:summaryRow>

                                </p:dataTable>
                            </p:panel>

                            <!-- Enhanced Nested Grouping Report -->
                            <p:panel header="Enhanced Hospital Fee &amp; Doctor Fee Report - Grouped by Payment Method and Bill Type" styleClass="mt-3">

                                <div class="table-responsive">
                                    <table id="tbl" class="table table-hover table-bordered table-sm">
                                        <thead class="table-primary">
                                            <tr>
                                                <th style="width: 120px;">Bill Number</th>
                                                <th style="width: 180px;">Patient Name</th>
                                                <th style="width: 180px;">Doctor Name</th>
                                                <th style="width: 100px;">Bill Type</th>
                                                <th style="width: 100px;" class="text-end">Hospital Fee</th>
                                                <th style="width: 100px;" class="text-end">Doctor Fee</th>
                                                <th style="width: 100px;" class="text-end">Net Total</th>
                                                <th style="width: 100px;">Bill Date</th>
                                                <th style="width: 120px;">Payment Method</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- LEVEL 1: Payment Method Groups -->
                                            <ui:repeat value="#{opdReportController.hospitalDoctorFeeBundle.nestedPaymentMethodGroups.entrySet()}"
                                                       var="paymentEntry" varStatus="pmStatus">

                                                <!-- Payment Method Header Row -->
                                                <tr class="table-secondary">
                                                    <td colspan="9" class="font-weight-bold">
                                                        <i class="pi pi-credit-card mr-2"></i>
                                                        #{paymentEntry.key.label} Payment Method
                                                    </td>
                                                </tr>

                                                <!-- LEVEL 2: Bill Category Groups within Payment Method -->
                                                <ui:repeat value="#{paymentEntry.value.entrySet()}" var="categoryEntry" varStatus="catStatus">

                                                    <!-- Bill Category Sub-header Row -->
                                                    <tr class="table-light">
                                                        <td colspan="9" class="font-weight-medium pl-4">
                                                            <i class="pi pi-angle-right mr-2"></i>
                                                            #{categoryEntry.key == 'BILL' ? 'Normal Bills' :
                                                              categoryEntry.key == 'CANCELLATION' ? 'Cancellations' : 'Returns'}
                                                            (#{categoryEntry.value.size()} records)
                                                        </td>
                                                    </tr>

                                                    <!-- LEVEL 3: Individual Bill Rows -->
                                                    <ui:repeat value="#{categoryEntry.value}" var="dto" varStatus="billStatus">
                                                        <tr class="data-row">
                                                            <td style="padding-left: 30px;">#{dto.deptId}</td>
                                                            <td>#{dto.patientName}</td>
                                                            <td>#{dto.doctorName}</td>
                                                            <td>
                                                                <span class="badge badge-#{dto.billTypeAtomic.name().contains('CANCELLATION') ? 'warning' :
                                                                                          dto.billTypeAtomic.name().contains('REFUND') ? 'danger' : 'success'}">
                                                                    #{dto.transactionTypeLabel}
                                                                </span>
                                                            </td>
                                                            <td class="text-end">
                                                                <h:outputText value="#{dto.hospitalFee}">
                                                                    <f:convertNumber pattern="#,##0.00" />
                                                                </h:outputText>
                                                            </td>
                                                            <td class="text-end">
                                                                <h:outputText value="#{dto.doctorFee}">
                                                                    <f:convertNumber pattern="#,##0.00" />
                                                                </h:outputText>
                                                            </td>
                                                            <td class="text-end">
                                                                <h:outputText value="#{dto.netTotal}">
                                                                    <f:convertNumber pattern="#,##0.00" />
                                                                </h:outputText>
                                                            </td>
                                                            <td>
                                                                <h:outputText value="#{dto.billDate}">
                                                                    <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                                </h:outputText>
                                                            </td>
                                                            <td>#{dto.paymentMethod.label}</td>
                                                        </tr>
                                                    </ui:repeat>

                                                    <!-- Bill Category Subtotal Row -->
                                                    <tr class="table-info category-subtotal">
                                                        <td colspan="4" class="text-right font-weight-bold pl-4">
                                                            #{categoryEntry.key == 'BILL' ? 'Normal Bills' :
                                                              categoryEntry.key == 'CANCELLATION' ? 'Cancellations' : 'Returns'} Subtotal:
                                                        </td>
                                                        <td class="text-end font-weight-bold">
                                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'HOSPITAL')}">
                                                                <f:convertNumber pattern="#,##0.00" />
                                                            </h:outputText>
                                                        </td>
                                                        <td class="text-end font-weight-bold">
                                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'DOCTOR')}">
                                                                <f:convertNumber pattern="#,##0.00" />
                                                            </h:outputText>
                                                        </td>
                                                        <td class="text-end font-weight-bold">
                                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getBillCategorySubtotal(paymentEntry.key, categoryEntry.key, 'NET')}">
                                                                <f:convertNumber pattern="#,##0.00" />
                                                            </h:outputText>
                                                        </td>
                                                        <td colspan="2"></td>
                                                    </tr>

                                                </ui:repeat>

                                                <!-- Payment Method Total Row -->
                                                <tr class="table-warning payment-method-total">
                                                    <td colspan="4" class="text-right font-weight-bold">
                                                        #{paymentEntry.key.label} Total:
                                                    </td>
                                                    <td class="text-end font-weight-bold">
                                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getHospitalFeeSubtotalForPaymentMethod(paymentEntry.key)}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </h:outputText>
                                                    </td>
                                                    <td class="text-end font-weight-bold">
                                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getDoctorFeeSubtotalForPaymentMethod(paymentEntry.key)}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </h:outputText>
                                                    </td>
                                                    <td class="text-end font-weight-bold">
                                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getSubtotalForPaymentMethod(paymentEntry.key)}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </h:outputText>
                                                    </td>
                                                    <td colspan="2"></td>
                                                </tr>

                                            </ui:repeat>
                                        </tbody>

                                        <!-- Grand Total Footer -->
                                        <tfoot class="table-success">
                                            <tr class="grand-total">
                                                <td colspan="4" class="text-right font-weight-bold h5">
                                                    GRAND TOTAL:
                                                </td>
                                                <td class="text-end font-weight-bold h5">
                                                    <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandHospitalFeeTotal}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td class="text-end font-weight-bold h5">
                                                    <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandDoctorFeeTotal}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td class="text-end font-weight-bold h5">
                                                    <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandTotal}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                            </p:panel>
                        </h:panelGroup>

                        <!-- Message when no data -->
                        <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos == null or empty opdReportController.hospitalDoctorFeeReportDtos}">
                            <p:panel header="No Data" styleClass="mt-3">
                                <h:outputText value="No data found for the selected criteria. Please adjust your filters and try again."
                                              styleClass="text-muted" />
                            </p:panel>
                        </h:panelGroup>

                    </h:form>
                </p:panel>
            </ui:define>
        </ui:composition>
    </h:body>

</html>