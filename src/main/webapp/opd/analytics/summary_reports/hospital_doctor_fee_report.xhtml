<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:body>
        <ui:composition template="/opd/analytics/index.xhtml">
            <ui:define name="subcontent">
                <p:panel header="Hospital Fee &amp; Doctor Fee Report">
                    <h:form>
                        <h:panelGrid columns="8" styleClass="w-100 form-grid" columnClasses="label-icon-column, input-column">
                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa ml-5" />
                                <h:outputLabel value="From" for="fromDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="fromDate"
                                value="#{opdReportController.fromDate}"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                />

                            <p:spacer width="50" ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf073;" styleClass="fa mr-2" />
                                <h:outputLabel value="To" for="toDate" class="mx-3"/>
                            </h:panelGroup>
                            <p:calendar
                                styleClass="w-100"
                                inputStyleClass="w-100 form-control"
                                id="toDate"
                                value="#{opdReportController.toDate}"
                                navigator="false"
                                pattern="#{sessionController.applicationPreference.longDateTimeFormat}"
                                />

                            <p:spacer width="50" ></p:spacer>
                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf0f0;" styleClass="fa mr-2" />
                                <h:outputLabel value="User" for="user" class="mx-3" />
                            </h:panelGroup>
                            <p:autoComplete
                                forceSelection="true"
                                value="#{opdReportController.webUser}"
                                placeholder="Select User"
                                completeMethod="#{webUserController.completeUser}"
                                id="user"
                                var="u"
                                itemLabel="#{u.webUserPerson.name}"
                                itemValue="#{u}"
                                class="w-100"
                                inputStyleClass="w-100"
                                >
                            </p:autoComplete>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf19c;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Institution" for="cmbIns" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmbIns"
                                styleClass="w-100 form-control"
                                value="#{opdReportController.institution}"
                                filter="true">
                                <f:selectItem itemLabel="All Institutions" />
                                <f:selectItems value="#{institutionController.companies}" var="ins" itemLabel="#{ins.name}" itemValue="#{ins}" />
                                <p:ajax process="cmbIns" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf3c5;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Site" for="siteMenu" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="siteMenu"
                                styleClass="w-100 form-control"
                                value="#{opdReportController.site}"
                                filter="true">
                                <f:selectItem itemLabel="All Sites" />
                                <f:selectItems value="#{institutionController.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site}" />
                                <p:ajax process="siteMenu" update="cmbDept" />
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf0e8;" styleClass="fa mr-2" />
                                <h:outputLabel value="Billing Department" for="cmbDept" class="mx-3"/>
                            </h:panelGroup>
                            <h:panelGroup id="cmbDept">
                                <!-- Simple department selector -->
                                <p:selectOneMenu
                                    styleClass="w-100 form-control"
                                    value="#{opdReportController.department}"
                                    filterMatchMode="contains"
                                    filter="true">
                                    <f:selectItem itemLabel="All Departments" />
                                    <f:selectItems
                                        value="#{departmentController.getDepartmentsOfInstitutionAndSite()}"
                                        var="d"
                                        itemLabel="#{d.name}"
                                        itemValue="#{d}" />
                                </p:selectOneMenu>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf80d;" styleClass="fa mr-2" />
                                <h:outputLabel value="Admission Type" for="cmbAdmissionType" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmbAdmissionType"
                                class="w-100"
                                autoWidth="false"
                                value="#{opdReportController.admissionType}" >
                                <f:selectItem itemLabel="All Admission Type"/>
                                <f:selectItems value="#{inwardReportController.admissionty}" var="myItem"
                                               itemValue="#{myItem}" itemLabel="#{myItem.name}"></f:selectItems>
                            </p:selectOneMenu>

                            <p:spacer ></p:spacer>

                            <h:panelGroup layout="block" styleClass="form-group">
                                <h:outputText value="&#xf80d;" styleClass="fa mr-2" />
                                <h:outputLabel value="Discount Scheme" for="cmdDiscount" class="mx-3"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                id="cmdDiscount"
                                class="w-100"
                                autoWidth="false"
                                value="#{opdReportController.paymentScheme}" >
                                <f:selectItem itemLabel="Select"/>
                                <f:selectItems value="#{paymentSchemeController.items}" var="ps" itemLabel="#{ps.name}"/>
                            </p:selectOneMenu>

                        </h:panelGrid>

                        <p:commandButton
                            value="Process"
                            ajax="false"
                            action="#{opdReportController.generateHospitalDoctorFeeReport()}"
                            styleClass="ui-button-success m-1"
                            icon="pi pi-cog">
                        </p:commandButton>

                        <p:commandButton
                            value="Download"
                            ajax="false"
                            styleClass="ui-button-info m-1"
                            icon="pi pi-download">
                            <p:dataExporter fileName="hospital_doctor_fee_report.xlsx" target="tbl" type="xlsx" />
                        </p:commandButton>

                        <!-- Display grouped data by payment method -->
                        <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos != null and not empty opdReportController.hospitalDoctorFeeReportDtos}">

                            <p:panel header="Summary by Payment Method" styleClass="mt-3">
                                <p:dataTable
                                    id="summaryTbl"
                                    styleClass="ui-datatable-borderless ui-datatable-sm compact-datatable"
                                    value="#{opdReportController.hospitalDoctorFeeBundle.paymentMethodGroups.entrySet()}" var="entry"
                                    emptyMessage="No data available">

                                    <p:column headerText="Payment Method" width="20em">
                                        <h:outputText value="#{entry.key.label}" />
                                    </p:column>

                                    <p:column headerText="Hospital Fee Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getHospitalFeeSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Doctor Fee Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getDoctorFeeSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Net Total" width="15em" styleClass="text-end">
                                        <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.getSubtotalForPaymentMethod(entry.key)}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:summaryRow>
                                        <p:column colspan="1">
                                            <h:outputText value="Grand Total" styleClass="font-weight-bold" />
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandHospitalFeeTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandDoctorFeeTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column styleClass="text-end">
                                            <h:outputText value="#{opdReportController.hospitalDoctorFeeBundle.grandTotal}" styleClass="font-weight-bold">
                                                <f:convertNumber pattern="#,##0.00" />
                                            </h:outputText>
                                        </p:column>
                                    </p:summaryRow>

                                </p:dataTable>
                            </p:panel>

                            <!-- Detailed data table -->
                            <p:panel header="Detailed Report" styleClass="mt-3">
                                <p:dataTable
                                    id="tbl"
                                    style="padding: 0px!important; margin: 0px!important; font-size: #{opdReportController.fontSizeForScreen}!important;"
                                    styleClass="ui-datatable-borderless ui-datatable-sm compact-datatable"
                                    value="#{opdReportController.hospitalDoctorFeeReportDtos}"
                                    var="dto"
                                    paginator="true"
                                    rows="#{opdReportController.rowsPerPageForScreen}"
                                    rowsPerPageTemplate="#{opdReportController.rowsPerPageForScreen}, 25,50,100,250,500"
                                    paginatorPosition="bottom"
                                    sortBy="#{dto.paymentMethod}"
                                    groupBy="#{dto.paymentMethod}"
                                    emptyMessage="No data available">

                                    <p:column headerText="Patient Name" width="20em" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.patientName}" />
                                    </p:column>

                                    <p:column headerText="Doctor Name" width="20em" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.doctorName}" />
                                    </p:column>

                                    <p:column headerText="Hospital Fee" width="12em" styleClass="text-end" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.hospitalFee}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Doctor Fee" width="12em" styleClass="text-end" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.doctorFee}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Net Total" width="12em" styleClass="text-end" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.netTotal}">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Date" width="12em" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.billDate}">
                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Payment Method" width="12em" style="padding: 2px!important;">
                                        <h:outputText value="#{dto.paymentMethod.label}" />
                                    </p:column>

                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>

                        <!-- Message when no data -->
                        <h:panelGroup rendered="#{opdReportController.hospitalDoctorFeeReportDtos == null or empty opdReportController.hospitalDoctorFeeReportDtos}">
                            <p:panel header="No Data" styleClass="mt-3">
                                <h:outputText value="No data found for the selected criteria. Please adjust your filters and try again."
                                              styleClass="text-muted" />
                            </p:panel>
                        </h:panelGroup>

                    </h:form>
                </p:panel>
            </ui:define>
        </ui:composition>
    </h:body>

</html>