<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/resources/template/template_without_menu.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ch="http://xmlns.jcp.org/jsf/composite/channel"
                xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
                xmlns:au="http://xmlns.jcp.org/jsf/composite/autocomplete"
                xmlns:pat="http://xmlns.jcp.org/jsf/composite/patient"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">



    <ui:define name="content">
        <style>
            @keyframes blink {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }

            .blink {
                animation: blink 1s infinite;
            }

            .sticky-top {
                position: fixed;
                top: 0;
                z-index: 1000; /* Ensure the navbar appears above other content */
            }


        </style>

        <h:form id="form">
            <div class="row w-100">
                <div class="col-12" >

                    <nav class="navbar navbar-light p-2 sticky-top w-100" style="background-color: #e3f2fd;" >
                        <div class="d-flex align-items-center mx-4">
                            <h:outputText styleClass="fa-solid fa-stethoscope"/>
                            <h4 onclick="toggleFullScreen()" class="mx-4">OPD Token Management</h4>
                        </div>

                        <div class="d-flex">
                            <p:selectOneMenu class="mx-2" value="#{opdTokenController.counter}" >
                                <f:selectItem itemLabel="All" ></f:selectItem>
                                <f:selectItems 
                                    value="#{sessionController.loggableSubDepartments}" 
                                    var="c" 
                                    itemLabel="#{c.name}" 
                                    itemValue="#{c}" >
                                </f:selectItems>
                            </p:selectOneMenu>

                            <p:commandButton ajax="false" 
                                             value="FIlter" 
                                             icon="fa fa-check" 
                                             styleClass="ui-button-success mx-1" 
                                             action="#{opdTokenController.fillOpdTokens()}" />
                        </div>

                    </nav>

                </div>
                <p:spacer height="65px" />
                <div>
                    <ui:repeat var="token" 
                               id="tblSessions"
                               value="#{opdTokenController.currentTokens}"
                               class="w-100 mt-5">

                        <div class="shadow-lg p-2 row d-flex align-items-center" style="height: 100px">

                            <div class="col-1 text-center">
                                <h:outputText value="#{token.tokenNumber}" />
                            </div>
                            <div class="col-3 ">
                                <h:outputText value="#{token.patient.person.nameWithTitle}" style="text-transform: uppercase;font-weight: bold;" />
                            </div>
                            <div class="col-1 ">
                                <h:outputText value="#{token.counter.name}" />
                            </div>

                            <div class="col-2 ">
                                <p:tag value="#{opdTokenController.getTokenStatus(token) == 'Pending' ? 'Pending' : 
                                                opdTokenController.getTokenStatus(token) == 'Called' ? 'Called' :
                                                opdTokenController.getTokenStatus(token) == 'In Progress' ? 'In Progress' :
                                                opdTokenController.getTokenStatus(token) == 'Completed' ? 'Completed' :
                                                opdTokenController.getTokenStatus(token)}" 
                                       severity="#{opdTokenController.getTokenStatus(token) == 'Pending' ? 'warning' :
                                                   opdTokenController.getTokenStatus(token) == 'Called' ? 'secondary' :
                                                   opdTokenController.getTokenStatus(token) == 'In Progress' ? 'info' :
                                                   opdTokenController.getTokenStatus(token) == 'Completed' ? 'success' : ''}"
                                       style="font-size: 14px;"/>
                            </div>
                            <div class="col-3">

                                <h:panelGrid rendered="#{not empty token.bill and token.bill.billType eq 'OpdBathcBillPre'}" >
                                    <h:panelGroup rendered="#{token.bill.referenceBill ne null}" >
                                        <h:outputText value="PAYMENT DONE" />
                                        <br/>
                                        <h:outputText value="Bill Number : " />
                                        <h:outputText value="#{token.bill.referenceBill.deptId}" />
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{token.bill.referenceBill eq null}" >
                                        <h:outputText value="AWAITING PAYMENT" rendered="#{token.bill.cancelled eq false}"/>

                                        <h:outputText value="ALL ITEMS GET ADDED TO STOCK" rendered="#{token.bill.cancelled eq true}"/>
                                        <br/>
                                        <h:outputText value="Bill Number : " />
                                        <h:outputText value="#{token.bill.deptId}" />
                                    </h:panelGroup>
                                </h:panelGrid>
                                <h:panelGrid rendered="#{not empty token.bill and token.bill.billType.label eq 'OPD Accepet Payment'}" >
                                    <h:outputText value="PAYMENT DONE" />
                                </h:panelGrid>
                            </div>
                            <div class="col-2">
                                <div class="d-flex justify-content-between">

                                    <p:commandButton ajax="false"
                                                     id="btnCall"
                                                     icon="#{token.called ? 'fa fa-times' : 'fa fa-phone'}"
                                                     class="#{token.called ? 'ui-button-warning' : 'ui-button-success'}"
                                                     update="@this"
                                                     title="#{token.called ? 'Cancel Call' : 'Call Token'}"
                                                     action="#{opdTokenController.toggleCalledStatus}"
                                                     process="btnCall">
                                        <f:setPropertyActionListener target="#{opdTokenController.currentToken}" value="#{token}" />
                                        <p:tooltip value="#{token.called ? 'Cancel Call' : 'Call Token'}" />
                                    </p:commandButton>

                                    <p:commandButton 
                                        id="opdCashier"
                                        icon="fa fa-fw fa-cash-register"
                                        disabled="#{token.bill ne null}"
                                        action="#{opdTokenController.navigateToNewOpdBillForCashierTabView()}"
                                        ajax="false"
                                        >
                                        <f:setPropertyActionListener target="#{opdTokenController.currentToken}" value="#{token}" />
                                        <f:setPropertyActionListener target="#{opdTabPreBillController.token}" value="#{token}" />
                                        <p:tooltip value="Opd Billing for Cashier"/>
                                    </p:commandButton>

                                    <p:commandButton ajax="false"
                                                     icon="#{token.completed ? 'fa fa-undo' : 'fa fa-check'}"
                                                     class="#{token.completed ? 'ui-button-danger' : 'ui-button-success'}"
                                                     update="@form"
                                                     title="#{token.completed ? 'Reverse Complete Service' : 'Complete Service'}"
                                                     action="#{opdTokenController.toggleCompletedStatus}"
                                                     process="@this">
                                        <f:setPropertyActionListener target="#{opdTokenController.currentToken}" value="#{token}" />
                                        <p:tooltip value="#{token.completed ? 'Reverse Complete Service' : 'Complete Service'}" />
                                    </p:commandButton>
                                    <p:tooltip value="Opd Billing For Cashier" for="opdCashier"/>
                                </div>
                            </div>

                        </div>
                    </ui:repeat>
                </div>
            </div>

        </h:form>
        <script type="text/javascript">
            //<![CDATA[
            function toggleFullScreen() {
                var elem = document.documentElement;
                if (!document.fullscreenElement && !document.mozFullScreenElement &&
                        !document.webkitFullscreenElement && !document.msFullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    } else if (elem.mozRequestFullScreen) {
                        elem.mozRequestFullScreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                }
            }
            //]]>
        </script>
    </ui:define>
</ui:composition>