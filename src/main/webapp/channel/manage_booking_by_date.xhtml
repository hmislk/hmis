<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/resources/template/template.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ch="http://java.sun.com/jsf/composite/channel"
                xmlns:pa="http://java.sun.com/jsf/composite/paymentMethod"
                xmlns:au="http://java.sun.com/jsf/composite/autocomplete"
                xmlns:pat="http://java.sun.com/jsf/composite/patient"
                xmlns:ezcommon="http://java.sun.com/jsf/composite/ezcomp/common"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <ui:define name="content">

        <h:form id="form">
            <p:panel >
                <f:facet name="header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex">
                            <div>
                                <h:outputText value="Manage Booking"></h:outputText> |
                            </div>
                            <h:outputLabel class="mx-1" value="#{bookingControllerViewScope.selectedSessionInstance.staff.person.nameWithTitle}" ></h:outputLabel>
                            (<h:outputLabel value="#{bookingControllerViewScope.selectedSessionInstance.staff.speciality.name}" ></h:outputLabel>) -<br />
                            <h:outputLabel class="mx-1" value="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.name}" ></h:outputLabel>
                        </div>

                        <div class="d-flex gap-2">
                            <p:commandButton 
                                ajax="false" 
                                class="mx-1 ui-button-secondary"
                                value="Back to Reports"
                                immediate="true"
                                action="/channel/channel_reports?faces-redirect=true"
                                icon="fa-solid fa-arrow-left" />
                            <p:commandButton 
                                ajax="false" 
                                class="mx-1 ui-button-secondary"
                                value="Back to Bookings"
                                immediate="true"
                                action="#{bookingControllerViewScope.navigateBackToBookingsFromBillSession()}"
                                icon="fa-solid fa-arrow-left" />
                            <p:commandButton 
                                ajax="false" 
                                class="mx-1 ui-button-secondary"
                                value="Back to Session"
                                immediate="true"
                                action="#{bookingControllerViewScope.navigateToManageSessionInstance(bookingControllerViewScope.selectedSessionInstance)}"
                                icon="fa-solid fa-arrow-left" />
                        </div>
                    </div>

                </f:facet>

                <h:panelGroup rendered="#{bookingControllerViewScope.printPreviewForSettle}">
                    <div cladd="row" >
                        <div class="col-12" >
                            <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                            <p:selectOneMenu
                                class="m-1"
                                value="#{sessionController.departmentPreference.channelBillPaperType}"
                                style="width: 20em;">
                                <f:selectItem itemLabel="Please Select Paper Type" />
                                <f:selectItems value="#{enumController.paperTypes}" />
                            </p:selectOneMenu>
                            <p:commandButton
                                id="btnRefreshAD"
                                ajax="false"
                                icon="fa fa-sync-alt"
                                class="ui-button m-1"
                                title="Redraw Bill">
                            </p:commandButton>

                            <p:commandButton 
                                value="Print"
                                ajax="false"
                                class="ui-button-success m-1"
                                icon="fa fa-print"
                                disabled="#{bookingControllerViewScope.selectedBillSession.bill.balance ne 0.0}">
                                <p:printer target="printAfterChannelBillSettling" ></p:printer>
                            </p:commandButton>

                            <p:commandButton 
                                value="Close Print"
                                ajax="false"
                                action="#{bookingControllerViewScope.closePrinting()}"
                                class="ui-button-warning m-1"
                                icon="fa fa-close">
                            </p:commandButton>
                        </div>
                    </div>
                    <div cladd="row" >
                        <div class="col-12" >
                            <h:panelGroup id="printAfterChannelBillSettling" style="display: block;">
                                <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">

                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is PosPaper',true)}">
                                        <ez:bmsChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFivePaper',true)}">
                                        <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFIvePaperCustom2',true)}">
                                        <ez:fivefivePapaerCustom2 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFIvePaperCustom3',true)}">
                                        <ez:fivefivePapaerCustom3 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFivePrintedPaper',true)}">
                                        <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                    </h:panelGroup>

                                </ui:repeat>
                            </h:panelGroup>
                        </div>
                    </div>

                </h:panelGroup>

                <h:panelGroup rendered="#{bookingControllerViewScope.printPreviewForOnlineBill}" >
                    <div class="row">
                        <div class="col-12">
                            <p:panel>
                                <div class="row">
                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h:outputLabel value="Print Online Bill" />
                                            <div>
                                                <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                                                <p:selectOneMenu
                                                    value="#{sessionController.departmentPreference.channelBillPaperType}"
                                                    class="m-1"
                                                    style="width: 13em;">
                                                    <f:selectItem itemLabel="Please Select Paper Type" />
                                                    <f:selectItems value="#{enumController.paperTypes}" />
                                                </p:selectOneMenu>
                                                <p:commandButton
                                                    ajax="false"
                                                    icon="fa fa-sync-alt"
                                                    class="ui-button-primary m-1"
                                                    title="Redraw Bill">
                                                </p:commandButton>
                                                <p:commandButton
                                                    value="Print"
                                                    ajax="false"
                                                    class="ui-button-info  m-1"
                                                    icon="fa fa-print"
                                                    action="#"
                                                    disabled="#{bookingControllerViewScope.selectedBillSession.bill.balance ne 0.0}">
                                                    <p:printer target="groupOnlineChannelBillPrint" ></p:printer>
                                                </p:commandButton>
                                                <p:commandButton
                                                    value="Close Print"
                                                    ajax="false"
                                                    action="#{bookingControllerViewScope.closePrinting()}"
                                                    class="ui-button-warning m-1"
                                                    icon="fa fa-close">
                                                </p:commandButton>
                                            </div>
                                        </div>
                                    </f:facet>
                                    <div class="col-md-12 mt-2">
                                        <div class="d-flex justify-content-center">
                                            <h:panelGroup id="groupOnlineChannelBillPrint">
                                                <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">

                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is PosPaper',true)}">
                                                        <ez:bmsChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFivePaper',true)}">
                                                        <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFIvePaperCustom2',true)}">
                                                        <ez:fivefivePapaerCustom2 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFIvePaperCustom3',true)}">
                                                        <ez:fivefivePapaerCustom3 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Settling Bill is FiveFivePrintedPaper',true)}">
                                                        <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>

                                                </ui:repeat>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                </div>
                            </p:panel>
                        </div>
                    </div>
                </h:panelGroup>

                <h:panelGroup  rendered="#{bookingControllerViewScope.printPreviewForReprintingAsDuplicate}">
                    <div class="row">
                        <div class="col-12">
                            <p:panel>
                                <div class="row">
                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h:outputLabel value="Reprint(Duplicate)" />
                                            <div>
                                                <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                                                <p:selectOneMenu
                                                    value="#{sessionController.departmentPreference.channelBillPaperType}"
                                                    class="m-1"
                                                    style="width: 13em;">
                                                    <f:selectItem itemLabel="Please Select Paper Type" />
                                                    <f:selectItems value="#{enumController.paperTypes}" />
                                                </p:selectOneMenu>
                                                <p:commandButton
                                                    ajax="false"
                                                    icon="fa fa-sync-alt"
                                                    class="ui-button-primary m-1"
                                                    title="Redraw Bill">
                                                </p:commandButton>
                                                <p:commandButton
                                                    value="Print as Duplicate"
                                                    ajax="false"
                                                    class="ui-button-info  m-1"
                                                    icon="fa fa-print"
                                                    action="#"
                                                    disabled="#{bookingControllerViewScope.selectedBillSession.bill.balance ne 0.0}">
                                                    <p:printer target="groupChannelBillReprintAsDuplicate" ></p:printer>
                                                </p:commandButton>
                                                <p:commandButton 
                                                    value="Close Print"
                                                    ajax="false"
                                                    action="#{bookingControllerViewScope.closePrinting()}"
                                                    class="ui-button-warning m-1"
                                                    icon="fa fa-close">
                                                </p:commandButton>

                                            </div>
                                        </div>
                                    </f:facet>
                                    <div class="col-md-12 mt-2">
                                        <div class="d-flex justify-content-center">
                                            <h:panelGroup id="groupChannelBillReprintAsDuplicate">
                                                <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">

                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Duplicate Bill is PosPaper',true)}">
                                                        <ez:bmsChannelBill  bill="#{bookingControllerViewScope.selectedBillSession.bill}" dup="true" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Duplicate Bill is FiveFivePaper',true)}">
                                                        <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.bill}" duplicate="true" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Duplicate Bill is FiveFIvePaperCustom2',true)}">
                                                        <ez:fivefivePapaerCustom2 bill="#{bookingControllerViewScope.selectedBillSession.bill}" duplicate="true" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Duplicate Bill is FiveFIvePaperCustom3',true)}">
                                                        <ez:fivefivePapaerCustom3 bill="#{bookingControllerViewScope.selectedBillSession.bill}" duplicate="true" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Duplicate Bill is FiveFivePrintedPaper',true)}">
                                                        <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.bill}" duplicate="true" />
                                                    </h:panelGroup>

                                                </ui:repeat>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                </div>
                            </p:panel>                          
                        </div>                        
                    </div>
                </h:panelGroup>

                <h:panelGroup  rendered="#{bookingControllerViewScope.printPreviewForReprintingAsOriginal}">
                    <div class="row">
                        <div class="col-12">
                            <p:panel>
                                <div class="row">
                                    <f:facet name="header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h:outputLabel value="Reprint Original" />
                                            <div>
                                                <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                                                <p:selectOneMenu
                                                    value="#{sessionController.departmentPreference.channelBillPaperType}"
                                                    class="m-1"
                                                    style="width: 13em;">
                                                    <f:selectItem itemLabel="Please Select Paper Type" />
                                                    <f:selectItems value="#{enumController.paperTypes}" />
                                                </p:selectOneMenu>
                                                <p:commandButton
                                                    ajax="false"
                                                    icon="fa fa-sync-alt"
                                                    class="ui-button-primary m-1"
                                                    title="Redraw Bill">
                                                </p:commandButton>
                                                <p:commandButton
                                                    value="Print as Original"
                                                    ajax="false"
                                                    class="ui-button-info  m-1"
                                                    icon="fa fa-print"
                                                    action="#"
                                                    disabled="#{bookingControllerViewScope.selectedBillSession.bill.balance ne 0.0}">
                                                    <p:printer target="groupChannelBillReprintAsOriginal" ></p:printer>
                                                </p:commandButton>
                                                <p:commandButton
                                                    value="Close Print"
                                                    ajax="false"
                                                    action="#{bookingControllerViewScope.closePrinting()}"
                                                    class="ui-button-warning m-1"
                                                    icon="fa fa-close">
                                                </p:commandButton>

                                            </div>
                                        </div>
                                    </f:facet>
                                    <div class="col-md-12 mt-2">
                                        <div class="d-flex justify-content-center">
                                            <h:panelGroup id="groupChannelBillReprintAsOriginal">
                                                <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is PosPaper',true)}">
                                                        <ez:bmsChannelBill  bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFivePaper',true)}">
                                                        <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFIvePaperCustom2',true)}">
                                                        <ez:fivefivePapaerCustom2 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFIvePaperCustom3',true)}">
                                                        <ez:fivefivePapaerCustom3 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFivePrintedPaper',true)}">
                                                        <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                    </h:panelGroup>

                                                </ui:repeat>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                </div>
                            </p:panel>
                        </div>
                    </div>
                </h:panelGroup>

                <h:panelGroup rendered="#{!bookingControllerViewScope.printPreview}" >

                    <p:tabView id="detail">
                        <p:tab title="Settle" id="settle">
                            <h:panelGroup >
                                <div class="row">
                                    <div class="col-6">

                                        <div class="row">
                                            <div class="col">
                                                <p:panel>
                                                    <f:facet name="header">
                                                        <h:outputText styleClass="fas fa-user" />
                                                        <h:outputLabel class="mx-4" value="Patient Details" />
                                                    </f:facet>
                                                    <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill ne null ? (bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking ne null ? true : false) : false }">

                                                        <i class="fa fa-user fa-fw mx-3" style="color: #007bff;" title="Name" />
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.title}. #{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.patientName}" />
                                                        <br></br>

                                                        <i class="fa fa-user fa-fw mx-3" style="color: #007bff;" title="Foreigner" />
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.foreignStatus eq true ? 'Foreign Patient' : 'Local Patient'}" />
                                                        <br></br>

                                                        <i class="fa fa-phone fa-fw mx-3" style="color: #007bff;" title="Phone" />
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.phoneNo}" />
                                                        <br></br>

                                                        <i class="fa fa-id-card fa-fw mx-3" style="color: #007bff;" title="NIC" />
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.nic}" />
                                                        <br></br>

                                                        <i class="fa fa-flag fa-fw mx-3" style="color: #007bff;" title="Ref No" />
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking.referenceNo}" />

                                                    </h:panelGroup>
                                                    <ezcommon:patient rendered="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill eq null}" patient="#{bookingControllerViewScope.selectedBillSession.bill.patient}" ></ezcommon:patient>
                                                </p:panel>
                                            </div>
                                            <div class="col">
                                                <p:panelGrid 
                                                    id="totalsPanel"
                                                    class="w-100"
                                                    layout="tabular" 
                                                    columns="2" columnClasses="text-centre text-end">
                                                    <f:facet name="header">
                                                        <h:outputText styleClass="fas fa-user" />
                                                        <h:outputLabel class="mx-4" value="Bill Details" />
                                                    </f:facet>
                                                    <h:outputLabel rendered="#{webUserController.hasPrivilege('Developers')}" value="Bill ID" ></h:outputLabel>
                                                    <h:outputLabel rendered="#{webUserController.hasPrivilege('Developers')}"  value="#{bookingControllerViewScope.selectedBillSession.bill.id}" >
                                                    </h:outputLabel>
                                                    <h:outputLabel value="Number" ></h:outputLabel>
                                                    <h:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.deptId}" ></h:outputLabel>
                                                    <h:outputLabel value="Total" ></h:outputLabel>
                                                    <h:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.total}" >
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </h:outputLabel>
                                                    <h:outputLabel value="Discount" ></h:outputLabel>
                                                    <h:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.discount}" >
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </h:outputLabel>
                                                    <h:outputLabel value="Net Total" ></h:outputLabel>
                                                    <h:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.netTotal}" >
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </h:outputLabel>
                                                </p:panelGrid>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-6">
                                        <!-- Cancelled Panel -->
                                        <p:panel 
                                            header="Cancelled"
                                            styleClass="custom-panel m-1"
                                            rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled}">
                                            <f:facet name="header">
                                                <h:outputText value="Cancelled" />
                                                <i class="fa fa-times-circle" style="float:right;"></i>
                                            </f:facet>
                                            <h:outputText 
                                                value="Booking is Cancelled. No Settling is allowed"
                                                class="ui-message-error">
                                            </h:outputText>
                                        </p:panel>

                                        <!-- Paid Booking Panel -->
                                        <p:panel 
                                            styleClass="custom-panel-success m-1"
                                            header="Paid Booking"
                                            rendered="#{bookingControllerViewScope.selectedBillSession.bill.billType.parent ne 'ChannelCreditFlow'}">
                                            <f:facet name="header">
                                                <h:outputText value="Paid Booking" />
                                                <i class="fa fa-dollar-sign" style="float:right;"></i>
                                            </f:facet>
                                            <h:outputText 
                                                value="Paid Booking. No Need to Settle"
                                                class="ui-message-success">
                                            </h:outputText>
                                        </p:panel>

                                        <!-- Payment Settled Panel -->
                                        <p:panel 
                                            styleClass="custom-panel-success m-1"
                                            header="Payment Settled"
                                            rendered="#{bookingControllerViewScope.selectedBillSession.bill.billType.parent eq 'ChannelCreditFlow' and bookingControllerViewScope.selectedBillSession.bill.paidAmount gt 0}">
                                            <f:facet name="header">
                                                <h:outputText value="Payment Settled" />
                                                <i class="fa fa-check-circle" style="float:right;"></i>
                                            </f:facet>
                                            <h:outputText 
                                                value="Payment Already Settled."
                                                class="ui-message-success">
                                            </h:outputText>
                                        </p:panel>

                                        <p:panel 
                                            class="m-1"
                                            rendered="#{
                                            bookingControllerViewScope.selectedBillSession.bill.billType.parent eq 'ChannelCreditFlow' 
                                                and bookingControllerViewScope.selectedBillSession.bill.cancelled ne true 
                                                and bookingControllerViewScope.selectedBillSession.bill.paidAmount eq 0}"
                                            >
                                            <f:facet name="header" >
                                                <h:outputText styleClass="fa fa-money-bill-wave" /> 
                                                <h:outputText value="Settle Payment" class="mx-4"></h:outputText>
                                                <p:commandButton
                                                    value="Settle"
                                                    style="float: right;"
                                                    ajax="false"
                                                    icon="fa fa-check"
                                                    action="#{bookingControllerViewScope.settleCredit()}"
                                                    disabled="#{bookingControllerViewScope.selectedBillSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                                or bookingControllerViewScope.selectedBillSession.bill.cancelled==true
                                                                or  bookingControllerViewScope.selectedBillSession.bill.paidAmount ne 0}"
                                                    class="ui-button-success m-1"
                                                    >
                                                </p:commandButton>
                                            </f:facet>
                                            <h:panelGrid columns="2" class="w-100">

                                                <p:outputLabel value="Payment Method" ></p:outputLabel>
                                                <p:selectOneMenu   
                                                    id="pay"
                                                    class="w-100"
                                                    value="#{bookingControllerViewScope.settlePaymentMethod}"
                                                    >

                                                    <f:selectItems 
                                                        value="#{enumController.paymentMethodsForChannelSettling}"  
                                                        var="pm"
                                                        itemLabel="#{pm.label}"
                                                        itemValue="#{pm}"/>
                                                    <p:ajax process="@this" 
                                                            update="paymentDetails"
                                                            event="change"
                                                            listener="#{bookingControllerViewScope.listnerForPaymentMethodChangeOnCreditSettle()}"/>
                                                </p:selectOneMenu>

                                                <p:outputLabel value="Discount Scheme"/>
                                                <p:selectOneMenu 
                                                    class="w-100" 
                                                    autoWidth="false" 
                                                    id="cmbPs2" 
                                                    value="#{bookingControllerViewScope.paymentScheme}">
                                                    <f:selectItem itemLabel="Select Discount Scheme"/>
                                                    <f:selectItems 
                                                        value="#{paymentSchemeController.paymentSchemesForChannel}"
                                                        var="paysch" 
                                                        itemLabel="#{paysch.name}" 
                                                        itemValue="#{paysch}"  />
                                                    <p:ajax 
                                                        process="@this "
                                                        update="gdManageBookings :#{p:resolveFirstComponentWithId('totalsPanel',view).clientId} paymentDetails lstItems"
                                                        event="change"
                                                        listener="#{bookingControllerViewScope.calculateSelectedBillSessionTotalForSettling()}"/>
                                                </p:selectOneMenu>

                                                <p:outputLabel value="Citizenship" ></p:outputLabel>
                                                <p:panel>
                                                    <h:panelGroup id="gpLocalForeign"  class="col-md-6" rendered="#{!configOptionApplicationController.getBooleanValueByKey('Save the Patient with Patient Status')}">
                                                        <p:commandButton
                                                            value="Mark Foreigner"
                                                            class="mx-2 my-2"
                                                            disabled="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.category ne 'Scanning'}"
                                                            action="#{bookingControllerViewScope.markAsForeignerWithBillUpdate()}"
                                                            rendered="#{!bookingControllerViewScope.foriegn}"
                                                            process="@this"
                                                            update="gpLocalForeign totalsPanel panelBookingDetails paymentDetails tblBillFeesForAddingNewItem tblBillItemsForAddingNewItem msg"
                                                            >
                                                        </p:commandButton>
                                                        <p:commandButton
                                                            value="Mark Local"
                                                            class="mx-2"
                                                            disabled="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.category ne 'Scanning'}"
                                                            action="#{bookingControllerViewScope.markAsLocalWithBillUpdate()}"
                                                            rendered="#{bookingControllerViewScope.foriegn}"
                                                            process="@this"
                                                            update="gpLocalForeign totalsPanel panelBookingDetails paymentDetails tblBillFeesForAddingNewItem tblBillItemsForAddingNewItem msg"
                                                            >
                                                        </p:commandButton>

                                                    </h:panelGroup>
                                                </p:panel>

                                            </h:panelGrid>
                                            <h:panelGroup id="paymentDetails"  >
                                                <h:panelGrid id="gdManageBookings" class="w-100 m-1" columns="2" rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Cash'}">
                                                    <p:outputLabel value="Tenderd Amount" />
                                                    <h:panelGroup class="w-100 my-2" style="font-weight: bolder" >
                                                        <p:inputText id="paid" value="#{bookingControllerViewScope.strTenderedValue}"
                                                                     onfocus="this.select()">
                                                            <p:ajax event="keyup" process="paid" update="balance" listener="#{bookingControllerViewScope.calculateCashBalance}"/>
                                                        </p:inputText>
                                                    </h:panelGroup>

                                                    <p:outputLabel value="Balance" />
                                                    <h:panelGroup id="balance" class="w-100 my-2" style="font-weight: bolder" >
                                                        <p:outputLabel value="#{-bookingControllerViewScope.cashBalance}"/>
                                                    </h:panelGroup>

                                                </h:panelGrid>
                                                <h:panelGroup
                                                    class="row"
                                                    layout="block"
                                                    rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Credit'}" >
                                                    <div class="my-1" id="credit">
                                                        <div class="row">
                                                            <div class="col-12 d-flex ">
                                                                <p:autoComplete
                                                                    id="creditCompany"
                                                                    class="w-100 -mx-2"
                                                                    inputStyleClass="form-control"
                                                                    forceSelection="true"
                                                                    value="#{bookingControllerViewScope.creditCompany}"
                                                                    completeMethod="#{creditCompanyController.completeCredit}"
                                                                    var="ix"
                                                                    minQueryLength="4"
                                                                    placeholder="Company (Type at least 4 letters to search)"
                                                                    itemLabel="#{ix.name}"
                                                                    itemValue="#{ix}"
                                                                    size="10"  >

                                                                    <f:ajax
                                                                        event="itemSelect"
                                                                        execute="@this"
                                                                        render="#{p:resolveFirstComponentWithId('pBillDetails',view).clientId}  #{p:resolveFirstComponentWithId('tblRequests',view).clientId} #{p:resolveFirstComponentWithId('tblBillItem',view).clientId}" />
                                                                </p:autoComplete>
                                                                <p:commandLink
                                                                    id="btnAddNewCreditCom"
                                                                    value="(+)"
                                                                    class="mx-3 mt-1"
                                                                    title="Add New Credit Company"
                                                                    ajax="false"
                                                                    action="#{navigationController.navigateToCreditCompany()}"
                                                                    actionListener="#{creditCompanyController.prepareAdd()}" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row"
                                                    layout="block"
                                                    rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Staff'}" >
                                                    <div class="my-1" id="staffCredit">
                                                        <div class="row mt-1">
                                                            <div class="col-12">
                                                                <p:autoComplete
                                                                    minQueryLength="4"
                                                                    forceSelection="true"
                                                                    value="#{bookingControllerViewScope.toStaff}"
                                                                    id="creditStaff"
                                                                    completeMethod="#{staffController.completeStaff}"
                                                                    var="mys"
                                                                    class="w-100"
                                                                    placeholder="Staff (Type at least 4 letters to search)"
                                                                    inputStyleClass="form-control"
                                                                    itemLabel="#{mys.person.name}"
                                                                    itemValue="#{mys}"
                                                                    size="10">
                                                                    <p:column headerText="Name" >
                                                                        <h:outputText value="#{mys.person.nameWithTitle}" ></h:outputText>
                                                                    </p:column>
                                                                    <p:column headerText="EPF" >
                                                                        <h:outputText value="#{mys.epfNo}" ></h:outputText>
                                                                    </p:column>
                                                                    <p:column headerText="Credit Entitlement">
                                                                        <h:outputText value="#{mys.creditLimitQualified}" >
                                                                            <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                        </h:outputText>
                                                                    </p:column>
                                                                    <p:column  headerText="Credit Utilized">
                                                                        <h:outputText value="#{mys.currentCreditValue}" >
                                                                            <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                        </h:outputText>
                                                                    </p:column>
                                                                    <p:ajax process="@this"
                                                                            update="#{p:resolveFirstComponentWithId('pBillDetails',view).clientId}  #{p:resolveFirstComponentWithId('tblRequests',view).clientId} #{p:resolveFirstComponentWithId('tblBillItem',view).clientId}"
                                                                            event="itemSelect" />
                                                                </p:autoComplete>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row"
                                                    layout="block"
                                                    rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Staff_Welfare'}" >
                                                    <div class="my-1" id="swf">
                                                        <div class="row mt-1">
                                                            <div class="col-12">
                                                                <p:autoComplete
                                                                    minQueryLength="3"
                                                                    forceSelection="true"
                                                                    value="#{bookingControllerViewScope.toStaff}"
                                                                    id="welfareStaff"
                                                                    completeMethod="#{staffController.completeStaff}"
                                                                    var="mys"
                                                                    class="w-100"
                                                                    placeholder="Staff (Type at least 4 letters to search)"
                                                                    inputStyleClass="form-control"
                                                                    itemLabel="#{mys.person.name}"
                                                                    itemValue="#{mys}"
                                                                    size="10">
                                                                    <p:column headerText="Name" >
                                                                        <h:outputText value="#{mys.person.nameWithTitle}" ></h:outputText>
                                                                    </p:column>
                                                                    <p:column headerText="EPF" >
                                                                        <h:outputText value="#{mys.epfNo}" ></h:outputText>
                                                                    </p:column>
                                                                    <p:column headerText="Welfare Entitlement">
                                                                        <h:outputText value="#{mys.annualWelfareQualified}" >
                                                                            <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                        </h:outputText>
                                                                    </p:column>
                                                                    <p:column  headerText="Welfare Utilized">
                                                                        <h:outputText value="#{mys.annualWelfareUtilized}" >
                                                                            <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                        </h:outputText>
                                                                    </p:column>
                                                                    <p:ajax process="@this"
                                                                            update="#{p:resolveFirstComponentWithId('pBillDetails',view).clientId}  #{p:resolveFirstComponentWithId('tblRequests',view).clientId} #{p:resolveFirstComponentWithId('tblBillItem',view).clientId}"
                                                                            event="itemSelect" />
                                                                </p:autoComplete>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1"
                                                    layout="block"
                                                    id="creditCard" rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Card'}" >
                                                    <pa:creditCard paymentMethodData="#{bookingControllerViewScope.paymentMethodData}"/>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1"
                                                    layout="block"
                                                    id="eWallet"  rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'ewallet'}" >
                                                    <pa:ewallet paymentMethodData="#{bookingControllerViewScope.paymentMethodData}"/>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1"
                                                    layout="block"
                                                    id="cheque"  rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Cheque'}" >
                                                    <pa:cheque paymentMethodData="#{bookingControllerViewScope.paymentMethodData}"/>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1"
                                                    layout="block"
                                                    id="slip"  rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Slip'}" >
                                                    <pa:slip paymentMethodData="#{bookingControllerViewScope.paymentMethodData}"/>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1"
                                                    layout="block"
                                                    id="patientDeposit"  rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'PatientDeposit'}" >
                                                    <pa:patient_deposit paymentMethodData="#{bookingControllerViewScope.paymentMethodData}"/>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    class="row my-1 w-100"
                                                    layout="block"
                                                    id="multiplePaymentMethods"  rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'MultiplePaymentMethods'}"
                                                    >
                                                    <pa:multiple_payment_methods controller="#{bookingControllerViewScope}" paymentMethods="#{enumController.paymentMethodsForChanneling}" class="w-100"/>

                                                </h:panelGroup>
                                                <!-- Agent Payment Method -->
                                                <p:panelGrid columns="1" rendered="#{bookingControllerViewScope.settlePaymentMethod eq 'Agent'}" >
                                                    <f:facet name="header">
                                                        <div class="d-flex align-items-center justify-content-between">
                                                            <h:outputLabel id="agent" value="Agent" />
                                                            <div class=" mx-4">
                                                                <p:outputLabel class="mx-2" value="Agent Balance" />
                                                                <h:outputLabel id="balance2" value="#{empty bookingControllerViewScope.institution.ballance ? '00.00' : bookingControllerViewScope.institution.ballance}" />
                                                            </div>
                                                        </div>
                                                    </f:facet>

                                                    <p:row>
                                                        <p:column>
                                                            <h:outputLabel value="Agent Details" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:autoComplete class="w-75 mx-2" id="agent2" forceSelection="true"
                                                                            value="#{bookingControllerViewScope.institution}" completeMethod="#{agencyController.completeAgency}" var="ix"
                                                                            itemLabel="#{ix.name}" itemValue="#{ix}" size="38">
                                                                <f:ajax event="itemSelect" execute="@this" render="balance2 totalsPanel agRefLbl agRefTxt :#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} gdManageBookings" listener="#{bookingControllerViewScope.validateAgentBalance()}"/>
                                                                <p:column>#{ix.institutionCode}</p:column>
                                                                <p:column>#{ix.name}</p:column>
                                                            </p:autoComplete>
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel for="agRefTxt" value="Agent Ref No" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:inputText size="38" class="mx-2" autocomplete="off" id="agRefTxt" value="#{bookingControllerViewScope.agentRefNo}" />
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column colspan="2">
                                                            <p:dataTable class="w-100" id="tblAgentBooks" emptyMessage="No Reference Books"
                                                                         value="#{bookingControllerViewScope.institution.agentReferenceBooks}" var="a">
                                                                <f:facet name="header">
                                                                    <p:outputLabel value="Agent Reference Number Details" />
                                                                </f:facet>
                                                                <p:column headerText="S.R.N.">
                                                                    <p:outputLabel value="#{a.startingReferenceNumber}">
                                                                        <f:convertNumber pattern="00000" />
                                                                    </p:outputLabel>
                                                                </p:column>
                                                                <p:column headerText="E.R.N.">
                                                                    <p:outputLabel value="#{a.endingReferenceNumber}">
                                                                        <f:convertNumber pattern="00000" />
                                                                    </p:outputLabel>
                                                                </p:column>
                                                            </p:dataTable>
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                            </h:panelGroup>
                                        </p:panel>

                                        <p:panel 
                                            header="Manage Services" 
                                            rendered="#{bookingControllerViewScope.selectedBillSession.bill.billType.parent eq 'ChannelCreditFlow' 
                                                        and bookingControllerViewScope.selectedBillSession.bill.cancelled ne true 
                                                        and bookingControllerViewScope.selectedBillSession.bill.paidAmount eq 0}">
                                            <p:selectOneMenu 
                                                class="w-75 mx-1" 
                                                autoWidth="false" 
                                                id="lstItems" 
                                                value="#{bookingControllerViewScope.itemToAddToBooking}" >
                                                <f:selectItem itemLabel="Select" ></f:selectItem>
                                                <f:selectItems  value="#{bookingControllerViewScope.itemsAvailableToAddToBooking}" var="iata" itemValue="#{iata}"  itemLabel="#{iata.name}" ></f:selectItems>
                                                <!--<p:ajax event="change" process="lstItems" update="lblSessionTotal :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId}" listener="#{bookingControllerViewScope.fillFees}" ></p:ajax>-->
                                            </p:selectOneMenu>

                                            <p:commandButton 
                                                id="btnAddItem"
                                                process="lstItems btnAddItem"
                                                value="Add Item" 
                                                icon="fas fa-plus"
                                                class="ui-button-success"
                                                action="#{bookingControllerViewScope.addItemToBookingAtSettling()}"
                                                update="lstItems tblBillItemsForAddingNewItem tblBillFeesForAddingNewItem totalsPanel gdManageBookings balance :#{p:resolveFirstComponentWithId('balance',view).clientId} "
                                                ></p:commandButton>

                                            <p:dataTable id="tblBillItemsForAddingNewItem" 
                                                         value="#{bookingControllerViewScope.selectedBillSession.bill.billItems}" 
                                                         var="bi" >
                                                <p:column >
                                                    <h:outputText value="#{bi.item.name}" ></h:outputText>
                                                </p:column>
                                                <p:column>
                                                    <h:outputText value="#{bookingControllerViewScope.foriegn ? bi.item.totalForForeigner : bi.netValue}" />
                                                </p:column>
                                                <p:column >
                                                    <p:commandButton 
                                                        id="btnRemove"
                                                        ajax="false"
                                                        icon="fas fa-trash"
                                                        disabled="#{bookingControllerViewScope.checkItemIsSessionInstance(bi)}"
                                                        class="ui-button-danger"
                                                        action="#{bookingControllerViewScope.removeAddedAditionalItem()}"
                                                        >
                                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillItem}" value="#{bi}"/>
                                                    </p:commandButton>
                                                </p:column>
                                            </p:dataTable>
                                            
                                            <p:growl id="msg" life="2000"></p:growl>
                                            <p:dataTable 
                                                id="tblBillFeesForAddingNewItem" 
                                                value="#{bookingControllerViewScope.selectedBillSession.bill.billFeesWIthoutZeroValue}" 
                                                var="bf" >
                                                <p:column headerText="Fee">
                                                    <h:outputText value="#{bf.fee.item.name} - " ></h:outputText>
                                                    <h:outputText value="#{bf.fee.name}" ></h:outputText>
                                                </p:column>
                                                <p:column rendered="false" headerText="Gross Fee">
                                                    <h:outputText value="#{bf.feeGrossValue}" >
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </h:outputText>
                                                </p:column>
                                                <p:column rendered="false" headerText="Discount">
                                                    <h:outputText value="#{bf.feeDiscount}" >
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </h:outputText>
                                                </p:column>
                                                <p:column headerText="Value">
                                                    <p:inputText id="txtFee" styleClass="updateFeeValue" onkeyup="validateFeeValue(this)" value="#{bf.feeValue}" onfocus="this.select()">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                        <p:ajax event="keyup" 
                                                                process="txtFee paymentDetails" 
                                                                update=":#{p:resolveFirstComponentWithId('lstItems',view).clientId} 
                                                                :#{p:resolveFirstComponentWithId('tblBillItemsForAddingNewItem',view).clientId} 
                                                                :#{p:resolveFirstComponentWithId('balance',view).clientId} 
                                                                :#{p:resolveFirstComponentWithId('totalsPanel',view).clientId} gdManageBookings balance" 
                                                                listener="#{bookingControllerViewScope.calculateBillTotalsFromBillFeesForChangingFeeBeforeBillSettlings(bf)}"
                                                                onstart="return validateFeeValue(document.querySelector('.updateFeeValue'))"
                                                                delay="500" /> <!-- Added a delay to avoid too frequent requests -->
                                                    </p:inputText>
                                                    <p:tag styleClass="tagText" value="Not a correct value" severity="danger" style="display: none" icon="pi pi-times-circle"></p:tag>
                                                </p:column>

                                            </p:dataTable>

                                            <script>

                                                function validateFeeValue(updateFeeInput) {
//                                                    const updateFeeInput = document.querySelector('.updateFeeValue');
                                                    console.log("start function");
                                                    let value = updateFeeInput.value.trim().replace(/,/g, '');
                                                    if(!value){
                                                        console.log("return function "+updateFeeInput.value);
                                                        return false;
                                                    }
                                                    
                                                    console.log(value);

                                                    if (value === "" || isNaN(value) || !value) {
                                                        document.querySelector('.tagText').style.display = 'block';
                                                        console.log("Dont send");
                                                        return false;
                                                    }
                                                    
                                                    return true;
                                                }


                                            </script>

                                        </p:panel>

                                        <p:dataTable 
                                            class="m-1"
                                            rendered="#{bookingControllerViewScope.selectedBillSession.bill.billType.parent ne 'ChannelCreditFlow' 
                                                        or bookingControllerViewScope.selectedBillSession.bill.cancelled eq true 
                                                        or bookingControllerViewScope.selectedBillSession.bill.paidAmount ne 0}"
                                            id="tblBillFeesAdded" 
                                            value="#{bookingControllerViewScope.selectedBillSession.bill.billFeesWIthoutZeroValue}" 
                                            var="bfa" >
                                            <p:column headerText="Fee">
                                                <h:outputText value="#{bfa.fee.item.name}" ></h:outputText>
                                                <p:splitter ></p:splitter>
                                                <h:outputText value="#{bfa.fee.name}" ></h:outputText>
                                            </p:column>
                                            <p:column rendered="false" headerText="Gross Fee">
                                                <h:outputText value="#{bfa.feeGrossValue}" >
                                                    <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                </h:outputText>
                                            </p:column>
                                            <p:column rendered="false" headerText="Discount">
                                                <h:outputText value="#{bfa.feeDiscount}" >
                                                    <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                </h:outputText>
                                            </p:column>
                                            <p:column headerText="Value" >
                                                <h:outputText id="txtFee" value="#{bfa.feeGrossValue}" >
                                                    <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                </h:outputText>
                                            </p:column>
                                        </p:dataTable>

                                    </div>

                                </div>
                            </h:panelGroup>
                        </p:tab>
                        <p:tab title="Booking" id="booking" class="w-100">
                            <div class="row" >
                                <div class="col-12" >
                                    <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.markedToCancel}" class="w-100 bg-danger text-white p-2" layout="block">
                                        <i class="fas fa-ban text-white m-3"></i>
                                        <h:outputText value="Marked to Cancel" />
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.markedToRefund}"  class="w-100 bg-danger text-white p-2" layout="block">
                                        <i class="fas fa-undo-alt  text-white m-3" ></i>
                                        <h:outputText value="Marked to Refund"  />
                                    </h:panelGroup>
                                </div>
                            </div>
                            <div class="row" >
                                <div class="d-flex" >
                                    <h:panelGroup rendered="false">
                                        <p:panel header="Booking" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill eq null and bookingControllerViewScope.selectedBillSession.bill.balance ne 0.0}">
                                            <div class="ui-message-error ui-widget ui-corner-all">
                                                <span class="ui-message-error-icon"/>
                                                <span class="ui-message-error-detail">
                                                    <h:outputText value="NOT PAID YET" ></h:outputText>
                                                </span>
                                            </div>

                                            <h:panelGrid columns="2">
                                                <p:outputLabel value="Name"/>
                                                <p:commandLink value="#{bookingControllerViewScope.selectedBillSession.bill.patient.person.nameWithTitle}"
                                                               action="#{patientController.toPatientFromSearchPatients()}">
                                                    <f:setPropertyActionListener value="#{bookingControllerViewScope.selectedBillSession.bill.patient}"
                                                                                 target="#{patientController.current}" ></f:setPropertyActionListener>
                                                </p:commandLink>
                                                <p:outputLabel value="Consultant"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.serviceSession.staff.person.nameWithTitle}"/>
                                                <p:outputLabel value="Serial No"/>
                                                <ui:repeat value="#{bookingControllerViewScope.selectedBillSession.bill.billItems}" var="bis" >
                                                    <p:outputLabel value="#{bis.billSession.serialNo}"/>
                                                </ui:repeat>
                                                <p:outputLabel value="Appointment Date">
                                                </p:outputLabel>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.sessionDate}"> 
                                                    <f:convertDateTime pattern="dd MMM yyyy" >
                                                    </f:convertDateTime>
                                                </p:outputLabel>
                                                <p:outputLabel value="Appointment Time">
                                                </p:outputLabel>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.serviceSession.startingTime}"> 
                                                    <f:convertDateTime pattern="hh:mm a" ></f:convertDateTime>
                                                </p:outputLabel>
                                                <p:separator ></p:separator>
                                                <p:separator ></p:separator>
                                                <p:outputLabel value="Payment Method"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod}"/>
                                                <p:outputLabel value="Agent" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.fromInstitution.name}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                                <p:outputLabel value="Agent Ref No" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.billItem.agentRefNo}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                                <p:outputLabel value="Staff Name" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingControllerViewScope.selectedBillSession.bill.toStaff.code}) " rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                                <p:outputLabel value="User"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.creater.webUserPerson.nameWithTitle}"/>
                                                <p:outputLabel value="Settled At" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill ne null}"/>
                                                <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill ne null}"> 
                                                    <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" ></f:convertDateTime>
                                                </p:outputLabel>
                                                <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}" ></p:separator>
                                                <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}" ></p:separator>
                                                <p:outputLabel style="color: red" value="Payment" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}" />
                                                <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}"/>
                                                <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}"/>
                                                <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}"/>
                                                <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}"/>
                                                <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.selectedBillSession.bill.refunded==true}">
                                                    <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a"  ></f:convertDateTime>
                                                </p:outputLabel> 
                                            </h:panelGrid>                            
                                        </p:panel>
                                    </h:panelGroup>
                                    <p:panel class="w-100"  header="Booking">
                                        <div class="row w-100">
                                            <div class="d-flex">
                                                <p:panel class="w-100">

                                                    <h:panelGrid columns="2" styleClass="w-100" columnClasses="label,value">
                                                        <p:outputLabel value="Consultant" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.sessionInstance.staff.name}"/>

                                                        <p:outputLabel value="Session" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.sessionInstance.originatingSession.name}"/>

                                                        <p:outputLabel value="Appointment No" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.serialNo}"/>

                                                        <p:outputLabel value="Start At" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.sessionInstance.originatingSession.startingTime}">
                                                            <f:convertDateTime pattern="HH:mm a"/>
                                                        </h:outputText>
                                                        <p:outputLabel value="Session Date" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.sessionInstance.sessionDate}"  >
                                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                        </h:outputText>
                                                        <p:outputLabel value="Payment Method" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod}"/>

                                                        <p:outputLabel value="Agent" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.fromInstitution.name}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Agent Ref No" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.billItem.agentRefNo}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Staff Name" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Staff'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingControllerViewScope.selectedBillSession.bill.toStaff.code})" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>

                                                        <p:outputLabel value="User" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.creater.webUserPerson.nameWithTitle}" />

                                                        <p:outputLabel value="Booked At" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.createdAt}">
                                                            <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" />
                                                        </p:outputLabel>

                                                        <p:outputLabel value="Settled At" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill ne null}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill ne null}">
                                                            <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" />
                                                        </p:outputLabel>

                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>
                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Payment" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}" />
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.bill.billedBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}">
                                                            <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" />
                                                        </p:outputLabel>
                                                    </h:panelGrid>
                                                    <p:panel header="Settling" class="my-4" rendered="#{(bookingControllerViewScope.selectedBillSession.bill.paidBill ne bookingControllerViewScope.selectedBillSession.bill) and bookingControllerViewScope.selectedBillSession.bill.balance eq 0.0}">
                                                        <h:panelGrid columns="2">
                                                            <p:outputLabel value="Bill ID"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.deptId}"/>
                                                            <p:outputLabel value="Payment Method"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.paymentMethod}"/>
                                                            <p:outputLabel value="Agent" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.creditCompany.name}"
                                                                           rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                                            <p:outputLabel value="Agent Ref No" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.agentRefNo}" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                                            <p:outputLabel value="User"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.creater.webUserPerson.nameWithTitle}"/>
                                                            <p:outputLabel value="Settled At"/>
                                                            <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.bill.paidBill.createdAt}"> 
                                                                <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" ></f:convertDateTime>
                                                            </p:outputLabel>
                                                        </h:panelGrid>                            
                                                    </p:panel>
                                                </p:panel>

                                                <p:panel header="Rescheduled From" class="w-100 mx-1" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession ne null}">
                                                    <h:panelGrid columns="2" styleClass="w-100" columnClasses="label,value">
                                                        <p:outputLabel value="Consultant" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.sessionInstance.staff.name}"/>

                                                        <p:outputLabel value="Session" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.sessionInstance.originatingSession.name}"/>

                                                        <p:outputLabel value="Appointment No" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.serialNo}"/>

                                                        <p:outputLabel value="Start At" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.sessionInstance.originatingSession.startingTime}">
                                                            <f:convertDateTime pattern="HH:mm a"/>
                                                        </h:outputText>
                                                        <p:outputLabel value="Session Date" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.sessionInstance.sessionDate}"  >
                                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                        </h:outputText>
                                                        <p:outputLabel value="Booked At" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.createdAt}">
                                                            <f:convertDateTime pattern="MM/dd/yyyy HH:mm a"/>
                                                        </h:outputText>

                                                        <p:outputLabel value="Payment Method" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod}"/>

                                                        <p:outputLabel value="Agent" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.fromInstitution.name}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Agent Ref No" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.billItem.agentRefNo}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Staff Name" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod eq 'Staff'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.toStaff.code})" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paymentMethod eq 'Staff'}"/>

                                                        <p:outputLabel value="User" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.creater.webUserPerson.nameWithTitle}"/>

                                                        <p:outputLabel value="Settled At" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paidBill ne null}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paidBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.paidBill ne null}">
                                                            <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" />
                                                        </p:outputLabel>

                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>
                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Payment" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.billedBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledFromBillSession.bill.refunded == true}">
                                                            <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" />
                                                        </p:outputLabel>
                                                    </h:panelGrid>

                                                </p:panel>
                                                <p:panel header="Rescheduled To" class="w-100 mx-1" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession ne null}">
                                                    <h:panelGrid columns="2" styleClass="w-100" columnClasses="label,value">
                                                        <p:outputLabel value="Consultant" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.sessionInstance.staff.name}"/>

                                                        <p:outputLabel value="Session" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.sessionInstance.originatingSession.name}"/>

                                                        <p:outputLabel value="Appointment No" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.serialNo}"/>

                                                        <p:outputLabel value="Start At" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.sessionInstance.originatingSession.startingTime}">
                                                            <f:convertDateTime pattern="HH:mm a"/>
                                                        </h:outputText>

                                                        <p:outputLabel value="Session Date" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.sessionInstance.sessionDate}"  >
                                                            <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                        </h:outputText>

                                                        <p:outputLabel value="Booked At" style="font-weight: bold"/>
                                                        <h:outputText value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.createdAt}">
                                                            <f:convertDateTime pattern="MM/dd/yyyy HH:mm a"/>
                                                        </h:outputText>

                                                        <p:outputLabel value="Payment Method" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod}"/>

                                                        <p:outputLabel value="Agent" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.fromInstitution.name}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Agent Ref No" rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'Agent'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.billItem.agentRefNo}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod eq 'Agent'}"/>

                                                        <p:outputLabel value="Staff Name" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod eq 'Staff'}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.toStaff.code})" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paymentMethod eq 'Staff'}"/>

                                                        <p:outputLabel value="User" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.creater.webUserPerson.nameWithTitle}"/>

                                                        <p:outputLabel value="Settled At" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paidBill ne null}" style="font-weight: bold"/>
                                                        <p:outputLabel value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paidBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.paidBill ne null}">
                                                            <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" />
                                                        </p:outputLabel>

                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>
                                                        <p:separator rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Payment" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingControllerViewScope.selectedBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>

                                                        <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}"/>
                                                        <p:outputLabel style="color: red" value="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.billedBill.createdAt}" rendered="#{bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.cancelled == true or bookingControllerViewScope.selectedBillSession.rescheduledToBillSession.bill.refunded == true}">
                                                            <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" />
                                                        </p:outputLabel>
                                                    </h:panelGrid>

                                                </p:panel>
                                            </div>

                                        </div>
                                    </p:panel>
                                </div>

                                <div class="col" >
                                    <p:commandButton 
                                        value="To Print as Original"
                                        ajax="false"
                                        immediate="true"
                                        class="ui-button-danger m-1"
                                        disabled="#{!webUserController.hasPrivilege('ChannellingReprintOriginalBill')}"
                                        action="#{bookingControllerViewScope.toReprintAsOriginal()}"
                                        >
                                    </p:commandButton>
                                    <p:commandButton
                                        value="To Print Online Booking"
                                        ajax="false"
                                        immediate="true"
                                        class="ui-button-warning m-1"
                                        action="#{bookingControllerViewScope.toPrintOnlineBill()}"
                                        rendered="#{bookingControllerViewScope.selectedBillSession.bill.paymentMethod eq 'OnlineSettlement' and !bookingControllerViewScope.selectedBillSession.bill.printed}"
                                        >
                                    </p:commandButton>
                                    <p:commandButton 
                                        value="To Print as Duplicate"
                                        ajax="false"
                                        class="ui-button-warning m-1"
                                        action="#{bookingControllerViewScope.toReprintAsDuplicate()}"
                                        >
                                    </p:commandButton>

                                </div>
                            </div>
                            <div class="row" >
                                <div class="col-12" >

                                </div>
                            </div>

                        </p:tab>

                        <p:tab title="Reprint" id="rePrint" disabled="#{!webUserController.hasPrivilege('ChannellingReprintOriginalBill')}">

                            <h:panelGroup>
                                <div class="row">
                                    <h:panelGroup class="mt-5" rendered="#{!webUserController.hasPrivilege('ChannellingReprintOriginalBill')}">
                                        <div class="text-center">
                                            <i class="fa-solid fa-triangle-exclamation" style="font-size: 72pt"></i>
                                            <h3>You Do Not Have Permission to Access The Requested Page</h3>
                                        </div>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{webUserController.hasPrivilege('ChannellingReprintOriginalBill')}">
                                        <div class="col-12">
                                            <p:panel>
                                                <div class="row">
                                                    <f:facet name="header">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h:outputLabel value="Reprint Original" />

                                                            <div>
                                                                <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                                                                <p:selectOneMenu
                                                                    value="#{sessionController.departmentPreference.channelBillPaperType}"
                                                                    class="m-1"
                                                                    style="width: 13em;">
                                                                    <f:selectItem itemLabel="Please Select Paper Type" />
                                                                    <f:selectItems value="#{enumController.paperTypes}" />
                                                                </p:selectOneMenu>
                                                                <p:commandButton
                                                                    ajax="false"
                                                                    icon="fa fa-sync-alt"
                                                                    class="ui-button-primary m-1"
                                                                    title="Redraw Bill">
                                                                </p:commandButton>
                                                                <p:commandButton
                                                                    value="Print"
                                                                    ajax="false"
                                                                    class="ui-button-info  m-1"
                                                                    icon="fa fa-print"
                                                                    action="#"
                                                                    >
                                                                    <p:printer target="groupChannelBillReprintAsOriginal" ></p:printer>
                                                                </p:commandButton>

                                                                <p:commandButton 
                                                                    value="Close Print"
                                                                    ajax="false"
                                                                    action="#{bookingControllerViewScope.closePrinting()}"
                                                                    class="ui-button-warning m-1"
                                                                    icon="fa fa-close">
                                                                </p:commandButton>

                                                            </div>
                                                        </div>
                                                    </f:facet>
                                                    <div class="col-md-12 mt-2">
                                                        <div class="d-flex justify-content-center">

                                                            <h:panelGroup id="groupChannelBillReprintAsOriginal">
                                                                <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">

                                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is PosPaper',true)}">
                                                                        <ez:bmsChannelBill  bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                                    </h:panelGroup>
                                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFivePaper',true)}">
                                                                        <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                                    </h:panelGroup>
                                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFIvePaperCustom2',true)}">
                                                                        <ez:fivefivePapaerCustom2 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                                    </h:panelGroup>
                                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFIvePaperCustom3',true)}">
                                                                        <ez:fivefivePapaerCustom3 bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                                    </h:panelGroup>
                                                                    <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Reprint Original Bill is FiveFivePrintedPaper',true)}">
                                                                        <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                                                    </h:panelGroup>

                                                                </ui:repeat>
                                                            </h:panelGroup>
                                                        </div>
                                                    </div>
                                                </div>
                                            </p:panel>
                                        </div>
                                    </h:panelGroup>
                                </div>
                            </h:panelGroup>
                        </p:tab>

                        <p:tab title="Cancel" id="cancel"  disabled="#{!webUserController.hasPrivilege('ChannelBookingCancel')}">                                                         

                            <h:panelGroup rendered="#{!bookingControllerViewScope.printPreviewC}" >
                                #{bookingControllerViewScope.selectedBillSession.bill.paymentMethod}
                                <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill ne null ? (bookingControllerViewScope.selectedBillSession.bill.referenceBill.onlineBooking ne null ? true : false):false}">
                                    <ch:bill_fees bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill.referenceBill}" />
                                </h:panelGroup>

                                <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.bill.referenceBill eq null}">
                                    <ch:bill_fees bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                </h:panelGroup>

                                <div class="d-flex gap-4 mt-2">
                                    <div class="d-flex gap-2">
                                        <p:outputLabel value="Re-payment Method" class="mt-2"/>
                                        <p:selectOneMenu  id="cmbCancellPs" value="#{bookingControllerViewScope.cancelPaymentMethod}">
                                            <f:selectItem itemLabel="Select Cancel Payment Method" ></f:selectItem>
                                            <f:selectItem itemLabel="Same As Billed Bill" itemValue="#{bookingControllerViewScope.billSession ne null ? (bookingControllerViewScope.billSession.bill.paidBill ne null ?  bookingControllerViewScope.billSession.bill.paidBill.paymentMethod : bookingControllerViewScope.billSession.bill.paymentMethod) : null}" ></f:selectItem>
                                            <f:selectItems value="#{bookingControllerViewScope.paymentMethodsToChannelCancellation}"/>
                                        </p:selectOneMenu>
                                    </div>
                                    <p:commandButton 
                                        value="Cancel Booking"  
                                        class="ui-button-danger" 
                                        icon="fas fa-cancel"
                                        disabled="#{ bookingControllerViewScope.selectedBillSession.bill.refunded==true
                                                     or bookingControllerViewScope.selectedBillSession.bill.cancelled==true}"
                                        onclick="PF('confirmationDialog').show();">
                                    </p:commandButton>
                                </div>

                            </h:panelGroup>
                            <h:panelGroup rendered="#{bookingControllerViewScope.printPreviewC}" >
                                <div class="d-flex justify-content-between">
                                    <h:outputLabel value="" />

                                    <div class="d-flex  gap-2">
                                        <p:outputLabel value="Paper Type" class="m-1"></p:outputLabel>
                                        <p:selectOneMenu
                                            value="#{sessionController.departmentPreference.channelBillPaperType}"

                                            style="width: 13em;">
                                            <f:selectItem itemLabel="Please Select Paper Type" />
                                            <f:selectItems value="#{enumController.paperTypes}" />
                                            <p:ajax event="itemSelect" process="@this" update="gpCancelBillPreview" />
                                        </p:selectOneMenu>
                                        <p:commandButton
                                            id="btnRefreshC"
                                            process="@this"
                                            update="gpCancelBillPreview"
                                            icon="fa fa-sync-alt"
                                            class="ui-button"
                                            title="Redraw Bill">
                                        </p:commandButton>
                                        <p:commandButton
                                            value="Print"
                                            ajax="false"
                                            action="#"
                                            class="ui-button-info"
                                            icon="fa fa-print"
                                            >
                                            <p:printer target="gpCancelBillPreview" ></p:printer>
                                        </p:commandButton>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-center mt-4">
                                    <h:panelGroup id="gpCancelBillPreview">
                                        <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">

                                            <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Cancel Bill is PosPaper',true)}">
                                                <ez:bmsChannelBill  bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Cancel Bill is FiveFivePaper',true)}">
                                                <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}" />
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Cancel Bill is FiveFIvePaperCustom2',true)}">
                                                <ez:fivefivePapaerCustom2  bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Cancel Bill is FiveFIvePaperCustom3',true)}">
                                                <ez:fivefivePapaerCustom3  bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booking By Dates Cancel Bill is FiveFivePrintedPaper',true)}">
                                                <ez:bms5x5WIthoutHeaderChannelBill bill="#{bookingControllerViewScope.selectedBillSession.billItem.bill}"/>
                                            </h:panelGroup>

                                        </ui:repeat>
                                    </h:panelGroup>
                                </div>
                            </h:panelGroup>
                            <p:dialog minHeight="100" width="800" header="Confirmation" widgetVar="confirmationDialog" modal="true" resizable="false">
                                <p>Are you sure you want to cancel the channel booking?</p>
                                <p:selectOneMenu 
                                    id="commentsMenuCancel" 
                                    value="#{bookingControllerViewScope.comment}" 
                                    editable="true" 
                                    filter="true" 
                                    placeholder="Select or enter a comment"
                                    filterMatchMode="contains"  
                                    style="float: right; width: 100%" 
                                    class="p-2">
                                    <f:selectItem itemLabel="Select or enter a comment" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems 
                                        value="#{configOptionApplicationController.getListOfCustomOptions('Channel Bill Canceling Comments')}" 
                                        var="option" 
                                        itemLabel="#{option}" 
                                        itemValue="#{option}"/>
                                </p:selectOneMenu>



                                <f:facet name="footer">
                                    <p:commandButton
                                        class="mx-2 ui-button-warning"
                                        ajax="false"
                                        value="Yes"
                                        action="#{bookingControllerViewScope.channelBookingCancel()}"
                                        onclick="PF('confirmationDialog').hide();" />
                                    <p:commandButton
                                        value="No"
                                        onclick="PF('confirmationDialog').hide();" />
                                </f:facet>
                            </p:dialog>

                        </p:tab>


                        <p:tab title="Refund" id="refund"   disabled="#{!webUserController.hasPrivilege('ChannelBookingRefund')}">                          

                            <h:panelGroup>
                                <h:panelGrid columns="2" rendered="#{bookingControllerViewScope.billSession.billItem.bill.paymentMethod eq 'Agent'}" >

                                    <p:outputLabel value="Re-payment Method"/>
                                    <p:selectOneMenu  id="cmbRefundPs" value="#{bookingControllerViewScope.refundPaymentMethod}" >  
                                        <f:selectItem itemLabel="Select Cancel Payment Method" ></f:selectItem>
                                        <f:selectItems value="#{enumController.paymentMethodsForChannelAgentSettle}"/>
                                    </p:selectOneMenu>

                                </h:panelGrid>
                                <!--                                <h:panelGrid columns="2">
                                                                    <h:outputLabel value="Refundable Total : "/>
                                                                    <h:outputLabel id="tot" value="#{bookingControllerViewScope.refundableTotal}"/>
                                                                </h:panelGrid>-->
                                <p:dataTable value="#{bookingControllerViewScope.billSession.bill.referenceBill ne null ? 
                                                      (bookingControllerViewScope.billSession.bill.referenceBill.onlineBooking ne null ? 
                                                      bookingControllerViewScope.billSession.bill.referenceBill.billFeesWIthoutZeroValue : 
                                                      bookingControllerViewScope.billSession.bill.billFeesWIthoutZeroValue):
                                                      bookingControllerViewScope.billSession.bill.billFeesWIthoutZeroValue}" 
                                             var="bi">
                                    <p:column headerText="Fee Name">
                                        <p:outputLabel value="#{bi.fee.name}"/>
                                    </p:column>
                                    <p:column headerText="Fee Type">
                                        <p:outputLabel value="#{bi.fee.feeType}"/>
                                    </p:column>
                                    <p:column headerText="Fee Value">
                                        <p:outputLabel value="#{bi.feeValue}"/> 
                                    </p:column>
                                    <p:column headerText="Return Value">
                                        <p:inputText value="#{bi.tmpChangedValue}" disabled="#{configOptionApplicationController.getBooleanValueByKey('Disallow Modifications to Refund Amounts') or (configOptionApplicationController.getBooleanValueByKey('Channel Booking by date appoinment allow rufund doctor fee only') ? (bi.fee.feeType ne 'Staff' ? true :false) : false)}"  >
                                            <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId}" event="blur" listener="#{bookingControllerViewScope.calRefundTotal()}"/>
                                            <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId} @this" event="blur" listener="#{bookingControllerViewScope.checkRefundTotal()}"/>
                                        </p:inputText>
                                        <p:commandButton class="ui-button-warning mx-2"
                                                         icon="fas fa-copy"
                                                         action="#{bookingControllerViewScope.copyValue(bi)}"
                                                         ajax="false"
                                                         disabled="#{bi.fee.feeType eq 'OwnInstitution' and configOptionApplicationController.getBooleanValueByKey('Disable Hospital Fee Refunds')}"
                                                         rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Users to Fetch Refund Amounts Using a Button')}" >
                                            <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId}" event="click" listener="#{bookingControllerViewScope.calRefundTotal()}"/>
                                            <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId} @this" event="click" listener="#{bookingControllerViewScope.checkRefundTotal()}"/>
                                        </p:commandButton>
                                    </p:column>
                                </p:dataTable>
                            </h:panelGroup>
                            <div class="d-flex align-items-center justify-content-between mt-5">
                                <div class="d-flex align-items-center w-100">
                                    <p:selectOneMenu 
                                        id="commentsMenuRefund" 
                                        value="#{bookingControllerViewScope.commentR}" 
                                        editable="true" 
                                        filter="true" 
                                        placeholder="Select or enter a comment"
                                        filterMatchMode="contains"  
                                        style="float: right; width: 75%" 
                                        class="p-2">
                                        <f:selectItem itemLabel="Select or enter a comment" itemValue="" noSelectionOption="true"/>
                                        <f:selectItems 
                                            value="#{configOptionApplicationController.getListOfCustomOptions('Channel Bill Refunding Comments')}" 
                                            var="option" 
                                            itemLabel="#{option}" 
                                            itemValue="#{option}"/>
                                    </p:selectOneMenu>                                    
                                    <p:selectOneMenu class="py-2 mx-2 w-10" id="RefundPs" value="#{bookingControllerViewScope.refundPaymentMethod}">
                                        <f:selectItem itemLabel="Select Cancel Payment Method" ></f:selectItem>
                                        <f:selectItems value="#{enumController.paymentMethodsForChannel}"/>
                                    </p:selectOneMenu>

                                    <p:commandButton id="btnIdRefund" value="Refund Booking" class="ui-button-warning py-2" icon="fas fa-reply" ajax="false"
                                                     disabled="#{bookingControllerViewScope.billSession.bill.refunded==true
                                                                 or bookingControllerViewScope.billSession.bill.cancelled==true or bookingControllerViewScope.disableRefund==true}"
                                                     action="#{bookingControllerViewScope.channelBookingRefund()}">
                                        <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId}" event="click" listener="#{bookingControllerViewScope.calRefundTotal()}"/>
                                        <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId} @this" event="click" listener="#{bookingControllerViewScope.checkRefundTotal()}"/>
                                    </p:commandButton>

                                </div>
                            </div>

                            <h:panelGroup rendered="#{bookingControllerViewScope.selectedBillSession.bill.refunded}">
                                <div>
                                    <p:commandButton
                                        class="mx-2 ui-button-info"
                                        icon="fas fa-print"
                                        ajax="false"
                                        value="Print">
                                        <p:printer target="gpSettleRefundBillPreview" ></p:printer>
                                    </p:commandButton>
                                </div>
                                <h:panelGroup id="gpSettleRefundBillPreview">
                                    <ez:five_five_paper_without_headings_channel_RefundBill bill="#{bookingControllerViewScope.selectedBillSession.bill}"/>
                                </h:panelGroup>
                            </h:panelGroup>

                        </p:tab>

                        <p:tab 
                            title="Change Patient"
                            id="change" 
                            rendered="#{webUserController.hasPrivilege('ChannelBookingChange') and bookingControllerViewScope.selectedBillSession.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}">
                            <p:panelGrid columns="2" class="w-100">
                                <f:facet name="header" >
                                    <p:outputLabel class="mx-2" value="Change Current Patient with a new Patient" ></p:outputLabel>
                                    <p:commandButton ajax="false" value="Change Patient" disabled ="#{bookingControllerViewScope.selectedBillSession.bill.creditCompany.institutionCode.equalsIgnoreCase('WEB_DOC990') and (bookingControllerViewScope.selectedBillSession.absent == true or bookingControllerViewScope.selectedBillSession.bill.cancelled == true)}" action="#{bookingControllerViewScope.changePatient()}" ></p:commandButton>
                                </f:facet>
                                <p:panel header="Current Patient for Booking" >
                                    <ezcommon:patient patient="#{bookingControllerViewScope.selectedBillSession.bill.patient}" ></ezcommon:patient>
                                </p:panel>
                                <ezcommon:patient_details_view_scope_1 editable="true" controller="#{bookingControllerViewScope}" ></ezcommon:patient_details_view_scope_1>
                            </p:panelGrid>
                        </p:tab>

                        <p:tab 
                            title="Change Appointment Details"
                            id="changeNumber" 
                            rendered="#{webUserController.hasPrivilege('ChannelBookingChange') and bookingControllerViewScope.selectedBillSession.bill.referenceBill eq null}">

                            <h:panelGrid columns="2" class="my-2">
                                <p:outputLabel value="Patient Name"/>
                                <p:inputText autocomplete="off" 
                                             value="#{bookingControllerViewScope.selectedBillSession.bill.patient.person.name}" />
                                <p:outputLabel value="Patient Phoone Number"/>
                                <p:inputText autocomplete="off" value="#{bookingControllerViewScope.selectedBillSession.bill.patient.person.phone}" />
                                <p:outputLabel value="Current Appointment No"/>
                                <ui:repeat value="#{bookingControllerViewScope.selectedBillSession.bill.billItems}" var="bis" >
                                    <p:outputLabel value="#{bis.billSession.serialNo}">                                        
                                    </p:outputLabel>
                                </ui:repeat>
                                <p:outputLabel value="Appointment No"/>
                                <p:inputText autocomplete="off" value="#{bookingControllerViewScope.serealNo}">                                        
                                </p:inputText>
                            </h:panelGrid>
                            <h:panelGrid columns="6" class="my-2">
                                <p:commandButton ajax="false" value="Update Patient" action="#{bookingControllerViewScope.updatePatient}"
                                                 disabled="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true
                                                             or bookingControllerViewScope.selectedBillSession.bill.refunded==true}" onclick="onSubmitButton();"/>

                                <p:commandButton ajax="false" value="Update Serial" action="#{bookingControllerViewScope.updateSerial()}"
                                                 disabled="#{bookingControllerViewScope.selectedBillSession.bill.cancelled==true
                                                             or bookingControllerViewScope.selectedBillSession.bill.refunded==true}" />
                            </h:panelGrid>
                        </p:tab>

                        <p:tab title="Status" id="statusTab">
                            <p:outputLabel value="Mark As Present / Absent"/>

                            <p:selectBooleanButton onLabel="Absent" offLabel="Absent" disabled="#{bookingControllerViewScope.selectedBillSession.bill.refunded==true
                                                                                                  or bookingControllerViewScope.selectedBillSession.bill.cancelled==true or bookingControllerViewScope.checkPaid()}"  value="#{bookingControllerViewScope.absent}" >
                                <p:ajax process="@this" update="statusTab" listener="#{bookingControllerViewScope.updatePresentStatusOfPatient(bookingControllerViewScope.absent)}" ></p:ajax>
                            </p:selectBooleanButton>

                            <p:outputLabel class="mx-3" value="Can't change the status. Staff pay already done for this appoinment." rendered="#{bookingControllerViewScope.checkPaid()}" style="color: red; font-weight: bold"/>

                        </p:tab>

                        <p:tab title="Search" rendered="false">

                            <p:calendar id="calFrom"  value="#{channelSearchController.fromDate}" pattern="dd MMMM yyyy" >   
                                <f:ajax event="dateSelect" execute="@this" render="bSessionSearch"/>
                            </p:calendar>
                            <p:calendar class="mx-2" id="calTo"  value="#{channelSearchController.toDate}" pattern="dd MMMM yyyy" >
                                <f:ajax event="dateSelect" execute="@this" render="bSessionSearch"/>
                            </p:calendar>

                            <p:inputText id="txtBsSearch" value="#{channelSearchController.txtSearch}" placeholder="ID" >
                            </p:inputText>

                            <p:commandButton id="btnBsSearch"
                                             class="ui-button-warning mx-2" icon="fas fa-search"
                                             value="Search" action="#{channelSearchController.searchForBillSessions}"
                                             ajax="false"
                                             process="txtBsSearch calFrom calTo btnBsSearch" 
                                             update="bSessionSearch">


                            </p:commandButton>

                            <p:dataTable id="bSessionSearch" value="#{channelSearchController.searchedBillSessions}" var='bs'
                                         filteredValue="#{channelSearchController.filteredbillSessions}">


                                <p:column headerText="Booking ID" filterBy="#{bs.bill.bookingId}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> #{bs.bill.bookingId}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="Speciality" filterBy="#{bs.serviceSession.staff.speciality.name}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}">#{bs.serviceSession.staff.speciality.name}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="Consultant" filterBy="#{bs.serviceSession.staff.person.nameWithTitle}" filterMatchMode="contains">

                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}">  #{bs.serviceSession.staff.person.nameWithTitle}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="Session Name" filterBy="#{bs.serviceSession.name}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}">  #{bs.serviceSession.name}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="No" filterBy="#{bs.serialNo}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> #{bs.serialNo}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}"  value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="Patient Name" filterBy="#{bs.bill.patient.person.nameWithTitle}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> #{bs.bill.patient.person.nameWithTitle}
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="Paid or Not" filterBy="#{bs.bill.billType}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> <p:outputLabel rendered="#{bs.bill.billType eq 'ChannelCredit'}" value="Credit" style="color: red;"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> <p:outputLabel rendered="#{bs.bill.billType eq 'ChannelPaid'}" value="Paid"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>
                                <p:column headerText="C/R" filterBy="#{bs.bill.billClass}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}">  <p:outputLabel value="Cancelled" rendered="#{bs.bill.cancelled==true}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}">  <p:outputLabel value="Refunded" rendered="#{bs.bill.refunded==true}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column>   
                                <p:column headerText="Agent" filterBy="#{bs.bill.fromInstitution.institutionCode}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> <p:outputLabel value="#{bs.bill.fromInstitution.institutionCode}"/>      
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column> 
                                <p:column headerText="Agent Ref No" filterBy="#{bs.billItem.agentRefNo}" filterMatchMode="contains">
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"><p:outputLabel value="#{bs.billItem.agentRefNo}"/>     
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column> 
                                <p:column headerText="P/A" filterBy="#{bs.absent}" filterMatchMode="contains">                                      
                                    <h:commandLink action="channel_booking" actionListener="#{bookingControllerViewScope.resetToStartFromSpeciality}"> <p:outputLabel value="Absent"  rendered="#{bs.absent}"/>  
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.staff}" value="#{bs.serviceSession.staff}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedBillSession}" value="#{bs}"/>
                                        <f:setPropertyActionListener target="#{bookingControllerViewScope.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                    </h:commandLink>
                                </p:column> 
                            </p:dataTable> 
                        </p:tab>


                        <p:tab title="Views">
                            <h:panelGrid columns="2">
                                <p:panel header="Selected Session">
                                    <h:panelGrid columns="1">
                                        <p:commandButton value="Nurse View " 
                                                         action="#{bookingControllerViewScope.navigateToNurseView}" 
                                                         onclick="onSubmitButton();" >                                       
                                        </p:commandButton>
                                        <p:commandButton value="Doctor View " action="#{bookingControllerViewScope.navigateToDoctorView}" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                        <p:commandButton value="Session View " action="#{bookingControllerViewScope.navigateToSessionView}" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                        <p:commandButton value="Phone View " action="#{bookingControllerViewScope.navigateToPhoneView}" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                        <p:commandButton value="User View " action="#{bookingControllerViewScope.navigateToUserView}" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                    </h:panelGrid>

                                </p:panel>
                                <p:panel header="Today's">
                                    <h:panelGrid columns="1">
                                        <p:commandButton value="All Patient" action="channel_patient_view_today" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                        <p:commandButton value="All Doctor" action="channel_doctor_view_today" ajax="false" onclick="onSubmitButton();">                                        
                                        </p:commandButton>
                                    </h:panelGrid>                                    
                                </p:panel>
                            </h:panelGrid>

                        </p:tab>
                        <p:tab title="Doctor Payment">
                            <p:panel header="Selected Session">
                                <h:panelGrid columns="1">
                                    <p:commandButton value="Pay Selected Doctor" action="#{bookingControllerViewScope.paySelectedDoctor}" 
                                                     ajax="false" onclick="onSubmitButton();" />                                        
                                </h:panelGrid>
                            </p:panel>
                        </p:tab>
                        <p:tab title="Reshedule" rendered="#{bookingControllerViewScope.selectedBillSession.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}">
                            <p:panel>
                                <f:facet name="header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h:outputLabel value="Reshedule"/>
                                        <p:commandButton value="Reshedule" action="#{bookingControllerViewScope.sessionReschedule()}" ajax="false" >
                                        </p:commandButton>
                                    </div>
                                </f:facet>
                                <h:panelGroup>
                                    <div class="row">
                                        <div class="col-6">
                                            <p:panel header="Patient Details">
                                                <ezcommon:patient patient="#{bookingControllerViewScope.selectedBillSession.bill.patient}" ></ezcommon:patient>
                                            </p:panel>
                                        </div>
                                        <div class="col-6">
                                            <p:panel header="Other Sessions">
                                                <p:commandButton id="btnFill" class="m-1" value="FIll" action="#{bookingControllerViewScope.fillSessionInstanceByDoctor()}" process="btnFill" update="lstSelect" />
                                                <h:panelGroup id="lstSelect">
                                                    <p:dataTable value="#{bookingControllerViewScope.sessionInstanceByDoctor}" var="myItem" selection="#{bookingControllerViewScope.selectedSessionInstanceForRechedule}" selectionMode="single"  rowKey="#{myItem.id}">
                                                        <p:column>
                                                            <f:facet name="header">Name</f:facet>
                                                                #{myItem.name}
                                                        </p:column>
                                                        <p:column>
                                                            <f:facet name="header">Consultant</f:facet>
                                                            <p:outputLabel value="#{myItem.staff.name}">
                                                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                                            </p:outputLabel>

                                                        </p:column>
                                                        <p:column filterBy="#{myItem.sessionDate}" filterMatchMode="contains">
                                                            <f:facet name="header">Session Date</f:facet>
                                                            <p:outputLabel value="#{myItem.sessionDate}">
                                                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                                            </p:outputLabel>

                                                        </p:column>
                                                        <p:column>
                                                            <f:facet name="header">Session TIme</f:facet>
                                                            <p:outputLabel value="#{myItem.startingTime}">
                                                                <f:convertDateTime pattern="HH:mm a"/>
                                                            </p:outputLabel>
                                                        </p:column>
                                                    </p:dataTable>

                                                </h:panelGroup>
                                            </p:panel>
                                        </div>
                                    </div>
                                </h:panelGroup>
                            </p:panel>
                        </p:tab>
                    </p:tabView>
                </h:panelGroup>
            </p:panel>
        </h:form>
    </ui:define>
</ui:composition>