<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ch="http://xmlns.jcp.org/jsf/composite/channel"
      xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
      xmlns:au="http://xmlns.jcp.org/jsf/composite/autocomplete"
      xmlns:pat="http://xmlns.jcp.org/jsf/composite/patient"
      xmlns:common="http://xmlns.jcp.org/jsf/composite/ezcomp/common"
      xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <h:head>
        <title>Channel Booking By Date</title>

    </h:head>

    <h:body>

        <f:metadata>
            <f:viewParam name="fromDate" value="#{bookingControllerViewScopeMonth.fromDate}">
                <f:converter converterId="javax.faces.DateTime"/>
            </f:viewParam>
            <f:viewParam name="toDate" value="#{bookingControllerViewScopeMonth.toDate}">
                <f:converter converterId="javax.faces.DateTime"/>
            </f:viewParam>
        </f:metadata>

        <ui:composition template="/resources/template/template.xhtml">


            <ui:define name="content">


                <h:panelGroup rendered="#{!bookingControllerViewScopeMonth.printPreview}" >
                    <h:form >
                        <div class="container-fluid" >
                            <div class="row bg-light my-2 py-2 shadow-sm navbar" >
                                <div class="col-12 p-2 d-flex" >
                                    <div class="d-flex align-items-center w-100">
                                        <div class="d-flex align-items-center ">
                                            <p:outputLabel value="From"></p:outputLabel>
                                            <p:calendar id="fromDate" value="#{bookingControllerViewScopeMonth.fromDate}" size="10" class="mx-2"></p:calendar>
                                            <p:outputLabel value="To" ></p:outputLabel>
                                            <p:calendar id="toDate" value="#{bookingControllerViewScopeMonth.toDate}" size="10"  class="mx-2"></p:calendar>
                                        </div>

                                        <div class="d-flex align-items-center w-100">
                                            <p:inputText id="txtFilter" class="w-100" value="#{bookingControllerViewScopeMonth.sessionInstanceFilter}" placeholder="Search">
                                                <p:ajax event="keyup" 
                                                        process="@this" 
                                                        update="groupFilteredSessions gdManageBookings panelBookingDetails" 
                                                        listener="#{bookingControllerViewScopeMonth.listAndFilterSessionInstances}"></p:ajax>
                                            </p:inputText>

                                        </div>
                                        <div class="d-flex align-items-center w-100">
                                            <p:commandButton value="Today" action="#{bookingControllerViewScopeMonth.addToDayToToDateNew()}" ajax="false" class="mx-1 ui-button-info" ></p:commandButton>
                                            <p:commandButton value="+1" action="#{bookingControllerViewScopeMonth.addSingleDateToToDateNew()}" ajax="false" class="mx-1 ui-button-info" ></p:commandButton>
                                            <p:commandButton value="+2" action="#{bookingControllerViewScopeMonth.addTwoDaysNew()}" ajax="false" class="mx-1 ui-button-info" ></p:commandButton>
                                            <p:commandButton value="+7" action="#{bookingControllerViewScopeMonth.addSevenDaysNew()}" ajax="false" class="mx-1 ui-button-info" ></p:commandButton>
                                            <p:commandButton value="+1 Month" action="#{bookingControllerViewScopeMonth.addMonthNew()}" ajax="false" class="mx-1 ui-button-info" ></p:commandButton>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end ">
                                        <div class="d-flex align-items-center">
                                            <p:commandButton 
                                                ajax="false" 
                                                title="OPD Billing"
                                                icon="fa fa-fw fa-notes-medical" 
                                                styleClass="ui-button-warning mx-1" 
                                                action="#{opdBillController.navigateToNewOpdBill()}"
                                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Navigation Button To OPD Billing From Channel Booking By Date')}"/>

                                            <p:commandButton 
                                                ajax="false" 
                                                title="Completed" 
                                                icon="fa fa-check"
                                                styleClass="ui-button-secondary mx-1" 
                                                action="#{bookingControllerViewScopeMonth.listCompleted}" />

                                            <!-- View Ongoing Session Data Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="Ongoing"
                                                icon="fa fa-sync-alt"
                                                styleClass="ui-button-success mx-1" 
                                                action="#{bookingControllerViewScopeMonth.listOngoing}" />

                                            <!-- List Pending Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="Pending"
                                                icon="fa fa-hourglass-start"
                                                styleClass="ui-button-primary mx-1" 
                                                action="#{bookingControllerViewScopeMonth.listPending}" />

                                            <!-- List Cancelled Button -->
                                            <p:commandButton 
                                                title="Cancelled"
                                                ajax="false" 
                                                icon="fa fa-times-circle"
                                                styleClass="ui-button-danger mx-1" 
                                                action="#{bookingControllerViewScopeMonth.listCancelled}" />

                                            <!-- List All Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="All"
                                                icon="fa fa-list" 
                                                styleClass="ui-button-primary mx-1" 
                                                action="#{bookingControllerViewScopeMonth.listAll}" />
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="row" >
                                <div class="col-7" >
                                    <h:panelGroup id="groupFilteredSessions" >
                                        <p:dataTable 
                                            value="#{bookingControllerViewScopeMonth.sessionInstancesFiltered}"
                                            var="s"
                                            selectionMode="single"
                                            selection="#{bookingControllerViewScopeMonth.selectedSessionInstance}"
                                            rowKey="#{s.id}"
                                            class="w-100">

                                            <p:ajax 
                                                event="rowSelect" 
                                                process="@this"
                                                update=":#{p:resolveFirstComponentWithId('totalsPanel',view).clientId} :#{p:resolveFirstComponentWithId('panelBookingDetails',view).clientId} :#{p:resolveFirstComponentWithId('gdManageBookings',view).clientId} :#{p:resolveFirstComponentWithId('gpAdditionalItems',view).clientId}"
                                                listener="#{bookingControllerViewScopeMonth.sessionInstanceSelected()}" />



                                            <p:column styleClass="#{s.completed ?'ui-messages-success': s.started ? 'ui-messages-info': s.cancelled ? 'ui-messages-fatal' : ''}"  style="#{s.completed ? 'background-color: #dff0d8' : s.started ? 'background-color: #d9edf7' : s.cancelled ? 'background-color: #f2dede' : ''}" >
                                                <div class="d-flex align-items-center w-100">
                                                    <div>
                                                        <i class="fa-solid fa-user-doctor" style="font-size: 26pt;margin-right: 28px"></i>
                                                    </div>
                                                    <div class="align-items-center">

                                                        <h:outputText value="#{s.staff.person.nameWithTitle}" style="font-weight: bolder" /> <p:badge class="mx-2" severity="success" value="Completed" rendered="#{s.completed}" /> <p:badge class="mx-2" severity="danger" value="Cancelled" rendered="#{s.cancelled}" /> <br/>

                                                        <h:outputText value="(#{s.staff.speciality.name})" /><p:badge class="mx-2" severity="warning" value="Scaning Session" rendered="#{s.originatingSession.category eq 'Scanning'}" /> 
                                                        <p:badge class="mx-2" severity="info" value="Arried" rendered="#{s.arrived}" /> 
                                                        <br/>

                                                        <div>
                                                            <h:outputText value="#{s.sessionDate}"  >
                                                                <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                            </h:outputText>

                                                            <h:outputText class="mx-2" value="#{s.startingTime}">
                                                                <f:convertDateTime pattern="hh:mm a"/>
                                                            </h:outputText>
                                                            <h:outputText class="mx-2" value="#{s.endingTime}">
                                                                <f:convertDateTime pattern="hh:mm a"/>
                                                            </h:outputText>

                                                            <!-- Conditional message for delayed start time -->
                                                            <h:panelGroup rendered="#{s.startingTime gt s.originatingSession.startingTime}">
                                                                <br/>
                                                                <h:outputText class="mr-2 text-danger" value="Delayed. Original starting time is ">
                                                                </h:outputText>
                                                                <h:outputText class="mr-2 text-danger" value="#{s.originatingSession.startingTime}">
                                                                    <f:convertDateTime pattern="hh:mm a"/>
                                                                </h:outputText>
                                                            </h:panelGroup>

                                                            <!-- Conditional message for early start time -->
                                                            <h:panelGroup rendered="#{s.startingTime lt s.originatingSession.startingTime}">
                                                                <br/>
                                                                <h:outputText class="mr-2 text-warning" value="Early. Original starting time is ">
                                                                </h:outputText>
                                                                <h:outputText class="mr-2 text-warning" value="#{s.originatingSession.startingTime}">
                                                                    <f:convertDateTime pattern="hh:mm a"/>
                                                                </h:outputText>
                                                            </h:panelGroup>
                                                        </div>
                                                        <div class="d-flex align-items-center justify-content-between">
                                                            <h:outputText rendered="true" value="#{s.name}" style="font-weight: bolder;font-size: 10pt" />
                                                            <br/>
                                                            <p:badge class="d-flex justify-content-end m-2" rendered="#{!s.started and !s.cancelled}" value="Room: #{s.roomNo}"  severity="primary" ></p:badge>
                                                            <p:badge rendered="#{s.started and !s.completed}" value="Room: #{s.roomNo}"  severity="success" styleClass="mr-2"></p:badge>
                                                            <p:badge rendered="#{s.completed}" value="Room: #{s.roomNo}"  severity="warning" styleClass="mr-2"></p:badge>
                                                            <p:badge rendered="#{s.cancelled}" value="Room: #{s.roomNo}"  severity="danger" styleClass="mr-2"></p:badge>
                                                        </div>

                                                        <br/>
                                                        <span class="text-center mx-1" > 
                                                            <h:panelGroup rendered="#{s.originatingSession.paidAppointmentsOnly}">
                                                                <p:badge value="Paid Appointments Only" severity="danger"></p:badge>
                                                            </h:panelGroup>
                                                        </span>
                                                    </div>
                                                </div>
                                            </p:column>
                                           <p:column styleClass="#{s.completed ?'ui-messages-success': s.started ? 'ui-messages-info': s.cancelled ? 'ui-messages-fatal' : ''}"  style="#{s.completed ? 'background-color: #dff0d8' : s.started ? 'background-color: #d9edf7' : s.cancelled ? 'background-color: #f2dede' : ''}" >
                                                <div class="d-flex align-items-center justify-content-between ">
                                                    <div class="d-flex align-items-center">
                                                        <div class="text-center">
                                                            <h:outputLabel style="font-weight: bolder" value="M"/><br/>
                                                            <p:badge value="#{s.maxNo}" size="large" styleClass="mr-2"></p:badge>
                                                        </div>
                                                        <div class="text-center mx-4">
                                                            <h:outputLabel style="font-weight: bolder" value="A"/><br/>
                                                            <h:panelGroup rendered="#{s.cancelPatientCount eq null}" >
                                                                <p:badge value="#{s.maxNo - s.bookedPatientCount}" size="large" styleClass="mr-2" rendered="#{s.maxNo - s.bookedPatientCount > 3}"></p:badge>
                                                                <p:badge value="#{s.maxNo - s.bookedPatientCount}" size="large" styleClass="mr-2" rendered="#{3 >= (s.maxNo - s.bookedPatientCount) and (s.maxNo - s.bookedPatientCount) > 0}" severity="warning"></p:badge>
                                                                <p:badge value="0" size="large" styleClass="mr-2" rendered="#{0 >= s.maxNo - s.bookedPatientCount}" severity="danger"></p:badge>
                                                            </h:panelGroup>
                                                            <h:panelGroup rendered="#{s.cancelPatientCount ne null}" >
                                                                <p:badge value="#{s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s))- s.cancelPatientCount)}" size="large" styleClass="mr-2" rendered="#{s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.cancelPatientCount) > 3}"></p:badge>
                                                                <p:badge value="#{s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.cancelPatientCount)}" size="large" styleClass="mr-2" rendered="#{3 >= (s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.cancelPatientCount)) and (s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.cancelPatientCount)) > 0}" severity="warning"></p:badge>
                                                                <p:badge value="0" size="large" styleClass="mr-2" rendered="#{0 >= s.maxNo - ((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.cancelPatientCount)}" severity="danger"></p:badge>
                                                            </h:panelGroup>                                  
                                                        </div>
                                                        <div class="text-center">
                                                            <h:outputLabel style="font-weight: bolder" value="N"/><br/>
                                                            <p:badge value="#{((s.bookedPatientCount + bookingControllerViewScopeMonth.totalReservedNumberCount(s)) - s.reservedBookingCount) + 1}" size="large" styleClass="mr-2"></p:badge>
                                                        </div>
                                                    </div>

                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="mx-4">
                                                            <div class="d-flex align-items-center">
                                                                <span class="text-center mx-1">
                                                                    <h:outputText value="P" style="font-weight: bolder"/><br/>
                                                                    <p:badge value="#{s.paidPatientCount != null ? s.paidPatientCount : ' '}" severity="warning" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1"> 
                                                                    <h:outputText style="font-weight: bolder" value="B"/><br/>
                                                                    <p:badge value="#{s.bookedPatientCount != null ? s.bookedPatientCount : ' '}" severity="warning" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1" > 
                                                                    <h:outputText style="font-weight: bolder" value="C"/><br/>
                                                                    <p:badge value="#{s.completedPatientCount != null ? s.completedPatientCount : ' '}" severity="success" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1" > 
                                                                    <h:outputLabel /><br/>
                                                                    <p:commandButton 
                                                                        icon="fas fa-cog"
                                                                        immediate="true"
                                                                        styleClass="rounded-button ui-button-secondary mr-2"
                                                                        action="#{bookingControllerViewScopeMonth.navigateToManageSessionInstance(s)}" 
                                                                        ajax="false" >
                                                                    </p:commandButton>
                                                                </span>
                                                            </div>
                                                        </span>
                                                    </div>



                                                </div>
                                            </p:column>
                                        </p:dataTable>
                                    </h:panelGroup>
                                </div>
                                <div class="col-5" > 
                                    <div class="sticky-top shadow " style="max-height: 100vh; overflow-y: auto;z-index: 100;">
                                        <p:panel id="ptImp">
                                            <p:growl id="msg"/>
                                            <f:facet name="header">
                                                <h:panelGroup layout="block" styleClass="d-flex justify-content-between align-items-center">
                                                    <!-- Left aligned content -->
                                                    <h:panelGroup id="headerFacet">
                                                        <h:outputText value="Select a Patient" rendered="#{bookingControllerViewScopeMonth.patient eq null}"></h:outputText>
                                                        <h:outputText styleClass="fas fa-user" />
                                                        <h:panelGroup 
                                                            rendered="#{bookingControllerViewScopeMonth.quickSearchPatientList eq null or empty bookingControllerViewScopeMonth.quickSearchPatientList}">
                                                            <h:outputText
                                                                rendered="#{bookingControllerViewScopeMonth.patient.id eq null}"
                                                                value="Patient" 
                                                                class="mx-4"
                                                                >
                                                            </h:outputText>
                                                            <h:outputText
                                                                rendered="#{bookingControllerViewScopeMonth.patient.id ne null}"
                                                                value="Searched Patient Details" 
                                                                class="mx-2"
                                                                ></h:outputText>
                                                            <h:panelGroup id="edit" >
                                                                <p:selectBooleanButton 
                                                                    value="#{bookingControllerViewScopeMonth.patientDetailsEditable}" 
                                                                    offIcon="pi pi-pencil" 
                                                                    onIcon="pi pi-eye"                                 
                                                                    class="mx-2"
                                                                    >
                                                                    <p:ajax 
                                                                        process="@this" 
                                                                        update="viewPatient editPatient btnDone edit" />
                                                                </p:selectBooleanButton>
                                                                <p:commandButton id="btnDone" alt="Save Patient Details" class="ui-button-success" icon="fas fa-check" action="#{bookingControllerViewScopeMonth.saveSelected}" rendered="#{bookingControllerViewScopeMonth.patientDetailsEditable}" />
                                                            </h:panelGroup>

                                                        </h:panelGroup>
                                                    </h:panelGroup>


                                                    <p:focus id="focusIx" for="txtQuickSearchPhoneNumber" />
                                                    <p:focus context="txtQuickSearchPhoneNumber"/>


                                                    <!-- Right aligned quick search -->
                                                    <h:panelGroup id="quickSearch" >
                                                        <h:panelGroup layout="block"  styleClass="form-inline">
                                                            <p:focus  for="txtQuickSearchPhoneNumber" />
                                                            <p:inputText 
                                                                autocomplete="off"
                                                                id="txtQuickSearchPhoneNumber"
                                                                value="#{bookingControllerViewScopeMonth.quickSearchPhoneNumber}"
                                                                placeholder="Phone Number"
                                                                class="form-control-sm mx-1"
                                                                onfocus="this.select()" 
                                                                >
                                                                <p:ajax process="txtQuickSearchPhoneNumber" ></p:ajax>
                                                            </p:inputText>
                                                            <p:commandButton 
                                                                id="btnSearchbyPhoneNo"
                                                                immediate="true"
                                                                icon="fa fa-search" 
                                                                title="Quick Search from Phone Number"
                                                                action="#{bookingControllerViewScopeMonth.quickSearchPatientLongPhoneNumber()}" 
                                                                process="btnSearchbyPhoneNo txtQuickSearchPhoneNumber"
                                                                update="ptImp selectPatient editPatient viewPatient"
                                                                ajax="false"
                                                                styleClass="btn-sm mx-1"/>
                                                            <p:defaultCommand target="btnSearchbyPhoneNo"> </p:defaultCommand>
                                                            <p:commandButton 
                                                                id="btnAddNewPatient"
                                                                icon="fa fa-plus-circle" 
                                                                title="Add New Patient"
                                                                action="#{bookingControllerViewScopeMonth.quickSearchNewPatient()}" 
                                                                process="btnAddNewPatient"
                                                                update="ptImp selectPatient editPatient viewPatient"
                                                                styleClass="btn-sm mx-1"/>
                                                        </h:panelGroup>
                                                    </h:panelGroup>
                                                </h:panelGroup>
                                            </f:facet>

                                            <h:panelGroup id="selectPatient" >
                                                <h:panelGroup rendered="#{bookingControllerViewScopeMonth.quickSearchPatientList ne null and not empty bookingControllerViewScopeMonth.quickSearchPatientList}">
                                                    <p:dataTable id="tblPatients" value="#{bookingControllerViewScopeMonth.quickSearchPatientList}" var="ps">
                                                        <p:column headerText="Name">
                                                            #{ps.person.name}
                                                        </p:column>
                                                        <p:column headerText="Phone Number">
                                                            #{ps.person.phone}
                                                        </p:column>
                                                        <p:column headerText="Mobile Number">
                                                            #{ps.person.mobile}
                                                        </p:column>
                                                        <p:column>
                                                            <p:commandButton 
                                                                action="#{bookingControllerViewScopeMonth.selectQuickOneFromQuickSearchPatient}" 
                                                                id="btnSelectPt"
                                                                process="btnSelectPt tblPatients"
                                                                update=":#{p:resolveFirstComponentWithId('ptImp',view).clientId}"
                                                                value="select">
                                                                <f:setPropertyActionListener value="#{ps}" target="#{bookingControllerViewScopeMonth.patient}" />
                                                            </p:commandButton>
                                                        </p:column>
                                                    </p:dataTable>
                                                </h:panelGroup>
                                            </h:panelGroup>

                                            <h:panelGroup id="editPatient" >

                                                <h:panelGroup rendered="#{bookingControllerViewScopeMonth.patientDetailsEditable}" >
                                                    <h:panelGroup rendered="#{patientController.quickSearchPatientList eq null or empty patientController.quickSearchPatientList}">
                                                        <h:panelGroup class="mb-1 w-100" id="panelPatient" >
                                                            <h:panelGroup id="gpPatient" >
                                                                <div class="row">
                                                                    <div class="col-md-3 p-1">
                                                                        <p:selectOneMenu 
                                                                            id="cmbTitle"
                                                                            class="form-control w-100"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.title}">
                                                                            <f:selectItem itemLabel="Select Title" />
                                                                            <f:selectItems value="#{opdBillController.title}" var="i"
                                                                                           itemLabel="#{i.label}" itemValue="#{i}"/>
                                                                            <p:ajax event="change" process="cmbTitle" update="cmbSex" ></p:ajax>
                                                                        </p:selectOneMenu>
                                                                    </div>
                                                                    <div class="col-md-9 p-1">
                                                                        <p:inputText 
                                                                            autocomplete="off" 
                                                                            id="txtNewPtName" 
                                                                            placeholder="Enter the Name of the patient"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.name}"
                                                                            validatorMessage="Please enter only letters and spaces."
                                                                            class="form-control" >
                                                                            <c:if test="#{not empty sessionController.applicationPreference.nameRegex}">
                                                                                <f:validateRegex pattern="#{sessionController.applicationPreference.nameRegex}"/>
                                                                            </c:if>

                                                                        </p:inputText>
                                                                    </div>
                                                                </div>

                                                                <div class="row">
                                                                    <div class="col-md-3 p-1">
                                                                        <p:selectOneMenu 
                                                                            id="cmbSex" 
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.sex}"
                                                                            class="form-control w-100">
                                                                            <f:selectItem itemLabel="Select Gender"/>
                                                                            <f:selectItems value="#{opdBillController.sex}"/>
                                                                        </p:selectOneMenu>
                                                                    </div>
                                                                    <div class="col-md-9 p-1">
                                                                        <div class="row">
                                                                            <div class="col-md-2">
                                                                                <p:inputText 
                                                                                    autocomplete="off" 
                                                                                    id="year" 
                                                                                    placeholder="Years"

                                                                                    value="#{bookingControllerViewScopeMonth.patient.person.ageYearsComponent}"
                                                                                    class="form-control">
                                                                                    <f:ajax event="keyup" execute="@this" render="dpDob" />
                                                                                </p:inputText>
                                                                            </div>
                                                                            <div class="col-md-2">
                                                                                <p:inputText

                                                                                    autocomplete="off" id="month" placeholder="Months"
                                                                                    value="#{bookingControllerViewScopeMonth.patient.person.ageMonthsComponent}"
                                                                                    class="form-control">
                                                                                    <f:ajax event="keyup" execute="@this"  render="dpDob"  />
                                                                                </p:inputText>
                                                                            </div>
                                                                            <div class="col-md-2">
                                                                                <p:inputText 

                                                                                    autocomplete="off" id="day" placeholder="Days"
                                                                                    value="#{bookingControllerViewScopeMonth.patient.person.ageDaysComponent}"
                                                                                    class="form-control">
                                                                                    <f:ajax event="keyup" execute="@this"  render="dpDob" />
                                                                                </p:inputText>
                                                                            </div>
                                                                            <div class="col-md-6">
                                                                                <p:datePicker  
                                                                                    value="#{bookingControllerViewScopeMonth.patient.person.dob}"
                                                                                    id="dpDob" 
                                                                                    class="w-100"
                                                                                    yearNavigator="true"
                                                                                    monthNavigator="true"
                                                                                    inputStyleClass="form-control"
                                                                                    pattern="#{sessionController.applicationPreference.longDateFormat}"
                                                                                    placeholder="Date of Birth (dd/mm/yyyy)"
                                                                                    >
                                                                                    <p:ajax event="dateSelect" process="@this" update="year month day" />
                                                                                </p:datePicker>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row">
                                                                    <div class="col-md-3 p-1">
                                                                        <p:inputText 
                                                                            id="txtMobile" 
                                                                            autocomplete="off" 
                                                                            placeholder="Mobile Number"
                                                                            value="#{bookingControllerViewScopeMonth.patient.mobileNumberStringTransient}"
                                                                            class="form-control" 
                                                                            validatorMessage="Please enter valid Number">
                                                                            <c:if test="#{not empty sessionController.applicationPreference.mobileRegex}">
                                                                                <f:validateRegex pattern="#{sessionController.applicationPreference.mobileRegex}"/>
                                                                            </c:if>
                                                                        </p:inputText>
                                                                    </div>
                                                                    <div class="col-md-3 p-1">
                                                                        <p:inputText 
                                                                            id="txtPhone" 
                                                                            autocomplete="off" 
                                                                            placeholder="Phone Number"
                                                                            value="#{bookingControllerViewScopeMonth.patient.phoneNumberStringTransient}"
                                                                            class="form-control" validatorMessage="Please enter valid Number">
                                                                            <c:if test="#{not empty sessionController.applicationPreference.mobileRegex}">
                                                                                <f:validateRegex pattern="#{sessionController.applicationPreference.mobileRegex}"/>
                                                                            </c:if>
                                                                        </p:inputText>
                                                                    </div>
                                                                    <div class="col-md-3 p-1">
                                                                        <p:inputText 
                                                                            autocomplete="off" id="txtEmail" placeholder="Enter Email here"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.email}"
                                                                            class="form-control"
                                                                            >
                                                                            <c:if test="#{not empty sessionController.applicationPreference.emailRegex}">
                                                                                <f:validateRegex pattern="#{sessionController.applicationPreference.emailRegex}"/>
                                                                            </c:if>
                                                                        </p:inputText>
                                                                    </div>
                                                                    <div class="col-md-3 p-1">
                                                                        <p:inputText 
                                                                            id="txtNic"
                                                                            autocomplete="off"
                                                                            placeholder="National ID Number"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.nic}"
                                                                            class="form-control"/>
                                                                    </div>
                                                                </div>

                                                                <div class="row">
                                                                    <div class="col-md-8 p-1">
                                                                        <p:inputText
                                                                            id="txtAddress"
                                                                            autocomplete="off"
                                                                            placeholder="Address"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.address}"
                                                                            class="form-control"/>
                                                                    </div>
                                                                    <div class="col-md-4 p-1">
                                                                        <p:autoComplete 
                                                                            id="acNewPtArea" 
                                                                            placeholder="Search &amp; Select Area"
                                                                            completeMethod="#{areaController.completeArea}"
                                                                            var="pta" itemLabel="#{pta.name}"
                                                                            minQueryLength="4"
                                                                            itemValue="#{pta}" forceSelection="true"
                                                                            value="#{bookingControllerViewScopeMonth.patient.person.area}"
                                                                            inputStyleClass="form-control"
                                                                            class="w-100"/>
                                                                    </div>
                                                                </div>

                                                                <p:tooltip for="txtNewPtName" value="Patient Name"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="txtNic" value="NIC No"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="dpDob" value="Date Of Birth"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="txtAddress" value="Address"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="txtMobile" value="Mobile Number"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="txtPhone" value="Home Phone Number"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="cmbSex" value="Sex"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="cmbTitle" value="Title"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="acNewPtArea" value="Area"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="txtEmail" value="Email"  showDelay="0" hideDelay="0"></p:tooltip>

                                                                <p:tooltip for="year" value="Age- Years Component"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="month" value="Age- Month Component"  showDelay="0" hideDelay="0"></p:tooltip>
                                                                <p:tooltip for="day" value="Age- Days Component"  showDelay="0" hideDelay="0"></p:tooltip>


                                                            </h:panelGroup>
                                                        </h:panelGroup>
                                                    </h:panelGroup>
                                                </h:panelGroup>
                                            </h:panelGroup>
                                            <h:panelGroup id="viewPatient" >

                                                <h:panelGroup  rendered="#{not bookingControllerViewScopeMonth.patientDetailsEditable}"  >
                                                    <h:panelGroup  rendered="#{bookingControllerViewScopeMonth.quickSearchPatientList eq null}" >
                                                        <h:panelGrid columns="3" class="my-1" id="panelPatientDisplay" rendered="#{bookingControllerViewScopeMonth.patient ne null}" >
                                                            <h:outputLabel value="Name " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.nameWithTitle}" />

                                                            <h:outputLabel value="Gender " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.sex}" />

                                                            <h:outputLabel value="Date of Birth " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.dob}" >
                                                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}" ></f:convertDateTime>
                                                            </h:outputText>

                                                            <h:outputLabel value="Age  " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.ageAsString}" />

                                                            <h:outputLabel value="Mobile No. " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.mobile}" />

                                                            <h:outputLabel value="Phone No. " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.phone}" />

                                                            <h:outputLabel value="Email " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.email}" />

                                                            <h:outputLabel value="National ID No. " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.nic}" />

                                                            <h:outputLabel value="Address " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.address}" />

                                                            <h:outputLabel value="Area " class="mx-3"/>
                                                            <h:outputLabel value=" : " class="mx-3"/>
                                                            <h:outputText value="#{bookingControllerViewScopeMonth.patient.person.area.name}" />

                                                        </h:panelGrid>
                                                    </h:panelGroup>
                                                </h:panelGroup>

                                            </h:panelGroup>

                                        </p:panel>

                                        <h:panelGroup id="gpAdditionalItems" >
                                            <p:panel header="Additional Items" rendered="#{not empty bookingControllerViewScopeMonth.itemsAvailableToAddToBooking}">
                                                <p:row >
                                                    <p:column >
                                                        <p:outputLabel  value="Item" ></p:outputLabel>
                                                    </p:column>
                                                    <p:column >
                                                        <p:selectOneMenu class="w-75 mx-1" autoWidth="false" id="lstItems" value="#{bookingControllerViewScopeMonth.itemToAddToBooking}" >
                                                            <f:selectItem itemLabel="Select" ></f:selectItem>
                                                            <f:selectItems  value="#{bookingControllerViewScopeMonth.itemsAvailableToAddToBooking}" var="iata" itemValue="#{iata}"  itemLabel="#{iata.name}" ></f:selectItems>
                                                            <p:ajax event="change" process="lstItems" update="totalsPanel :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId}" listener="#{bookingControllerViewScopeMonth.fillFees}" ></p:ajax>
                                                        </p:selectOneMenu>
                                                    </p:column>
                                                    <p:column >
                                                        <p:commandButton 
                                                            id="btnAddItem"
                                                            process="lstItems btnAddItem"
                                                            value="Add Item" 
                                                            icon="fas fa-plus"
                                                            class="ui-button-success"
                                                            action="#{bookingControllerViewScopeMonth.addItemToBooking}"
                                                            update="totalsPanel paymentDetails :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId} :#{p:resolveFirstComponentWithId('lstAddedItems',view).clientId} lstItems panelBookingDetails"
                                                            ></p:commandButton>
                                                    </p:column>
                                                </p:row>

                                                <h:panelGroup id="lstAddedItems" >
                                                    <ui:repeat  value="#{bookingControllerViewScopeMonth.itemsAddedToBooking}" var="item" rendered="#{not empty bookingControllerViewScopeMonth.itemsAddedToBooking}">
                                                        <div class="row">
                                                            <div class="d-flex justify-content-between align-items-center my-2">
                                                                <h6>#{item.name}</h6>
                                                                <h6>#{item.itemFee.fee}</h6>
                                                                <p:commandButton 
                                                                    id="btnRemoveAdditem" 
                                                                    icon="fas fa-trash" 
                                                                    class="ui-button-danger" 
                                                                    action="#{bookingControllerViewScopeMonth.removeAddedAditionalItems(item)}" 
                                                                    process="btnRemoveAdditem" 
                                                                    update=":#{p:resolveFirstComponentWithId('lstAddedItems',view).clientId} :#{p:resolveFirstComponentWithId('paymentDetails',view).clientId} :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId} :#{p:resolveFirstComponentWithId('panelBookingDetails',view).clientId}"/>
                                                            </div>
                                                        </div>
                                                    </ui:repeat>

                                                </h:panelGroup>
                                            </p:panel>
                                        </h:panelGroup>

                                        <p:panel class="my-1">
                                            <f:facet name="header">
                                                <p:row>
                                                    <p:column  colspan="2" >
                                                        <h:outputText styleClass="fa-solid fa-money-bill-wave"/>
                                                        <h:outputText class="mx-4" value="Payment Details"/>
                                                    </p:column>
                                                </p:row>
                                            </f:facet>
                                            <f:facet name="footer">
                                                <p:row>
                                                    <p:column colspan="4" >
                                                        <p:commandButton
                                                            id="btnAdd"
                                                            value="Add Normal Booking"
                                                            ajax="false"
                                                            update="gpThisBookingDetails"
                                                            class="ui-button-info "
                                                            icon="pi pi-check"
                                                            action="#{bookingControllerViewScopeMonth.addNormalChannelBooking}" >
                                                        </p:commandButton>
                                                        <p:spacer height="1" width="10" ></p:spacer>
                                                        <p:spacer height="1" width="10" ></p:spacer>
                                                        <p:selectOneMenu value="#{bookingControllerViewScopeMonth.selectedReserverdBookingNumber}" >
                                                            <f:selectItem itemLabel="Next Number" ></f:selectItem>
                                                            <f:selectItems value="#{bookingControllerViewScopeMonth.reservedBookingNumbers}" ></f:selectItems>
                                                        </p:selectOneMenu>
                                                        <p:commandButton
                                                            id="btnAddReserved"
                                                            value="Add Reserved Booking"
                                                            ajax="false"
                                                            update="gpThisBookingDetails"
                                                            class="ui-button-warning m-2"
                                                            icon="pi pi-bookmark"
                                                            action="#{bookingControllerViewScopeMonth.addReservedChannelBooking}" > <!-- Assuming a different action for reserved booking -->
                                                        </p:commandButton>
                                                    </p:column>
                                                </p:row>
                                            </f:facet>

                                            <h:panelGroup style="display: flex; flex-direction: column; align-items: start;" id="totalsPanel">

                                                <!-- Total -->
                                                <h:panelGroup style="display: flex; justify-content: space-between; width: 100%; font-weight: bolder;">
                                                    <h:outputText value="Total:" />
                                                    <h:outputText value="#{bookingControllerViewScopeMonth.feeTotalForSelectedBill}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </h:panelGroup>

                                                <!-- Discount -->
                                                <h:panelGroup style="display: flex; justify-content: space-between; width: 100%;">
                                                    <h:outputText value="Discount:" />
                                                    <h:outputText value="#{bookingControllerViewScopeMonth.feeDiscountForSelectedBill}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </h:panelGroup>

                                                <!-- Net Total -->
                                                <h:panelGroup style="display: flex; justify-content: space-between; width: 100%;">
                                                    <h:outputText value="Net Total:" />
                                                    <h:outputText value="#{bookingControllerViewScopeMonth.feeNetTotalForSelectedBill}">
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </h:outputText>
                                                </h:panelGroup>
                                            </h:panelGroup>

                                            <h:panelGrid id="gdManageBookings" class="w-100 m-2" columns="2"  >
                                                <p:outputLabel value="Tenderd Amount" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Cash'}"/>
                                                <h:panelGroup class="w-100 my-2" style="font-weight: bolder" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Cash'}">
                                                    <p:inputText id="paid" value="#{bookingControllerViewScopeMonth.strTenderedValue}">
                                                        <p:ajax event="keyup" process=" paid" update="balance"/>
                                                    </p:inputText>
                                                </h:panelGroup>

                                                <p:outputLabel value="Balance" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Cash'}"/>
                                                <h:panelGroup id="balance" class="w-100 my-2" style="font-weight: bolder" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Cash'}">
                                                    <p:outputLabel value="#{-bookingControllerViewScopeMonth.cashBalance}"/>
                                                </h:panelGroup>

                                                <h:outputLabel value="Foriegner"/>
                                                <p:selectBooleanCheckbox class="w-75" id="f" value="#{bookingControllerViewScopeMonth.foriegn}">
                                                    <f:ajax event="change" execute="@this" render="totalsPanel panelBookingDetails"/>
                                                </p:selectBooleanCheckbox>


                                                <p:outputLabel value="Payment Method"/>
                                                <h:panelGroup>
                                                    <p:selectOneMenu 
                                                        class="w-75"
                                                        autoWidth="false"
                                                        id="cmbPs"
                                                        filter="true"
                                                        filterMatchMode="contains"
                                                        value="#{bookingControllerViewScopeMonth.paymentMethod}">
                                                        <f:selectItem itemLabel="Select Payment Method" ></f:selectItem>
                                                        <f:selectItems value="#{enumController.paymentMethodsForChanneling}"/>
                                                        <p:ajax 
                                                            process="@this"
                                                            update="gdManageBookings :#{p:resolveFirstComponentWithId('totalsPanel',view).clientId} paymentDetails lstItems" 
                                                            event="change" 
                                                            listener="#{bookingControllerViewScopeMonth.calculateSelectedBillSessionTotal()}" />
                                                    </p:selectOneMenu>
                                                    <h:outputScript>
                                                        $(document.getElementById('form:cmbPs_focus')).keypress(function (event) {
                                                        var keycode = (event.keyCode ? event.keyCode : event.which);
                                                        alert("sdf");
                                                        if (keycode == '13') {
                                                        document.getElementById("form:txtSearch3").focus();
                                                        return false;
                                                        }

                                                        });
                                                    </h:outputScript>
                                                </h:panelGroup>


                                                <p:outputLabel value="Discount Scheme"/>
                                                <p:selectOneMenu 
                                                    class="w-75" 
                                                    autoWidth="false" 
                                                    id="cmbPs2" 
                                                    value="#{bookingControllerViewScopeMonth.paymentScheme}">
                                                    <f:selectItem itemLabel="Select Discount Scheme"/>
                                                    <f:selectItems 
                                                        value="#{paymentSchemeController.paymentSchemesForChannel}"
                                                        var="paysch" 
                                                        itemLabel="#{paysch.name}" 
                                                        itemValue="#{paysch}"  />
                                                    <p:ajax 
                                                        process="@this"
                                                        update="gdManageBookings :#{p:resolveFirstComponentWithId('totalsPanel',view).clientId} paymentDetails lstItems"
                                                        event="change"
                                                        listener="#{bookingControllerViewScopeMonth.calculateSelectedBillSessionTotal()}"/>
                                                </p:selectOneMenu>
                                            </h:panelGrid>

                                            <h:panelGroup id="paymentDetails" class="payment-details">

                                                <!-- Agent Payment Method -->
                                                <p:panelGrid columns="1" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Agent'}" >
                                                    <f:facet name="header">
                                                        <div class="d-flex align-items-center justify-content-between">
                                                            <h:outputLabel id="agent" value="Agent" />
                                                            <div class=" mx-4">
                                                                <p:outputLabel class="mx-2" value="Agent Balance" />
                                                                <h:outputLabel id="balance2" value="#{empty bookingControllerViewScopeMonth.institution.ballance ? '00.00' : bookingControllerViewScopeMonth.institution.ballance}" />
                                                            </div>
                                                        </div>
                                                    </f:facet>

                                                    <p:row>
                                                        <p:column>
                                                            <h:outputLabel value="Agent Details" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:autoComplete class="w-75 mx-2" id="agent2" forceSelection="true"
                                                                            value="#{bookingControllerViewScopeMonth.institution}" completeMethod="#{agencyController.completeAgency}" var="ix"
                                                                            itemLabel="#{ix.name}" itemValue="#{ix}" size="38">
                                                                <f:ajax event="itemSelect" execute="@this" render="balance2 totalsPanel agRefLbl agRefTxt :#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} gdManageBookings" listener="#{bookingControllerViewScopeMonth.validateAgentBalance()}"/>
                                                                <p:column>#{ix.institutionCode}</p:column>
                                                                <p:column>#{ix.name}</p:column>
                                                            </p:autoComplete>
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel for="agRefTxt" value="Agent Ref No" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:inputText size="38" class="mx-2" autocomplete="off" id="agRefTxt" value="#{bookingControllerViewScopeMonth.agentRefNo}" />
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column colspan="2">
                                                            <p:dataTable class="w-100" id="tblAgentBooks" emptyMessage="No Reference Books"
                                                                         value="#{bookingControllerViewScopeMonth.institution.agentReferenceBooks}" var="a">
                                                                <f:facet name="header">
                                                                    <p:outputLabel value="Agent Reference Number Details" />
                                                                </f:facet>
                                                                <p:column headerText="S.R.N.">
                                                                    <p:outputLabel value="#{a.startingReferenceNumber}">
                                                                        <f:convertNumber pattern="00000" />
                                                                    </p:outputLabel>
                                                                </p:column>
                                                                <p:column headerText="E.R.N.">
                                                                    <p:outputLabel value="#{a.endingReferenceNumber}">
                                                                        <f:convertNumber pattern="00000" />
                                                                    </p:outputLabel>
                                                                </p:column>
                                                            </p:dataTable>
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Card Payment Method -->
                                                <p:panelGrid columns="1" class="w-100" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Card'}">
                                                    <f:facet name="header">
                                                        <div class="d-flex align-items-center justify-content-between">
                                                            <h:outputLabel id="card" value="Card" />
                                                        </div>
                                                    </f:facet>

                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="creditCardbnkLbl" value="Select Bank" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:selectOneMenu class="w-75 mx-2" autoWidth="false" id="creditCardSlc" filter="true" filterMatchMode="contains" value="#{bookingControllerViewScopeMonth.paymentMethodData.creditCard.institution}">
                                                                <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                            </p:selectOneMenu>
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel for="creditCardTxt" value="Card Ref. No" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:inputText class="w-75 mx-2" id="creditCardTxt" autocomplete="off" value="#{bookingControllerViewScopeMonth.paymentMethodData.creditCard.no}" />
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Cheque Payment Method -->
                                                <p:panelGrid columns="1" class="w-100" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Cheque'}">
                                                    <f:facet name="header">
                                                        <h:outputLabel value="Cheque Payment" />
                                                    </f:facet>

                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="lblCheque" value="Cheque No" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:inputText size="38" class="mx-2" id="chequeNo" autocomplete="off" value="#{bookingControllerViewScopeMonth.paymentMethodData.cheque.no}" />
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="lblBank" value="Select Bank" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:selectOneMenu class="mx-2" style="width: 335px" autoWidth="false" id="bankSel" value="#{bookingControllerViewScopeMonth.paymentMethodData.cheque.institution}">
                                                                <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                            </p:selectOneMenu>
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="lblChequeDate" value="Cheque Date" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:calendar class="mx-2" size="38" id="ChequeDate" value="#{bookingControllerViewScopeMonth.paymentMethodData.cheque.date}" pattern="dd MMMM yyyy" />
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Staff Payment Method -->
                                                <p:panelGrid columns="1" class="w-100" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Staff'}">
                                                    <f:facet name="header">
                                                        <p:outputLabel id="staff" value="Staff" />
                                                    </f:facet>

                                                    <p:row>

                                                        <p:column>
                                                            <h:panelGroup id="autoStaff">
                                                                <p:autoComplete minQueryLength="2" forceSelection="true" value="#{bookingControllerViewScopeMonth.toStaff}" id="creditStaff"
                                                                                completeMethod="#{staffController.completeStaff}" var="mys" class="w-100"
                                                                                placeholder="Staff (Type at least 4 letters to search)" inputStyleClass="form-control"
                                                                                itemLabel="#{mys.person.name}" itemValue="#{mys}" size="10">
                                                                    <p:column headerText="Name" style="padding: 2px;">
                                                                        <h:outputText value="#{mys.person.nameWithTitle}" />
                                                                    </p:column>
                                                                    <p:column headerText="EPF" style="padding: 2px;">
                                                                        <h:outputText value="#{mys.epfNo}" />
                                                                    </p:column>
                                                                    <p:column headerText="Credit Entitlement" style="padding: 2px;">
                                                                        <h:outputText value="#{mys.creditLimitQualified}">
                                                                            <f:convertNumber pattern="#,##0.00" />
                                                                        </h:outputText>
                                                                    </p:column>
                                                                    <p:column headerText="Credit Utilized" style="padding: 2px;">
                                                                        <h:outputText value="#{mys.currentCreditValue}">
                                                                            <f:convertNumber pattern="#,##0.00" />
                                                                        </h:outputText>
                                                                    </p:column>
                                                                </p:autoComplete>
                                                            </h:panelGroup>
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Slip Payment Method -->
                                                <p:panelGrid columns="2" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Slip'}">
                                                    <p:row>
                                                        <p:column colspan="2">
                                                            <h:outputLabel value="Slip Payment" />
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="slipLblBank" value="Select Bank" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:selectOneMenu class="w-75" autoWidth="false" id="slipSelBank" value="#{bookingControllerViewScopeMonth.paymentMethodData.slip.institution}">
                                                                <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                            </p:selectOneMenu>
                                                        </p:column>
                                                    </p:row>
                                                    <p:row>
                                                        <p:column>
                                                            <p:outputLabel id="slipLblDate" value="Slip Date" />
                                                        </p:column>
                                                        <p:column>
                                                            <p:datePicker class="w-100" showTime="true" showButtonBar="true" timeInput="true" id="date" value="#{bookingControllerViewScopeMonth.paymentMethodData.slip.date}" pattern="dd MMMM yyyy" />
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Multiple Payment Methods -->
                                                <p:panelGrid columns="1" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'MultiplePaymentMethods'}">
                                                    <p:row>
                                                        <p:column>
                                                            <pa:multiple_payment_methods controller="#{bookingControllerViewScopeMonth}" class="w-100" />
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                                <!-- Credit Payment Method -->
                                                <p:panelGrid columns="1" rendered="#{bookingControllerViewScopeMonth.paymentMethod eq 'Credit'}">
                                                    <p:row>
                                                        <p:column>
                                                            <h:panelGroup class="row" layout="block">
                                                                <div class="my-1" id="credit">
                                                                    <div class="row">
                                                                        <div class="col-12 d-flex">
                                                                            <p:autoComplete id="creditCompany" class="w-100 -mx-2" inputStyleClass="form-control" forceSelection="true"
                                                                                            value="#{bookingControllerViewScopeMonthMonth.creditCompany}" completeMethod="#{creditCompanyController.completeCredit}" var="ix"
                                                                                            minQueryLength="4" placeholder="Company (Type at least 4 letters to search)" itemLabel="#{ix.name}" itemValue="#{ix}" size="10">
                                                                                <f:ajax event="itemSelect" listener="#{bookingControllerViewScopeMonth.calTotals()}" execute="@this" render=":#{p:resolveFirstComponentWithId('paymentDetails',view).clientId}" />
                                                                            </p:autoComplete>
                                                                            <p:commandLink id="btnAddNewCreditCom" value="(+)" class="mx-3 mt-1" title="Add New Credit Company"
                                                                                           ajax="false" action="#{navigationController.navigateToCreditCompany()}" actionListener="#{creditCompanyController.prepareAdd()}" />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </h:panelGroup>
                                                        </p:column>
                                                    </p:row>
                                                </p:panelGrid>

                                            </h:panelGroup>

                                        </p:panel>

                                        <p:panel id="panelBillReferrals" class="my-1" >
                                            <f:facet name="header" >
                                                <h:outputText styleClass="fa fa-stethoscope" /> 
                                                <h:outputText value="Referral Details" class="mx-4"></h:outputText>
                                            </f:facet>

                                            <h:panelGrid 
                                                columns="2" 
                                                class="w-100">
                                                <p:outputLabel for="refIns" value="Institution" ></p:outputLabel>
                                                <p:autoComplete id="refIns" 
                                                                forceSelection="true" 
                                                                value="#{bookingControllerViewScopeMonth.referredByInstitution}"
                                                                completeMethod="#{institutionController.completeIns}"
                                                                var="ri" 
                                                                itemLabel="#{ri.name}" 
                                                                itemValue="#{ri}"
                                                                scrollHeight="500"
                                                                inputStyleClass="form-control"
                                                                class="w-100">
                                                    <f:ajax  event="itemSelect" execute="creditCom"  />
                                                    <p:column headerText="Referring Institution Name" style="padding: 2px;">#{ri.name}</p:column>
                                                    <p:column headerText="Code" style="padding: 2px;">#{ri.institutionCode}</p:column>
                                                </p:autoComplete>


                                                <h:panelGroup class="w-100">
                                                    <p:outputLabel for="cmbDoc" value="Doctor" ></p:outputLabel>
                                                    <p:commandLink id="btnAddNewDoc" 
                                                                   type="button"  
                                                                   value="&nbsp;(+)" 
                                                                   oncomplete="PF('dlg').show();" 
                                                                   actionListener="#{doctorController.prepareAdd}" 
                                                                   process="btnAddNewDoc" 
                                                                   update="#{p:resolveFirstComponentWithId('panDoc',view).clientId}" />  

                                                </h:panelGroup>


                                                <p:autoComplete forceSelection="true" 
                                                                id="cmbDoc" 
                                                                value="#{bookingControllerViewScopeMonth.referredBy}" 
                                                                completeMethod="#{doctorController.completeDoctor}" var="ix" 
                                                                itemLabel="#{ix.person.name}" 
                                                                itemValue="#{ix}" 
                                                                inputStyleClass="form-control"
                                                                class="w-100" 
                                                                scrollHeight="500">
                                                    <p:column headerText="Name" style="padding: 2px;">
                                                        <h:outputText value="#{ix.person.nameWithTitle}" ></h:outputText>
                                                    </p:column>
                                                    <p:column headerText="Code" style="padding: 2px;">
                                                        <h:outputText value="#{ix.code}" ></h:outputText>
                                                    </p:column>
                                                </p:autoComplete>

                                                <h:panelGroup class="w-100">
                                                    <p:outputLabel value="Centre" />
                                                    <p:commandLink 
                                                        id="btnAddNewCc" 
                                                        value="&nbsp;(+)"  
                                                        ajax="false" 
                                                        action="#{navigationController.navigateToCollectingCenter()}"
                                                        actionListener="#{collectingCentreController.prepareAdd()}"  />  
                                                </h:panelGroup>
                                                <p:autoComplete id="creditCom" 
                                                                forceSelection="true" 
                                                                class="w-100"
                                                                value="#{bookingControllerViewScopeMonth.collectingCentre}"  
                                                                completeMethod="#{institutionController.completeCollectingCenter}" 
                                                                var="ix" 
                                                                placeholder="Type at least 4 letters to search"
                                                                inputStyleClass="form-control"
                                                                minQueryLength="4"
                                                                itemLabel="#{ix.name}" 
                                                                itemValue="#{ix}" 
                                                                scrollHeight="500" >
                                                    <f:ajax  event="itemSelect" execute="creditCom"  />
                                                    <p:column headerText="Collecting Centre Name" style="padding: 2px;">
                                                        <h:outputText value="#{ix.name}" ></h:outputText>
                                                    </p:column>
                                                    <p:column headerText="Code" style="padding: 2px;">
                                                        <h:outputText value="#{ix.institutionCode}" ></h:outputText>
                                                    </p:column>

                                                </p:autoComplete>

                                            </h:panelGrid>
                                        </p:panel>

                                        <p:panelGrid id="panelBookingDetails" class="w-100 mt-1">
                                            <f:facet name="header">
                                                <p:row>
                                                    <p:column colspan="2" class="w-100" style="text-align: left" >
                                                        <h:outputText styleClass="fa-solid fa-calendar-plus"/>
                                                        <h:outputText class="mx-4" value="Booking Details"/>
                                                    </p:column>
                                                </p:row>

                                            </f:facet>
                                            <p:row>
                                                <p:column><p:outputLabel value="Speciality" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScopeMonth.speciality.name}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Consultant" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScopeMonth.staff.person.nameWithTitle}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Session" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScopeMonth.selectedSessionInstance.name}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Date" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScopeMonth.selectedSessionInstance.sessionDate}">
                                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Time" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScopeMonth.selectedSessionInstance.originatingSession.startingTime}">
                                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longTimeFormat}" />
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Reserved Numbers" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScopeMonth.selectedSessionInstance.originatingSession.reserveNumbers}">
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Total Fee" /></p:column>
                                                <p:column >
                                                    <h:panelGroup id="gpFeeTotal">
                                                        <p:outputLabel  rendered="#{!bookingControllerViewScopeMonth.foriegn}"
                                                                        value="#{bookingControllerViewScopeMonth.feeTotalForSelectedBill}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </p:outputLabel>
                                                        <p:outputLabel rendered="#{bookingControllerViewScopeMonth.foriegn}"
                                                                       value="#{bookingControllerViewScopeMonth.feeTotalForSelectedBill}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </p:outputLabel>
                                                    </h:panelGroup>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column colspan="2">
                                                    <p:dataTable value="#{bookingControllerViewScopeMonth.selectedItemFeesWithouZeros}" var="i" >
                                                        <p:column headerText="Name">
                                                            <h:outputLabel value="#{i.item.name}"/> 
                                                            <h:outputLabel class="mr-4" value="("/> 
                                                            <h:outputLabel value="#{i.feeType.label}"/> 
                                                            <h:outputLabel value=")"/> 
                                                        </p:column>
                                                        <p:column headerText="Fee for">
                                                            <h:panelGroup rendered="#{i.feeType eq 'Staff'}" >
                                                                <h:outputLabel rendered="#{i.staff.person.name ne null}"  value=" #{i.staff.person.name}"></h:outputLabel>
                                                                <h:outputLabel  rendered="#{i.speciality.name ne null}" class="mr-4" value="("/> 
                                                                <h:outputLabel rendered="#{i.speciality.name ne null}"  value="#{i.speciality.name}"/> 
                                                                <h:outputLabel  rendered="#{i.speciality.name ne null}" value=")"/> 
                                                            </h:panelGroup>
                                                            <h:panelGroup rendered="#{i.feeType eq 'OwnInstitution' or i.feeType eq 'OtherInstitution' }" >
                                                                <h:outputLabel rendered="#{i.institution.name ne null}"  value="#{i.institution.name}"></h:outputLabel>
                                                                <h:outputLabel  rendered="#{i.department.name ne null}" class="mr-4" value="("/> 
                                                                <h:outputLabel rendered="#{i.department.name ne null}"  value=" #{i.department.name}"></h:outputLabel>
                                                                <h:outputLabel  rendered="#{i.department.name ne null}" value=")"/> 
                                                            </h:panelGroup>
                                                        </p:column>
                                                        <p:column headerText="Fee" rendered="#{!bookingControllerViewScopeMonth.foriegn}">
                                                            <h:outputText value="#{i.fee}" >
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputText>
                                                        </p:column>
                                                        <p:column headerText="Fee" rendered="#{bookingControllerViewScopeMonth.foriegn}">
                                                            <h:outputText value="#{i.ffee}" >
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputText>
                                                        </p:column>
                                                    </p:dataTable>
                                                </p:column>

                                            </p:row>
                                        </p:panelGrid>


                                    </div>
                                    <p:dialog id="panDoc" header="Add New Doctor" widgetVar="dlg" resizable="false" modal="true" class="p-2" showEffect="fade"  width="450">  
                                        <h:panelGrid columns="2" >  
                                            <p:outputLabel id="lblNameD" value="Name" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtNameD"  value="#{doctorController.current.person.name}"  ></p:inputText>
                                            <p:outputLabel id="lblPhoneD" value="Phone" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtPhoneD" value="#{doctorController.current.person.phone}"  ></p:inputText>
                                            <p:outputLabel id="lblFaxD" value="Fax" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtFaxD" value="#{doctorController.current.person.fax}"  ></p:inputText>
                                            <p:outputLabel id="lblMobileD" value="Mobile" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtMobileD" value="#{doctorController.current.person.mobile}"  ></p:inputText>
                                            <p:outputLabel id="lblAddressD" value="Address" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtAddressD" value="#{doctorController.current.person.address}"  ></p:inputText>
                                            <p:outputLabel value="Code"></p:outputLabel>   
                                            <p:inputText autocomplete="off" id="txtCodeD" value="#{doctorController.current.code}"  ></p:inputText>
                                            <p:outputLabel value="Speciality" ></p:outputLabel>
                                            <p:selectOneMenu id="cmbSpecialityD" value="#{doctorController.current.speciality}" >
                                                <f:selectItem itemLabel="Please select a speciality"/>
                                                <f:selectItems value="#{doctorSpecialityController.items}" var="cat" itemLabel="#{cat.name}" itemValue="#{cat}" />
                                            </p:selectOneMenu>
                                            <p:outputLabel id="lblRegD" value="Registration" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtRegD" value="#{doctorController.current.registration}"  ></p:inputText>                 
                                            <p:outputLabel id="lblQuaD" value="Qualification" ></p:outputLabel>
                                            <p:inputText autocomplete="off" id="txtQuaD" value="#{doctorController.current.qualification}"  ></p:inputText>   

                                            <p:commandButton 
                                                id="btnDocSave" 
                                                value="Add New" 
                                                ajax="false"
                                                process="btnDocSave panDoc" 
                                                update="msg panDoc cmbDoc :#{p:resolveFirstComponentWithId('cmbDoc',view).clientId}" actionListener="#{doctorController.saveSelected()}" styleClass="buttons" oncomplete="dlg.hide();">
                                            </p:commandButton>
                                        </h:panelGrid>  
                                    </p:dialog> 
                                </div>
                            </div>
                        </div>  
                    </h:form >
                </h:panelGroup>


                <h:panelGroup rendered="#{bookingControllerViewScopeMonth.printPreview}" >

                    <h:form>

                        <div class="row">
                            <div>
                                <div class="row w-100">
                                    <div class="d-flex align-items-center justify-content-end">
                                        <div>
                                            <p:commandButton 
                                                value="Print" 
                                                ajax="false" 
                                                class="ui-button-info"
                                                icon="fa fa-print"
                                                action="#"
                                                disabled="#{bookingControllerViewScopeMonth.printingBill.balance ne 0.0 or !bookingControllerViewScopeMonth.settleSucessFully or bookingControllerViewScopeMonth.printingBill.paymentMethod eq 'OnCall'}">
                                                <p:printer 
                                                    target="gpBillPreview" >
                                                </p:printer>
                                            </p:commandButton>
                                        </div>
                                        <div class="d-flex justify-content-end">

                                            <p:outputLabel value="Paper Type" class="m-2"></p:outputLabel>
                                            <p:selectOneMenu 
                                                value="#{bookingControllerViewScopeMonth.departmentPreference.channelBillPaperType}" 
                                                class="m-1" 
                                                style="width: 13em;">
                                                <f:selectItem itemLabel="Please Select Paper Type" />
                                                <f:selectItems value="#{enumController.paperTypes}" />
                                            </p:selectOneMenu>
                                            <p:commandButton 
                                                ajax="false" 
                                                icon="fa fa-sync-alt" 
                                                class="ui-button m-1" 
                                                title="Redraw Bill">
                                            </p:commandButton>
                                        </div>

                                        <div>
                                            <p:commandButton 
                                                value="Back" 
                                                icon="fa fa-redo" 
                                                class="ui-button-success" 
                                                action="#{bookingControllerViewScopeMonth.navigateBackToBookingsFromBillSession()}" 
                                                ajax="false" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div >
                                    <h:panelGroup id="gpBillPreview">
                                        <ui:repeat value="#{bookingControllerViewScopeMonth.departmentPreference.channellingBillCopiesList}" var="copy">
                                            <h:panelGroup rendered="#{bookingControllerViewScopeMonth.departmentPreference.channelBillPaperType eq 'PosPaper'}" >
                                                <ez:bmsChannelBill  bill="#{bookingControllerViewScopeMonth.printingBill}"/>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{bookingControllerViewScopeMonth.departmentPreference.channelBillPaperType eq 'FiveFivePaper'}" >
                                                <ez:bms5x5ChannelBill bill="#{bookingControllerViewScopeMonth.printingBill}" payments="#{bookingControllerViewScopeMonth.payments}"/> 
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{sessionController.loggedPreference.channelBillPaperType eq 'FiveFivePrintedPaper'}" >
                                                <ez:bms5x5WIthoutHeaderChannelBill controller="#{bookingControllerViewScopeMonth}" bill="#{bookingControllerViewScopeMonth.printingBill}" paymentMethodData="#{bookingControllerViewScopeMonth.paymentMethodData}" payments="#{bookingControllerViewScopeMonth.payments}"/>
                                            </h:panelGroup>
                                        </ui:repeat>
                                    </h:panelGroup>
                                </div>
                            </div>
                        </div>


                    </h:form>





                </h:panelGroup>


            </ui:define>
        </ui:composition>
    </h:body>
</html>