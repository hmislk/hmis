<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/resources/template/template.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ch="http://java.sun.com/jsf/composite/channel"
                xmlns:pa="http://java.sun.com/jsf/composite/paymentMethod"
                xmlns:au="http://java.sun.com/jsf/composite/autocomplete"
                xmlns:pat="http://java.sun.com/jsf/composite/patient"
                xmlns:ezcommon="http://java.sun.com/jsf/composite/ezcomp/common"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <ui:define name="content">

        <h:form id="form">
            <p:growl id="msg" />
            <!--            
            #{bookingController.selectedBillSession.bill.billItems}
            #{bookingController.selectedBillSession.bill.billFees}
            
            <ui:repeat value="#{bookingController.selectedBillSession.bill.billItems}" var="bi" >
                Bill Item : #{bi} <br/>
                <ui:repeat value="#{bi.billFees}" var="bf" >
                    Bill Fee : #{bf} <br/>
                </ui:repeat>
            </ui:repeat>-->

            <p:panel >
                <f:facet name="header">
                    <div class="d-flex justify-content-between">
                        <h:outputText value="Manage Booking" class="mt-2"></h:outputText>
                        <div class="d-flex gap-2">
                            <p:commandButton 
                                ajax="false" 
                                value="Add New Booking" 
                                icon="fas fa-plus"
                                class="ui-button-success"
                                action="#{bookingController.navigateToAddBooking()}"
                                />
                            <p:commandButton 
                                ajax="false" 
                                class="mx-1 ui-button-secondary"
                                value="Back to Bookings" 
                                action="#{bookingController.navigateBackToBookings()}"
                                icon="fa-solid fa-arrow-left" />
                        </div>
                    </div>

                </f:facet>
                <p:tabView id="detail">
                    <p:tab title="Booking" id="booking" class="w-100">
                        <h:panelGroup rendered="#{bookingController.selectedBillSession.markedToCancel}" class="w-100 bg-danger text-white p-2" layout="block">
                            <i class="fas fa-ban text-white m-3"></i>
                            <h:outputText value="Marked to Cancel" />
                        </h:panelGroup>
                        <h:panelGroup rendered="#{bookingController.selectedBillSession.markedToRefund}"  class="w-100 bg-danger text-white p-2" layout="block">
                            <i class="fas fa-undo-alt  text-white m-3" ></i>
                            <h:outputText value="Marked to Refund"  />
                        </h:panelGroup>
                        <!-- More Labels and Output Below -->
                        <h:panelGrid columns="2" >
                            <p:panel header="Booking" rendered="#{bookingController.selectedBillSession.bill.paidBill eq null and bookingController.selectedBillSession.bill.balance ne 0.0}">
                                <div class="ui-message-error ui-widget ui-corner-all">
                                    <span class="ui-message-error-icon"/>
                                    <span class="ui-message-error-detail">
                                        <h:outputText value="NOT PAID YET" ></h:outputText>
                                    </span>
                                </div>



                                <h:panelGrid columns="2">
                                    <p:outputLabel value="Name"/>
                                    <p:commandLink value="#{bookingController.selectedBillSession.bill.patient.person.nameWithTitle}"
                                                   action="#{patientController.toPatientFromSearchPatients()}">
                                        <f:setPropertyActionListener value="#{bookingController.selectedBillSession.bill.patient}"
                                                                     target="#{patientController.current}" ></f:setPropertyActionListener>
                                    </p:commandLink>
                                    <p:outputLabel value="Consultant"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.staff.person.nameWithTitle}"/>
                                    <p:outputLabel value="Serial No"/>
                                    <ui:repeat value="#{bookingController.selectedBillSession.bill.billItems}" var="bis" >
                                        <p:outputLabel value="#{bis.billSession.serialNo}"/>
                                    </ui:repeat>
                                    <p:outputLabel value="Appointment Date">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.sessionDate}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy" >
                                        </f:convertDateTime>
                                    </p:outputLabel>
                                    <p:outputLabel value="Appointment Time">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.startingTime}"> 
                                        <f:convertDateTime pattern="hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:separator ></p:separator>
                                    <p:separator ></p:separator>
                                    <p:outputLabel value="Payment Method"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paymentMethod}"/>
                                    <p:outputLabel value="Agent" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.fromInstitution.name}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Agent Ref No" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.billItem.agentRefNo}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Staff Name" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingController.selectedBillSession.bill.toStaff.code}) " rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="User"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.creater.webUserPerson.nameWithTitle}"/>
                                    <p:outputLabel value="Booked At"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.createdAt}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>

                                    <p:outputLabel value="Settled At" rendered="#{bookingController.selectedBillSession.bill.paidBill ne null}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.createdAt}" rendered="#{bookingController.selectedBillSession.bill.paidBill ne null}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:separator rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" ></p:separator>
                                    <p:separator rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" ></p:separator>
                                    <p:outputLabel style="color: red" value="Payment" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.createdAt}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}">
                                        <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a"  ></f:convertDateTime>
                                    </p:outputLabel> 
                                </h:panelGrid>                            
                            </p:panel>

                            <p:panel header="Booking &amp; Settling" rendered="#{bookingController.selectedBillSession.bill.paidBill eq bookingController.selectedBillSession.bill and bookingController.selectedBillSession.bill.balance eq 0.0}">
                                <h:panelGrid columns="2">
                                    <p:outputLabel value="Name"/>
                                    <p:commandLink value="#{bookingController.selectedBillSession.bill.patient.person.nameWithTitle}"
                                                   action="#{patientController.toPatientFromSearchPatients()}">
                                        <f:setPropertyActionListener value="#{bookingController.selectedBillSession.bill.patient}"
                                                                     target="#{patientController.current}" ></f:setPropertyActionListener>
                                    </p:commandLink>
                                    <p:outputLabel value="Consultant"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.staff.person.nameWithTitle}"/>
                                    <p:outputLabel value="Serial No"/>
                                    <ui:repeat value="#{bookingController.selectedBillSession.bill.billItems}" var="bis" >
                                        <p:outputLabel value="#{bis.billSession.serialNo}"/>
                                    </ui:repeat>
                                    <p:outputLabel value="Appointment Date">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.sessionDate}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy" >
                                        </f:convertDateTime>
                                    </p:outputLabel>
                                    <p:outputLabel value="Appointment Time">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.startingTime}"> 
                                        <f:convertDateTime pattern="hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:separator ></p:separator>
                                    <p:separator ></p:separator>

                                    <p:outputLabel value="Bill No"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.insId}"/>
                                    <p:outputLabel value="Payment"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paymentMethod}"/>
                                    <p:outputLabel value="Agent" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.creditCompany.name}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Agent Ref No" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.billItem.agentRefNo}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Staff Name" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingController.selectedBillSession.bill.toStaff.code}) " rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="User"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.creater.webUserPerson.nameWithTitle}"/>
                                    <p:outputLabel value="Billed At"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.createdAt}"> 
                                        <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:separator 
                                        rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" ></p:separator>
                                    <p:separator rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" ></p:separator>
                                    <p:outputLabel style="color: red" value="Payment" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.paymentMethod}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="Cancel/Refund User" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.creater.webUserPerson.nameWithTitle}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="Cancel/Refund At" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.billedBill.createdAt}" rendered="#{bookingController.selectedBillSession.bill.cancelled==true or bookingController.selectedBillSession.bill.refunded==true}">
                                        <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a"  ></f:convertDateTime>
                                    </p:outputLabel> 

                                </h:panelGrid>    

                                <h:panelGrid columns="2" rendered="#{bookingController.selectedBillSession.bill.cancelled}">
                                    <p:outputLabel style="color: red" value="Cancelled Payment"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.cancelledBill.paymentMethod}"/>
                                    <p:outputLabel style="color: red" value="Cancel/Refund User" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.cancelledBill.creater.webUserPerson.nameWithTitle}" />
                                    <p:outputLabel style="color: red" value="Cancel/Refund At" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.cancelledBill.createdAt}" >
                                        <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a"  ></f:convertDateTime>
                                    </p:outputLabel> 
                                </h:panelGrid>

                                <h:panelGrid columns="2" rendered="#{bookingController.selectedBillSession.bill.refunded}">
                                    <p:outputLabel style="color: red" value="Refunded Payment"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.refundedBill.paymentMethod}"/>
                                    <p:outputLabel style="color: red" value="Refunded Value"/>
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.refundedBill.netTotal}">
                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                    </p:outputLabel>

                                    <p:outputLabel style="color: red" value="Refund User" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.refundedBill.creater.webUserPerson.nameWithTitle}" />
                                    <p:outputLabel style="color: red" value="Refund At" />
                                    <p:outputLabel style="color: red" value="#{bookingController.selectedBillSession.bill.refundedBill.createdAt}" >
                                        <!--                                        <f:convertNumber pattern="dd/MMM/yyyy - hh:mm a"  ></f:convertNumber>-->
                                    </p:outputLabel> 
                                </h:panelGrid>

                            </p:panel>

                            <p:panel header="Booking" rendered="#{(bookingController.selectedBillSession.bill.paidBill ne bookingController.selectedBillSession.bill) and bookingController.selectedBillSession.bill.balance eq 0.0}">
                                <h:panelGrid columns="2">
                                    <p:outputLabel value="Name"/>


                                    <p:commandLink value="#{bookingController.selectedBillSession.bill.patient.person.nameWithTitle}"
                                                   action="#{patientController.toPatientFromSearchPatients()}">
                                        <f:setPropertyActionListener value="#{bookingController.selectedBillSession.bill.patient}"
                                                                     target="#{patientController.current}" ></f:setPropertyActionListener>
                                    </p:commandLink>

                                    <p:outputLabel value="Consultant"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.staff.person.nameWithTitle}"/>
                                    <p:outputLabel value="Serial No"/>
                                    <ui:repeat value="#{bookingController.selectedBillSession.bill.billItems}" var="bis" >
                                        <p:outputLabel value="#{bis.billSession.serialNo}"/>
                                    </ui:repeat>
                                    <p:outputLabel value="Appointment Date">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.sessionDate}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy" >
                                        </f:convertDateTime>
                                    </p:outputLabel>
                                    <p:outputLabel value="Appointment Time">
                                    </p:outputLabel>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.serviceSession.startingTime}"> 
                                        <f:convertDateTime pattern="hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:separator ></p:separator>
                                    <p:separator ></p:separator>
                                    <p:outputLabel value="Payment"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paymentMethod}"/>
                                    <p:outputLabel value="Agent" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.fromInstitution.name}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Agent Ref No" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.billItem.agentRefNo}" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Booking User"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.creater.webUserPerson.nameWithTitle}"/>
                                    <p:outputLabel value="Staff Name" rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.toStaff.person.nameWithTitle} - (#{bookingController.selectedBillSession.bill.toStaff.code}) " rendered="#{bookingController.selectedBillSession.bill.paymentMethod eq 'Staff'}"/>
                                    <p:outputLabel value="Booked At"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.createdAt}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                    <p:outputLabel value="Settled At" rendered="#{bookingController.selectedBillSession.bill.paidBill ne null}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.createdAt}" rendered="#{bookingController.selectedBillSession.bill.paidBill ne null}"> 
                                        <f:convertDateTime pattern="dd MMM yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                </h:panelGrid>                            
                            </p:panel>

                            <p:panel header="Settling" class="mx-4" style="margin-bottom: 40%" rendered="#{(bookingController.selectedBillSession.bill.paidBill ne bookingController.selectedBillSession.bill) and bookingController.selectedBillSession.bill.balance eq 0.0}">
                                <h:panelGrid columns="2">
                                    <p:outputLabel value="Bill ID"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.insId}"/>
                                    <p:outputLabel value="Payment Method"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.paymentMethod}"/>
                                    <p:outputLabel value="Agent" rendered="#{bookingController.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.fromInstitution.name}" 
                                                   rendered="#{bookingController.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="Agent Ref No" rendered="#{bookingController.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.billItem.paidBill.agentRefNo}" rendered="#{bookingController.selectedBillSession.bill.paidBill.paymentMethod eq 'Agent'}"/>
                                    <p:outputLabel value="User"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.creater.webUserPerson.nameWithTitle}"/>
                                    <p:outputLabel value="Settled At"/>
                                    <p:outputLabel value="#{bookingController.selectedBillSession.bill.paidBill.createdAt}"> 
                                        <f:convertDateTime pattern="dd/MMM/yyyy - hh:mm a" ></f:convertDateTime>
                                    </p:outputLabel>
                                </h:panelGrid>                            
                            </p:panel>
                        </h:panelGrid>

                    </p:tab>

                    <p:tab title="Reprint" id="rePrint" >
                        <div class="row">
                            <div class="d-flex justify-content-between">
                                <p:commandButton 
                                    value="Print" 
                                    ajax="false" 
                                    class="ui-button-info  m-1"
                                    icon="fa fa-print"
                                    action="#" 
                                    disabled="#{channelBillController.billSession.billItem.bill.balance ne 0.0}">                    
                                    <p:printer target="gpBillPreview" ></p:printer>
                                </p:commandButton>

                                <div>
                                    <p:outputLabel value="Paper Type" class="m-2"></p:outputLabel>
                                    <p:selectOneMenu 
                                        value="#{sessionController.departmentPreference.channelBillPaperType}" 
                                        class="m-1" 
                                        style="width: 13em;">
                                        <f:selectItem itemLabel="Please Select Paper Type" />
                                        <f:selectItems value="#{enumController.paperTypes}" />
                                    </p:selectOneMenu>
                                    <p:commandButton 
                                        ajax="false" 
                                        icon="fa fa-sync-alt" 
                                        class="ui-button-primary m-1" 
                                        title="Redraw Bill">
                                    </p:commandButton>
                                </div>
                            </div>
                            <div class="col-md-12 mt-2">
                                <div class="d-flex justify-content-center">

                                    <h:panelGroup id="gpBillPreview">
                                        <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">
                                            <h:panelGroup rendered="#{sessionController.loggedPreference.channelBillPaperType eq 'PosPaper'}" >
                                                <ez:bmsChannelBill  bill="#{channelBillController.billSession.billItem.bill}" dup="true"/>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{sessionController.loggedPreference.channelBillPaperType eq 'FiveFivePaper'}" >
                                                <ez:bms5x5ChannelBill bill="#{channelBillController.billSession.billItem.bill}" duplicate="true"/> 
            <!--                                <bg:fiveFiveCCBill_CC bill="#{bookingController.printingBill}"/>  -->
                                            </h:panelGroup>
                                        </ui:repeat>
                                    </h:panelGroup>
                                </div>
                            </div>
                        </div>

                    </p:tab>

                    <p:tab title="Cancel" id="cancel"  disabled="#{!webUserController.hasPrivilege('ChannelBookingCancel')}">                                                         

                        <h:panelGroup rendered="#{channelBillController.billSession.billItem.bill.paymentMethod eq 'Agent'}" >
                            <p:outputLabel value="Re-payment Method"/>
                            <p:selectOneMenu  id="cmbCancellPs" value="#{channelBillController.cancelPaymentMethod}">  
                                <f:selectItem itemLabel="Select Cancel Payment Method" ></f:selectItem>
                                <f:selectItems value="#{enumController.paymentMethodsForChannelAgentSettle}"/>                                                               
                            </p:selectOneMenu>
                        </h:panelGroup>

                        <h:panelGroup>
                            <ch:bill_fees bill="#{channelBillController.billSession.billItem.bill}" />
                        </h:panelGroup>
                        <h:inputTextarea value="#{channelBillController.comment}"/>
                        <p:commandButton ajax="false" value="Cancel Agent Bill" 
                                         rendered="#{channelBillController.billSession.bill.billType eq 'ChannelAgent'}"
                                         action="#{channelBillController.cancelAgentPaidBill()}"
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true}" 
                                         onclick="onSubmitButton();"/>
                        <p:commandButton ajax="false" value="Cancel" 
                                         rendered="#{channelBillController.billSession.bill.billType.parent eq 'ChannelCashFlow' and channelBillController.billSession.bill.billType ne 'ChannelAgent'}"
                                         action="#{channelBillController.cancelCashFlowBill}"
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true}" 
                                         onclick="onSubmitButton();"/>
                        <p:commandButton ajax="false" value="Cancel Booking" 
                                         rendered="#{(channelBillController.billSession.bill.billType eq 'ChannelOnCall' or channelBillController.billSession.bill.billType eq 'ChannelStaff')and channelBillController.billSession.bill.paidBill eq null}"
                                         action="#{channelBillController.cancelBookingBill}"
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true}" 
                                         onclick="onSubmitButton();"/>
                        <p:commandButton ajax="false" value="Cancel Paid" 
                                         rendered="#{channelBillController.billSession.bill.billType.parent eq 'ChannelCreditFlow' and channelBillController.billSession.bill.billType ne 'ChannelAgent'}"
                                         action="#{channelBillController.cancelCreditPaidBill}"
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true
                                                     or channelBillController.billSession.bill.paidAmount eq 0}" 
                                         onclick="onSubmitButton();"/>
                    </p:tab>


                    <p:tab title="Refund" id="refund"   disabled="#{!webUserController.hasPrivilege('ChannelBookingRefund')}">                          

                        <h:panelGroup>
                            <h:panelGrid columns="2" rendered="#{channelBillController.billSession.billItem.bill.paymentMethod eq 'Agent'}" >

                                <p:outputLabel value="Re-payment Method"/>
                                <p:selectOneMenu  id="cmbRefundPs" value="#{channelBillController.refundPaymentMethod}" >  
                                    <f:selectItem itemLabel="Select Cancel Payment Method" ></f:selectItem>
                                    <f:selectItems value="#{enumController.paymentMethodsForChannelAgentSettle}"/>
                                </p:selectOneMenu>

                            </h:panelGrid>
                            <h:panelGrid columns="2">
                                <h:outputLabel value="Refundable Total : "/>
                                <h:outputLabel id="tot" value="#{channelBillController.refundableTotal}"/>
                            </h:panelGrid>
                            <p:dataTable value="#{channelBillController.billSession.bill.billFees}" var="bi">
                                <p:column headerText="Fee Name">
                                    <p:outputLabel value="#{bi.fee.name}"/>
                                </p:column>
                                <p:column headerText="Fee Type">
                                    <p:outputLabel value="#{bi.fee.feeType}"/>
                                </p:column>
                                <p:column headerText="Fee Value">
                                    <p:outputLabel value="#{bi.feeValue}"/> 
                                </p:column>
                                <p:column headerText="Return Value">
                                    <p:inputText value="#{bi.tmpChangedValue}">
                                        <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId}" event="blur" listener="#{channelBillController.calRefundTotal()}"/>
                                        <f:ajax execute="@this" render=":#{p:resolveFirstComponentWithId('tot',view).clientId} @this" event="blur" listener="#{channelBillController.checkRefundTotal()}"/>
                                    </p:inputText>

                                </p:column>
                            </p:dataTable>
                        </h:panelGroup>
                        <h:inputTextarea value="#{channelBillController.commentR}"/>

                        <p:commandButton ajax="false" value="Refund Agent Bills" 
                                         rendered="#{channelBillController.billSession.billItem.bill.paymentMethod eq 'Agent'}"
                                         action="#{channelBillController.refundAgentBill}" 
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true}"
                                         onclick="onSubmitButton();"/>

                        <p:commandButton ajax="false" value="Refund" 
                                         rendered="#{channelBillController.billSession.bill.billType.parent eq 'ChannelCashFlow' and channelBillController.billSession.billItem.bill.paymentMethod ne 'Agent'}"
                                         action="#{channelBillController.refundCashFlowBill}" 
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true}"
                                         onclick="onSubmitButton();"/>

                        <p:commandButton ajax="false" value="Refund Paid" 
                                         rendered="#{channelBillController.billSession.bill.billType.parent eq 'ChannelCreditFlow' }"
                                         action="#{channelBillController.refundCreditPaidBill}" 
                                         disabled="#{channelBillController.billSession.bill.refunded==true
                                                     or channelBillController.billSession.bill.cancelled==true
                                                     or channelBillController.billSession.bill.paidAmount eq 0}"
                                         onclick="onSubmitButton();"/>


                    </p:tab>


                    <p:tab title="Settle" id="settle">
                        <p:panel  id="set">
                            <ch:bill_fees bill="#{channelBillController.billSession.billItem.bill}" />

                            <p:outputLabel rendered="false" value="Payment Method"/>
                            <p:selectOneMenu  
                                class="mx-2"
                                rendered="false"
                                style="width: 10em;"
                                id="cmbSettlePs" value="#{channelBillController.settlePaymentMethod}">  
                                <f:selectItems value="#{enumController.paymentMethodsForChannelSettle}"/>                                                               
                                <f:ajax execute="@this" render="settleAgent settleAgent2 settleBallance settleBallance2 settleAgRefLbl settleAgRefTxt" event="change" />
                            </p:selectOneMenu>

                            <h:outputLabel id="settleAgent" value="Agent"  style="display: #{channelBillController.settlePaymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <p:autoComplete id="settleAgent2" forceSelection="true" style="display: #{channelBillController.settlePaymentMethod eq 'Agent'? 'block' : 'none'} ; "
                                            value="#{channelBillController.settleInstitution}"  completeMethod="#{agencyController.completeAgency}" var="ix"
                                            itemLabel="#{ix.name}" itemValue="#{ix}" >
                                <f:ajax  event="itemSelect" execute="@this"  render="settleBallance settleBallance2 settleAgRefLbl settleAgRefTxt"/>
                                <p:column>#{ix.institutionCode}</p:column>
                                <p:column>#{ix.name}</p:column>                                
                            </p:autoComplete> 

                            <h:outputLabel id="settleAgRefLbl" value="Agent Reference No"  style="display: #{channelBillController.settlePaymentMethod eq 'Agent'? 'block' : 'none'} ; "/>
                            <p:inputText autocomplete="off" id="settleAgRefTxt" value="#{channelBillController.settleAgentRefNo}"  style="display: #{channelBillController.settlePaymentMethod eq 'Agent' ? 'block' : 'none'} ; " />

                            <h:outputLabel id="settleBallance" value="Balance"  style="display: #{channelBillController.paymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <h:outputLabel id="settleBallance2" value="#{channelBillController.institution.ballance}"  style="display: #{channelBillController.settlePaymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <p:commandButton
                                id="setBtn"
                                class="ui-button-success mt-2"
                                icon="fa-solid fa-check"
                                value="Settle Credit Booking"
                                process="cmbSettlePs settleAgent2 settleAgRefTxt setBtn"
                                update="gpSettlePrint"
                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Channel Credit Booking Settle Requires Additional Information')}"
                                disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                            or channelBillController.billSession.bill.cancelled==true
                                            or  channelBillController.billSession.bill.paidAmount ne 0}"
                                oncomplete="PF('dlgPreSettle').show();"
                                />

                            <p:commandButton
                                id="setBtna"
                                class="ui-button-success mt-2"
                                icon="fa-solid fa-check"
                                value="Settle Credit Booking"
                                process="cmbSettlePs settleAgent2 settleAgRefTxt setBtn"
                                update="gpSettlePrint"
                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Credit Booking Settle Requires Additional Information')}"
                                disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                            or channelBillController.billSession.bill.cancelled==true
                                            or  channelBillController.billSession.bill.paidAmount ne 0}"
                                oncomplete="PF('dlgPreSettleAdd').show();"
                                />


                            <p:dialog 
                                id="dialogChannelPreSettle"
                                closable="true"
                                header="Choose Payment Method" 
                                widgetVar="dlgPreSettle" 
                                width="900"
                                height="200"
                                modal="true">
                                <div class="row">
                                    <p:spacer height="40px" />
                                    <div class="col-4">
                                        <p:commandButton 
                                            id="setBtn1"  
                                            class="ui-button-success mt-2 btn-lg" 
                                            icon="fa-solid fa-money-bill"
                                            value="Settle with Cash"
                                            style="height: 90px; width: 250px;"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtn1"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithCash}" 
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow' 
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}" 
                                            oncomplete="PF('dlgSettle').show();">
                                            <style>
                                                .fa-money-bill {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                    <div class="col-4">
                                        <p:commandButton 
                                            id="setBtn2"  
                                            class="ui-button-warning mt-2 btn-lg" 
                                            icon="fa-solid fa-credit-card"
                                            value="Settle With Card"
                                            style="height: 90px; width: 250px"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtn2"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithCard}" 
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow' 
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}" 
                                            oncomplete="PF('dlgSettle').show();">
                                            <style>
                                                .fa-credit-card {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                    <div class="col-4">
                                        <p:commandButton 
                                            id="setBtn3"  
                                            class="ui-button-danger mt-2 btn-lg"
                                            icon="fa-solid fa-file-invoice-dollar"
                                            value="Settle With Credit"
                                            style="height: 90px; width: 250px"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtn3"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithCredit}" 
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow' 
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}" 
                                            oncomplete="PF('dlgSettle').show();">
                                            <style>
                                                .fa-file-invoice-dollar {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                </div>
                            </p:dialog>

                            <p:dialog
                                id="dlgPreSettleAdd"
                                closable="true"
                                header="Choose Payment Method"
                                widgetVar="dlgPreSettleAdd"
                                width="900"
                                height="200"
                                modal="true">
                                <div class="row">
                                    <p:spacer height="40px" />
                                    <div class="col-4">
                                        <p:commandButton
                                            id="setBtna1"
                                            class="ui-button-success mt-2 btn-lg"
                                            icon="fa-solid fa-money-bill"
                                            value="Settle with Cash"
                                            style="height: 90px; width: 250px;"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtna1"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithCash}"
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}"
                                            oncomplete="PF('dlgSettle').show();">
                                            <style>
                                                .fa-money-bill {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                    <div class="col-4">
                                        <p:commandButton
                                            id="setBtna2"
                                            class="ui-button-warning mt-2 btn-lg"
                                            icon="fa-solid fa-credit-card"
                                            value="Settle With Card"
                                            style="height: 90px; width: 250px"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtna2"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithAddCard}"
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}"
                                            oncomplete="PF('dlgAdditionalCard').show();">
                                            <style>
                                                .fa-credit-card {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                    <div class="col-4">
                                        <p:commandButton
                                            id="setBtna3"
                                            class="ui-button-danger mt-2 btn-lg"
                                            icon="fa-solid fa-file-invoice-dollar"
                                            value="Settle With Credit"
                                            style="height: 90px; width: 250px"
                                            process="cmbSettlePs settleAgent2 settleAgRefTxt setBtna3"
                                            update="gpSettlePrint"
                                            action="#{channelBillController.settleCreditWithAddCredit}"
                                            disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                        or channelBillController.billSession.bill.cancelled==true
                                                        or  channelBillController.billSession.bill.paidAmount ne 0}"
                                            oncomplete="PF('dlgAdditionalCredit').show();">
                                            <style>
                                                .fa-file-invoice-dollar {
                                                    font-size: 25px !important;
                                                }
                                            </style>
                                        </p:commandButton>
                                    </div>
                                </div>
                            </p:dialog>

                            <p:dialog
                                id="dlgAdditionalCard"
                                closable="true"
                                header="Add Additional Details For Card Payment"
                                widgetVar="dlgAdditionalCard"
                                width="900"
                                height="200"
                                modal="true"
                                onShow="PF('dlgPreSettleAdd').hide();">
                                <div class="row">
                                    <h:panelGrid columns="3">
                                        <p:outputLabel id="creditCardbnkLbl" value="Select Bank" />
                                        <p:outputLabel value=":" />
                                        <p:selectOneMenu id="creditCardSlc" value="#{channelBillController.paymentMethodData.creditCard.institution}">
                                            <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                            <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                        </p:selectOneMenu>
                                        <p:outputLabel for="creditCardTxt" value="Card Ref. No"/>
                                        <p:outputLabel value=":" />
                                        <p:inputText id="creditCardTxt" autocomplete="off" value="#{channelBillController.paymentMethodData.creditCard.no}"/>
                                    </h:panelGrid>
                                    <p:commandButton
                                        id="setBtna4"
                                        class="ui-button-success mt-2 btn-lg"
                                        value="Settle"
                                        style="height: 90px; width: 250px"
                                        process="cmbSettlePs settleAgent2 settleAgRefTxt setBtna4"
                                        update="gpSettlePrint :#{p:resolveFirstComponentWithId('msg',view).clientId}"
                                        action="#{channelBillController.settleCredit()}"
                                        disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                    or channelBillController.billSession.bill.cancelled==true
                                                    or  channelBillController.billSession.bill.paidAmount ne 0}"
                                        oncomplete="PF('dlgSettle').show();">
                                    </p:commandButton>
                                </div>
                            </p:dialog>

                            <p:dialog
                                id="dlgAdditionalCredit"
                                closable="true"
                                header="Add Additional Credit Details"
                                widgetVar="dlgAdditionalCredit"
                                width="900"
                                height="200"
                                modal="true"
                                onShow="PF('dlgPreSettleAdd').hide();">
                                <div class="row">
                                    <h:panelGrid columns="3" class="my-2">
                                        <p:outputLabel id="staff" value="Staff" />
                                        <p:outputLabel value=":" />
                                        <au:completeStaffChannel value="#{channelBillController.toStaff}" />
                                        <p:outputLabel  value="Credit Company"/>
                                        <p:outputLabel value=":" />
                                        <p:autoComplete id="acCreditCompany" forceSelection="true" style="text-align: right;"
                                                        value="#{channelBillController.creditCompany}"
                                                        completeMethod="#{creditCompanyController.completeCredit}"
                                                        var="ix" itemLabel="#{ix.name}"
                                                        itemValue="#{ix}" size="30" >  
                                        </p:autoComplete>
                                    </h:panelGrid>
                                    <p:commandButton
                                        id="setBtna5"
                                        class="ui-button-success mt-2 btn-lg"
                                        value="Settle"
                                        style="height: 90px; width: 250px"
                                        process="cmbSettlePs settleAgent2 settleAgRefTxt setBtna5"
                                        update="gpSettlePrint :#{p:resolveFirstComponentWithId('msg',view).clientId}"
                                        action="#{channelBillController.settleCredit()}"
                                        disabled="#{channelBillController.billSession.bill.billType.parent ne 'ChannelCreditFlow'
                                                    or channelBillController.billSession.bill.cancelled==true
                                                    or  channelBillController.billSession.bill.paidAmount ne 0}"
                                        oncomplete="PF('dlgSettle').show();">
                                    </p:commandButton>
                                </div>
                            </p:dialog>

                            <h:panelGroup id="gpSettlePrint" >

                                <p:dialog 
                                    id="dialogChannelSettle"
                                    closable="true"
                                    header="Booked" 
                                    widgetVar="dlgSettle" 
                                    width="900"
                                    height="700"
                                    modal="true"
                                    onShow="PF('dlgPreSettle').hide();PF('dlgAdditionalCredit').hide();PF('dlgAdditionalCard').hide();">

                                    <div class="d-flex justify-content-between">
                                        <h1>#{channelBillController.errorInSettle}</h1>
                                        <p:commandButton
                                            class="ui-button-secondary mx-2"
                                            icon="fa-solid fa-arrow-left"
                                            action="#{bookingController.navigateBackToBookingsLoagingBillSessions()}"
                                            value="Back to Channel Booking"
                                            process="@this"
                                            update="@all">
                                        </p:commandButton>

                                        <div class="d-flex  gap-2">
                                            <p:outputLabel value="Paper Type" class="m-2"></p:outputLabel>
                                            <p:selectOneMenu 
                                                value="#{sessionController.departmentPreference.channelBillPaperType}" 

                                                style="width: 13em;">
                                                <f:selectItem itemLabel="Please Select Paper Type" />
                                                <f:selectItems value="#{enumController.paperTypes}" />
                                                <p:ajax event="itemSelect" process="@this" update="gpSettleBillPreview" />
                                            </p:selectOneMenu>
                                            <p:commandButton 
                                                id="btnRefresh"
                                                process="@this"
                                                update="gpSettleBillPreview"
                                                icon="fa fa-sync-alt" 
                                                class="ui-button" 
                                                title="Redraw Bill">
                                            </p:commandButton>
                                            <p:commandButton 
                                                value="Print" 
                                                ajax="false" 
                                                action="#" 
                                                class="ui-button-info"
                                                icon="fa fa-print"
                                                disabled="#{channelBillController.billSession.billItem.bill.balance ne 0.0}">
                                                <p:printer target="gpSettleBillPreview" ></p:printer>
                                            </p:commandButton>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-center mt-4">
                                        <h:panelGroup id="gpSettleBillPreview">
                                            <ui:repeat value="#{sessionController.departmentPreference.channellingBillCopiesList}" var="copy">
                                                <h:panelGroup rendered="#{sessionController.loggedPreference.channelBillPaperType eq 'PosPaper'}" >
                                                    <ez:bmsChannelBill  bill="#{channelBillController.billSession.billItem.bill}"/>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{sessionController.loggedPreference.channelBillPaperType eq 'FiveFivePaper'}" >
                                                    <ez:bms5x5ChannelBill bill="#{channelBillController.billSession.billItem.bill}"/> 
                <!--                                <bg:fiveFiveCCBill_CC bill="#{bookingController.printingBill}"/>  -->
                                                </h:panelGroup>
                                            </ui:repeat>
                                        </h:panelGroup>
                                    </div>
                                </p:dialog>
                            </h:panelGroup>

                        </p:panel>

                    </p:tab>


                    <p:tab 
                        title="Change Patient"
                        id="change" 
                        rendered="#{webUserController.hasPrivilege('ChannelBookingChange')}">
                        <p:panelGrid columns="2" class="w-100">
                            <f:facet name="header" >
                                <p:outputLabel value="Change Current Patient with a new Patient" ></p:outputLabel>
                                <p:commandButton ajax="false" value="Change Patient" action="#{bookingController.changePatient()}" ></p:commandButton>
                            </f:facet>
                            <p:panel header="Current Patient for Booking" >
                                <ezcommon:patient patient="#{bookingController.selectedBillSession.bill.patient}" ></ezcommon:patient>
                            </p:panel>
                            <ezcommon:patient_details controller="#{bookingController}" ></ezcommon:patient_details>
                        </p:panelGrid>
                    </p:tab>

                    <p:tab 
                        title="Change Appointment Details"
                        id="changeNumber" 
                        rendered="#{webUserController.hasPrivilege('ChannelBookingChange')}">

                        <h:panelGrid columns="2" class="my-2">
                            <p:outputLabel value="Patient Name"/>
                            <p:inputText autocomplete="off" 
                                         readonly="#{!webUserController.hasPrivilege('ClinicalPatientNameChange')}"
                                         value="#{bookingController.selectedBillSession.bill.patient.person.name}" />
                            <p:outputLabel value="Patient Phoone Number"/>
                            <p:inputText autocomplete="off" value="#{bookingController.selectedBillSession.bill.patient.person.phone}"  disabled="#{!webUserController.hasPrivilege('ClinicalPatientPhoneNumberEdit')}"/>
                            <p:outputLabel value="Current Appointment No"/>
                            <ui:repeat value="#{bookingController.selectedBillSession.bill.billItems}" var="bis" >
                                <p:outputLabel value="#{bis.billSession.serialNo}">                                        
                                </p:outputLabel>
                            </ui:repeat>
                            <p:outputLabel value="Appointment No"/>
                            <p:inputText autocomplete="off" value="#{bookingController.serealNo}">                                        
                            </p:inputText>
                        </h:panelGrid>
                        <h:panelGrid columns="6" class="my-2">
                            <p:commandButton ajax="false" value="Update Patient" action="#{bookingController.updatePatient}"
                                             disabled="#{bookingController.selectedBillSession.bill.cancelled==true
                                                         or bookingController.selectedBillSession.bill.refunded==true}" onclick="onSubmitButton();"/>

                            <p:commandButton ajax="false" value="Update Serial" action="#{bookingController.updateSerial()}"
                                             disabled="#{bookingController.selectedBillSession.bill.cancelled==true
                                                         or bookingController.selectedBillSession.bill.refunded==true}" />
                        </h:panelGrid>



                    </p:tab>

                    <p:tab title="Status" >
                        <p:outputLabel value="Mark As Present / Absent"/>
                        <p:selectBooleanButton onLabel="Absent" offLabel="Absent" disabled="#{channelBillController.billSession.bill.refunded==true
                                                                                              or channelBillController.billSession.bill.cancelled==true}"  value="#{bookingController.selectedBillSession.absent}" >
                            <p:ajax process="@this" listener="#{bookingController.updateSelectedBillSessionPatient()}" ></p:ajax>
                        </p:selectBooleanButton>

                    </p:tab>

                    <p:tab title="Search" rendered="false">

                        <p:calendar id="calFrom"  value="#{channelSearchController.fromDate}" pattern="dd MMMM yyyy" >   
                            <f:ajax event="dateSelect" execute="@this" render="bSessionSearch"/>
                        </p:calendar>
                        <p:calendar class="mx-2" id="calTo"  value="#{channelSearchController.toDate}" pattern="dd MMMM yyyy" >
                            <f:ajax event="dateSelect" execute="@this" render="bSessionSearch"/>
                        </p:calendar>

                        <p:inputText id="txtBsSearch" value="#{channelSearchController.txtSearch}" placeholder="ID" >
                        </p:inputText>

                        <p:commandButton id="btnBsSearch"
                                         class="ui-button-warning mx-2" icon="fas fa-search"
                                         value="Search" action="#{channelSearchController.searchForBillSessions}"
                                         ajax="false"
                                         process="txtBsSearch calFrom calTo btnBsSearch" 
                                         update="bSessionSearch">


                        </p:commandButton>

                        <p:dataTable id="bSessionSearch" value="#{channelSearchController.searchedBillSessions}" var='bs'
                                     filteredValue="#{channelSearchController.filteredbillSessions}">


                            <p:column headerText="Booking ID" filterBy="#{bs.bill.bookingId}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> #{bs.bill.bookingId}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="Speciality" filterBy="#{bs.serviceSession.staff.speciality.name}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}">#{bs.serviceSession.staff.speciality.name}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="Consultant" filterBy="#{bs.serviceSession.staff.person.nameWithTitle}" filterMatchMode="contains">

                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}">  #{bs.serviceSession.staff.person.nameWithTitle}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="Session Name" filterBy="#{bs.serviceSession.name}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}">  #{bs.serviceSession.name}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="No" filterBy="#{bs.serialNo}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> #{bs.serialNo}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}"  value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="Patient Name" filterBy="#{bs.bill.patient.person.nameWithTitle}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> #{bs.bill.patient.person.nameWithTitle}
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="Paid or Not" filterBy="#{bs.bill.billType}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> <p:outputLabel rendered="#{bs.bill.billType eq 'ChannelCredit'}" value="Credit" style="color: red;"/>
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> <p:outputLabel rendered="#{bs.bill.billType eq 'ChannelPaid'}" value="Paid"/>
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>
                            <p:column headerText="C/R" filterBy="#{bs.bill.billClass}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}">  <p:outputLabel value="Cancelled" rendered="#{bs.bill.cancelled==true}"/>
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}">  <p:outputLabel value="Refunded" rendered="#{bs.bill.refunded==true}"/>
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column>   
                            <p:column headerText="Agent" filterBy="#{bs.bill.fromInstitution.institutionCode}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> <p:outputLabel value="#{bs.bill.fromInstitution.institutionCode}"/>      
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column> 
                            <p:column headerText="Agent Ref No" filterBy="#{bs.billItem.agentRefNo}" filterMatchMode="contains">
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"><p:outputLabel value="#{bs.billItem.agentRefNo}"/>     
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column> 
                            <p:column headerText="P/A" filterBy="#{bs.absent}" filterMatchMode="contains">                                      
                                <h:commandLink action="channel_booking" actionListener="#{bookingController.resetToStartFromSpeciality}"> <p:outputLabel value="Absent"  rendered="#{bs.absent}"/>  
                                    <f:setPropertyActionListener target="#{bookingController.speciality}" value="#{bs.serviceSession.staff.speciality}"/>
                                    <f:setPropertyActionListener target="#{bookingController.staff}" value="#{bs.serviceSession.staff}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession}" value="#{bs.serviceSession}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedBillSession}" value="#{bs}"/>
                                    <f:setPropertyActionListener target="#{bookingController.selectedServiceSession.sessionAt}" value="#{bs.sessionDate}"/>
                                </h:commandLink>
                            </p:column> 
                        </p:dataTable> 
                    </p:tab>


                    <p:tab title="Views">
                        <h:panelGrid columns="2">
                            <p:panel header="Selected Session">
                                <h:panelGrid columns="1">
                                    <p:commandButton value="Nurse View " 
                                                     action="#{bookingController.navigateToNurseView}" 
                                                     onclick="onSubmitButton();" >                                       
                                    </p:commandButton>
                                    <p:commandButton value="Doctor View " action="#{bookingController.navigateToDoctorView}" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                    <p:commandButton value="Session View " action="#{bookingController.navigateToSessionView}" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                    <p:commandButton value="Phone View " action="#{bookingController.navigateToPhoneView}" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                    <p:commandButton value="User View " action="#{bookingController.navigateToUserView}" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                </h:panelGrid>

                            </p:panel>
                            <p:panel header="Today's">
                                <h:panelGrid columns="1">
                                    <p:commandButton value="All Patient" action="channel_patient_view_today" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                    <p:commandButton value="All Doctor" action="channel_doctor_view_today" ajax="false" onclick="onSubmitButton();">                                        
                                    </p:commandButton>
                                </h:panelGrid>                                    
                            </p:panel>
                        </h:panelGrid>

                    </p:tab>
                    <p:tab title="Doctor Payment">
                        <p:panel header="Selected Session">
                            <h:panelGrid columns="1">
                                <p:commandButton value="Pay Selected Doctor" action="#{bookingController.paySelectedDoctor}" 
                                                 ajax="false" onclick="onSubmitButton();" />                                        
                            </h:panelGrid>
                        </p:panel>
                    </p:tab>
                </p:tabView>
            </p:panel>

        </h:form>
    </ui:define>
</ui:composition>