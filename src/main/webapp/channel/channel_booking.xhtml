<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/resources/template/template.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ch="http://xmlns.jcp.org/jsf/composite/channel"
                xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
                xmlns:au="http://xmlns.jcp.org/jsf/composite/autocomplete"
                xmlns:pat="http://xmlns.jcp.org/jsf/composite/patient"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <ui:define name="content">
        <h:form id="form">
            <style >
                .fullHeightListbox,
                .fullHeightListbox .ui-selectlistbox-listcontainer,
                .fullHeightListbox * {
                    box-sizing: border-box;
                    margin: 0;
                    padding: 0;
                }

                .fullHeightListbox .ui-selectlistbox-listcontainer {
                    height: 80vh !important;
                }

                .ring-container {
                    position: relative;
                }

                .circle {
                    width: 10px;
                    height: 10px;
                    background-color: #62bd19;
                    border-radius: 50%;
                    position: absolute;
                    top: -5.3px;
                    left: 1.2px;
                }

                .ringring {
                    border: 3px solid #62bd19;
                    -webkit-border-radius: 20px;
                    height: 20px;
                    width: 20px;
                    top : -9.45px;
                    left: -4.10px;
                    position: absolute;
                    -webkit-animation: pulsate 1s ease-out;
                    -webkit-animation-iteration-count: infinite;
                    opacity: 0.0
                }
                @-webkit-keyframes pulsate {
                    0% {
                        -webkit-transform: scale(0.1, 0.1);
                        opacity: 0.0;
                    }
                    50% {
                        opacity: 1.0;
                    }
                    100% {
                        -webkit-transform: scale(1.2, 1.2);
                        opacity: 0.0;
                    }
                }
            </style>

            <p:panel class="my-2">
                <f:facet name="header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h:outputText styleClass="fa-solid fa-stethoscope"/>
                            <h:outputText class="mx-4" value="Channel Booking"/>
                        </div>

                        <div class="d-flex justify-content-center align-items-center">
                            <p:commandButton 
                                id="btnAddBooking"
                                ajax="false" 
                                value="To Add Booking" 
                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                icon="fas fa-plus"
                                class="ui-button-success"
                                actionListener="#{bookingController.makeNull()}"
                                disabled="#{bookingController.selectedSessionInstance.cancelled or bookingController.selectedSessionInstance.completed}"
                                action="#{bookingController.navigateToAddBooking()}"
                                />

                            <!-- View Session Data Button -->
                            <p:commandButton 
                                ajax="false" 
                                value="View Session Data"
                                icon="fas fa-eye"
                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                class="mx-1 ui-button-primary"
                                action="#{bookingController.navigateToViewSessionData()}"
                                />

                            <p:commandButton 
                                ajax="false" 
                                value="View Session"
                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                icon="fas fa-eye"
                                class="mx-1 ui-button-primary"
                                action="#{bookingControllerViewScope.navigateToManageSessionInstance(bookingController.selectedSessionInstance)}"
                                />

                            <p:commandButton 
                                ajax="false" 
                                id="manageBookingId"
                                value="Manage Booking"
                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                icon="fas fa-eye"
                                disabled="#{bookingController.selectedBillSession.id eq null}"
                                class="mx-1 ui-button-primary"
                                action="#{bookingControllerViewScope.navigateToManageBookingFromChannelBooking(bookingController.selectedBillSession, bookingController.selectedSessionInstance)}"

                                />

                            <p:commandButton 
                                ajax="false" 
                                value="Consulant Room"
                                icon="fas fa-eye"
                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                class=" ui-button-primary"
                                action="#{bookingController.navigateToViewSessionData()}"
                                />

                            <!-- Manage Booking Button -->
                            <p:commandButton 
                                ajax="false" 
                                value="Manage Booking" 
                                rendered="#{!configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                class="ui-button-warning mx-1"
                                action="#{bookingController.navigateToManageBooking()}"
                                icon="fa-solid fa-bars-progress" />

                            <p:commandButton 
                                ajax="false" 
                                value="Add Channel Booking" 
                                class="ui-button-warning mx-1"
                                action="#{bookingControllerViewScope.sessionInstanceFetchFromChannelBooking()}"
                                rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable channel booking by date navigations from channel booking view', false)}"
                                actionListener="#{bookingControllerViewScope.setSelectedSessionInstance(bookingController.selectedSessionInstance)}"
                                icon="fa-solid fa-bars-progress" />

                            <p:commandButton 
                                rendered="#{!bookingController.selectedSessionInstance.arrived}"
                                id="btnArrival"
                                ajax="false"
                                value="Mark Arrival " 
                                class="ui-button-info"
                                action="#{bookingController.markAsArrived()}"
                                icon="fa-solid fa-check" />
                            <p:commandButton 
                                rendered="#{bookingController.selectedSessionInstance.arrived}"
                                id="btnNotArrival"
                                ajax="false"
                                value="Mark Not Arrival " 
                                class="ui-button-info"
                                action="#{bookingController.markAsNotArrived()}"
                                icon="fa-solid fa-check" />

                            <p:commandButton value="Doctor Holiday" icon="pi pi-table"
                                             class="mx-1"
                                             rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable mark doctor holiday from channel view', false) and webUserController.hasPrivilege('ChannelSessionHolidayMark')}"
                                             oncomplete="PF('holidayMarkWidget').show()" 
                                             update="dialogContentForHolidayMark doctorNameForHoliday" />
                            <p:menuButton icon="fa-solid fa-sliders" rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Channel Management from channel Booking', false)}">
                                <p:menuitem value="Channel Schedule Management" rendered="#{webUserController.hasPrivilege('ChannelSheduleManagement')}" action="#{channelScheduleController.navigateSheduleManagementFromChannelBooking(bookingController.speciality, bookingController.staff, bookingController.selectedSessionInstance)}" ajax="false"  icon="fa fa-calendar-alt"/>
                                <p:menuitem value="Channel Session Management" rendered="#{webUserController.hasPrivilege('ChannelSessionManagement')}" action="#{channelScheduleController.navigateSessionManagementFromChannelBooking(bookingController.speciality, bookingController.staff, bookingController.selectedSessionInstance)}" ajax="false"   icon="fa fa-users"/> 
                                <p:menuitem value="Multiple Session Cancellation" rendered="#{configOptionApplicationController.getBooleanValueByKey('Enable Multiple Session Cancellation in Channel Booking', false) and webUserController.hasPrivilege('ChannelSessionMultipleDeletion')}" oncomplete="PF('sessionCancellationWidget').show()"  update="dialogContentForCancellation doctorNameForHoliday"   icon="fa-solid fa-trash"/> 
                            </p:menuButton>

                        </div>
                    </div>

                    <p:growl id="growl" showDetail="false" life="900"/>

                    <p:confirmDialog id="cancelDialog"
                                     widgetVar="cancelDialog"
                                     header="Confirmation"
                                     message="Are you sure you want to cancel the selected sessions?"
                                     severity="warn"
                                     showEffect="fade"
                                     hideEffect="fade"
                                     responsive="true">

                        <p:commandButton value="Yes"
                                         icon="pi pi-check"
                                         update="dialogContentForCancellation growl"
                                         oncomplete="PF('cancelDialog').hide();"
                                         action="#{bookingControllerViewScope.multipleSessionCancellation(bookingController.sessionsForCancellation, true)}"
                                         process="@this"
                                         />

                        <p:commandButton value="No"
                                         icon="pi pi-times"
                                         onclick="PF('cancelDialog').hide(); return false;"
                                         type="button"
                                         styleClass="ui-button-secondary" />
                    </p:confirmDialog>

                    <p:dialog 
                        widgetVar="sessionCancellationWidget" 
                        modal="true" 
                        id="multipleCancellation"
                        resizable="false" 
                        draggable="true" 
                        height="600"
                        width="800">

                        <p:ajax event="close" update="acSessions"></p:ajax>

                        <f:facet name="header">
                            <h:outputText id="doctorNameCancellation" value="Sessions of #{bookingController.staff.person.nameWithTitle}" ></h:outputText>
                            <p:commandButton class="mx-3" value="Cancel"  onclick="PF('cancelDialog').show();"  icon="fa-solid fa-check" update="growl dialogContentForCancellation"></p:commandButton>
                            <p:commandButton value="Re-Open" action="#{bookingControllerViewScope.multipleSessionCancellation(bookingController.sessionsForCancellation, false)}" update="growl dialogContentForCancellation" icon="fa-solid fa-xmark"></p:commandButton>

                        </f:facet>

                        <h:panelGroup id="dialogContentForCancellation">
                            <p:dataTable value="#{bookingController.sessionInstances}" 
                                         var="s" 
                                         selection="#{bookingController.sessionsForCancellation}"
                                         selectionMode="multiple" 
                                         rowKey="#{s.id}">

                                <p:column selectionBox="true" width="20"></p:column>
                                <p:column width="10em" headerText="Name">
                                    <f:facet name="header" >
                                        <h:outputText value="Name" ></h:outputText>
                                    </f:facet>
                                    <div class="d-flex align-items-center gap-2">
                                        <h:outputText value="#{s.name}" />
                                        <h:outputText class="mx-1" style="font-weight: bold; color: red; border: 3px solid #fbc531; border-radius: 10px; padding: 4px 8px" value="Holiday" rendered="#{s.doctorHoliday}"/>
                                        <h:outputText class="mx-1" style="font-weight: bold; color: red; padding: 4px 8px" value="Cancelled" rendered="#{s.cancelled}"/>
                                    </div>


                                </p:column>
                                <p:column headerText="Date" style="width: 50px!important; text-align: center;">
                                    <h:outputText value="#{s.sessionDate}">
                                        <f:convertDateTime pattern="dd MMM"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Start" style="width: 40px!important; text-align: center;">
                                    <h:outputText value="#{s.startingTime}">
                                        <f:convertDateTime pattern="hh:mm a"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Max" style="width: 20px!important; text-align: center;">
                                    <h:outputText value="#{s.maxNo}" rendered="#{s.maxNo ne 0}">
                                        <f:convertNumber pattern="00" />
                                    </h:outputText>
                                </p:column>
                            </p:dataTable>
                        </h:panelGroup>
                    </p:dialog>

                    <p:dialog 
                        widgetVar="holidayMarkWidget" 
                        modal="true" 
                        id="holidayMarkDialog"
                        resizable="false" 
                        draggable="true" 
                        height="600"
                        width="800">

                        <p:ajax event="close" update="acSessions"></p:ajax>

                        <f:facet name="header">
                            <h:outputText id="doctorNameForHoliday" value="Sessions of #{bookingController.staff.person.nameWithTitle}" ></h:outputText>
                            <p:commandButton class="mx-3" value="Mark" action="#{bookingController.markHolidayForSessionInstances(true)}" icon="fa-solid fa-check" update="dialogContentForHolidayMark growl"></p:commandButton>
                            <p:commandButton value="Unmark" action="#{bookingController.markHolidayForSessionInstances(false)}" update="dialogContentForHolidayMark growl" icon="fa-solid fa-xmark"></p:commandButton>

                        </f:facet>


                        <h:panelGroup id="dialogContentForHolidayMark">
                            <p:dataTable value="#{bookingController.sessionInstances}" 
                                         var="s" 
                                         selection="#{bookingController.sessionsForHolidayMark}"
                                         selectionMode="multiple" 
                                         rowKey="#{s.id}">

                                <p:column selectionBox="true" width="20"></p:column>
                                <p:column width="10em" headerText="Name">
                                    <f:facet name="header" >
                                        <h:outputText value="Name" ></h:outputText>
                                    </f:facet>
                                    <div class="d-flex align-items-center gap-2">
                                        <h:outputText value="#{s.name}" />
                                        <h:outputText class="mx-1" style="font-weight: bold; color: red; border: 3px solid #fbc531; border-radius: 10px; padding: 4px 8px" value="Holiday" rendered="#{s.doctorHoliday}"/>
                                        <h:outputText class="mx-1" style="font-weight: bold; color: red; padding: 4px 8px" value="Cancelled" rendered="#{s.cancelled}"/>
                                    </div>


                                </p:column>
                                <p:column headerText="Date" style="width: 50px!important; text-align: center;">
                                    <h:outputText value="#{s.sessionDate}">
                                        <f:convertDateTime pattern="dd MMM"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Start" style="width: 40px!important; text-align: center;">
                                    <h:outputText value="#{s.startingTime}">
                                        <f:convertDateTime pattern="hh:mm a"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="Max" style="width: 20px!important; text-align: center;">
                                    <h:outputText value="#{s.maxNo}" rendered="#{s.maxNo ne 0}">
                                        <f:convertNumber pattern="00" />
                                    </h:outputText>
                                </p:column>
                            </p:dataTable>
                        </h:panelGroup>
                    </p:dialog>
                </f:facet>
                <div class="row">
                    <div class="col-2">
                        <div >
                            <div>

                                <p:selectOneListbox 
                                    id="acSpeciality"
                                    filter="true"
                                    value="#{bookingController.speciality}"
                                    class="w-100 fullHeightListbox"
                                    >
                                    <p:ajax
                                        event="change"
                                        process="@this" 
                                        update="acBookings scStaff acSessions pnlArrived moreInfo"
                                        listener="#{bookingController.listnerStaffListForRowSelect}"/> 
                                    <p:ajax
                                        event="click"
                                        process="@this" 
                                        update="acBookings scStaff acSessions pnlArrived moreInfo"
                                        listener="#{bookingController.listnerStaffListForRowSelect}"/> 

                                    <f:selectItem itemLabel="All" ></f:selectItem>
                                    <f:selectItems 
                                        value="#{doctorSpecialityController.selectedItems}"
                                        var="spe" 
                                        itemValue="#{spe}"
                                        itemLabel="#{spe.name}">
                                    </f:selectItems>
                                </p:selectOneListbox>
                            </div>

                        </div>
                    </div>

                    <div class="col-2">
                        <div>

                            <p:selectOneListbox 
                                id="scStaff"
                                filter="true"
                                filterMatchMode="contains"
                                value="#{bookingController.staff}"
                                class="w-100 fullHeightListbox"
                                >
                                <p:ajax  
                                    event="change"
                                    process="@this" 
                                    update=":#{p:resolveFirstComponentWithId('acSessions',view).clientId} #{p:resolveFirstComponentWithId('acBookings',view).clientId} moreInfo"  
                                    listener="#{bookingController.generateSessions}"/>

                                <p:ajax  
                                    event="click"
                                    process="@this" 
                                    update=":#{p:resolveFirstComponentWithId('acSessions',view).clientId} #{p:resolveFirstComponentWithId('acBookings',view).clientId} moreInfo"  
                                    listener="#{bookingController.generateSessions}"/>

                                <f:selectItems value="#{bookingController.consultants}"
                                               var="con" 
                                               itemValue="#{con}"
                                               itemLabel="#{con.name}">
                                </f:selectItems>
                            </p:selectOneListbox>
                        </div>
                    </div>

                    <div class="col-md-4 p-0"  >

                        <p:selectOneListbox 
                            id="acSessions"
                            filter="true"
                            filterMatchMode="contains"
                            value="#{bookingController.selectedSessionInstance}" 
                            class="w-100 fullHeightListbox"
                            var="s">

                            <f:selectItems 
                                value="#{bookingController.sessionInstances}" 
                                var="ses" 
                                itemValue="#{ses}"
                                itemLabel="#{ses.name}">
                            </f:selectItems>

                            <p:column headerText="Name">
                                <f:facet name="header" >
                                    <h:outputText value="Name" ></h:outputText>
                                </f:facet>
                                <div class="d-flex align-items-center gap-2">
                                    <h:outputText id="name" value="#{s.name}" />
                                    <p:tag severity="warning" value="Scanning" rendered="#{s.originatingSession.category eq 'Scanning'}"></p:tag>
                                    <h:outputText class="mx-1" style="font-weight: bold; color: red; border: 3px solid #fbc531; border-radius: 10px; padding: 4px 8px" value="Holiday" rendered="#{s.doctorHoliday}"/>

                                </div>
                            </p:column>

                            <p:column headerText="Date" style="width: 50px!important; text-align: center;">
                                <h:outputText value="#{s.sessionDate}">
                                    <f:convertDateTime pattern="dd MMM"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Start" style="width: 70px!important; text-align: left;">
                                <h:outputText value="#{s.startingTime}">
                                    <f:convertDateTime pattern="hh:mm a"/>
                                </h:outputText>
                            </p:column>

                            <p:column rendered="#{configOptionApplicationController.getBooleanValueByKey('Channel Booked Details on Channel Booking')}" headerText="Booked" style="width: 20px!important; text-align: center;">
                                <h:outputText value="#{s.bookedPatientCount}" rendered="#{s.bookedPatientCount ne null}">
                                    <f:convertNumber pattern="00" />
                                </h:outputText>
                                <h:outputText value="&nbsp;"></h:outputText>
                                <h:outputText value="(" class="text-success" rendered="#{s.bookedPatientCount ne null}"></h:outputText>
                                <h:outputText value="#{s.paidPatientCount}"  class="text-success" rendered="#{s.bookedPatientCount ne null}">
                                    <f:convertNumber pattern="00" />
                                </h:outputText>
                                <h:outputText value=")"  class="text-success" rendered="#{s.bookedPatientCount ne null}"></h:outputText>
                            </p:column>
                            <p:column headerText="Fee" style="width: 40px!important; text-align: center;">
                                <h:outputText value="#{s.originatingSession.total}">
                                    <f:convertNumber pattern="#,##0" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Status" style="width: 40px!important; text-align: center;">
                                <p:badge value="Cancelled" severity="danger" style="width: 60px;" rendered="#{s.cancelled}"></p:badge>
                                <p:badge class="px-1" value="Arrived" severity="info" rendered="#{s.arrived and !s.started}"/>
                                <p:badge class="px-1" value="On Going" severity="warning" rendered="#{s.started and !s.completed}"/>
                                <p:badge class="px-1" value="Completed" severity="success" rendered="#{s.completed}"/>
                            </p:column>

                            <p:ajax 
                                event="change" 
                                process="@this"
                                update="pnlArrived acBookings acSessions btnAddBooking manageBookingId moreInfo"
                                listener="#{bookingController.fillBillSessions}" />

                            <p:ajax 
                                event="click" 
                                process="@this"
                                update="pnlArrived acBookings acSessions btnAddBooking manageBookingId moreInfo"
                                listener="#{bookingController.fillBillSessions}" />
                            
                        </p:selectOneListbox>
                    </div>

                    <div class="col-4" >
                        <p:accordionPanel multiple="true" 
                                          id="moreInfo"
                                          rendered="#{not empty bookingController.selectedSessionInstance}"
                                          style="width:100%;">

                            <p:tab title="More Info">
                                <h:panelGrid columns="3" cellpadding="5">
                                    <h:outputText value="Institution" />
                                    <h:outputText value=":" />
                                    <h:outputText value="#{bookingController.selectedSessionInstance.institution.name} " />

                                    <h:outputText value="Max No " />
                                    <h:outputText value=":" />
                                    <h:outputText value="#{bookingController.selectedSessionInstance.maxNo} " />

                                    <h:outputText value="Room No " />
                                    <h:outputText value=":" />
                                    <h:outputText value="#{bookingController.selectedSessionInstance.roomNo} " rendered="#{bookingController.selectedSessionInstance.roomNo ne 0}"/>
                                    <h:outputText value="Not Specified Yet " rendered="#{bookingController.selectedSessionInstance.roomNo eq 0}"/>

                                    <h:outputText value="End Time" />
                                    <h:outputText value=":" />
                                    <h:outputText value="#{bookingController.selectedSessionInstance.endingTime}">
                                        <f:convertDateTime pattern="hh:mm a"/>
                                    </h:outputText>
                                    
                                    <h:outputText value="Booked Patient Count " />
                                    <h:outputText value=":" />
                                    <h:outputText value="#{bookingController.selectedSessionInstance.bookedPatientCount != null ? bookingController.selectedSessionInstance.bookedPatientCount : ' '}" />
                                    

                                    <h:outputText value="Note " rendered="#{not empty bookingController.selectedSessionInstance.specialNoticeSessionInstance or not empty bookingController.selectedSessionInstance.originatingSession.specialNotice}" />
                                    <h:outputText value=":" rendered="#{not empty bookingController.selectedSessionInstance.specialNoticeSessionInstance or not empty bookingController.selectedSessionInstance.originatingSession.specialNotice}"/>
                                    <h:outputText value="#{bookingController.selectedSessionInstance.specialNoticeSessionInstance} | #{bookingController.selectedSessionInstance.originatingSession.specialNotice}" 
                                                  rendered="#{not empty bookingController.selectedSessionInstance.specialNoticeSessionInstance or not empty bookingController.selectedSessionInstance.originatingSession.specialNotice}" style="color: red"/>
                                </h:panelGrid>
                            </p:tab>
                        </p:accordionPanel>

                        <p:selectOneListbox
                            id="acBookings" 
                            value="#{bookingController.selectedBillSession}" 
                            filter="true"
                            filterMatchMode="contains"
                            var="bs"
                            class="w-100 fullHeightListbox">

                            <f:selectItems value="#{bookingController.billSessions}" var="item" itemValue="#{item}" itemLabel="#{item.bill.patient.person.nameWithTitle}" />
                            <p:ajax process="acBookings" update="test manageBookingId"></p:ajax>

                            <p:column style="width: 5px!important;">
                                <h:outputText value="#{bs.serialNo}" style="font-weight: bold"/>
                            </p:column>

                            <p:column style="width: 50px!important;">
                                <h:outputText rendered="#{bs.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}" value="#{bs.bill.patient.person.nameWithTitle}" style="font-weight: bold"/>
                                <h:outputText rendered="#{bs.bill.billTypeAtomic eq 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}" value="#{bs.bill.referenceBill.onlineBooking.title}. #{bs.bill.referenceBill.onlineBooking.patientName}" style="font-weight: bold"/>
                            </p:column>

                            <p:column style="width: 20px!important;" rendered="#{bookingController.selectedSessionInstance.started}">
                                <p:tag class="mr-2" style="font-size: 0.8rem" severity="success" value="Completed" rendered="#{bs.completed}"/>
                                <p:tag class="mr-2" style="font-size: 0.8rem" severity="warning" value="OnGoing" rendered="#{bs.currentlyConsulted}"/>
                                <p:tag class="mr-2" style="font-size: 0.8rem" severity="danger" value="Next" rendered="#{bs.nextInLine}"/>
                            </p:column>

                            <p:column style="width: 20px!important;">
<!--                                <p:outputLabel class="badge badge-light" value="Credit" rendered="#{!bs.bill.billPaymentCompletelySettled}" style="color: red;"/>
                                <p:outputLabel value="-On Call" rendered="#{!bs.bill.billPaymentCompletelySettled and bs.bill.paymentMethod eq 'OnCall'}" style="color: red;"/>

                                <p:outputLabel value="Paid" rendered="#{bs.bill.billPaymentCompletelySettled}" style="color: green;"/>-->
                                <p:outputLabel value="OnCall - " rendered="#{bs.bill.paymentMethod eq 'OnCall'}" style="margin-left: 5px; color: green; font-weight: bold"/>
                                <p:outputLabel value="Card " rendered="#{bs.bill.paymentMethod eq 'Card' or bs.bill.paidBill.paymentMethod eq 'Card'}" style="color: green; font-weight: bold"/>
                                <p:outputLabel value="Cash " rendered="#{bs.bill.paymentMethod eq 'Cash' or bs.bill.paidBill.paymentMethod eq 'Cash'}" style="color: green; font-weight: bold"/>
                                <p:outputLabel value="MultiplePayments" rendered="#{bs.bill.paymentMethod eq 'MultiplePaymentMethods' or bs.bill.paidBill.paymentMethod eq 'MultiplePaymentMethods'}" style="color: green; font-weight: bold"/>
                                <p:outputLabel value="Agent " rendered="#{bs.bill.paidAmount ne 0 and bs.bill.paidBill.paymentMethod eq 'Agent' and bs.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}" style="color: green; font-weight: bold"/>
                                <p:outputLabel value="Staff " rendered="#{bs.bill.paymentMethod eq 'Staff'}" style="color: green;"/>
                                <p:outputLabel value="OB - #{bs.bill.referenceBill.onlineBooking.referenceNo}" rendered="#{bs.bill.billTypeAtomic eq 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}" style="color: #000; background: #fbc531; font-weight: bold; padding: 2px"/>


<!--<p:outputLabel value="Paid OnCall-Card" rendered="#{bs.bill.paidAmount ne 0 and bs.bill.paymentMethod eq 'OnCall' and bs.bill.paidBill.paymentMethod eq 'Card'}"/>-->
<!--<p:outputLabel value="-Staff" rendered="#{bs.bill.paidAmount ne 0 and bs.bill.paymentMethod eq 'Staff'}"/>-->

                            </p:column>

                            <p:column style="width: 10px!important;">
                                <p:tag class="mr-2" style="font-size: 1.03rem" severity="danger" value="Cancelled" rendered="#{bs.bill.cancelled==true}" rounded="true"/>
                                <p:tag class="mr-2" style="font-size: 1.03rem" severity="warning" value="Refunded" rendered="#{bs.bill.refunded==true}" rounded="true"/>
                                <p:tag class="mr-2" style="font-size: 1.03rem" severity="danger" value="Rescheduled" rendered="#{bs.recheduledSession}" rounded="true"/>
                            </p:column>

                            <p:column style="width: 5px!important;">
                                <p:outputLabel rendered="#{bs.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT' and bs.bill.billType eq 'ChannelAgent'}" value="Ref-#{bs.bill.agentRefNo}" title="Agent - #{bs.bill.creditCompany.name}" style="font-weight: bold"/>
                                <p:outputLabel rendered="#{bs.bill.billTypeAtomic ne 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT' and bs.bill.billType ne 'ChannelAgent'}" value="System Booking" style="font-weight: bold"/>
                                <p:outputLabel rendered="#{bs.bill.billTypeAtomic eq 'CHANNEL_BOOKING_FOR_PAYMENT_ONLINE_COMPLETED_PAYMENT'}" value="#{bs.bill.referenceBill.onlineBooking.agency.name}" style="font-weight: bold"/>
                            </p:column>

                            <p:column style="width: 10px!important;">
                                <p:outputLabel value="Absent" rendered="#{bs.absent}" style='color:red; font-weight: bold'/>
                            </p:column>

                            <p:column style="width: 10px!important;">
                                <h:panelGroup rendered="#{bs.markedToCancel}">
                                    <i class="fas fa-ban text-danger"></i>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{bs.markedToRefund}">
                                    <i class="fas fa-undo-alt  text-danger"></i>
                                </h:panelGroup>
                            </p:column>

                        </p:selectOneListbox>

                        <div id="global-notification" style="position: fixed; top: 100px; right: 1000px; z-index: 9999; display: none; padding: 10px 20px; background-color: #28a745; color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); ">
                            Online booking received!
                        </div>

                        <script>

                            function initializeWebSocket() {
                                console.log("start connection");
                                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
                                const pathName = window.location.pathname;
                                const contextPath = pathName.split('/')[1];
                                const wsUrl = protocol + "//" + window.location.host + "/" + contextPath + "/ws/notify";

                                let socket = new WebSocket(wsUrl);

                                return socket;
                            }

                            const socket = initializeWebSocket();

                            socket.onmessage = function (event) {

                                try {
                                    const message = event.data;
                                    const messageParts = message.split(" - ");
                                    const sendSessionId = messageParts[1];
                                    const sendMessage = messageParts[0];

                                    if (sendMessage === "Online Booking Completed" || sendMessage === "Online Booking Cancelled") {
                                        const selectedSessionId = '#{bookingController.selectedSessionInstance.id}';

                                        if (selectedSessionId == sendSessionId) {
                                            document.querySelector('.ws-trigger').click();
                                        }

                                        if (sendMessage === "Online Booking Completed") {
                                            const notify = document.getElementById('global-notification');
                                            notify.style.display = 'block';
                                            setTimeout(() => {
                                                notify.style.display = 'none';
                                                notify.style.transition = 'all 0.6s ease';
                                            }, 3000);
                                        }

                                    }
                                } catch (e) {
                                    console.error("Error in WebSocket onmessage:", error);
                                }
                            }

                            socket.onclose = function (event) {
                                console.log("Web socket connection is closed.");

                                setTimeout(initializeWebSocket, 2000);
                            }

                            socket.onerror = function (event) {
                                console.log("Web socket connection error occured.");

                            }

                            socket.onopen = function (event) {
                                console.log("Web socket is connected.");

                            }
                        </script>

                        <p:commandButton id="ws"
                                         action="#{bookingController.fillBillSessions}"
                                         process="@this"
                                         styleClass="ws-trigger"
                                         update="acBookings "
                                         style="display:none"/>
                        <p:poll interval="15" update="acBookings" listener="#{bookingController.fillBillSessions}"></p:poll>
                    </div>
                </div>


            </p:panel>


        </h:form>
    </ui:define>
</ui:composition>