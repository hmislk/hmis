<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/patient_deposit/index.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:common="http://xmlns.jcp.org/jsf/composite/ezcomp/common">

    <ui:define name="subcontent">
        <h:form id="frmPatientSpecificReport">
            <p:panel header="Patient Deposit Balance Report - By Patient" styleClass="w-100">

                <div class="row">
                    <div class="col-md-6">
                        <!-- Patient Search Panel -->
                        <p:panel id="ptSearch">
                            <f:facet name="header">
                                <h:panelGroup layout="block" styleClass="d-flex justify-content-between align-items-center">
                                    <!-- Left aligned content -->
                                    <h:panelGroup id="headerFacet">
                                        <h:outputText value="Select a Patient" rendered="#{patientController.patient eq null}"/>
                                        <h:outputText styleClass="fas fa-user mx-2" />
                                        <h:outputText
                                            rendered="#{patientController.patient.id ne null}"
                                            value="Selected Patient Details"
                                            class="mx-2"/>
                                    </h:panelGroup>

                                    <!-- Right aligned quick search -->
                                    <h:panelGroup id="quickSearch">
                                        <h:panelGroup rendered="true" layout="block" styleClass="form-inline">
                                            <p:focus for="txtQuickSearchPhoneNumber" />
                                            <p:inputText
                                                autocomplete="off"
                                                id="txtQuickSearchPhoneNumber"
                                                value="#{patientController.searchPatientPhoneNumber}"
                                                placeholder="Phone Number"
                                                class="form-control-sm mx-1"
                                                onfocus="this.select()"/>
                                            <p:commandButton
                                                id="btnSearchbyPhoneNo"
                                                icon="fa fa-search"
                                                title="Quick Search from Phone Number"
                                                actionListener="#{patientController.searchByPatientPhoneNumber()}"
                                                process="@this txtQuickSearchPhoneNumber"
                                                update="ptSearch"
                                                styleClass="btn-sm mx-1">
                                            </p:commandButton>
                                            <p:defaultCommand target="btnSearchbyPhoneNo"> </p:defaultCommand>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </h:panelGroup>
                            </f:facet>

                            <h:panelGroup id="selectPatient">
                                <h:panelGroup rendered="#{patientController.searchedPatients ne null and not empty patientController.searchedPatients}">
                                    <p:dataTable id="tblPatients" value="#{patientController.searchedPatients}" var="ps">
                                        <p:column headerText="Name">
                                            #{ps.person.name}
                                        </p:column>
                                        <p:column headerText="MRN">
                                            #{ps.phn}
                                        </p:column>
                                        <p:column headerText="Phone Number">
                                            #{ps.person.phone}
                                        </p:column>
                                        <p:column headerText="Mobile Number">
                                            #{ps.person.mobile}
                                        </p:column>
                                        <p:column>
                                            <p:commandButton
                                                id="btnSelectPt"
                                                process="@this"
                                                update=":frmPatientSpecificReport:ptSearch"
                                                value="Select">
                                                <f:setPropertyActionListener value="#{ps}" target="#{patientController.patient}" />
                                                <f:setPropertyActionListener value="#{null}" target="#{patientController.searchedPatients}" />
                                            </p:commandButton>
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGroup>
                            </h:panelGroup>

                            <h:panelGroup id="patientDisplay">
                                <h:panelGroup rendered="#{patientController.patient ne null and (patientController.searchedPatients eq null or empty patientController.searchedPatients)}">
                                    <h:panelGrid columns="3" class="my-1" id="panelPatientDisplay">
                                        <h:outputLabel value="Name" class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.person.nameWithTitle}" />

                                        <h:outputLabel value="MRN" class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.phn}" />

                                        <h:outputLabel value="Gender" class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.person.sex}" />

                                        <h:outputLabel value="Age" class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.person.ageAsString}" />

                                        <h:outputLabel value="Mobile No." class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.person.mobile}" />

                                        <h:outputLabel value="Phone No." class="mx-3"/>
                                        <h:outputLabel value=":" class="mx-3"/>
                                        <h:outputText value="#{patientController.patient.person.phone}" />
                                    </h:panelGrid>
                                </h:panelGroup>
                            </h:panelGroup>
                        </p:panel>
                    </div>

                    <div class="col-md-6">
                        <!-- Filter and Action Buttons Panel -->
                        <p:panel header="Report Settings">
                            <h:panelGroup layout="block" styleClass="container-fluid">
                                <!-- Date Filter -->
                                <h:panelGroup layout="block" styleClass="row mb-3">
                                    <h:panelGroup layout="block" styleClass="col-12">
                                        <h:panelGroup layout="block" styleClass="form-group">
                                            <h:outputLabel value="Report Date" styleClass="mb-1 d-block"/>
                                            <p:datePicker id="reportDate"
                                                          value="#{patientSpecificDepositBalanceReportController.reportDate}"
                                                          showTime="false"
                                                          pattern="#{sessionController.applicationPreference.longDateFormat}"
                                                          styleClass="w-100"/>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </h:panelGroup>

                                <!-- Action Buttons -->
                                <h:panelGroup layout="block" styleClass="row mt-3">
                                    <h:panelGroup layout="block" styleClass="col-12">
                                        <p:commandButton value="Process"
                                                         icon="fas fa-cogs"
                                                         actionListener="#{patientSpecificDepositBalanceReportController.processPatientDepositBalanceReport()}"
                                                         process="@form"
                                                         update="tblResults"
                                                         styleClass="ui-button-warning mr-2"/>
                                        <p:commandButton value="Clear"
                                                         icon="fas fa-eraser"
                                                         action="#{patientSpecificDepositBalanceReportController.clearPatientDepositBalanceReport()}"
                                                         update="@form"
                                                         styleClass="ui-button-secondary mr-2"/>
                                        <p:commandButton value="Print"
                                                         icon="fas fa-print"
                                                         styleClass="ui-button-info mr-2">
                                            <p:printer target="tblResults"/>
                                        </p:commandButton>
                                        <p:commandButton value="Excel"
                                                         icon="fas fa-file-excel"
                                                         ajax="false"
                                                         styleClass="ui-button-success">
                                            <p:dataExporter type="xlsx"
                                                            target="tblResults"
                                                            fileName="Patient_Deposit_Balance_#{patientController.patient.phn}"/>
                                        </p:commandButton>
                                    </h:panelGroup>
                                </h:panelGroup>
                            </h:panelGroup>
                        </p:panel>
                    </div>
                </div>

                <!-- Results DataTable -->
                <p:dataTable id="tblResults"
                             value="#{patientSpecificDepositBalanceReportController.patientDepositBalanceDtos}"
                             var="dto"
                             paginator="true"
                             rows="20"
                             paginatorPosition="bottom"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="10,20,50,100"
                             currentPageReportTemplate="Showing {startRecord} to {endRecord} of {totalRecords} entries"
                             sortMode="multiple"
                             reflow="true"
                             emptyMessage="No records found. Please select a patient and click Process."
                             styleClass="mt-3">

                    <f:facet name="header">
                        <h:panelGroup layout="block">
                            <h:outputText value="Patient Deposit Balance Report - "/>
                            <h:outputText value="#{patientController.patient.person.nameWithTitle}" rendered="#{patientController.patient ne null}"/>
                            <br/>
                            <h:outputText value="MRN: "/>
                            <h:outputText value="#{patientController.patient.phn}" rendered="#{patientController.patient ne null}"/>
                            <br/>
                            <h:outputText value="As of: "/>
                            <h:outputText value="#{patientSpecificDepositBalanceReportController.reportDate}">
                                <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}"/>
                            </h:outputText>
                        </h:panelGroup>
                    </f:facet>

                    <p:column headerText="Institution" sortBy="#{dto.institutionName}" filterBy="#{dto.institutionName}" filterMatchMode="contains">
                        <h:outputText value="#{dto.institutionName}"/>
                    </p:column>

                    <p:column headerText="Site" sortBy="#{dto.siteName}" filterBy="#{dto.siteName}" filterMatchMode="contains">
                        <h:outputText value="#{dto.siteName}"/>
                    </p:column>

                    <p:column headerText="Department" sortBy="#{dto.departmentName}" filterBy="#{dto.departmentName}" filterMatchMode="contains">
                        <h:outputText value="#{dto.departmentName}"/>
                    </p:column>

                    <p:column headerText="Balance" sortBy="#{dto.balance}">
                        <h:outputText value="#{dto.balance}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>
                        <f:facet name="footer">
                            <h:outputText value="#{patientSpecificDepositBalanceReportController.totalBalance}" style="font-weight: bold;">
                                <f:convertNumber pattern="#,##0.00"/>
                            </h:outputText>
                        </f:facet>
                    </p:column>

                </p:dataTable>
            </p:panel>
        </h:form>
    </ui:define>

</ui:composition>
