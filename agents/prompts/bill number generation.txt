The deptId and insId generation is currently been updated to a year based number. Yet, some implemented hospitals needs to continue the old legacy method to generate bill number. In the following buttons in the given pages, we have to check weather the new year based bill number generation by passing the BillTypeAtomic and Logged Department is already implemented. If implemented, we can simply skip. If not implemented, we have to have a configuration option with default = false for each bill type. If that configuration is updated as true, a new deptId (and hense the same is used for insId) have to be generated by yearly number. (Refer to the sample before and after)

Task to do
Create a task list
Study the Sample code before and after update

For each page given do the following

Identify Page
Identify Settle Button
Identify the backend method for Settle button
Identify the methods called from the Settle Method
Identify the place where deptId and insId generated
Identify the BillTypeAtomic used in the saving bill
Check bill number yearly is already implemented
If implemented, skip that page.
If not create configuration option with default as false
add new bill number generation method by passing the logged department and bill type atomic

Add a document to wiki folder with bill number configuration details

Paged to add this functionality
https://qa.carecode.org/qa1/faces/pharmacy/pharmacy_bill_retail_sale_for_cashier.xhtml - Pharmacy Retail Sale for Cashier to Collect Payments
https://qa.carecode.org/qa1/faces/pharmacy/direct_purchase.xhtml - Direct Purchase
https://qa.carecode.org/qa1/faces/pharmacy/pharmacy_purhcase_order_request.xhtml - Purchase Order Request



THis is an example how I improved the bill number generation

Page: https://qa.carecode.org/qa1/faces/pharmacy/pharmacy_bill_retail_sale.xhtml
Button: Settle

Previous method that created deptId and insId


    private void savePreBillFinallyForRetailSale(Patient pt) {
        if (getPreBill().getId() == null) {
            getBillFacade().create(getPreBill());
        }
        getPreBill().setDepartment(getSessionController().getLoggedUser().getDepartment());
        getPreBill().setInstitution(getSessionController().getLoggedUser().getDepartment().getInstitution());

        getPreBill().setCreatedAt(Calendar.getInstance().getTime());
        getPreBill().setCreater(getSessionController().getLoggedUser());

        getPreBill().setPatient(pt);
//        getPreBill().setMembershipScheme(membershipSchemeController.fetchPatientMembershipScheme(pt, getSessionController().getApplicationPreference().isMembershipExpires()));
        getPreBill().setToStaff(toStaff);
        getPreBill().setToInstitution(toInstitution);

        getPreBill().setComments(comment);

        getPreBill().setCashPaid(cashPaid);
        getPreBill().setBalance(balance);

        getPreBill().setBillDate(new Date());
        getPreBill().setBillTime(new Date());
        getPreBill().setFromDepartment(getSessionController().getLoggedUser().getDepartment());
        getPreBill().setFromInstitution(getSessionController().getLoggedUser().getDepartment().getInstitution());
        getPreBill().setPaymentMethod(getPaymentMethod());
        getPreBill().setPaymentScheme(getPaymentScheme());

        getBillBean().setPaymentMethodData(getPreBill(), getPaymentMethod(), getPaymentMethodData());

        String insId = getBillNumberBean().institutionBillNumberGenerator(getPreBill().getInstitution(), getPreBill().getBillType(), BillClassType.PreBill, BillNumberSuffix.SALE);
        getPreBill().setInsId(insId);
        String deptId = getBillNumberBean().departmentBillNumberGenerator(getPreBill().getDepartment(), getPreBill().getBillType(), BillClassType.PreBill, BillNumberSuffix.SALE);
        getPreBill().setDeptId(deptId);
        getPreBill().setBillTypeAtomic(BillTypeAtomic.PHARMACY_RETAIL_SALE_PRE);
        getPreBill().setInvoiceNumber(billNumberBean.fetchPaymentSchemeCount(getPreBill().getPaymentScheme(), getPreBill().getBillType(), getPreBill().getInstitution()));

    }


How I updated to new method

    private void savePreBillFinallyForRetailSale(Patient pt) {
        if (getPreBill().getId() == null) {
            getBillFacade().create(getPreBill());
        }
        getPreBill().setDepartment(getSessionController().getLoggedUser().getDepartment());
        getPreBill().setInstitution(getSessionController().getLoggedUser().getDepartment().getInstitution());

        getPreBill().setCreatedAt(Calendar.getInstance().getTime());
        getPreBill().setCreater(getSessionController().getLoggedUser());

        getPreBill().setPatient(pt);
//        getPreBill().setMembershipScheme(membershipSchemeController.fetchPatientMembershipScheme(pt, getSessionController().getApplicationPreference().isMembershipExpires()));
        getPreBill().setToStaff(toStaff);
        getPreBill().setToInstitution(toInstitution);

        getPreBill().setComments(comment);

        getPreBill().setCashPaid(cashPaid);
        getPreBill().setBalance(balance);

        getPreBill().setBillDate(new Date());
        getPreBill().setBillTime(new Date());
        getPreBill().setFromDepartment(getSessionController().getLoggedUser().getDepartment());
        getPreBill().setFromInstitution(getSessionController().getLoggedUser().getDepartment().getInstitution());
        getPreBill().setPaymentMethod(getPaymentMethod());
        getPreBill().setPaymentScheme(getPaymentScheme());

        getBillBean().setPaymentMethodData(getPreBill(), getPaymentMethod(), getPaymentMethodData());

        String billId = "";
        String insId = "";
        String deptId = "";
        boolean billNumberGenerationStrategyForPharmacyOpdRetailSaleIsByBillYearTypeAtomicAndLoggedDepartment
                = configOptionController.getBooleanValueByKey("Bill Number Generation Strategy For Pharmacy Opd Retail Sale Is By Year, Bill Type Atomic And Logged Department", false);

        if (billNumberGenerationStrategyForPharmacyOpdRetailSaleIsByBillYearTypeAtomicAndLoggedDepartment) {
            billId = getBillNumberBean().departmentBillNumberGeneratorYearly(
                    sessionController.getDepartment(),
                    BillTypeAtomic.PHARMACY_RETAIL_SALE_PRE);
            insId=billId;
            deptId=billId;
        } else {
            insId = getBillNumberBean().institutionBillNumberGenerator(getPreBill().getInstitution(), getPreBill().getBillType(), BillClassType.PreBill, BillNumberSuffix.SALE);
            deptId = getBillNumberBean().departmentBillNumberGenerator(getPreBill().getDepartment(), getPreBill().getBillType(), BillClassType.PreBill, BillNumberSuffix.SALE);
        }
        getPreBill().setInsId(insId);
        getPreBill().setDeptId(deptId);
        getPreBill().setBillTypeAtomic(BillTypeAtomic.PHARMACY_RETAIL_SALE_PRE);
        getPreBill().setInvoiceNumber(billNumberBean.fetchPaymentSchemeCount(getPreBill().getPaymentScheme(), getPreBill().getBillType(), getPreBill().getInstitution()));

    }

