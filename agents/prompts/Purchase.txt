Here's a cleaned, agent-ready brief of the Purchase Order (PO), Goods Receipt Note (GRN), and GRN Return flows, with duplicates removed and the key technical details you'll need to implement and verify the behaviour in our JavaEE/JSF/JPA (EclipseLink) + PF stack (see project stack in pom.xml).

# Scope and tech context

This describes page routes, UI states, privilege guards, and persistence flags for PO creation/finalization/approval; GRN costing/finalization/approval; and GRN Return save/finalize/approve, including full-return handling and listing behaviour. Use existing facades and controller patterns; persistence operations should go through facades (merge+flush) per our standard (see `editAndCommit` and related helpers).

# Purchase Order workflow

Create PO at `/pharmacy/pharmacy_purhcase_order_request.xhtml`. Finalize PO list at `/pharmacy/pharmacy_purhcase_order_list_to_finalize.xhtml`. Finalize individual POs on the PO request page (`/pharmacy/pharmacy_purhcase_order_request.xhtml`). Page names with "purhcase" are legacy and must remain unchanged (do not rename routes).

Approved PO listing is at `/pharmacy/pharmacy_purchase_order_list_for_recieve.xhtml` (legacy route; do not rename). Each approved PO row shows its related GRNs in the last column. Keep this behaviour.

# GRN workflow (costing, finalize, approve)

Costing and save/approve happen at `/pharmacy/pharmacy_grn_costing_with_save_approve.xhtml`. Add a "Finalize" button alongside "Save" and "Approve". Finalize must perform the same actions as Save and additionally set, on the GRN Bill entity: `completed = true`, `completedBy = <logged user>`, `completedAt = now`. When a GRN is completed, hide Save and Finalize; show Approve only when `completed == true`.

Add two menu pages under Pharmacy - Procurement (just below "Goods Receipt"):

1. "Finalize GRN" = list of GRNs where `billTypeAtomic == 'PHARMACY_GRN_PRE'` and `completed == false`.
2. "Approve GRN" = list where `billTypeAtomic == 'PHARMACY_GRN_PRE'` and `completed == true`.

Both pages must be accessible from the menu. Do not change existing URLs for legacy pages; create new list views as required and re-use existing row actions.

When navigating to `/pharmacy/pharmacy_grn_costing_with_save_approve.xhtml` from menu items or in-page buttons, force `printPreview = false` (pass as request param) so printing does not auto-trigger.

# GRN bill-level tax allocation

On the GRN costing page (`/pharmacy/pharmacy_grn_costing_with_save_approve.xhtml`), when the bill tax input (`id="txtBillTax"`) is entered/changed, proportionally distribute bill-level tax across items and reflect it in the Finance Details dialog opened by `id="btnViewFinanceDetails"` (dialog id `dialog`). This already works here; preserve behaviour.

On Direct Purchase (`/pharmacy/direct_purchase.xhtml`), the bill tax input (`id="tx"`) must trigger the same proportional distribution and the same Finance Details reflection. Implement the same recalculation hooks and UI updates that exist on the GRN costing page so the Finance Details dialog mirrors the updated per-line finance values.

# GRN Return workflow

Entry page is `/pharmacy/pharmacy_grn_return_request.xhtml`, which lists available GRNs. Selecting a GRN and clicking "Create Return" navigates to `/pharmacy/pharmacy_grn_return_form.xhtml`. The return then follows save + finalize + approve.

Legacy return pages: GRNs available to return are shown at `/pharmacy/pharmacy_grn_list_for_return.xhtml`. Items are returned at `/pharmacy/grn_return_with_costing.xhtml`. When all items of a GRN are returned in full, set the original GRN as "fully returned" and set the relevant completion attributes accordingly. After full return, disable the GRN's Return button in the list.

# Privilege hardening: single-item stock adjustment

In `UserPrivilageController` around lines 688â€“690, `PharmacyStockAdjustmentSingleItem` was exposed without UI guards. Locate every JSF element that renders or navigates to single-item stock adjustment (buttons, links, menu entries, and any includes used by `/pharmacy/adjustments/pharmacy_adjustment_department.xhtml`) and wrap them with `rendered="#{webUserController.hasPrivilege('PharmacyStockAdjustmentSingleItem')}"`. Apply the same guard at any navigation/action method level to block direct URL access.

# Navigation and print behaviour

For `/pharmacy/pharmacy_grn_return_form.xhtml`, add visible buttons for: Create GRN, Finalize GRN, Approve GRN, matching the menu structure. These must be present whether `printPreview` is true or false. When navigating into this page from any source, enforce `printPreview=false` to prevent automatic print dialogs.

